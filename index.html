<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-j.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-j.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-j.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo_j.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Java,Spring,Spring Cloud,中间件,RocketMQ,高并发,分布式,分布式事务,流式计算,Storm,机器学习,深度学习,Python,大数据,Spark,Hadoop,HDFS" />





  <link rel="alternate" href="/atom.xml" title="Jay Chang's Blog" type="application/atom+xml" />






<meta name="description" content="当你的才华还撑不起你的野心时，你就应该静下心来学习。">
<meta property="og:type" content="website">
<meta property="og:title" content="Jay Chang&#39;s Blog">
<meta property="og:url" content="http://jaychang.cn/index.html">
<meta property="og:site_name" content="Jay Chang&#39;s Blog">
<meta property="og:description" content="当你的才华还撑不起你的野心时，你就应该静下心来学习。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jay Chang&#39;s Blog">
<meta name="twitter:description" content="当你的才华还撑不起你的野心时，你就应该静下心来学习。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jaychang.cn/"/>





  <title>Jay Chang's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d383fa81ebb62476e09fe22470595b8d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
	
	<a href="https://github.com/jaychang9"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jay Chang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我的技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2023/04/17/buntu20-04-源码安装APISIX-2-15-x-Dashboard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/04/17/buntu20-04-源码安装APISIX-2-15-x-Dashboard/" itemprop="url">Ubuntu20.04 源码安装APISIX-2.15.x Dashboard</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-17T21:26:18+08:00">
                2023-04-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2023/04/17/buntu20-04-源码安装APISIX-2-15-x-Dashboard/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2023/04/17/buntu20-04-源码安装APISIX-2-15-x-Dashboard/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  911
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h1 id="nodejs及go环境准备"><a href="#nodejs及go环境准备" class="headerlink" title="nodejs及go环境准备"></a>nodejs及go环境准备</h1><h2 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://nodejs.org/download/release/v14.21.3/node-v14.21.3-linux-x64.tar.gz</span><br><span class="line">tar xzvf node-v14.21.3-linux-x64.tar.gz -C /opt</span><br><span class="line">mv /opt/node-v14.21.3-linux-x64/ /opt/node/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意nodejs版本不能过高，试过node18构建会报错，建议版本node14~node16</p>
</blockquote>
<p>配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tee -a /etc/profile &lt;&lt; EOF</span><br><span class="line">export NODE_HOME=/opt/node</span><br><span class="line">export PATH=$PATH:$NODE_HOME/bin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>使环境变量生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>安装yarn<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yarn</span><br></pre></td></tr></table></figure></p>
<h2 id="安装go"><a href="#安装go" class="headerlink" title="安装go"></a>安装go</h2><p><a href="https://mirrors.aliyun.com/golang/可以找需要的版本" target="_blank" rel="noopener">https://mirrors.aliyun.com/golang/可以找需要的版本</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.aliyun.com/golang/go1.20.3.linux-amd64.tar.gz</span><br><span class="line">tar xzvf go1.20.3.linux-amd64.tar.gz -C /opt/</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tee -a /etc/profile &lt;&lt; EOF</span><br><span class="line">export GO_HOME=/opt/go</span><br><span class="line">export PATH=$PATH:$GO_HOME/bin</span><br><span class="line">go env -w GO111MODULE=on</span><br><span class="line">go env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>使环境变量生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p>
<h1 id="安装APISIX-Dashboard"><a href="#安装APISIX-Dashboard" class="headerlink" title="安装APISIX Dashboard"></a>安装APISIX Dashboard</h1><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/apache/apisix-dashboard/archive/refs/tags/v2.15.1.tar.gz</span><br></pre></td></tr></table></figure>
<h2 id="解压源码"><a href="#解压源码" class="headerlink" title="解压源码"></a>解压源码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf v2.15.1.tar.gz</span><br><span class="line"></span><br><span class="line">cd apisix-dashboard-2.15.1</span><br></pre></td></tr></table></figure>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make build</span><br></pre></td></tr></table></figure>
<p>构建完成会打印以下内容，估计要7分钟左右<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">其他省略...</span><br><span class="line"></span><br><span class="line">The bundle size is significantly larger than recommended.</span><br><span class="line">Consider reducing it with code splitting: https://umijs.org/docs/load-on-demand</span><br><span class="line">You can also analyze the project dependencies using ANALYZE=1</span><br><span class="line"></span><br><span class="line">Done in 433.32s.</span><br></pre></td></tr></table></figure></p>
<p>编译完将output拷贝到/opt/apisix-dashboard<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p mkdir -p /usr/local/apisix/dashboard &amp;&amp; cp -r ./output/* /usr/local/apisix/dashboard</span><br></pre></td></tr></table></figure></p>
<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><p>如果是http访问etcd仅需配置ectd的访问地址即可</p>
<p>如果是https访问etcd则需要相关证书</p>
<p>将根证书，etcd-server-key证书，etcd-server证书拷贝到apisix目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/apisix/ssl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 根据具体情况即可</span><br><span class="line">cp /opt/etcd3/ssl/&#123;etcd-ca.pem,etcd-server-key.pem,etcd-server.pem&#125; /usr/local/apisix/ssl/</span><br></pre></td></tr></table></figure>
<p>修改vi /usr/local/apisix/dashboard/conf/conf.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其余省略...</span></span><br><span class="line"><span class="attr">  etcd:</span></span><br><span class="line"><span class="attr">    endpoints:</span>            <span class="comment"># supports defining multiple etcd host addresses for an etcd cluster</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.91</span><span class="string">:2379</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.92</span><span class="string">:2379</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.93</span><span class="string">:2379</span></span><br><span class="line">                          <span class="comment"># yamllint disable rule:comments-indentation</span></span><br><span class="line">                          <span class="comment"># etcd basic auth info</span></span><br><span class="line">    <span class="comment"># username: "root"    # ignore etcd username if not enable etcd auth</span></span><br><span class="line">    <span class="comment"># password: "123456"  # ignore etcd password if not enable etcd auth</span></span><br><span class="line"><span class="attr">    mtls:</span></span><br><span class="line"><span class="attr">      key_file:</span> <span class="string">"/usr/local/apisix/ssl/etcd-server-key.pem"</span>  <span class="comment"># Path of your self-signed client side key</span></span><br><span class="line"><span class="attr">      cert_file:</span> <span class="string">"/usr/local/apisix/ssl/etcd-server.pem"</span>     <span class="comment"># Path of your self-signed client side cert</span></span><br><span class="line"><span class="attr">      ca_file:</span> <span class="string">"/usr/local/apisix/ssl/etcd-ca.pem"</span>           <span class="comment"># Path of your self-signed ca cert, the CA is used to sign callers' certificates</span></span><br><span class="line">    <span class="comment"># prefix: /apisix       # apisix config's prefix in etcd, /apisix by default</span></span><br><span class="line"><span class="comment"># 其余省略...</span></span><br></pre></td></tr></table></figure>
<h1 id="运行APISIX-DASHBOARD"><a href="#运行APISIX-DASHBOARD" class="headerlink" title="运行APISIX DASHBOARD"></a>运行APISIX DASHBOARD</h1><p>frontend方式运行apisix-dashboard(不推荐)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/apisix/dashboard</span><br><span class="line">./manager-api</span><br></pre></td></tr></table></figure></p>
<p>安装为系统服务(推荐)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tee /usr/lib/systemd/system/apisix-dashboard.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=apisix-dashboard</span><br><span class="line">Conflicts=apisix-dashboard.service</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/usr/local/apisix/dashboard</span><br><span class="line">ExecStart=/usr/local/apisix/dashboard/manager-api -c /usr/local/apisix/dashboard/conf/conf.yaml</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>服务管理<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> reload下</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> enable apisix-dashboard</span><br><span class="line">systemctl enable apisix-dashboard</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> start apisix-dashboard</span><br><span class="line">systemctl start apisix-dashboard</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> stop apisix-dashboard</span><br><span class="line">systemctl stop apisix-dashboard</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> check apisix-dashboard status</span><br><span class="line">systemctl status apisix-dashboard</span><br></pre></td></tr></table></figure></p>
<p>访问<a href="http://10.1.80.91:9000/" target="_blank" rel="noopener">http://10.1.80.91:9000/</a></p>
<p>若出现以下错误，需要将您的机器IP加入白名单，修改conf.yaml将IP地址或IP网段加入到allow_list内即可<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    Code: 20002,</span><br><span class="line">    Message: "IP address not allowed",</span><br><span class="line">    Data: null,</span><br><span class="line">    SourceSrv: ""</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改vi /usr/local/apisix/dashboard/conf/conf.yaml，加入允许访问的网段即可<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其余省略...</span></span><br><span class="line"><span class="attr">  allow_list:</span>             <span class="comment"># If we don't set any IP list, then any IP access is allowed by default.</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>           <span class="comment"># The rules are checked in sequence until the first match is found.</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.0</span><span class="string">/24</span>        <span class="comment"># The rules are checked in sequence until the first match is found.</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">::1</span>                 <span class="comment"># In this example, access is allowed only for IPv4 network 127.0.0.1, and for IPv6 network ::1.</span></span><br><span class="line">                          <span class="comment"># It also support CIDR like 192.168.1.0/24 and 2001:0db8::/32</span></span><br><span class="line"><span class="comment"># 其余省略...</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2023/04/17/buntu20-04-源码安装APISIX-2-15-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/04/17/buntu20-04-源码安装APISIX-2-15-3/" itemprop="url">Ubuntu20.04 源码安装APISIX-2.15.3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-17T21:25:39+08:00">
                2023-04-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2023/04/17/buntu20-04-源码安装APISIX-2-15-3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2023/04/17/buntu20-04-源码安装APISIX-2-15-3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,315
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<h1 id="OpenResty源码安装"><a href="#OpenResty源码安装" class="headerlink" title="OpenResty源码安装"></a>OpenResty源码安装</h1><h2 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h2><p>您必须将这些库 perl 5.6.1+, libpcre, libssl安装在您的电脑之中。 对于 Linux来说, 您需要确认使用 ldconfig 命令，让其在您的系统环境路径中能找到它们。</p>
<p>以下安装的内容就是取自<a href="https://raw.githubusercontent.com/apache/apisix/master/utils/linux-install-luarocks.sh(master可以替换为具体版本号" target="_blank" rel="noopener">https://raw.githubusercontent.com/apache/apisix/master/utils/linux-install-luarocks.sh(master可以替换为具体版本号</a>)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install make gcc g++ build-essential curl unzip</span><br><span class="line">sudo apt-get install -y libssl-dev perl zlib1g-dev libpcre3 libpcre3-dev libldap2-dev libpq-dev</span><br></pre></td></tr></table></figure></p>
<h2 id="编译安装OpenResty"><a href="#编译安装OpenResty" class="headerlink" title="编译安装OpenResty"></a>编译安装OpenResty</h2><p>下载，解压openresty-$VERSION.tar.gz<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/src &amp;&amp; cd /opt/src</span><br><span class="line">curl -O https://openresty.org/download/openresty-1.21.4.1.tar.gz</span><br><span class="line">tar xzvf openresty-1.21.4.1.tar.gz -C /opt/src</span><br><span class="line">cd /opt/src/openresty-1.21.4.1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/openresty \</span><br><span class="line">    --with-poll_module \</span><br><span class="line">    --with-pcre-jit \</span><br><span class="line">    --without-http_rds_json_module \</span><br><span class="line">    --without-http_rds_csv_module \</span><br><span class="line">    --without-lua_rds_parser \</span><br><span class="line">    --with-stream \</span><br><span class="line">    --with-stream_ssl_module \</span><br><span class="line">    --with-stream_ssl_preread_module \</span><br><span class="line">    --with-http_v2_module \</span><br><span class="line">    --without-mail_pop3_module \</span><br><span class="line">    --without-mail_imap_module \</span><br><span class="line">    --without-mail_smtp_module \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --with-http_realip_module \</span><br><span class="line">    --with-http_addition_module \</span><br><span class="line">    --with-http_auth_request_module \</span><br><span class="line">    --with-http_secure_link_module \</span><br><span class="line">    --with-http_random_index_module \</span><br><span class="line">    --with-http_gzip_static_module \</span><br><span class="line">    --with-http_sub_module \</span><br><span class="line">    --with-http_dav_module \</span><br><span class="line">    --with-http_flv_module \</span><br><span class="line">    --with-http_mp4_module \</span><br><span class="line">    --with-http_gunzip_module \</span><br><span class="line">    --with-threads \</span><br><span class="line">    --with-compat \</span><br><span class="line">    -j`nproc`</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j`nproc` &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h2 id="安装OpenResty的相关组件"><a href="#安装OpenResty的相关组件" class="headerlink" title="安装OpenResty的相关组件"></a>安装OpenResty的相关组件</h2><p>openresty-openssl111-dev openresty-pcre-dev openresty-zlib-dev</p>
<p>我们应该通过添加 GPG 公钥来安装一些需要的组件。这些可以在之后删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install --no-install-recommends wget gnupg ca-certificates</span><br></pre></td></tr></table></figure>
<p>然后导入openresty的 GPG 密钥<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O - https://openresty.org/package/pubkey.gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure></p>
<p>接着添加 openresty 的官方 APT 库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo "deb https://openresty.org/package/ubuntu $(lsb_release -sc) main" &gt; openresty.list</span><br><span class="line">sudo cp openresty.list /etc/apt/sources.list.d/</span><br></pre></td></tr></table></figure>
<p>请注意，这是针对 x86_64 或 amd64 系统的</p>
<p>对于 Aarch64 或 ARM64 系统，你应该使用这个 URL 来代替</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "deb https://openresty.org/package/arm64/ubuntu $(lsb_release -sc) main"</span><br></pre></td></tr></table></figure>
<p>现在更新 APT 索引<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure></p>
<p>安装 Openrety 相关组件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install openresty-openssl111-dev openresty-pcre-dev openresty-zlib-dev</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>安装完会生成/usr/local/openresty目录，且/usr/local/openresty/openssl111,/usr/local/openresty/pcre,/usr/local/openresty/zlib这子目录会在该目录下。</p>
</blockquote>
<h2 id="安装luarocks"><a href="#安装luarocks" class="headerlink" title="安装luarocks"></a>安装luarocks</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://luarocks.org/releases/luarocks-3.8.0.tar.gz</span><br><span class="line">tar -xzvf luarocks-3.8.0.tar.gz</span><br><span class="line">cd luarocks-3.8.0</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/openresty/luajit \</span><br><span class="line">--with-lua=/usr/local/openresty/luajit/ \</span><br><span class="line">--lua-suffix=jit \</span><br><span class="line">--with-lua-include=/usr/local/openresty/luajit/include/luajit-2.1</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>结果如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@s91:/opt/src/apisix-3.2.0/utils/luarocks-3.8.0# ./configure --prefix=/usr/local/openresty/luajit \</span><br><span class="line"><span class="meta">&gt;</span> --with-lua=/usr/local/openresty/luajit/ \</span><br><span class="line"><span class="meta">&gt;</span> --lua-suffix=jit \</span><br><span class="line"><span class="meta">&gt;</span> --with-lua-include=/usr/local/openresty/luajit/include/luajit-2.1</span><br><span class="line">--lua-suffix is no longer necessary.</span><br><span class="line">The suffix is automatically detected.</span><br><span class="line"></span><br><span class="line">Configuring LuaRocks version 3.8.0...</span><br><span class="line"></span><br><span class="line">Lua version detected: 5.1</span><br><span class="line">Lua interpreter found: /usr/local/openresty/luajit/bin/luajit</span><br><span class="line">lua.h found: /usr/local/openresty/luajit/include/luajit-2.1/lua.h</span><br><span class="line">unzip found in PATH: /usr/bin</span><br><span class="line"></span><br><span class="line">Done configuring.</span><br><span class="line"></span><br><span class="line">LuaRocks will be installed at......: /usr/local/openresty/luajit</span><br><span class="line">LuaRocks will install rocks at.....: /usr/local/openresty/luajit</span><br><span class="line">LuaRocks configuration directory...: /usr/local/openresty/luajit/etc/luarocks</span><br><span class="line">Using Lua from.....................: /usr/local/openresty/luajit</span><br><span class="line">Lua include directory..............: /usr/local/openresty/luajit/include/luajit-2.1</span><br><span class="line"></span><br><span class="line">* Type make and make install:</span><br><span class="line">  to install to /usr/local/openresty/luajit as usual.</span><br><span class="line">* Type make bootstrap:</span><br><span class="line">  to install LuaRocks into /usr/local/openresty/luajit as a rock.</span><br></pre></td></tr></table></figure></p>
<p>设置环境变量<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>/etc/profile文件最后添加如下代码<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export OPENRESTY_HOME=/usr/local/openresty</span><br><span class="line">export PATH=$PATH:$OPENRESTY_HOME/bin:$OPENRESTY_HOME/luajit/bin</span><br></pre></td></tr></table></figure></p>
<p>使得环境变量生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p>
<h2 id="重构Openresty"><a href="#重构Openresty" class="headerlink" title="重构Openresty"></a>重构Openresty</h2><p>主要是为了加一些apisix所需的模块</p>
<pre><code>To enable etcd client certificate you need to build APISIX-Base, see
https://apisix.apache.org/docs/apisix/FAQ#how-do-i-build-the-apisix-base-environment
</code></pre><p><a href="https://raw.githubusercontent.com/api7/apisix-build-tools/apisix/2.5.13/build-apisix-base.sh" target="_blank" rel="noopener">apisix提供的openresty构建脚本</a><br>我将版本改为2.5.13，即version=${version:-0.0.0}改为了version=2.5.13。<br>由于git clone经常出问题(github不稳定，翻墙会好一些)，我改了下脚本，可以先将需要的包都下载下来(所需的源码包百度网盘下载)[<a href="https://pan.baidu.com/s/1X8U4_pIL86QH3wJuhrv6LQ?pwd=k8sl" target="_blank" rel="noopener">https://pan.baidu.com/s/1X8U4_pIL86QH3wJuhrv6LQ?pwd=k8sl</a>]</p>
<p>可以提前将下载好的安装包放到构建脚本同目录下，构建脚本内容如下,我处理了下：1.有些解压出来不带v，但是文件名带v 2.解压出来是大写的。这两种情况<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line">set -euo pipefail</span><br><span class="line">set -x</span><br><span class="line"></span><br><span class="line">version=$&#123;version:-2.15.3&#125;</span><br><span class="line"></span><br><span class="line">if ([ $# -gt 0 ] &amp;&amp; [ "$1" == "latest" ]) || [ "$version" == "latest" ]; then</span><br><span class="line">    ngx_multi_upstream_module_ver="master"</span><br><span class="line">    mod_dubbo_ver="master"</span><br><span class="line">    apisix_nginx_module_ver="main"</span><br><span class="line">    wasm_nginx_module_ver="main"</span><br><span class="line">    lua_var_nginx_module_ver="master"</span><br><span class="line">    grpc_client_nginx_module_ver="main"</span><br><span class="line">    amesh_ver="main"</span><br><span class="line">    debug_args="--with-debug"</span><br><span class="line">    OR_PREFIX=$&#123;OR_PREFIX:="/usr/local/openresty-debug"&#125;</span><br><span class="line">else</span><br><span class="line">    ngx_multi_upstream_module_ver="1.1.1"</span><br><span class="line">    mod_dubbo_ver="1.0.2"</span><br><span class="line">    apisix_nginx_module_ver="1.12.0"</span><br><span class="line">    wasm_nginx_module_ver="0.6.4"</span><br><span class="line">    lua_var_nginx_module_ver="v0.5.3"</span><br><span class="line">    grpc_client_nginx_module_ver="v0.4.2"</span><br><span class="line">    amesh_ver="main"</span><br><span class="line">    debug_args=$&#123;debug_args:-&#125;</span><br><span class="line">    OR_PREFIX=$&#123;OR_PREFIX:="/usr/local/openresty"&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">prev_workdir="$PWD"</span><br><span class="line">repo=$(basename "$prev_workdir")</span><br><span class="line">workdir=$(mktemp -d)</span><br><span class="line">cd "$workdir" || exit 1</span><br><span class="line"></span><br><span class="line">or_ver="1.21.4.1"</span><br><span class="line">wget --no-check-certificate https://openresty.org/download/openresty-$&#123;or_ver&#125;.tar.gz</span><br><span class="line">tar -zxvpf openresty-$&#123;or_ver&#125;.tar.gz &gt; /dev/null</span><br><span class="line"></span><br><span class="line">if [ "$repo" == ngx_multi_upstream_module ]; then</span><br><span class="line">    cp -r "$prev_workdir" ./ngx_multi_upstream_module-$&#123;ngx_multi_upstream_module_ver&#125;</span><br><span class="line">else</span><br><span class="line">    unzip $&#123;prev_workdir&#125;/ngx_multi_upstream_module-$&#123;ngx_multi_upstream_module_ver&#125;.zip</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$repo" == mod_dubbo ]; then</span><br><span class="line">    cp -r "$prev_workdir" ./mod_dubbo-$&#123;mod_dubbo_ver&#125;</span><br><span class="line">else</span><br><span class="line">     unzip $&#123;prev_workdir&#125;/mod_dubbo-$&#123;mod_dubbo_ver&#125;.zip</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$repo" == apisix-nginx-module ]; then</span><br><span class="line">    cp -r "$prev_workdir" ./apisix-nginx-module-$&#123;apisix_nginx_module_ver&#125;</span><br><span class="line">else</span><br><span class="line">    unzip $&#123;prev_workdir&#125;/apisix-nginx-module-$&#123;apisix_nginx_module_ver&#125;.zip	</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$repo" == wasm-nginx-module ]; then</span><br><span class="line">    cp -r "$prev_workdir" ./wasm-nginx-module-$&#123;wasm_nginx_module_ver&#125;</span><br><span class="line">else</span><br><span class="line">    unzip $&#123;prev_workdir&#125;/wasm-nginx-module-$&#123;wasm_nginx_module_ver&#125;.zip</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$repo" == lua-var-nginx-module ]; then</span><br><span class="line">    cp -r "$prev_workdir" ./lua-var-nginx-module-$&#123;lua_var_nginx_module_ver&#125;</span><br><span class="line">else</span><br><span class="line">    unzip $&#123;prev_workdir&#125;/lua-var-nginx-module-$&#123;lua_var_nginx_module_ver#*v&#125;.zip</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$repo" == grpc-client-nginx-module ]; then</span><br><span class="line">    cp -r "$prev_workdir" ./grpc-client-nginx-module-$&#123;grpc_client_nginx_module_ver&#125;</span><br><span class="line">else</span><br><span class="line">    unzip $&#123;prev_workdir&#125;/grpc-client-nginx-module-$&#123;grpc_client_nginx_module_ver#*v&#125;.zip</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ "$repo" == amesh ]; then</span><br><span class="line">    cp -r "$prev_workdir" ./amesh-$&#123;amesh_ver&#125;</span><br><span class="line">else</span><br><span class="line">    unzip $&#123;prev_workdir&#125;/Amesh-$&#123;amesh_ver&#125;.zip	</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd ngx_multi_upstream_module-$&#123;ngx_multi_upstream_module_ver&#125; || exit 1</span><br><span class="line">./patch.sh ../openresty-$&#123;or_ver&#125;</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">cd apisix-nginx-module-$&#123;apisix_nginx_module_ver&#125;/patch || exit 1</span><br><span class="line">./patch.sh ../../openresty-$&#123;or_ver&#125;</span><br><span class="line">cd ../..</span><br><span class="line"></span><br><span class="line">cd wasm-nginx-module-$&#123;wasm_nginx_module_ver&#125; || exit 1</span><br><span class="line">./install-wasmtime.sh</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">cc_opt=$&#123;cc_opt:-&#125;</span><br><span class="line">ld_opt=$&#123;ld_opt:-&#125;</span><br><span class="line">luajit_xcflags=$&#123;luajit_xcflags:="-DLUAJIT_NUMMODE=2 -DLUAJIT_ENABLE_LUA52COMPAT"&#125;</span><br><span class="line">no_pool_patch=$&#123;no_pool_patch:-&#125;</span><br><span class="line"><span class="meta">#</span> TODO: remove old NGX_HTTP_GRPC_CLI_ENGINE_PATH once we have released a new</span><br><span class="line"><span class="meta">#</span> version of grpc-client-nginx-module</span><br><span class="line">grpc_engine_path="-DNGX_GRPC_CLI_ENGINE_PATH=$OR_PREFIX/libgrpc_engine.so -DNGX_HTTP_GRPC_CLI_ENGINE_PATH=$OR_PREFIX/libgrpc_engine.so"</span><br><span class="line"></span><br><span class="line">cd openresty-$&#123;or_ver&#125; || exit 1</span><br><span class="line"><span class="meta">#</span> FIXME: remove this once 1.21.4.2 is released</span><br><span class="line">rm -rf bundle/LuaJIT-2.1-20220411</span><br><span class="line">lj_ver=2.1-20230119</span><br><span class="line">wget "https://github.com/openresty/luajit2/archive/v$lj_ver.tar.gz" -O "LuaJIT-$lj_ver.tar.gz"</span><br><span class="line">tar -xzf LuaJIT-$lj_ver.tar.gz</span><br><span class="line">mv luajit2-* bundle/LuaJIT-2.1-20220411</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> $&#123;lua_var_nginx_module_ver#*v&#125;是为了去掉v</span><br><span class="line"></span><br><span class="line">./configure --prefix="$OR_PREFIX" \</span><br><span class="line">    --with-cc-opt="-DAPISIX_BASE_VER=$version $grpc_engine_path $cc_opt" \</span><br><span class="line">    --with-ld-opt="-Wl,-rpath,$OR_PREFIX/wasmtime-c-api/lib $ld_opt" \</span><br><span class="line">    $debug_args \</span><br><span class="line">    --add-module=../mod_dubbo-$&#123;mod_dubbo_ver&#125; \</span><br><span class="line">    --add-module=../ngx_multi_upstream_module-$&#123;ngx_multi_upstream_module_ver&#125; \</span><br><span class="line">    --add-module=../apisix-nginx-module-$&#123;apisix_nginx_module_ver&#125; \</span><br><span class="line">    --add-module=../apisix-nginx-module-$&#123;apisix_nginx_module_ver&#125;/src/stream \</span><br><span class="line">    --add-module=../apisix-nginx-module-$&#123;apisix_nginx_module_ver&#125;/src/meta \</span><br><span class="line">    --add-module=../wasm-nginx-module-$&#123;wasm_nginx_module_ver&#125; \</span><br><span class="line">    --add-module=../lua-var-nginx-module-$&#123;lua_var_nginx_module_ver#*v&#125; \</span><br><span class="line">    --add-module=../grpc-client-nginx-module-$&#123;grpc_client_nginx_module_ver#*v&#125; \</span><br><span class="line">    --with-poll_module \</span><br><span class="line">    --with-pcre-jit \</span><br><span class="line">    --without-http_rds_json_module \</span><br><span class="line">    --without-http_rds_csv_module \</span><br><span class="line">    --without-lua_rds_parser \</span><br><span class="line">    --with-stream \</span><br><span class="line">    --with-stream_ssl_module \</span><br><span class="line">    --with-stream_ssl_preread_module \</span><br><span class="line">    --with-http_v2_module \</span><br><span class="line">    --without-mail_pop3_module \</span><br><span class="line">    --without-mail_imap_module \</span><br><span class="line">    --without-mail_smtp_module \</span><br><span class="line">    --with-http_stub_status_module \</span><br><span class="line">    --with-http_realip_module \</span><br><span class="line">    --with-http_addition_module \</span><br><span class="line">    --with-http_auth_request_module \</span><br><span class="line">    --with-http_secure_link_module \</span><br><span class="line">    --with-http_random_index_module \</span><br><span class="line">    --with-http_gzip_static_module \</span><br><span class="line">    --with-http_sub_module \</span><br><span class="line">    --with-http_dav_module \</span><br><span class="line">    --with-http_flv_module \</span><br><span class="line">    --with-http_mp4_module \</span><br><span class="line">    --with-http_gunzip_module \</span><br><span class="line">    --with-threads \</span><br><span class="line">    --with-compat \</span><br><span class="line">    --with-luajit-xcflags="$luajit_xcflags" \</span><br><span class="line">    $no_pool_patch \</span><br><span class="line">    -j`nproc`</span><br><span class="line"></span><br><span class="line">make -j`nproc`</span><br><span class="line">sudo make install</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">cd apisix-nginx-module-$&#123;apisix_nginx_module_ver&#125; || exit 1</span><br><span class="line">sudo OPENRESTY_PREFIX="$OR_PREFIX" make install</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">cd wasm-nginx-module-$&#123;wasm_nginx_module_ver&#125; || exit 1</span><br><span class="line">sudo OPENRESTY_PREFIX="$OR_PREFIX" make install</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">cd grpc-client-nginx-module-$&#123;grpc_client_nginx_module_ver#*v&#125; || exit 1</span><br><span class="line">sudo sed -i s#https://go.dev/dl/#https://golang.google.cn/dl/#g install-util.sh</span><br><span class="line">sudo /usr/local/go/bin/go env -w GO111MODULE=on</span><br><span class="line">sudo /usr/local/go/bin/go env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line">sudo OPENRESTY_PREFIX="$OR_PREFIX" make install</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">cd Amesh-$&#123;amesh_ver&#125; || exit 1</span><br><span class="line">sudo OPENRESTY_PREFIX="$OR_PREFIX" sh -c 'PATH="$&#123;PATH&#125;:/usr/local/go/bin" make install'</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> package etcdctl</span><br><span class="line">ETCD_ARCH="amd64"</span><br><span class="line">ETCD_VERSION=$&#123;ETCD_VERSION:-'3.5.4'&#125;</span><br><span class="line">ARCH=$&#123;ARCH:-$(uname -m | tr '[:upper:]' '[:lower:]')&#125;</span><br><span class="line"></span><br><span class="line">if [[ $ARCH == "arm64" ]] || [[ $ARCH == "aarch64" ]]; then</span><br><span class="line">    ETCD_ARCH="arm64"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">wget -q https://github.com/etcd-io/etcd/releases/download/v$&#123;ETCD_VERSION&#125;/etcd-v$&#123;ETCD_VERSION&#125;-linux-$&#123;ETCD_ARCH&#125;.tar.gz</span><br><span class="line">tar xf etcd-v$&#123;ETCD_VERSION&#125;-linux-$&#123;ETCD_ARCH&#125;.tar.gz</span><br><span class="line"><span class="meta">#</span> ship etcdctl under the same bin dir of openresty so we can package it easily</span><br><span class="line">sudo cp etcd-v$&#123;ETCD_VERSION&#125;-linux-$&#123;ETCD_ARCH&#125;/etcdctl "$OR_PREFIX"/bin/</span><br><span class="line">rm -rf etcd-v$&#123;ETCD_VERSION&#125;-linux-$&#123;ETCD_ARCH&#125;</span><br></pre></td></tr></table></figure></p>
<p>设置环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>添加以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt; /etc/profile &lt;&lt; EOF</span><br><span class="line">export $OPENRESTY_HOME=/usr/local/openresty</span><br><span class="line">export PATH=$PATH:$OPENRESTY_HOME/bin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>然后执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">souce /etc/profile</span><br></pre></td></tr></table></figure></p>
<h1 id="APISIX安装"><a href="#APISIX安装" class="headerlink" title="APISIX安装"></a>APISIX安装</h1><p>进入APISIX源码目录</p>
<p>设置APISIX版本，并创建目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APISIX_VERSION=2.15.3</span><br><span class="line">mkdir apisix-$&#123;APISIX_VERSION&#125;</span><br></pre></td></tr></table></figure>
<p>下载源码包<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://downloads.apache.org/apisix/$&#123;APISIX_VERSION&#125;/apache-apisix-$&#123;APISIX_VERSION&#125;-src.tgz</span><br></pre></td></tr></table></figure></p>
<p>解压源码包<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/src/apisix-$&#123;APISIX_VERSION&#125; &amp;&amp; tar xzvf apache-apisix-$&#123;APISIX_VERSION&#125;-src.tgz -C /opt/src/apisix-$&#123;APISIX_VERSION&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改luarocks源,添加以下配置<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/.luarocks</span><br><span class="line">cat &gt;&gt; ~/.luarocks/config-5.1.lua &lt;&lt; EOF</span><br><span class="line">rocks_servers = &#123;</span><br><span class="line">   &#123;</span><br><span class="line">      "https://luarocks.cn",</span><br><span class="line">      "https://luarocks.org",</span><br><span class="line">      "https://raw.githubusercontent.com/rocks-moonscript-org/moonrocks-mirror/master/",</span><br><span class="line">      "https://luafr.org/luarocks/",</span><br><span class="line">      "http://luarocks.logiceditor.com/rocks"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">variables = &#123;</span><br><span class="line">   OPENSSL_INCDIR = "/usr/local/openresty/openssl111/include",</span><br><span class="line">   OPENSSL_LIBDIR = "/usr/local/openresty/openssl111/lib"</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>构建<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Switch to the apisix-$&#123;APISIX_VERSION&#125; directory</span><br><span class="line">cd apisix-$&#123;APISIX_VERSION&#125;</span><br><span class="line"><span class="meta">#</span> Create dependencies</span><br><span class="line">make deps</span><br></pre></td></tr></table></figure></p>
<p>或指定源地址<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make deps ENV_LUAROCKS_SERVER=https://luarocks.cn</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>构建的话由于网络问题，可能需要多试几次</p>
</blockquote>
<p>最后安装<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Install apisix command</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo tee -a /etc/security/limits.conf &lt;&lt; EOF</span><br><span class="line"><span class="meta">#</span> </span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br><span class="line">* soft nproc 65536</span><br><span class="line">* hard nproc 65536</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>设置luarocks<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OPENSSL_PREFIX=/usr/local/openresty/openssl111</span><br><span class="line">luarocks config variables.OPENSSL_LIBDIR $&#123;OPENSSL_PREFIX&#125;/lib</span><br><span class="line">luarocks config variables.OPENSSL_INCDIR $&#123;OPENSSL_PREFIX&#125;/include</span><br></pre></td></tr></table></figure></p>
<p>拷贝源码构建目录下的apisix目录以及deps目录到 /usr/local/apisix<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r /opt/src/apisix-$&#123;APISIX_VERSION&#125;/apisix/ /opt/src/apisix-$&#123;APISIX_VERSION&#125;/deps/ /usr/local/apisix/</span><br></pre></td></tr></table></figure></p>
<p>测试apisix<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/apisix test</span><br><span class="line">/usr/bin/apisix init</span><br></pre></td></tr></table></figure></p>
<h1 id="APISIX连接etcd"><a href="#APISIX连接etcd" class="headerlink" title="APISIX连接etcd"></a>APISIX连接etcd</h1><h2 id="无证书方式"><a href="#无证书方式" class="headerlink" title="无证书方式"></a>无证书方式</h2><p>分别在三个节点上起etcd服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd3/etcd \</span><br><span class="line">--name s1 \</span><br><span class="line">--data-dir /tmp/etcd-data \</span><br><span class="line">--listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">--advertise-client-urls http://0.0.0.0:2379 \</span><br><span class="line">--listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">--initial-advertise-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">--initial-cluster s1=http://0.0.0.0:2380 \</span><br><span class="line">--initial-cluster-token tkn \</span><br><span class="line">--initial-cluster-state new \</span><br><span class="line">--log-level info \</span><br><span class="line">--logger zap \</span><br><span class="line">--log-outputs stderr</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd3/etcd \</span><br><span class="line">--name s2 \</span><br><span class="line">--data-dir /tmp/etcd-data \</span><br><span class="line">--listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">--advertise-client-urls http://0.0.0.0:2379 \</span><br><span class="line">--listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">--initial-advertise-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">--initial-cluster s1=http://0.0.0.0:2380 \</span><br><span class="line">--initial-cluster-token tkn \</span><br><span class="line">--initial-cluster-state new \</span><br><span class="line">--log-level info \</span><br><span class="line">--logger zap \</span><br><span class="line">--log-outputs stderr</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd3/etcd \</span><br><span class="line">--name s3 \</span><br><span class="line">--data-dir /tmp/etcd-data \</span><br><span class="line">--listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">--advertise-client-urls http://0.0.0.0:2379 \</span><br><span class="line">--listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">--initial-advertise-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">--initial-cluster s1=http://0.0.0.0:2380 \</span><br><span class="line">--initial-cluster-token tkn \</span><br><span class="line">--initial-cluster-state new \</span><br><span class="line">--log-level info \</span><br><span class="line">--logger zap \</span><br><span class="line">--log-outputs stderr</span><br></pre></td></tr></table></figure>
<p>如果是使用http的话，就配置下host就行了<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其他配置省略...</span></span><br><span class="line"></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  host:</span>                           </span><br><span class="line"><span class="bullet">    -</span> <span class="string">"http://10.1.80.91:2379"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"http://10.1.80.92:2379"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"http://10.1.80.93:2379"</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 其他配置省略...</span></span><br></pre></td></tr></table></figure></p>
<h2 id="有证书方式"><a href="#有证书方式" class="headerlink" title="有证书方式"></a>有证书方式</h2><p>如果是使用https的话，需要配置下etcd证书</p>
<p>创建放etcd证书的目录，并将证书拷贝过去，由于我是将etcd和apisix安装在一台上了，请根据具体情况来操作<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /usr/local/apisix/ssl</span><br><span class="line">sudo cp /opt/etcd3/ssl/&#123;etcd-ca.pem,etcd-server-key.pem,etcd-server.pem&#125; /usr/local/apisix/ssl</span><br><span class="line">sudo chmod a+r /usr/local/apisix/ssl/etcd-server-key.pem</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>chmod 666 /usr/local/apisix/ssl/etcd-server-key.pem 为什么加写权限，见常见问题</p>
</blockquote>
<p>修改APISIX配置文件，可以先备份下，然后用config-default.yaml这个模板<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/apisix/conf/config.yaml /usr/local/apisix/conf/config.yaml.bak</span><br><span class="line">cp /usr/local/apisix/conf/config-default.yaml /usr/local/apisix/conf/config.yaml</span><br><span class="line">vi /usr/local/apisix/conf/config.yaml</span><br></pre></td></tr></table></figure></p>
<p>修改内容如下<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其余省略...</span></span><br><span class="line"><span class="attr">ssl:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  listen:</span>                       <span class="comment"># APISIX listening port in https.</span></span><br><span class="line"><span class="attr">    - port:</span> <span class="number">9443</span></span><br><span class="line"><span class="attr">      enable_http2:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">#   - ip: 127.0.0.3           # Specific IP, If not set, the default value is `0.0.0.0`.</span></span><br><span class="line">  <span class="comment">#     port: 9445</span></span><br><span class="line">  <span class="comment">#     enable_http2: true</span></span><br><span class="line"><span class="attr">  ssl_trusted_certificate:</span> <span class="string">/usr/local/apisix/ssl/etcd-ca.pem</span> <span class="comment"># Specifies a file path with trusted CA certificates in the PEM format  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其余省略...</span></span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line"><span class="attr">  host:</span>                           <span class="comment"># it's possible to define multiple etcd hosts addresses of the same etcd cluster.</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"https://10.1.80.91:2379"</span>   <span class="comment"># multiple etcd address, if your etcd cluster enables TLS, please use https scheme,</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"https://10.1.80.92:2379"</span>   <span class="comment"># multiple etcd address, if your etcd cluster enables TLS, please use https scheme,</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"https://10.1.80.93:2379"</span>   <span class="comment"># multiple etcd address, if your etcd cluster enables TLS, please use https scheme,</span></span><br><span class="line">                                  <span class="comment"># e.g. https://127.0.0.1:2379.</span></span><br><span class="line"><span class="attr">  prefix:</span> <span class="string">/apisix</span>                 <span class="comment"># configuration prefix in etcd</span></span><br><span class="line"><span class="attr">  use_grpc:</span> <span class="literal">false</span>                 <span class="comment"># enable the experimental configuration sync via gRPC</span></span><br><span class="line"><span class="attr">  timeout:</span> <span class="number">30</span>                     <span class="comment"># 30 seconds. Use a much higher timeout (like an hour) if the `use_grpc` is true.</span></span><br><span class="line">  <span class="comment">#resync_delay: 5                # when sync failed and a rest is needed, resync after the configured seconds plus 50% random jitter</span></span><br><span class="line">  <span class="comment">#health_check_timeout: 10       # etcd retry the unhealthy nodes after the configured seconds</span></span><br><span class="line"><span class="attr">  startup_retry:</span> <span class="number">2</span>                <span class="comment"># the number of retry to etcd during the startup, default to 2</span></span><br><span class="line">  <span class="comment">#user: root                     # root username for etcd</span></span><br><span class="line">  <span class="comment">#password: 5tHkHhYkjr6cQY       # root password for etcd</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line">    <span class="comment"># To enable etcd client certificate you need to build APISIX-Base, see</span></span><br><span class="line">    <span class="comment"># https://apisix.apache.org/docs/apisix/FAQ#how-do-i-build-the-apisix-base-environment</span></span><br><span class="line"><span class="attr">    cert:</span> <span class="string">/usr/local/apisix/ssl/etcd-server.pem</span>          <span class="comment"># path of certificate used by the etcd client</span></span><br><span class="line"><span class="attr">    key:</span> <span class="string">/usr/local/apisix/ssl/etcd-server-key.pem</span>       <span class="comment"># path of key used by the etcd client</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    verify:</span> <span class="literal">true</span>                  <span class="comment"># whether to verify the etcd endpoint certificate when setup a TLS connection to etcd,</span></span><br></pre></td></tr></table></figure></p>
<h1 id="初始化启动APISIX"><a href="#初始化启动APISIX" class="headerlink" title="初始化启动APISIX"></a>初始化启动APISIX</h1><p>启动apisix<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/apisix test</span><br><span class="line">/usr/bin/apisix init</span><br><span class="line">/usr/bin/apisix start</span><br></pre></td></tr></table></figure></p>
<p>如果以这种方式启动了，当使用systemd服务方式启动时，别忘了关掉之前的apisix进程</p>
<p>为APISIX添加systemd服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sudo tee -a /usr/lib/systemd/system/apisix.service &lt;&lt; EOF  </span><br><span class="line"><span class="meta">#</span> apisix systemd service</span><br><span class="line"><span class="meta">#</span> https://github.com/api7/apisix-build-tools/blob/master/usr/lib/systemd/system/apisix.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=apisix</span><br><span class="line"><span class="meta">#</span>Conflicts=apisix.service</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">Restart=on-failure</span><br><span class="line">WorkingDirectory=/usr/local/apisix</span><br><span class="line">ExecStart=/usr/bin/apisix start</span><br><span class="line">ExecStop=/usr/bin/apisix stop</span><br><span class="line">ExecReload=/usr/bin/apisix reload</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<p>启用apisix服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable apisix</span><br></pre></td></tr></table></figure></p>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><h2 id="Could-not-find-header-file-for-OPENSSL"><a href="#Could-not-find-header-file-for-OPENSSL" class="headerlink" title="Could not find header file for OPENSSL"></a>Could not find header file for OPENSSL</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Installing https://luarocks.org/luasec-0.9-1.src.rock</span><br><span class="line"></span><br><span class="line">Error: Failed installing dependency: https://luarocks.org/luasec-0.9-1.src.rock - Could not find header file for OPENSSL</span><br><span class="line">  No file openssl/ssl.h in /usr/local/openresty/openssl/include</span><br><span class="line">You may have to install OPENSSL in your system and/or pass OPENSSL_DIR or OPENSSL_INCDIR to the luarocks command.</span><br><span class="line">Example: luarocks install luasec OPENSSL_DIR=/usr/local</span><br><span class="line">make: *** [Makefile:152: deps] Error 1</span><br><span class="line">root@exp:/tmp/src/apisix-2.15# ll /usr/local/openresty/op^C</span><br><span class="line">root@exp:/tmp/src/apisix-2.15# apt install libssl-dev</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree</span><br><span class="line">Reading state information... Done</span><br><span class="line">libssl-dev is already the newest version (1.1.1f-1ubuntu2.16).</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 9 not upgraded.</span><br></pre></td></tr></table></figure>
<p>需要安装openresty-openssl111-dev</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y openresty-openssl111-dev</span><br></pre></td></tr></table></figure>
<h2 id="gzip-module-requires-the-zlib-library"><a href="#gzip-module-requires-the-zlib-library" class="headerlink" title="gzip module requires the zlib library"></a>gzip module requires the zlib library</h2><p>在进行./configure编译Nginx提示gzip module requires the zlib library<br>执行sudo apt install zlib1g-dev可解决</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install zlib1g-dev</span><br></pre></td></tr></table></figure>
<h2 id="ngx-postgres-addon-was-unable-to-detect-version-of-the-libpq-library"><a href="#ngx-postgres-addon-was-unable-to-detect-version-of-the-libpq-library" class="headerlink" title="ngx_postgres addon was unable to detect version of the libpq library"></a>ngx_postgres addon was unable to detect version of the libpq library</h2><p>在进行./configure编译Nginx提示ngx_postgres addon was unable to detect version of the libpq library<br>执行sudo apt-get install libpq-dev可解决</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libpq-dev</span><br></pre></td></tr></table></figure>
<p>安装apixsix make deps时报如下错误，说明没有安装libldap2-dev<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error: Failed installing dependency: https://luarocks.cn/lualdap-1.2.6-1.src.rock - Could not find header file for LDAP</span><br><span class="line">  No file ldap.h in /usr/local/include</span><br><span class="line">  No file ldap.h in /usr/include</span><br><span class="line">  No file ldap.h in /include</span><br></pre></td></tr></table></figure></p>
<h2 id="APISIX相关文件缺失"><a href="#APISIX相关文件缺失" class="headerlink" title="APISIX相关文件缺失"></a>APISIX相关文件缺失</h2><p>遇如下错误，只需将源码apisix-$VERSION/apisix目录拷贝到 /usr/local/apisix安装目录下 cp -r /opt/src/apisix-3.2.0/apisix/ /usr/local/apisix/<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@s91:/usr/local/apisix# apisix init</span><br><span class="line">/usr/local/openresty//luajit/bin/luajit /usr/local/apisix/apisix/cli/apisix.lua init</span><br><span class="line">/usr/local/openresty//luajit/bin/luajit: cannot open /usr/local/apisix/apisix/cli/apisix.lua: No such file or directory</span><br><span class="line">root@s91:/usr/local/apisix# apisix test</span><br><span class="line">/usr/local/openresty//luajit/bin/luajit /usr/local/apisix/apisix/cli/apisix.lua test</span><br><span class="line">/usr/local/openresty//luajit/bin/luajit: cannot open /usr/local/apisix/apisix/cli/apisix.lua: No such file or directory</span><br></pre></td></tr></table></figure></p>
<h2 id="缺少主机名的解析"><a href="#缺少主机名的解析" class="headerlink" title="缺少主机名的解析"></a>缺少主机名的解析</h2><p>遇到如下错误，只需要在/etc/hosts里加一条记录 127.0.0.1 s92.idc3.meeleet.com 即可<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo: unable to resolve host s92.idc3.meeleet.com: Temporary failure in name resolution</span><br></pre></td></tr></table></figure></p>
<h2 id="默认luarocks源下载慢，很容易下载失败的问题"><a href="#默认luarocks源下载慢，很容易下载失败的问题" class="headerlink" title="默认luarocks源下载慢，很容易下载失败的问题"></a>默认luarocks源下载慢，很容易下载失败的问题</h2><p>APISIX make deps构建，如果出现以下错误,需要配置下luarcoks国内源优先,因为默认的源luarocks.org比较慢，使用<a href="https://luarocks.cn的源，成功率会高很多，但是可能还有偶尔失败，多试几次就可以了" target="_blank" rel="noopener">https://luarocks.cn的源，成功率会高很多，但是可能还有偶尔失败，多试几次就可以了</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Installing https://luarocks.org/lua-resty-radixtree-2.8.2-0.src.rock</span><br><span class="line">Missing dependencies for lua-resty-radixtree 2.8.2-0:</span><br><span class="line">   lua-resty-expr 1.3.0 (not installed)</span><br><span class="line"></span><br><span class="line">lua-resty-radixtree 2.8.2-0 depends on lua-resty-ipmatcher (0.6.1-0 installed)</span><br><span class="line">lua-resty-radixtree 2.8.2-0 depends on lua-resty-expr 1.3.0 (not installed)</span><br><span class="line">Installing https://luarocks.org/lua-resty-expr-1.3.0-0.rockspec</span><br><span class="line">Cloning into 'lua-resty-expr'...</span><br><span class="line">fatal: unable to access 'https://github.com/api7/lua-resty-expr/': GnuTLS recv error (-110): The TLS connection was non-properly terminated.</span><br><span class="line"></span><br><span class="line">Error: Failed installing dependency: https://luarocks.org/lua-resty-radixtree-2.8.2-0.src.rock - Failed installing dependency: https://luarocks.org/lua-resty-expr-1.3.0-0.rockspec - Failed cloning git repository.</span><br><span class="line">make: *** [Makefile:152: deps] Error 1</span><br></pre></td></tr></table></figure></p>
<h2 id="etcd-server-key-pem-Permission-denied"><a href="#etcd-server-key-pem-Permission-denied" class="headerlink" title="etcd-server-key.pem:Permission denied"></a>etcd-server-key.pem:Permission denied</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2023/04/17 04:28:11 [warn] 110028#110028: *44161 [lua] v3.lua:716: request_chunk(): https://10.1.80.93:2379: /usr/local/apisix/ssl/etcd-server-key.pem: Permission denied. Retrying, context: ngx.timer</span><br><span class="line">2023/04/17 04:28:11 [warn] 110028#110028: *44161 [lua] v3.lua:716: request_chunk(): https://10.1.80.91:2379: /usr/local/apisix/ssl/etcd-server-key.pem: Permission denied. Retrying, context: ngx.timer</span><br><span class="line">2023/04/17 04:28:11 [warn] 110028#110028: *44161 [lua] v3.lua:716: request_chunk(): https://10.1.80.92:2379: /usr/local/apisix/ssl/etcd-server-key.pem: Permission denied. Retrying, context: ngx.timer</span><br></pre></td></tr></table></figure>
<p>需要给证书文件所有用户以读权限<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod a+r /usr/local/apisix/ssl/etcd-server-key.pem</span><br></pre></td></tr></table></figure></p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="需要安装Lua吗？"><a href="#需要安装Lua吗？" class="headerlink" title="需要安装Lua吗？"></a>需要安装Lua吗？</h2><p>不需要，因为这里OpenResty用的LuaJIT来运行</p>
<h2 id="怎么卸载APISIX"><a href="#怎么卸载APISIX" class="headerlink" title="怎么卸载APISIX"></a>怎么卸载APISIX</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> To uninstall the APISIX runtime, run:</span><br><span class="line">make uninstall</span><br><span class="line">make undeps</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://openresty.org/cn/linux-packages.html" target="_blank" rel="noopener">OpenResty® Linux 包</a></p>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-openresty-web-framework-for-nginx-on-ubuntu-16-04" target="_blank" rel="noopener">How to Use the OpenResty Web Framework for Nginx on Ubuntu 16.04
</a></p>
<p><a href="https://apisix.apache.org/zh/docs/apisix/install-dependencies/" target="_blank" rel="noopener">APISIX安装依赖</a></p>
<p><a href="https://blog.51cto.com/rongfengliang/5289951" target="_blank" rel="noopener">luarocks 简单使用&amp;openresty 离线集成说明 原创</a></p>
<p><a href="https://www.cnblogs.com/wangguishe/p/16165880.html" target="_blank" rel="noopener">ubuntu 20.04安装 Apache APISIX</a></p>
<p><a href="https://github.com/apache/apisix/issues/7098" target="_blank" rel="noopener">help request: please check the version of OpenResty and lua, OpenResty 1.19 + LuaJIT or OpenResty before 1.19 + Lua 5.1 is required for Apache APISIX</a></p>
<p><a href="https://cmjava.ltd:8090/archives/apisix%E9%85%8D%E7%BD%AE%E9%9C%80%E8%A6%81%E8%AF%81%E4%B9%A6%E7%9A%84etcd%E9%9B%86%E7%BE%A4" target="_blank" rel="noopener">apisix配置需要证书的etcd集群
</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2023/04/17/安装部署3节点Etcd高可用集群-3节点同一套证书-【APISIX用的etcd集群】/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/04/17/安装部署3节点Etcd高可用集群-3节点同一套证书-【APISIX用的etcd集群】/" itemprop="url">安装部署3节点Etcd高可用集群(3节点同一套证书)【APISIX用的etcd集群】</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-04-17T21:24:30+08:00">
                2023-04-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2023/04/17/安装部署3节点Etcd高可用集群-3节点同一套证书-【APISIX用的etcd集群】/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2023/04/17/安装部署3节点Etcd高可用集群-3节点同一套证书-【APISIX用的etcd集群】/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,268
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[toc]</p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1.80.91</td>
<td>s1</td>
</tr>
<tr>
<td>10.1.80.92</td>
<td>s2</td>
</tr>
<tr>
<td>10.1.80.93</td>
<td>s3</td>
</tr>
</tbody>
</table>
<h1 id="安装cfssl"><a href="#安装cfssl" class="headerlink" title="安装cfssl"></a>安装cfssl</h1><table>
<thead>
<tr>
<th>cfssl版本</th>
<th>可执行文件存放目录</th>
<th>证书存放目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.6.2</td>
<td>/usr/local/bin</td>
<td>/tmp/certs</td>
</tr>
</tbody>
</table>
<blockquote>
<p>下载地址<br><a href="https://github.com/cloudflare/cfssl/releases" target="_blank" rel="noopener">https://github.com/cloudflare/cfssl/releases</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.2/cfssl_1.6.2_linux_amd64 -o /tmp/cfssl</span><br><span class="line">chmod +x /tmp/cfssl</span><br><span class="line">mv /tmp/cfssl /usr/bin/cfssl</span><br><span class="line"></span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.2/cfssljson_1.6.2_linux_amd64 -o /tmp/cfssljson</span><br><span class="line">chmod +x /tmp/cfssljson</span><br><span class="line">mv /tmp/cfssljson /usr/bin/cfssljson</span><br></pre></td></tr></table></figure>
<p>打印默认证书配置<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cfssl print-defaults csr</span><br><span class="line">cfssl print-defaults config</span><br></pre></td></tr></table></figure></p>
<h1 id="生成CA根证书"><a href="#生成CA根证书" class="headerlink" title="生成CA根证书"></a>生成CA根证书</h1><h2 id="ca-config配置"><a href="#ca-config配置" class="headerlink" title="ca-config配置"></a>ca-config配置</h2><p>需要注意的是，etcd-ca-config.json里面server的配置一定要加上”client auth”，因为APISIX新建集群时候，会默认做一次节点间健康检查，此时并没有像etcdctl那样提供client的证书和私钥，所以节点会用server的证书和私钥来进行通信，此时server证书就互为服务端和客户端了。<br>并且apisix和etcd集群通信时，etcd由于grpc-gateway的原因，也会把server证书当成客户端证书来验证。</p>
<p>profiles(ca证书不同配置的作用)里面的内容就是CA可以用来发挥作用的功能，一共预置了三种配置，分别对应Server、Peer和Client的证书密钥。</p>
<p>signing即签名证书，key encipherment即加密，server auth即服务器认证，client auth即客户端认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/certs</span><br><span class="line"></span><br><span class="line">cat &gt; /tmp/certs/etcd-ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;876000h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;876000h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;876000h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                	&quot;signing&quot;,</span><br><span class="line">                	&quot;key encipherment&quot;,</span><br><span class="line">               	 	&quot;server auth&quot;,</span><br><span class="line">               	 	&quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="ca-csr配置"><a href="#ca-csr配置" class="headerlink" title="ca-csr配置"></a>ca-csr配置</h2><p>hosts里写所有etcd节点的ip，所有etcd节点的ip和对应的<strong>域名</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /tmp/certs/etcd-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "etcd-ca",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "127.0.0.1",</span><br><span class="line">        "localhost",</span><br><span class="line">        "10.1.80.91",</span><br><span class="line">        "10.1.80.92",</span><br><span class="line">        "10.1.80.93"</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "ecdsa",</span><br><span class="line">        "size": 256</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">          "L": "Hangzhou",</span><br><span class="line">          "ST": "Zhejiang",</span><br><span class="line">          "C": "CN"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="生成CA证书和CA证书的私钥"><a href="#生成CA证书和CA证书的私钥" class="headerlink" title="生成CA证书和CA证书的私钥"></a>生成CA证书和CA证书的私钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp/certs</span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca -</span><br></pre></td></tr></table></figure>
<p>会生成以下文件</p>
<ul>
<li>etcd-ca.csr </li>
<li>etcd-ca-key.pem  </li>
<li>etcd-ca.pem</li>
</ul>
<p>etcd-ca-key.pem为CA的私钥，请妥善保管<br>etcd-ca.csr文件为证书请求文件，可以删除</p>
<h1 id="生成Server和Peer证书"><a href="#生成Server和Peer证书" class="headerlink" title="生成Server和Peer证书"></a>生成Server和Peer证书</h1><h2 id="Server和Peer配置"><a href="#Server和Peer配置" class="headerlink" title="Server和Peer配置"></a>Server和Peer配置</h2><p>Server用来服务端客户端通信的，Peer用来节点间通信的，它们共用同一套配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/certs</span><br><span class="line"></span><br><span class="line">cat &gt; /tmp/certs/etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd",</span><br><span class="line">  "hosts": [</span><br><span class="line">    "127.0.0.1",</span><br><span class="line">    "localhost",</span><br><span class="line">    "10.1.80.91",</span><br><span class="line">    "10.1.80.92",</span><br><span class="line">    "10.1.80.93"</span><br><span class="line">  ],</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "ecdsa",</span><br><span class="line">    "size": 256</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "L": "Hangzhou",</span><br><span class="line">      "ST": "Zhejiang",</span><br><span class="line">      "C": "CN"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="生成Server和Peer证书-1"><a href="#生成Server和Peer证书-1" class="headerlink" title="生成Server和Peer证书"></a>生成Server和Peer证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=etcd-ca-config.json -profile=server etcd-csr.json | cfssljson -bare etcd-server</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=etcd-ca-config.json -profile=peer etcd-csr.json | cfssljson -bare etcd-peer</span><br></pre></td></tr></table></figure>
<p>生成以下文件</p>
<ul>
<li>etcd-server.csr</li>
<li>etcd-server-key.pem</li>
<li>etcd-server.pem</li>
<li>etcd-peer.csr</li>
<li>etcd-peer-key.pem</li>
<li>etcd-peer.pem</li>
</ul>
<h1 id="生成Client证书"><a href="#生成Client证书" class="headerlink" title="生成Client证书"></a>生成Client证书</h1><h2 id="Client配置"><a href="#Client配置" class="headerlink" title="Client配置"></a>Client配置</h2><p>客户端证书不需要hosts字段，只需要CN字段设置为client</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/certs</span><br><span class="line"></span><br><span class="line">cat &gt; /tmp/certs/etcd-client-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "etcd-client",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "ecdsa",</span><br><span class="line">    "size": 256</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="生成Client证书-1"><a href="#生成Client证书-1" class="headerlink" title="生成Client证书"></a>生成Client证书</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=etcd-ca.pem -ca-key=etcd-ca-key.pem -config=etcd-ca-config.json -profile=client etcd-client-csr.json  | cfssljson -bare etcd-client</span><br></pre></td></tr></table></figure>
<p>生成以下文件</p>
<ul>
<li>etcd-client.csr</li>
<li>etcd-client-key.pem</li>
<li>etcd-client.pem</li>
</ul>
<h1 id="创建3节点集群"><a href="#创建3节点集群" class="headerlink" title="创建3节点集群"></a>创建3节点集群</h1><h2 id="安装etcd"><a href="#安装etcd" class="headerlink" title="安装etcd"></a>安装etcd</h2><p>s91,s92,s93上安装etcd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ETCD_VER=v3.5.4</span><br><span class="line">ETCD_INSTALL_PATH=/opt/etcd3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> choose either URL</span><br><span class="line"><span class="meta">#</span> GOOGLE_URL=https://storage.googleapis.com/etcd</span><br><span class="line">GITHUB_URL=https://github.com/etcd-io/etcd/releases/download</span><br><span class="line">DOWNLOAD_URL=$&#123;GITHUB_URL&#125;</span><br><span class="line"></span><br><span class="line">mkdir -p $&#123;ETCD_INSTALL_PATH&#125;</span><br><span class="line">curl -L $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -o $&#123;ETCD_INSTALL_PATH&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzvf $&#123;ETCD_INSTALL_PATH&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -C /opt/etcd3 --strip-components=1</span><br><span class="line">rm -f $&#123;ETCD_INSTALL_PATH&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span>&#123;ETCD_INSTALL_PATH&#125;/etcd --version</span><br><span class="line"><span class="meta">$</span>&#123;ETCD_INSTALL_PATH&#125;/etcdctl version</span><br></pre></td></tr></table></figure>
<h2 id="创建证书存放目录"><a href="#创建证书存放目录" class="headerlink" title="创建证书存放目录"></a>创建证书存放目录</h2><p>每个节点创建证书存放目录<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/etcd3/ssl</span><br></pre></td></tr></table></figure></p>
<h2 id="将证书传到s91-s92-s93"><a href="#将证书传到s91-s92-s93" class="headerlink" title="将证书传到s91, s92, s93"></a>将证书传到s91, s92, s93</h2><p>方便起见，就把所有文件都传了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -r /tmp/certs/etcd-*.pem root@10.1.80.91:/opt/etcd3/ssl</span><br><span class="line">scp -r /tmp/certs/etcd-*.pem root@10.1.80.92:/opt/etcd3/ssl</span><br><span class="line">scp -r /tmp/certs/etcd-*.pem root@10.1.80.93:/opt/etcd3/ssl</span><br></pre></td></tr></table></figure></p>
<h2 id="frontend-运行etcd-不推荐"><a href="#frontend-运行etcd-不推荐" class="headerlink" title="frontend 运行etcd(不推荐)"></a>frontend 运行etcd(不推荐)</h2><h3 id="运行etcd的模板"><a href="#运行etcd的模板" class="headerlink" title="运行etcd的模板"></a>运行etcd的模板</h3><p>–initial-cluster-token etcd-cluster-tkn  “etcd-cluster-tkn”可以替换成你自己需要的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">./etcd -name etcd1 \</span><br><span class="line">  --data-dir /tmp/etcd/s1 \</span><br><span class="line">  --auto-tls \</span><br><span class="line">  --client-cert-auth \ # 要求客户端验证</span><br><span class="line">  --cert-file=/opt/etcd3/ssl/etcd-server.pem \ # 服务端证书</span><br><span class="line">  --key-file=/opt/etcd3/ssl/etcd-server-key.pem \ # 服务端私钥</span><br><span class="line">  --trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \ # 服务端CA根证书</span><br><span class="line">  --peer-auto-tls \</span><br><span class="line">  --peer-cert-file=/opt/etcd3/ssl/etcd-peer.pem \ # 节点通信证书</span><br><span class="line">  --peer-key-file=/opt/etcd3/ssl/etcd-peer-key.pem \ # 节点通信私钥</span><br><span class="line">  --peer-client-cert-auth \ # 要求节点通信验证</span><br><span class="line">  --peer-trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \ #节点通信CA根证书</span><br><span class="line">  --advertise-client-urls https://10.1.80.91:2379 \ # 所有url都变成https协议</span><br><span class="line">  --listen-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-tkn \</span><br><span class="line">  --initial-cluster "s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380" \</span><br><span class="line">  --initial-cluster-state new</span><br></pre></td></tr></table></figure>
<h3 id="分别在s91-s92-s93上运行etcd"><a href="#分别在s91-s92-s93上运行etcd" class="headerlink" title="分别在s91,s92,s93上运行etcd"></a>分别在s91,s92,s93上运行etcd</h3><ul>
<li><p>节点1</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> make sure etcd process has write access to this directory</span><br><span class="line"><span class="meta">#</span> remove this directory if the cluster is new; keep if restarting etcd</span><br><span class="line"><span class="meta">#</span> rm -rf /tmp/etcd</span><br><span class="line"></span><br><span class="line">./etcd -name s1 \</span><br><span class="line">  --data-dir /tmp/etcd-data \</span><br><span class="line">  --auto-tls \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --cert-file=/opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">  --key-file=/opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">  --trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --peer-auto-tls \</span><br><span class="line">  --peer-cert-file=/opt/etcd3/ssl/etcd-peer.pem \</span><br><span class="line">  --peer-key-file=/opt/etcd3/ssl/etcd-peer-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --advertise-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --listen-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-tkn \</span><br><span class="line">  --initial-cluster "s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380" \</span><br><span class="line">  --initial-cluster-state new</span><br></pre></td></tr></table></figure>
</li>
<li><p>节点2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> make sure etcd process has write access to this directory</span><br><span class="line"><span class="meta">#</span> remove this directory if the cluster is new; keep if restarting etcd</span><br><span class="line"><span class="meta">#</span> rm -rf /tmp/etcd</span><br><span class="line"></span><br><span class="line">./etcd -name s2 \</span><br><span class="line">  --data-dir /tmp/etcd-data \</span><br><span class="line">  --auto-tls \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --cert-file=/opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">  --key-file=/opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">  --trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --peer-auto-tls \</span><br><span class="line">  --peer-cert-file=/opt/etcd3/ssl/etcd-peer.pem \</span><br><span class="line">  --peer-key-file=/opt/etcd3/ssl/etcd-peer-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --advertise-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --listen-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-tkn \</span><br><span class="line">  --initial-cluster "s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380" \</span><br><span class="line">  --initial-cluster-state new</span><br></pre></td></tr></table></figure>
</li>
<li><p>节点3</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> make sure etcd process has write access to this directory</span><br><span class="line"><span class="meta">#</span> remove this directory if the cluster is new; keep if restarting etcd</span><br><span class="line"><span class="meta">#</span> rm -rf /tmp/etcd</span><br><span class="line"></span><br><span class="line">./etcd -name s3 \</span><br><span class="line">  --data-dir /tmp/etcd-data \</span><br><span class="line">  --auto-tls \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --cert-file=/opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">  --key-file=/opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">  --trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --peer-auto-tls \</span><br><span class="line">  --peer-cert-file=/opt/etcd3/ssl/etcd-peer.pem \</span><br><span class="line">  --peer-key-file=/opt/etcd3/ssl/etcd-peer-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --advertise-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --listen-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-tkn \</span><br><span class="line">  --initial-cluster "s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380" \</span><br><span class="line">  --initial-cluster-state new</span><br></pre></td></tr></table></figure>
<p>检查etcd集群状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 </span><br><span class="line">/opt/etcd3/etcdctl \</span><br><span class="line">  --endpoints 10.1.80.91:2379,10.1.80.92:2379,10.1.80.93:2379 \</span><br><span class="line">  --cacert /opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --cert  /opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">  --key  /opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">  endpoint health</span><br></pre></td></tr></table></figure>
<h2 id="systemd运行方式-强烈推荐"><a href="#systemd运行方式-强烈推荐" class="headerlink" title="systemd运行方式(强烈推荐)"></a>systemd运行方式(强烈推荐)</h2><p>如果之前通过frontend方式运行过apisix,记得要停掉之前的apisix进程。</p>
<p>证书先拷贝到/opt/etcd3/ssl目录<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> make sure etcd process has write access to this directory</span><br><span class="line"><span class="meta">#</span> remove this directory if the cluster is new; keep if restarting etcd</span><br><span class="line"><span class="meta">#</span> rm -rf /tmp/etcd/s1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to write service file for etcd</span><br></pre></td></tr></table></figure></p>
<h3 id="s1"><a href="#s1" class="headerlink" title="s1"></a>s1</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /tmp/s1.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">Documentation=https://github.com/coreos/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">Conflicts=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">LimitNOFILE=40000</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"></span><br><span class="line">ExecStart=/opt/etcd3/etcd -name s1 \</span><br><span class="line">  --data-dir /tmp/etcd-data \</span><br><span class="line">  --auto-tls \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --cert-file=/opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">  --key-file=/opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">  --trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --peer-auto-tls \</span><br><span class="line">  --peer-cert-file=/opt/etcd3/ssl/etcd-peer.pem \</span><br><span class="line">  --peer-key-file=/opt/etcd3/ssl/etcd-peer-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --advertise-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --listen-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-tkn \</span><br><span class="line">  --initial-cluster "s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380" \</span><br><span class="line">  --initial-cluster-state new</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo mv /tmp/s1.service /etc/systemd/system/s1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to start service</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable s1.service</span><br><span class="line">sudo systemctl start s1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> cat s1.service</span><br><span class="line">sudo systemctl cat s1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to get logs from service</span><br><span class="line">sudo systemctl status s1.service -l --no-pager</span><br><span class="line">sudo journalctl -u s1.service -l --no-pager|less</span><br><span class="line">sudo journalctl -f -u s1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to stop service</span><br><span class="line">sudo systemctl stop s1.service</span><br><span class="line">sudo systemctl disable s1.service</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> to start service</span><br></pre></td></tr></table></figure>
<h3 id="s2"><a href="#s2" class="headerlink" title="s2"></a>s2</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /tmp/s2.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">Documentation=https://github.com/coreos/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">Conflicts=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">LimitNOFILE=40000</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"></span><br><span class="line">ExecStart=/opt/etcd3/etcd -name s2 \</span><br><span class="line">  --data-dir /tmp/etcd-data \</span><br><span class="line">  --auto-tls \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --cert-file=/opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">  --key-file=/opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">  --trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --peer-auto-tls \</span><br><span class="line">  --peer-cert-file=/opt/etcd3/ssl/etcd-peer.pem \</span><br><span class="line">  --peer-key-file=/opt/etcd3/ssl/etcd-peer-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --advertise-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --listen-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-tkn \</span><br><span class="line">  --initial-cluster "s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380" \</span><br><span class="line">  --initial-cluster-state new</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo mv /tmp/s2.service /etc/systemd/system/s2.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to start service</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable s2.service</span><br><span class="line">sudo systemctl start s2.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> cat s2.service</span><br><span class="line">sudo systemctl cat s2.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to get logs from service</span><br><span class="line">sudo systemctl status s2.service -l --no-pager</span><br><span class="line">sudo journalctl -u s2.service -l --no-pager|less</span><br><span class="line">sudo journalctl -f -u s2.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to stop service</span><br><span class="line">sudo systemctl stop s2.service</span><br><span class="line">sudo systemctl disable s2.service</span><br></pre></td></tr></table></figure>
<h3 id="s3"><a href="#s3" class="headerlink" title="s3"></a>s3</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /tmp/s3.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">Documentation=https://github.com/coreos/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">Conflicts=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">LimitNOFILE=40000</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"></span><br><span class="line">ExecStart=/opt/etcd3/etcd -name s3 \</span><br><span class="line">  --data-dir /tmp/etcd-data \</span><br><span class="line">  --auto-tls \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --cert-file=/opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">  --key-file=/opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">  --trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --peer-auto-tls \</span><br><span class="line">  --peer-cert-file=/opt/etcd3/ssl/etcd-peer.pem \</span><br><span class="line">  --peer-key-file=/opt/etcd3/ssl/etcd-peer-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file=/opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">  --advertise-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --listen-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-tkn \</span><br><span class="line">  --initial-cluster "s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380" \</span><br><span class="line">  --initial-cluster-state new</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo mv /tmp/s3.service /etc/systemd/system/s3.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to start service</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable s3.service</span><br><span class="line">sudo systemctl start s3.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> cat s3.service</span><br><span class="line">sudo systemctl cat s3.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to get logs from service</span><br><span class="line">sudo systemctl status s3.service -l --no-pager</span><br><span class="line">sudo journalctl -u s3.service -l --no-pager|less</span><br><span class="line">sudo journalctl -f -u s3.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> to stop service</span><br><span class="line">sudo systemctl stop s3.service</span><br><span class="line">sudo systemctl disable s3.service</span><br></pre></td></tr></table></figure>
<p>Check status:</p>
<p>etcdctl检查<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 </span><br><span class="line">/opt/etcd3/etcdctl \</span><br><span class="line">--cacert /opt/etcd3/ssl/etcd-ca.pem \</span><br><span class="line">--cert /opt/etcd3/ssl/etcd-server.pem \</span><br><span class="line">--key /opt/etcd3/ssl/etcd-server-key.pem \</span><br><span class="line">--endpoints 10.1.80.91:2379,10.1.80.92:2379,10.1.80.93:2379 \</span><br><span class="line">endpoint health</span><br></pre></td></tr></table></figure></p>
<p>curl检查<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> curl查看健康状态</span><br><span class="line">curl --cacert /opt/etcd3/ssl/etcd-ca.pem --cert /opt/etcd3/ssl/etcd-server.pem --key /opt/etcd3/ssl/etcd-server-key.pem  https://10.1.80.91:2379/health</span><br></pre></td></tr></table></figure></p>
<p>注意切换到指定用户</p>
<p>若结果如下，表示集群状态正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.1.80.93:2379 is healthy: successfully committed proposal: took = 6.506639ms</span><br><span class="line">10.1.80.91:2379 is healthy: successfully committed proposal: took = 6.427877ms</span><br><span class="line">10.1.80.92:2379 is healthy: successfully committed proposal: took = 7.161322ms</span><br></pre></td></tr></table></figure></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://play.etcd.io/install" target="_blank" rel="noopener">etcd Labs</a></p>
<p><a href="https://www.cnblogs.com/LiuChang-blog/p/15916998.html" target="_blank" rel="noopener">cfssl ca证书有效期修改</a></p>
<p><a href="https://cmjava.ltd:8090/archives/apisix%E9%85%8D%E7%BD%AE%E9%9C%80%E8%A6%81%E8%AF%81%E4%B9%A6%E7%9A%84etcd%E9%9B%86%E7%BE%A4" target="_blank" rel="noopener">apisix配置需要证书的etcd集群
</a></p>
<p><a href="https://cmjava.ltd:8090/archives/%E4%B8%BAetcd%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E8%AF%81%E4%B9%A6" target="_blank" rel="noopener">为etcd集群配置证书</a></p>
<p><a href="https://blog.csdn.net/xiaozhiit/article/details/108304488" target="_blank" rel="noopener">ETCD集群搭建和TLS证书访问
</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2022/10/10/安装部署3节点Etcd高可用集群-3节点同一套证书/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/10/10/安装部署3节点Etcd高可用集群-3节点同一套证书/" itemprop="url">安装部署3节点Etcd高可用集群(3节点同一套证书)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-10-10T22:19:46+08:00">
                2022-10-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/10/10/安装部署3节点Etcd高可用集群-3节点同一套证书/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/10/10/安装部署3节点Etcd高可用集群-3节点同一套证书/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,580
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1.80.91</td>
<td>s1</td>
</tr>
<tr>
<td>10.1.80.92</td>
<td>s2</td>
</tr>
<tr>
<td>10.1.80.93</td>
<td>s3</td>
</tr>
</tbody>
</table>
<h1 id="安装cfssl"><a href="#安装cfssl" class="headerlink" title="安装cfssl"></a>安装cfssl</h1><table>
<thead>
<tr>
<th>cfssl版本</th>
<th>可执行文件存放目录</th>
<th>证书存放目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.6.2</td>
<td>/usr/local/bin</td>
<td>/tmp/certs</td>
</tr>
</tbody>
</table>
<blockquote>
<p>下载地址<br><a href="https://github.com/cloudflare/cfssl/releases" target="_blank" rel="noopener">https://github.com/cloudflare/cfssl/releases</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.2/cfssl_1.6.2_linux_amd64 -o /tmp/cfssl</span><br><span class="line">chmod +x /tmp/cfssl</span><br><span class="line">mv /tmp/cfssl /usr/bin/cfssl</span><br><span class="line"></span><br><span class="line">curl -L https://github.com/cloudflare/cfssl/releases/download/v1.6.2/cfssljson_1.6.2_linux_amd64 -o /tmp/cfssljson</span><br><span class="line">chmod +x /tmp/cfssljson</span><br><span class="line">mv /tmp/cfssljson /usr/bin/cfssljson</span><br></pre></td></tr></table></figure>
<h1 id="生成自签名CA证书"><a href="#生成自签名CA证书" class="headerlink" title="生成自签名CA证书"></a>生成自签名CA证书</h1><blockquote>
<p>可通过<a href="http://play.etcd.io/install生成配置" target="_blank" rel="noopener">http://play.etcd.io/install生成配置</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/certs</span><br><span class="line"></span><br><span class="line">cat &gt; /tmp/certs/root-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;O&quot;: &quot;Meeleet&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Meeleet Security&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Hangzhou&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Zhejiang&quot;,</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;CN&quot;: &quot;root-ca&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cfssl gencert --initca=true /tmp/certs/root-ca-csr.json | cfssljson --bare /tmp/certs/root-ca</span><br><span class="line"></span><br><span class="line"># verify</span><br><span class="line">openssl x509 -in /tmp/certs/root-ca.pem -text -noout</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># cert-generation configuration</span><br><span class="line">cat &gt; /tmp/certs/gencert.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">          &quot;signing&quot;,</span><br><span class="line">          &quot;key encipherment&quot;,</span><br><span class="line">          &quot;server auth&quot;,</span><br><span class="line">          &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>结果<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> CSR configuration</span></span><br><span class="line">/tmp/certs/root-ca-csr.json</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> CSR</span></span><br><span class="line">/tmp/certs/root-ca.csr</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> self-signed root CA public key</span></span><br><span class="line">/tmp/certs/root-ca.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> self-signed root CA private key</span></span><br><span class="line">/tmp/certs/root-ca-key.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cert-generation configuration <span class="keyword">for</span> other TLS assets</span></span><br><span class="line">/tmp/certs/gencert.json</span><br></pre></td></tr></table></figure></p>
<h1 id="生成本地颁发的带有私钥的证书"><a href="#生成本地颁发的带有私钥的证书" class="headerlink" title="生成本地颁发的带有私钥的证书"></a>生成本地颁发的带有私钥的证书</h1><h2 id="证书相关操作"><a href="#证书相关操作" class="headerlink" title="证书相关操作"></a>证书相关操作</h2><p>由于3个节点用同一套证书，所以只需生成一套即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/certs</span><br><span class="line"></span><br><span class="line">cat &gt; /tmp/certs/etcd-ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "O": "Meeleet",</span><br><span class="line">      "OU": "Meeleet Security",</span><br><span class="line">      "L": "Hangzhou",</span><br><span class="line">      "ST": "Zhejiang",</span><br><span class="line">      "C": "CN"</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  "CN": "etcd",</span><br><span class="line">  "hosts": [</span><br><span class="line">    "127.0.0.1",</span><br><span class="line">    "localhost",</span><br><span class="line">    "10.1.80.91",</span><br><span class="line">    "10.1.80.92",</span><br><span class="line">    "10.1.80.93"</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cfssl gencert \</span><br><span class="line">  --ca /tmp/certs/root-ca.pem \</span><br><span class="line">  --ca-key /tmp/certs/root-ca-key.pem \</span><br><span class="line">  --config /tmp/certs/gencert.json \</span><br><span class="line">  /tmp/certs/etcd-ca-csr.json | cfssljson --bare /tmp/certs/etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> verify</span></span><br><span class="line">openssl x509 -in /tmp/certs/etcd.pem -text -noout</span><br></pre></td></tr></table></figure>
<p>结果<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--  1 root root  323 Sep 30 05:28 etcd-ca-csr.json</span><br><span class="line">-rw-r--r--  1 root root 1098 Sep 30 05:28 etcd.csr</span><br><span class="line">-rw-------  1 root root 1679 Sep 30 05:28 etcd-key.pem</span><br><span class="line">-rw-r--r--  1 root root 1493 Sep 30 05:28 etcd.pem</span><br><span class="line">-rw-r--r--  1 root root  205 Sep 30 05:25 gencert.json</span><br><span class="line">-rw-r--r--  1 root root 1017 Sep 30 05:25 root-ca.csr</span><br><span class="line">-rw-r--r--  1 root root  221 Sep 30 05:25 root-ca-csr.json</span><br><span class="line">-rw-------  1 root root 1679 Sep 30 05:25 root-ca-key.pem</span><br><span class="line">-rw-r--r--  1 root root 1346 Sep 30 05:25 root-ca.pem</span><br></pre></td></tr></table></figure></p>
<p>将证书传到s91, s92, s93,方便起见，就把所有文件都传了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp -r /tmp/certs/ root@10.1.80.91:/root/</span><br><span class="line">scp -r /tmp/certs/ root@10.1.80.92:/root/</span><br><span class="line">scp -r /tmp/certs/ root@10.1.80.93:/root/</span><br></pre></td></tr></table></figure></p>
<p>这里请更改成您自己所用的系统用户名</p>
<h1 id="安装etcd"><a href="#安装etcd" class="headerlink" title="安装etcd"></a>安装etcd</h1><p>s91,s92,s93上安装etcd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ETCD_VER=v3.4.21</span><br><span class="line">ETCD_INSTALL_PATH=/opt/etcd3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> choose either URL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> GOOGLE_URL=https://storage.googleapis.com/etcd</span></span><br><span class="line">GITHUB_URL=https://github.com/etcd-io/etcd/releases/download</span><br><span class="line">DOWNLOAD_URL=$&#123;GITHUB_URL&#125;</span><br><span class="line"></span><br><span class="line">mkdir -p $&#123;ETCD_INSTALL_PATH&#125;</span><br><span class="line">curl -L $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -o $&#123;ETCD_INSTALL_PATH&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzvf $&#123;ETCD_INSTALL_PATH&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -C /opt/etcd3 --strip-components=1</span><br><span class="line">rm -f $&#123;ETCD_INSTALL_PATH&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;ETCD_INSTALL_PATH&#125;/etcd --version</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;ETCD_INSTALL_PATH&#125;/etcdctl version</span></span><br></pre></td></tr></table></figure>
<h1 id="frontend-运行etcd-不推荐，只用于测试功能用"><a href="#frontend-运行etcd-不推荐，只用于测试功能用" class="headerlink" title="frontend 运行etcd(不推荐，只用于测试功能用)"></a>frontend 运行etcd(不推荐，只用于测试功能用)</h1><p>分别在s91,s92,s93上运行etcd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> make sure etcd process has write access to this directory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove this directory <span class="keyword">if</span> the cluster is new; keep <span class="keyword">if</span> restarting etcd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf /tmp/etcd</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/opt/etcd3/etcd --name s1 \</span><br><span class="line">  --data-dir /tmp/etcd/s1 \</span><br><span class="line">  --listen-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --advertise-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-cluster s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token tkn \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key-file $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --peer-cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --peer-key-file $&#123;HOME&#125;/certs/etcd-key.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd3/etcd --name s2 \</span><br><span class="line">  --data-dir /tmp/etcd/s2 \</span><br><span class="line">  --listen-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --advertise-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-cluster s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token tkn \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key-file $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --peer-cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --peer-key-file $&#123;HOME&#125;/certs/etcd-key.pem</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd3/etcd --name s3 \</span><br><span class="line">  --data-dir /tmp/etcd/s3 \</span><br><span class="line">  --listen-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --advertise-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token tkn \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key-file $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --peer-cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --peer-key-file $&#123;HOME&#125;/certs/etcd-key.pem</span><br></pre></td></tr></table></figure>
<p>–initial-cluster-token tkn  “tkn”可以替换成你自己需要的值</p>
<p>检查etcd集群状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 /opt/etcd3/etcdctl \</span><br><span class="line">  --endpoints 10.1.80.91:2379,10.1.80.92:2379,10.1.80.93:2379 \</span><br><span class="line">  --cacert $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  endpoint health</span><br></pre></td></tr></table></figure>
<h1 id="systemd运行方式-推荐"><a href="#systemd运行方式-推荐" class="headerlink" title="systemd运行方式(推荐)"></a>systemd运行方式(推荐)</h1><h2 id="s1"><a href="#s1" class="headerlink" title="s1"></a>s1</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> after transferring certs to remote machines</span></span><br><span class="line">mkdir -p $&#123;HOME&#125;/certs</span><br><span class="line">cp /tmp/certs/* $&#123;HOME&#125;/certs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> make sure etcd process has write access to this directory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove this directory <span class="keyword">if</span> the cluster is new; keep <span class="keyword">if</span> restarting etcd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf /tmp/etcd/s1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to write service file <span class="keyword">for</span> etcd</span></span><br><span class="line">cat &gt; /tmp/s1.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">Documentation=https://github.com/coreos/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">Conflicts=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">LimitNOFILE=40000</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"></span><br><span class="line">ExecStart=/opt/etcd3/etcd --name s1 \</span><br><span class="line">  --data-dir /tmp/etcd/s1 \</span><br><span class="line">  --listen-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --advertise-client-urls https://10.1.80.91:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.91:2380 \</span><br><span class="line">  --initial-cluster s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token tkn \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key-file $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --peer-cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --peer-key-file $&#123;HOME&#125;/certs/etcd-key.pem</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">sudo mv /tmp/s1.service /etc/systemd/system/s1.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to start service</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable s1.service</span><br><span class="line">sudo systemctl start s1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat s1.service</span></span><br><span class="line">sudo systemctl cat s1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to get logs from service</span></span><br><span class="line">sudo systemctl status s1.service -l --no-pager</span><br><span class="line">sudo journalctl -u s1.service -l --no-pager|less</span><br><span class="line">sudo journalctl -f -u s1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to stop service</span></span><br><span class="line">sudo systemctl stop s1.service</span><br><span class="line">sudo systemctl disable s1.service</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> to start service</span></span><br></pre></td></tr></table></figure>
<h2 id="s2"><a href="#s2" class="headerlink" title="s2"></a>s2</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> after transferring certs to remote machines</span></span><br><span class="line">mkdir -p $&#123;HOME&#125;/certs</span><br><span class="line">cp /tmp/certs/* $&#123;HOME&#125;/certs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> make sure etcd process has write access to this directory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove this directory <span class="keyword">if</span> the cluster is new; keep <span class="keyword">if</span> restarting etcd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf /tmp/etcd/s2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to write service file <span class="keyword">for</span> etcd</span></span><br><span class="line">cat &gt; /tmp/s2.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">Documentation=https://github.com/coreos/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">Conflicts=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">LimitNOFILE=40000</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"></span><br><span class="line">ExecStart=/opt/etcd3/etcd --name s2 \</span><br><span class="line">  --data-dir /tmp/etcd/s2 \</span><br><span class="line">  --listen-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --advertise-client-urls https://10.1.80.92:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.92:2380 \</span><br><span class="line">  --initial-cluster s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token tkn \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key-file $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --peer-cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --peer-key-file $&#123;HOME&#125;/certs/etcd-key.pem</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">sudo mv /tmp/s2.service /etc/systemd/system/s2.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to start service</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable s2.service</span><br><span class="line">sudo systemctl start s2.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat s2.service</span></span><br><span class="line">sudo systemctl cat s2.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to get logs from service</span></span><br><span class="line">sudo systemctl status s2.service -l --no-pager</span><br><span class="line">sudo journalctl -u s2.service -l --no-pager|less</span><br><span class="line">sudo journalctl -f -u s2.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to stop service</span></span><br><span class="line">sudo systemctl stop s2.service</span><br><span class="line">sudo systemctl disable s2.service</span><br></pre></td></tr></table></figure>
<h2 id="s3"><a href="#s3" class="headerlink" title="s3"></a>s3</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> after transferring certs to remote machines</span></span><br><span class="line">mkdir -p $&#123;HOME&#125;/certs</span><br><span class="line">cp /tmp/certs/* $&#123;HOME&#125;/certs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> make sure etcd process has write access to this directory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> remove this directory <span class="keyword">if</span> the cluster is new; keep <span class="keyword">if</span> restarting etcd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf /tmp/etcd/s3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to write service file <span class="keyword">for</span> etcd</span></span><br><span class="line">cat &gt; /tmp/s3.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd</span><br><span class="line">Documentation=https://github.com/coreos/etcd</span><br><span class="line">Conflicts=etcd.service</span><br><span class="line">Conflicts=etcd2.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">LimitNOFILE=40000</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"></span><br><span class="line">ExecStart=/opt/etcd3/etcd --name s3 \</span><br><span class="line">  --data-dir /tmp/etcd/s3 \</span><br><span class="line">  --listen-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --advertise-client-urls https://10.1.80.93:2379 \</span><br><span class="line">  --listen-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-advertise-peer-urls https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster s1=https://10.1.80.91:2380,s2=https://10.1.80.92:2380,s3=https://10.1.80.93:2380 \</span><br><span class="line">  --initial-cluster-token tkn \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --client-cert-auth \</span><br><span class="line">  --trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key-file $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --peer-trusted-ca-file $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --peer-cert-file $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --peer-key-file $&#123;HOME&#125;/certs/etcd-key.pem</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">sudo mv /tmp/s3.service /etc/systemd/system/s3.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to start service</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable s3.service</span><br><span class="line">sudo systemctl start s3.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat s3.service</span></span><br><span class="line">sudo systemctl cat s3.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to get logs from service</span></span><br><span class="line">sudo systemctl status s3.service -l --no-pager</span><br><span class="line">sudo journalctl -u s3.service -l --no-pager|less</span><br><span class="line">sudo journalctl -f -u s3.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to stop service</span></span><br><span class="line">sudo systemctl stop s3.service</span><br><span class="line">sudo systemctl disable s3.service</span><br></pre></td></tr></table></figure>
<p>Check status:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 /opt/etcd3/etcdctl \</span><br><span class="line">  --endpoints 10.1.80.91:2379,10.1.80.92:2379,10.1.80.93:2379 \</span><br><span class="line">  --cacert $&#123;HOME&#125;/certs/root-ca.pem \</span><br><span class="line">  --cert $&#123;HOME&#125;/certs/etcd.pem \</span><br><span class="line">  --key $&#123;HOME&#125;/certs/etcd-key.pem \</span><br><span class="line">  endpoint health</span><br></pre></td></tr></table></figure>
<p>注意切换到指定用户</p>
<p>若结果如下，表示集群状态正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.1.80.92:2379 is healthy: successfully committed proposal: took = 9.184858ms</span><br><span class="line">10.1.80.93:2379 is healthy: successfully committed proposal: took = 8.681243ms</span><br><span class="line">10.1.80.91:2379 is healthy: successfully committed proposal: took = 11.855811ms</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://play.etcd.io/install" target="_blank" rel="noopener">etcd Labs</a></p>
<p><a href="https://www.cnblogs.com/LiuChang-blog/p/15916998.html" target="_blank" rel="noopener">cfssl ca证书有效期修改</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2022/10/10/ubuntu20.04-bind9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/10/10/ubuntu20.04-bind9/" itemprop="url">Ubuntu 20.04上配置BIND作为私有网络DNS服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-10-10T20:03:42+08:00">
                2022-10-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/10/10/ubuntu20.04-bind9/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/10/10/ubuntu20.04-bind9/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,394
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="准备及说明"><a href="#准备及说明" class="headerlink" title="准备及说明"></a>准备及说明</h1><p>假设某公司有多个数据中心，数据中心1以内部使用idc1.meeleet.com,数据中心2使用idc2.meeleet.com,数据中心3使用idc3.meeleet.com。我们这里以数据中心3内部需要搭建私网DNS服务器为例来讲，idc3.meeleet.com(具体实施过程中，按读者实际情况进行修改)</p>
<ul>
<li>DNS服务器</li>
</ul>
<table>
<thead>
<tr>
<th>私网IP地址</th>
<th>简称</th>
<th>是否为主DNS服务器</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1.80.220</td>
<td>ns1</td>
<td>是(主DNS服务器)</td>
</tr>
<tr>
<td>10.1.80.221</td>
<td>ns2</td>
<td>否(备DNS服务器)</td>
</tr>
</tbody>
</table>
<ul>
<li>DNS客户端</li>
</ul>
<table>
<thead>
<tr>
<th>私网IP地址</th>
<th>简称</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.1.80.91</td>
<td>s91</td>
<td></td>
</tr>
<tr>
<td>10.1.80.92</td>
<td>s92</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="步骤1-在DNS服务器上安装Bind"><a href="#步骤1-在DNS服务器上安装Bind" class="headerlink" title="步骤1 在DNS服务器上安装Bind"></a>步骤1 在DNS服务器上安装Bind</h1><p>在主DNS服务器及备DNS服务器上安装BIND</p>
<p><strong>ON ns1 ns2</strong> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install bind9 bind9utils bind9-doc</span><br></pre></td></tr></table></figure>
<p>修改启动参数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/default/named</span><br></pre></td></tr></table></figure></p>
<p>OPTIONS参数最后添加-4,使用Ipv4模式<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> run resolvconf?</span></span><br><span class="line">RESOLVCONF=no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> startup options <span class="keyword">for</span> the server</span></span><br><span class="line">OPTIONS="-u bind -4"</span><br></pre></td></tr></table></figure></p>
<p>重启bind</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart bind9</span><br></pre></td></tr></table></figure>
<h1 id="步骤2-配置主DNS服务器"><a href="#步骤2-配置主DNS服务器" class="headerlink" title="步骤2 配置主DNS服务器"></a>步骤2 配置主DNS服务器</h1><p><strong>on ns1</strong> </p>
<h2 id="配置Options文件"><a href="#配置Options文件" class="headerlink" title="配置Options文件"></a>配置Options文件</h2><p>打开named.conf.options并修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/bind/named.conf.options</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">acl "trusted" &#123;</span><br><span class="line">  10.1.80.220;    # ns1</span><br><span class="line">  10.1.80.221;    # ns2</span><br><span class="line">  10.1.80.0/24;   # trusted DNS clients network</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        directory "/var/cache/bind";</span><br><span class="line"></span><br><span class="line">        recursion yes;                 # enables recursive queries</span><br><span class="line">        allow-recursion &#123; trusted; &#125;;  # allows recursive queries from "trusted" clients</span><br><span class="line">        allow-query &#123; trusted; &#125;;      # allows queries from "trusted" clients</span><br><span class="line">        listen-on &#123; 10.1.80.220; &#125;;    # ns1 private IP address - listen on private network only</span><br><span class="line">        allow-transfer &#123; none; &#125;;      # disable zone transfers by default</span><br><span class="line"></span><br><span class="line">        forwarders &#123;</span><br><span class="line">          223.5.5.5;</span><br><span class="line">          223.6.6.6;</span><br><span class="line">          114.114.114.114;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        dnssec-validation auto;</span><br><span class="line"></span><br><span class="line">        listen-on-v6 &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意<em>forwards</em>配置块，有三个ip地址，其中223.5.5.5,223.6.6.6是阿里云公共DNS，114.114.114.114是电信提供公共的DNS。forwards可以为无法直接连接到外网的机器提供域名解析服务。</p>
<p>完成之后，保存并关闭named.conf.options文件。上面的配置指定只有您自己的服务器(受信任”trusted”的服务器)能够查询您的DNS服务器的外部域。</p>
<h2 id="配置named-conf-local"><a href="#配置named-conf-local" class="headerlink" title="配置named.conf.local"></a>配置named.conf.local</h2><p><strong>on ns1</strong> </p>
<p>打开named.conf.local，用vi来编辑</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/bind/named.conf.local</span><br></pre></td></tr></table></figure>
<p>正向、反向解析，指定配置文件路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">zone "idc3.meeleet.com" &#123;</span><br><span class="line">    type primary;</span><br><span class="line">    file "/etc/bind/zones/db.idc3.meeleet.com"; # zone file path</span><br><span class="line">    allow-transfer &#123; 10.1.80.221; &#125;;            # ns2 private IP address - secondary</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone "80.1.10.in-addr.arpa" &#123;</span><br><span class="line">    type primary;</span><br><span class="line">    file "/etc/bind/zones/db.10.1.80"; # 10.1.80.0/24 subnet</span><br><span class="line">    allow-transfer &#123; 10.1.80.221; &#125;;   # ns2 private IP address - secondary</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="创建正向zone文件"><a href="#创建正向zone文件" class="headerlink" title="创建正向zone文件"></a>创建正向zone文件</h2><p><strong>on ns1</strong></p>
<p>创建转发区域文件存放目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/bind/zones</span><br></pre></td></tr></table></figure>
<p>复制db.local并修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/bind/db.local /etc/bind/zones/db.idc3.meeleet.com</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">;</span><br><span class="line">; BIND data file for local loopback interface</span><br><span class="line">;</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL    604800</span></span><br><span class="line">@       IN      SOA     localhost. root.localhost. (</span><br><span class="line">                              2         ; Serial</span><br><span class="line">                         604800         ; Refresh</span><br><span class="line">                          86400         ; Retry</span><br><span class="line">                        2419200         ; Expire</span><br><span class="line">                         604800 )       ; Negative Cache TTL</span><br><span class="line">;</span><br><span class="line">@       IN      NS      localhost. ; delete this line</span><br><span class="line">@       IN      A       127.0.0.1  ; delete this line</span><br><span class="line">@       IN      AAAA    ::1        ; delete this line</span><br></pre></td></tr></table></figure>
<p>将<em>localhost</em>替换为<em>idc3.meeleet.com</em>,删除含<em>delete this line</em>标记的行</p>
<p>文件最后添加上DNS服务器NS记录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">; name servers - NS records</span><br><span class="line">    IN      NS      ns1.idc3.meeleet.com.</span><br><span class="line">    IN      NS      ns2.idc3.meeleet.com.</span><br></pre></td></tr></table></figure>
<p>给这个域内的主机添加A记录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">; name servers - A records</span><br><span class="line">ns1.idc3.meeleet.com.          IN      A       10.1.80.220</span><br><span class="line">ns2.idc3.meeleet.com.          IN      A       10.1.80.221</span><br><span class="line"></span><br><span class="line">; 10.1.80.0/24 - A records</span><br><span class="line">s91.idc3.meeleet.com.          IN      A       10.1.80.91</span><br><span class="line">s92.idc3.meeleet.com.          IN      A       10.1.80.92</span><br></pre></td></tr></table></figure>
<p>每次编辑区域文件时，需要在重新启动命名进程之前增加<strong>Serial</strong>值。在这里，将其增加为3,注意增加<strong>Serial</strong>值非常重要！非常重要！非常重要！最终zone配置文件内容如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">; BIND data file for local loopback interface</span><br><span class="line">;</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL    604800</span></span><br><span class="line">@       IN      SOA     idc3.meeleet.com. root.idc3.meeleet.com. (</span><br><span class="line">                              3         ; Serial</span><br><span class="line">                         604800         ; Refresh</span><br><span class="line">                          86400         ; Retry</span><br><span class="line">                        2419200         ; Expire</span><br><span class="line">                         604800 )       ; Negative Cache TTL</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">; name servers - NS records</span><br><span class="line">    IN      NS      ns1.idc3.meeleet.com.</span><br><span class="line">    IN      NS      ns2.idc3.meeleet.com.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; name servers - A records</span><br><span class="line">ns1.idc3.meeleet.com.          IN      A       10.1.80.220</span><br><span class="line">ns2.idc3.meeleet.com.          IN      A       10.1.80.221</span><br><span class="line"></span><br><span class="line">; 10.1.80.0/24 - A records</span><br><span class="line">s91.idc3.meeleet.com.          IN      A       10.1.80.91</span><br><span class="line">s92.idc3.meeleet.com.          IN      A       10.1.80.92</span><br></pre></td></tr></table></figure></p>
<p>保存/etc/bind/zones/db.idc3.meeleet.com</p>
<h2 id="创建反向zone文件"><a href="#创建反向zone文件" class="headerlink" title="创建反向zone文件"></a>创建反向zone文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/bind/db.127 /etc/bind/zones/db.10.1.80</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">TTL    604800</span></span><br><span class="line">@       IN      SOA     localhost. root.localhost. (</span><br><span class="line">                              1         ; Serial</span><br><span class="line">                         604800         ; Refresh</span><br><span class="line">                          86400         ; Retry</span><br><span class="line">                        2419200         ; Expire</span><br><span class="line">                         604800 )       ; Negative Cache TTL</span><br><span class="line">;</span><br><span class="line">@       IN      NS      localhost.      ; delete this line</span><br><span class="line">1.0.0   IN      PTR     localhost.      ; delete this line</span><br></pre></td></tr></table></figure>
<p>删除含<em>delete this line</em>标记的行</p>
<p>最终<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">TTL    604800</span></span><br><span class="line">@       IN      SOA     ns1.idc3.meeleet.com. root.idc3.meeleet.com. (</span><br><span class="line">                              3         ; Serial</span><br><span class="line">                         604800         ; Refresh</span><br><span class="line">                          86400         ; Retry</span><br><span class="line">                        2419200         ; Expire</span><br><span class="line">                         604800 )       ; Negative Cache TTL</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">; name servers - NS records</span><br><span class="line">      IN      NS      ns1.idc3.meeleet.com.</span><br><span class="line">      IN      NS      ns2.idc3.meeleet.com.</span><br><span class="line"></span><br><span class="line">; PTR Records</span><br><span class="line">220   IN      PTR     ns1.idc3.meeleet.com.    ; 10.1.80.220</span><br><span class="line">221   IN      PTR     ns2.idc3.meeleet.com.    ; 10.1.80.221</span><br><span class="line">91    IN      PTR     s91.idc3.meeleet.com.    ; 10.1.80.91</span><br><span class="line">92    IN      PTR     s92.idc3.meeleet.com.    ; 10.1.80.92</span><br></pre></td></tr></table></figure></p>
<h2 id="检查配置文件是否正确"><a href="#检查配置文件是否正确" class="headerlink" title="检查配置文件是否正确"></a>检查配置文件是否正确</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo named-checkzone idc3.meeleet.com /etc/bind/zones/db.idc3.meeleet.com</span><br><span class="line"></span><br><span class="line">zone idc3.meeleet.com/IN: loaded serial 2</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo named-checkzone 80.1.10.in-addr.arpa /etc/bind/zones/db.10.1.80</span><br><span class="line">zone 80.1.10.in-addr.arpa/IN: loaded serial 2</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>检查没问题，可以重启bind9</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart bind9</span><br></pre></td></tr></table></figure>
<p>如果有使用ufw,则需要让ufw允许bind9(如果有启用ufw的话)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow Bind9</span><br></pre></td></tr></table></figure>
<h1 id="步骤3-配置备DNS服务器"><a href="#步骤3-配置备DNS服务器" class="headerlink" title="步骤3 配置备DNS服务器"></a>步骤3 配置备DNS服务器</h1><p>多数情况下搞一套主备DNS服务器还是很有必要的，这样的话当主备DNS服务器不可用时，备DNS服务器也可以接受DNS查询请求并作出响应。幸运的是，配置一个备DNS服务器比配置主DNS服务器简单多了。</p>
<p><strong>on ns2</strong></p>
<p>编辑named.conf.options文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/bind/named.conf.options</span><br></pre></td></tr></table></figure>
<p>在文件的顶部，添加包含所有受信任服务器的私有IP地址的ACL。(也支持添加单独的ip,这里我为了方便，直接用网段来表示，这样就不用一个个IP写出来了)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">acl "trusted" &#123;</span><br><span class="line">  10.1.80.220;    # ns1</span><br><span class="line">  10.1.80.221;    # ns2</span><br><span class="line">  10.1.80.0/24;   # trusted DNS clients network</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line"></span><br><span class="line">        . . .</span><br></pre></td></tr></table></figure>
<p>directory指令下方，添加如下行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">. . .</span><br><span class="line"></span><br><span class="line">     recursion yes;                     # enables recursive queries</span><br><span class="line">     allow-recursion &#123; trusted; &#125;;      # allows recursive queries from "trusted" clients</span><br><span class="line">     allow-query &#123; trusted; &#125;;          # allows queries from "trusted" clients</span><br><span class="line">     listen-on &#123; 10.1.80.221; &#125;;        # ns2 private IP address</span><br><span class="line">     allow-transfer &#123; none; &#125;;          # disable zone transfers by default</span><br><span class="line"></span><br><span class="line">     forwarders &#123;</span><br><span class="line">             223.5.5.5;</span><br><span class="line">             223.6.6.6;</span><br><span class="line">             114.114.114.114;</span><br><span class="line">     &#125;;</span><br><span class="line"></span><br><span class="line"> . . .</span><br></pre></td></tr></table></figure>
<p>保存并关闭named.conf.options文件。这个文件应该与ns1的named.conf.options文件相同，只是它应该被配置为监听ns2的私有IP地址。</p>
<p>最终named.conf.options文件内容如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">acl "trusted" &#123;</span><br><span class="line">  10.1.80.220;    # ns1</span><br><span class="line">  10.1.80.221;    # ns2</span><br><span class="line">  10.1.80.0/24;   # trusted DNS clients network</span><br><span class="line">&#125;;</span><br><span class="line">options &#123;</span><br><span class="line">        directory "/var/cache/bind";</span><br><span class="line"></span><br><span class="line">        recursion yes;                     # enables recursive queries</span><br><span class="line">        allow-recursion &#123; trusted; &#125;;      # allows recursive queries from "trusted" clients</span><br><span class="line">        allow-query &#123; trusted; &#125;;          # allows queries from "trusted" clients</span><br><span class="line">        listen-on &#123; 10.1.80.221; &#125;;        # ns2 private IP address</span><br><span class="line">        allow-transfer &#123; none; &#125;;          # disable zone transfers by default</span><br><span class="line"></span><br><span class="line">        forwarders &#123;</span><br><span class="line">                223.5.5.5;</span><br><span class="line">                223.6.6.6;</span><br><span class="line">                114.114.114.114;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        dnssec-validation auto;</span><br><span class="line"></span><br><span class="line">        listen-on-v6 &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>现在编辑named.conf.loca文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/bind/named.conf.local</span><br></pre></td></tr></table></figure></p>
<p>在主DNS服务器上定义与主DNS服务器对应的辅助区域。注意，该类型是slave，文件不包含路径，并且有一个master指令，该指令应该设置为主DNS服务器的私有IP地址。如果您在主DNS服务器中定义了多个反向区域，请确保将它们全部添加到这里:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">zone "idc3.meeleet.com" &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file "db.idc3.meeleet.com";</span><br><span class="line">    masters &#123; 10.1.80.220; &#125;;   # ns1 private IP</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone "80.1.10.in-addr.arpa" &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file "db.10.1.80";</span><br><span class="line">    masters &#123; 10.1.80.220; &#125;;   # ns1 private IP</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意:考虑到它们的负面含义，DigitalOcean倾向于尽可能避免使用“主人”和“奴隶”等术语。在Bind的最新版本中，可以使用primaries而不是masters，并将备服务器的类型定义为secondary服务器而不是slave服务器。然而，从默认的Ubuntu 20.04存储库中安装的BIND版本(如步骤1中所述)将无法识别这些选项，这意味着除非升级，否则您将不得不使用包含较少的术语。</p>
<p>保存并关闭named.conf.local文件<br>运行以下命令检查配置文件有效性<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo named-checkconf</span><br></pre></td></tr></table></figure></p>
<p>如果命令执行反回没有任何错误，那么就可以重启bind</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart bind9</span><br></pre></td></tr></table></figure>
<p>然后通过修改防火墙规则使得允许DNS客户端的连接到此DNS服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow Bind9</span><br></pre></td></tr></table></figure>
<p>到现在为止，DNS主备服务器就搭建好了</p>
<p>从ns1传输到ns2的区域文件放在 ns2的/var/cache/bind/目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /var/cache/bind/</span><br><span class="line">db.10.1.80             db.idc3.meeleet.com    managed-keys.bind      managed-keys.bind.jnl</span><br></pre></td></tr></table></figure>
<h1 id="步骤4-配置DNS客户端"><a href="#步骤4-配置DNS客户端" class="headerlink" title="步骤4 配置DNS客户端"></a>步骤4 配置DNS客户端</h1><p>在受信任ACL中的所有服务器都可以查询您的DNS服务器之前，必须将每个服务器配置为使用ns1和ns2作为DNS服务器。</p>
<p>假设您的客户端服务器运行Ubuntu，您需要找到与您的专用网络相关联的设备。可以使用ip address命令查询私有子网。在每台客户机上运行以下命令，将突出显示的子网替换为您自己的子网。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ip address show to 10.1.80.0/24</span><br><span class="line"></span><br><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    inet 10.1.80.91/24 brd 10.1.80.255 scope global enp0s3</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>本例中私网网卡名为enp0s3。本节中的示例将把enp0s3作为私有网络(10.1.80.0/24网段)网卡，不过您应该根据您的实际情况更改这些示例，以反映您自己的服务器的私有网卡。</p>
<p>修改/etc/netplan/00-installer-config.yaml给s91,s92的相应网卡设置ns1和ns2 DNS服务器的地址，以及search域</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/netplan/00-installer-config.yaml</span><br></pre></td></tr></table></figure>
<p>s91<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">  ethernets:</span></span><br><span class="line"><span class="attr">    enp0s3:</span></span><br><span class="line"><span class="attr">      addresses:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.91</span><span class="string">/24</span></span><br><span class="line"><span class="attr">      gateway4:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.254</span></span><br><span class="line"><span class="attr">      nameservers:</span></span><br><span class="line"><span class="attr">        addresses:</span> <span class="string">[10.1.80.220,10.1.80.221]</span></span><br><span class="line"><span class="attr">        search:</span> <span class="string">[idc3.meeleet.com]</span></span><br><span class="line"><span class="attr">    enp0s8:</span></span><br><span class="line"><span class="attr">      dhcp4:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>s92<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line"><span class="attr">  ethernets:</span></span><br><span class="line"><span class="attr">    enp0s3:</span></span><br><span class="line"><span class="attr">      addresses:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.92</span><span class="string">/24</span></span><br><span class="line"><span class="attr">      gateway4:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.254</span></span><br><span class="line"><span class="attr">      nameservers:</span></span><br><span class="line"><span class="attr">        addresses:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.220</span></span><br><span class="line"><span class="bullet">          -</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.221</span></span><br><span class="line"><span class="attr">        search:</span> <span class="string">[idc3.meeleet.com]</span></span><br><span class="line"><span class="attr">    enp0s8:</span></span><br><span class="line"><span class="attr">      dhcp4:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>DNS服务器列表network-&gt;ethernets-&gt;enp0s3-&gt;nameservers-&gt;addresses两种配置方式都可以。search的作用就是就去ping s91时，原来当访问的域名(s91)不能被DNS解析时，resolver会将该域名加上search指定的参数，也就是s91.idc3.meeleet.com，重新请求DNS，直到被正确解析或试完search指定的列表为止。</p>
<p>保存并关闭</p>
<p>使用netplan try尝试新配置，如果有问netplay会在倒计时后自动回滚配置。</p>
<p>现在，检查系统的DNS解析器，以确定您的DNS配置是否已应用:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemd-resolve --status</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">Global</span><br><span class="line">       LLMNR setting: no</span><br><span class="line">MulticastDNS setting: no</span><br><span class="line">  DNSOverTLS setting: no</span><br><span class="line">      DNSSEC setting: no</span><br><span class="line">    DNSSEC supported: no</span><br><span class="line">          DNSSEC NTA: 10.in-addr.arpa</span><br><span class="line">                      16.172.in-addr.arpa</span><br><span class="line">                      168.192.in-addr.arpa</span><br><span class="line">                      17.172.in-addr.arpa</span><br><span class="line">                      18.172.in-addr.arpa</span><br><span class="line">                      19.172.in-addr.arpa</span><br><span class="line">                      20.172.in-addr.arpa</span><br><span class="line">                      21.172.in-addr.arpa</span><br><span class="line">                      22.172.in-addr.arpa</span><br><span class="line">                      23.172.in-addr.arpa</span><br><span class="line">                      24.172.in-addr.arpa</span><br><span class="line">                      25.172.in-addr.arpa</span><br><span class="line">                      26.172.in-addr.arpa</span><br><span class="line">                      27.172.in-addr.arpa</span><br><span class="line">                      28.172.in-addr.arpa</span><br><span class="line">                      29.172.in-addr.arpa</span><br><span class="line">                      30.172.in-addr.arpa</span><br><span class="line">                      31.172.in-addr.arpa</span><br><span class="line">                      corp</span><br><span class="line">                      d.f.ip6.arpa</span><br><span class="line">                      home</span><br><span class="line">                      internal</span><br><span class="line">                      intranet</span><br><span class="line">                      lan</span><br><span class="line">                      local</span><br><span class="line">                      private</span><br><span class="line">                      test</span><br><span class="line"></span><br><span class="line">Link 3 (enp0s8)</span><br><span class="line">      Current Scopes: DNS</span><br><span class="line">DefaultRoute setting: yes</span><br><span class="line">       LLMNR setting: yes</span><br><span class="line">MulticastDNS setting: no</span><br><span class="line">  DNSOverTLS setting: no</span><br><span class="line">      DNSSEC setting: no</span><br><span class="line">    DNSSEC supported: no</span><br><span class="line">  Current DNS Server: 223.5.5.5</span><br><span class="line">         DNS Servers: 223.5.5.5</span><br><span class="line">                      223.6.6.6</span><br><span class="line"></span><br><span class="line">Link 2 (enp0s3)</span><br><span class="line">      Current Scopes: DNS</span><br><span class="line">DefaultRoute setting: yes</span><br><span class="line">       LLMNR setting: yes</span><br><span class="line">MulticastDNS setting: no</span><br><span class="line">  DNSOverTLS setting: no</span><br><span class="line">      DNSSEC setting: no</span><br><span class="line">    DNSSEC supported: no</span><br><span class="line">  Current DNS Server: 223.5.5.5</span><br><span class="line">         DNS Servers: 223.5.5.5</span><br><span class="line">                      223.6.6.6</span><br><span class="line">                      10.1.80.200</span><br><span class="line">                      10.1.80.201</span><br><span class="line">          DNS Domain: idc3.meeleet.com</span><br></pre></td></tr></table></figure>
<h1 id="步骤5-测试客户端"><a href="#步骤5-测试客户端" class="headerlink" title="步骤5 测试客户端"></a>步骤5 测试客户端</h1><h1 id="步骤6-维护DNS记录"><a href="#步骤6-维护DNS记录" class="headerlink" title="步骤6 维护DNS记录"></a>步骤6 维护DNS记录</h1><p>现在你已拥有了工作在内网的DNS服务器，你需要维护DNS记录以便支持你的服务器环境。</p>
<h2 id="添加新主机DNS记录"><a href="#添加新主机DNS记录" class="headerlink" title="添加新主机DNS记录"></a>添加新主机DNS记录</h2><p>任何时候你要添加新主机到你的服务器环境(在同一个数据中心)，添加一个新主机的DNS记录，需要以下步骤：</p>
<h3 id="主域名服务器"><a href="#主域名服务器" class="headerlink" title="主域名服务器"></a>主域名服务器</h3><ul>
<li><p>正向区域文件：为新主机添加A记录，并增加Serial值</p>
</li>
<li><p>反向区域文件：为新主机增加PTR记录，并增加Serial值</p>
</li>
<li><p>添加新的主机私网IP地址到受信任的ACL列表(named.conf.options)</p>
</li>
</ul>
<p>测试配置文件：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo named-checkconf</span><br><span class="line">sudo named-checkzone idc3.meeleet.com /etc/bind/zones/db.idc3.meeleet.com</span><br><span class="line">sudo named-checkzone 80.1.10.in-addr.arpa /etc/bind/zones/db.10.1.80</span><br></pre></td></tr></table></figure></p>
<h3 id="辅域名服务器"><a href="#辅域名服务器" class="headerlink" title="辅域名服务器"></a>辅域名服务器</h3><ul>
<li>添加新的主机私网IP地址到受信任的ACL列表(named.conf.options)</li>
</ul>
<p>检查配置文件语法是否正确<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo named-checkconf</span><br></pre></td></tr></table></figure></p>
<p>然后重载bind:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload bind9</span><br></pre></td></tr></table></figure></p>
<h2 id="删除主机DNS记录"><a href="#删除主机DNS记录" class="headerlink" title="删除主机DNS记录"></a>删除主机DNS记录</h2><p>如果你要删除某个主机的DNS记录，只需要删除之前添加的该主机的DNS记录信息(就是与之前添加主机DNS记录的步骤相反)</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-bind-as-a-private-network-dns-server-on-ubuntu-20-04" target="_blank" rel="noopener">How To Configure BIND as a Private Network DNS Server on Ubuntu 20.04</a></p>
<p><a href="https://lnsyyj.github.io/2019/01/06/%E5%A6%82%E4%BD%95%E5%9C%A8CentOS-7%E4%B8%8A%E5%B0%86BIND%E9%85%8D%E7%BD%AE%E4%B8%BA%E4%B8%93%E7%94%A8%E7%BD%91%E7%BB%9CDNS%E6%9C%8D%E5%8A%A1%E5%99%A8/" target="_blank" rel="noopener">如何在CentOS-7上将BIND配置为专用网络DNS服务器</a></p>
<p><a href="https://www.cnblogs.com/doherasyang/p/14464999.html?ivk_sa=1024320u" target="_blank" rel="noopener">ISC BIND9 - 最详细、最认真的从零开始的 BIND 9 - DNS服务搭建及其原理讲解</a></p>
<p><a href="https://wiki.ubuntu.org.cn/Bind9%E5%AE%89%E8%A3%85%E8%AE%BE%E7%BD%AE%E6%8C%87%E5%8D%97#HOWTO_Setup_BIND9_DNS_Server_.EF.BC.88.E5.A6.82.E4.BD.95.E5.AE.89.E8.A3.85.E8.AE.BE.E7.BD.AEBind9_DNS.E6.9C.8D.E5.8A.A1.E5.99.A8.EF.BC.89" target="_blank" rel="noopener">Bind9安装设置指南</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2022/10/09/VS高可用实战之DR模式-CentOS-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/10/09/VS高可用实战之DR模式-CentOS-7/" itemprop="url">LVS高可用实战之DR模式(CentOS 7)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-10-09T16:18:50+08:00">
                2022-10-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/10/09/VS高可用实战之DR模式-CentOS-7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/10/09/VS高可用实战之DR模式-CentOS-7/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,134
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>VirtualBox虚拟机3台，使用的网络有桥接网卡、网络地址转换(NAT)</p>
<p>桥接网卡网段是10.1.80.0/24，网络地址转换(NAT)是为了能访问internet以便安装软件</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>IP</th>
<th>VIP</th>
</tr>
</thead>
<tbody>
<tr>
<td>ds1</td>
<td>10.1.80.91</td>
<td>enp0s3</td>
<td></td>
</tr>
<tr>
<td>ds2</td>
<td>10.1.80.92</td>
<td>enp0s3</td>
<td></td>
</tr>
<tr>
<td>rs1</td>
<td>10.1.80.93</td>
<td>lo:0</td>
<td></td>
</tr>
<tr>
<td>rs2</td>
<td>10.1.80.95</td>
<td>lo:0</td>
<td></td>
</tr>
</tbody>
</table>
<p>VIP地址为10.1.80.90</p>
<p>RS的RIP可以使用私网或公网IP， 文中DS与RS用的是同一网段。实际场景，一般情况下RS的RIP与VIP是不同网段的。</p>
<h1 id="LVS常用名词"><a href="#LVS常用名词" class="headerlink" title="LVS常用名词"></a>LVS常用名词</h1><ul>
<li>Load Balancer：负载均衡器，运行LVS负责负载均衡的服务器</li>
<li>DS：Director Server，指的是前端负载均衡器节点，也就是运行LVS的服务器；</li>
<li>RS：Real Server，后端真实的工作服务器；</li>
<li>VIP：Virtual Server IP，向外部直接面向用户请求，作为用户请求的目标的IP地址，一般也是DS的外部IP地址；</li>
<li>DIP：Director Server IP，主要用于和内部主机通讯的IP地址，一般也是DS的内部IP地址；</li>
<li>RIP：Real Server IP，后端服务器的IP地址；</li>
<li>CIP：Client IP，访问客户端的IP地址；</li>
</ul>
<h1 id="Director-Server"><a href="#Director-Server" class="headerlink" title="Director Server"></a>Director Server</h1><h2 id="ds1"><a href="#ds1" class="headerlink" title="ds1"></a>ds1</h2><p>安装ipvsadm<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y ipvsadm</span><br></pre></td></tr></table></figure></p>
<p>安装keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y keepalived</span><br></pre></td></tr></table></figure></p>
<p>备份keepalived.conf配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 1</span><br><span class="line">    </span><br><span class="line">    # 如果两节点的上联交换机禁用了组播，则采用 vrrp 单播通告的方式</span><br><span class="line">    # unicast_src_ip 10.1.80.91</span><br><span class="line">    # unicast_peer &#123;</span><br><span class="line">    #    10.1.80.92</span><br><span class="line">    # &#125;</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.1.80.90</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.1.80.90 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 5</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.93 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.95 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ds1作为MASTER优先级比ds2高，ds1设置priority 101，ds2设置priority 100</p>
</blockquote>
<p>重启keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart keepalived</span><br></pre></td></tr></table></figure></p>
<p>防火墙开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>防火墙允许vrrp的组播</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class="line"></span><br><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --out-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>防火墙重新加载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h2 id="ds2"><a href="#ds2" class="headerlink" title="ds2"></a>ds2</h2><p>安装ipvsadm<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y ipvsadm</span><br></pre></td></tr></table></figure></p>
<p>安装keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y keepalived</span><br></pre></td></tr></table></figure></p>
<p>备份keepalived.conf配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    </span><br><span class="line">    # 如果两节点的上联交换机禁用了组播，则采用 vrrp 单播通告的方式</span><br><span class="line">    # unicast_src_ip 10.1.80.92</span><br><span class="line">    # unicast_peer &#123;</span><br><span class="line">    #    10.1.80.91</span><br><span class="line">    # &#125;</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.1.80.90</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.1.80.90 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 5</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.93 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.95 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart keepalived</span><br></pre></td></tr></table></figure></p>
<p>防火墙开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>防火墙允许vrrp的组播</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class="line"></span><br><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --out-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>防火墙重新加载<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<h1 id="Real-Server"><a href="#Real-Server" class="headerlink" title="Real Server"></a>Real Server</h1><h2 id="rs1"><a href="#rs1" class="headerlink" title="rs1"></a>rs1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/scripts</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /opt/scripts/lvs_rs.sh</span><br></pre></td></tr></table></figure>
<p>脚本如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash </span><br><span class="line">VIP=10.1.80.90</span><br><span class="line">case "$1" in</span><br><span class="line">start)</span><br><span class="line">       ifconfig lo:0 $VIP netmask 255.255.255.255 broadcast $VIP</span><br><span class="line">       /sbin/route add -host $VIP dev lo:0</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       sysctl -p &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "RealServer Start OK"</span><br><span class="line">       ;;</span><br><span class="line">stop)</span><br><span class="line">       ifconfig lo:0 down</span><br><span class="line">       route del $VIP &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       echo "RealServer Stoped"</span><br><span class="line">       ;;</span><br><span class="line">*)</span><br><span class="line">       echo "Usage: $0 &#123;start|stop&#125;"</span><br><span class="line">       exit 1</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /opt/scripts/lvs_rs.sh </span><br><span class="line">sudo /opt/scripts/lvs_rs.sh start</span><br></pre></td></tr></table></figure>
<p>安装tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /tmp/software</span><br><span class="line">sudo cd /tmp/software</span><br><span class="line">sudo curl -O https://tengine.taobao.org/download/tengine-2.3.3.tar.gz</span><br><span class="line">sudo tar -xzvf tengine-2.3.3.tar.gz</span><br><span class="line">sudo cd tengine-2.3.3</span><br><span class="line">sudo yum install -y gcc make pcre-devel openssl-devel</span><br><span class="line">sudo ./configure --prefix=/usr/local/tengine</span><br></pre></td></tr></table></figure></p>
<p>修改index.html<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /usr/local/tengine/html/index.html</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">其余省略...</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to tengine! I'm rs1<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">其余省略...</span><br></pre></td></tr></table></figure>
<p>启动tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/tengine/sbin/nginx</span><br></pre></td></tr></table></figure></p>
<p>防火墙设置开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<h2 id="rs2"><a href="#rs2" class="headerlink" title="rs2"></a>rs2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/scripts</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /opt/scripts/lvs_rs.sh</span><br></pre></td></tr></table></figure>
<p>脚本如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash </span><br><span class="line">VIP=10.1.80.90</span><br><span class="line">case "$1" in</span><br><span class="line">start)</span><br><span class="line">       ifconfig lo:0 $VIP netmask 255.255.255.255 broadcast $VIP</span><br><span class="line">       /sbin/route add -host $VIP dev lo:0</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       sysctl -p &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "RealServer Start OK"</span><br><span class="line">       ;;</span><br><span class="line">stop)</span><br><span class="line">       ifconfig lo:0 down</span><br><span class="line">       route del $VIP &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       echo "RealServer Stoped"</span><br><span class="line">       ;;</span><br><span class="line">*)</span><br><span class="line">       echo "Usage: $0 &#123;start|stop&#125;"</span><br><span class="line">       exit 1</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /opt/scripts/lvs_rs.sh </span><br><span class="line">sudo /opt/scripts/lvs_rs.sh start</span><br></pre></td></tr></table></figure>
<p>安装tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /tmp/software</span><br><span class="line">sudo cd /tmp/software</span><br><span class="line">sudo curl -O https://tengine.taobao.org/download/tengine-2.3.3.tar.gz</span><br><span class="line">sudo tar -xzvf tengine-2.3.3.tar.gz</span><br><span class="line">sudo cd tengine-2.3.3</span><br><span class="line">sudo yum install -y gcc make pcre-devel openssl-devel</span><br><span class="line">sudo ./configure --prefix=/usr/local/tengine</span><br></pre></td></tr></table></figure></p>
<p>修改index.html<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /usr/local/tengine/html/index.html</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">其余省略...</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to tengine! I'm rs2<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">其余省略...</span><br></pre></td></tr></table></figure>
<p>启动tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/tengine/sbin/nginx</span><br></pre></td></tr></table></figure></p>
<p>防火墙设置开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<h1 id="测试keepalived-vrrp报文"><a href="#测试keepalived-vrrp报文" class="headerlink" title="测试keepalived vrrp报文"></a>测试keepalived vrrp报文</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 host 224.0.0.18</span><br></pre></td></tr></table></figure>
<p>在ds1上执行(ds2,rs1,rs2都可以的)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">14:43:04.752665 IP (tos 0xc0, ttl 255, id 130, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 101, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br><span class="line">14:43:05.753059 IP (tos 0xc0, ttl 255, id 131, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 101, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br></pre></td></tr></table></figure></p>
<p>可以看到10.1.80.91在发组播消息，10.1.80.91证明我是MASTER，vip(10.1.80.90)在ds1的enp0s3上。<br>然后把ds1的keepalived关了,sudo systemctl stop keepalived</p>
<p>观察报文变化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">14:45:08.488190 IP (tos 0xc0, ttl 255, id 253, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 0, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br><span class="line">14:45:09.120876 IP (tos 0xc0, ttl 255, id 8772, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.92 &gt; 224.0.0.18: vrrp 10.1.80.92 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br></pre></td></tr></table></figure>
<p>发现已经由10.1.80.91改为10.1.80.92发组播消息,vip(10.1.80.90)飘到了ds2的enp0s3上。</p>
<p>重新启动ds1上的keepalived,再次观察报文</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">14:46:59.177236 IP (tos 0xc0, ttl 255, id 8880, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.92 &gt; 224.0.0.18: vrrp 10.1.80.92 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br><span class="line">14:46:59.177350 IP (tos 0xc0, ttl 255, id 1, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 101, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br></pre></td></tr></table></figure>
<p>发现由10.1.80.92改为了10.1.80.91发组播消息了，vip(10.1.80.90)飘回了ds1的enp0s3上。</p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><ul>
<li>打开浏览器，访问<a href="http://10.1.80.90" target="_blank" rel="noopener">http://10.1.80.90</a></li>
</ul>
<p>页面展示 Welcome to tengine! I’m rs1</p>
<p>ds1上查看sudo ipvsadm -ln</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[jaychang@ds01 ~]# sudo ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.1.80.90:80 wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.93:80              Route   100    0          0</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.95:80              Route   100    2          0</span><br></pre></td></tr></table></figure>
<ul>
<li>停掉rs1的nginx后</li>
</ul>
<p>ds1上查看/var/log/keepalived.log(如果未设置过，默认是在/var/log/message)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Oct  8 15:50:14 ds01 Keepalived_healthcheckers[15444]: TCP connection to [10.1.80.93]:80 failed.</span><br><span class="line">Oct  8 15:50:15 ds01 Keepalived_healthcheckers[15444]: TCP connection to [10.1.80.93]:80 failed.</span><br><span class="line">Oct  8 15:50:15 ds01 Keepalived_healthcheckers[15444]: Check on service [10.1.80.93]:80 failed after 1 retry.</span><br><span class="line">Oct  8 15:50:15 ds01 Keepalived_healthcheckers[15444]: Removing service [10.1.80.93]:80 from VS [10.1.80.90]:80</span><br></pre></td></tr></table></figure>
<p>从日志内容可以看到10.1.80.93已被剔除了</p>
<p>ds1上查看sudo ipvsadm -ln</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[jaychang@ds01 ~]$ sudo ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.1.80.90:80 wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.95:80              Route   100    4          0</span><br></pre></td></tr></table></figure>
<p>刷新浏览器页面显示Welcome to tengine! I’m rs2</p>
<ul>
<li>重新开启rs1的nginx</li>
</ul>
<p>观察/var/log/keepalived.log(如果未设置过，默认是在/var/log/message)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Oct  8 16:11:41 ds01 Keepalived_healthcheckers[15444]: TCP connection to [10.1.80.93]:80 success.</span><br><span class="line">Oct  8 16:11:41 ds01 Keepalived_healthcheckers[15444]: Adding service [10.1.80.93]:80 to VS [10.1.80.90]:80</span><br></pre></td></tr></table></figure>
<p>ds1上查看sudo ipvsadm -ln</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.1.80.90:80 wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.93:80              Route   100    0          0</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.95:80              Route   100    2          0</span><br></pre></td></tr></table></figure>
<p>发现10.1.80.93已经重新被加入到服务列表中了</p>
<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><ul>
<li>ds1,ds2上的LVS规则如何删除？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm --clear</span><br></pre></td></tr></table></figure>
<ul>
<li>如何删掉ds1,ds2上的VIP？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig enp0s3:0 down</span><br></pre></td></tr></table></figure>
<ul>
<li>如何查看LVS统计信息？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm -ln --stats</span><br></pre></td></tr></table></figure>
<ul>
<li>如何查看LVS连接条目？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm -lnc</span><br></pre></td></tr></table></figure>
<ul>
<li>ds1,ds2上用tcpdump抓包观察组播消息？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 host 224.0.0.18</span><br></pre></td></tr></table></figure>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 vrrp</span><br></pre></td></tr></table></figure></p>
<ul>
<li>指定访问来源主机，指定抓包端口号，网卡名称<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i enp0s3 tcp port 80 and host 10.1.80.62</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>查看详细一点信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 tcp port 80 and host 10.1.80.62</span><br></pre></td></tr></table></figure>
<ul>
<li>用iptables如何允许组播?</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT -i enp0s3 -d 224.0.0.18 -p vrrp -j ACCEPT</span><br><span class="line">sudo iptables -I OUTPUT -o enp0s3 -d 224.0.0.18 -p vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>
<ul>
<li>firewall防火墙如何开放端口，关闭端口？</li>
</ul>
<p>开放80端口访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>关闭80端口访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --remove-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>记得要reload或restart下，防火墙才会生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload firewalld</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart firewalld</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>推荐使用第一种方式重新加载防火墙</p>
</blockquote>
<ul>
<li>查看防火墙开放的端口</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --list-port</span><br></pre></td></tr></table></figure>
<ul>
<li>脑裂的原因有哪些？</li>
</ul>
<ol>
<li>主备的virtual_router_id 不一致</li>
<li>交换机不允许组播(可以改成单播方式)</li>
<li>防火墙未允许组播</li>
</ol>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul>
<li>注意要使得rs1,rs2上的配置重启生效的话，可以将/opt/scripts/lvs_rs.sh作为启动脚本（推荐）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo echo "/opt/scripts/lvs_rs.sh start" &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
<p>在centos7中，/etc/rc.d/rc.local文件的权限被降低了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></p>
<ul>
<li>或使用以下方法</li>
</ul>
<p>要使得rs1,rs2上的lo:0重启后仍生效的话，要创建一个ifcfg-lo:0文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/sysconfig/network-scripts/ifcfg-lo /etc/sysconfig/network-scripts/ifcfg-lo:0</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/sysconfig/network-scripts/ifcfg-lo:0</span><br></pre></td></tr></table></figure>
<p>内容如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=lo:0</span><br><span class="line">IPADDR=10.1.80.90</span><br><span class="line">NETMASK=255.255.255.255</span><br><span class="line">BROADCAST=10.1.80.90</span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure></p>
<p>重启网络<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service network restart</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure>
<p>添加以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.default.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.default.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br></pre></td></tr></table></figure>
<p>刷新文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>路由设置添加开启自启动<br>echo “route add -host 10.1.80.90 dev lo:0” &gt;&gt; /etc/rc.local</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://tinychen.com/20200427-lvs-principle-introduction/" target="_blank" rel="noopener">LVS三种模式的工作原理</a></p>
<p><a href="https://ynotes.cn/blog/article_detail/194" target="_blank" rel="noopener">CentOS7搭建LVS负载均衡器</a></p>
<p><a href="http://www.linuxvirtualserver.org/docs/ha/keepalived.html" target="_blank" rel="noopener">LVS High Availability - The Keepalived Solution</a></p>
<p><a href="https://blog.51cto.com/qujunorz/1861541" target="_blank" rel="noopener">keepalived组播故障排查</a></p>
<p><a href="https://blog.csdn.net/u010943765/article/details/59574764" target="_blank" rel="noopener">centos7 keepalived 主备通信 防火墙vrrp 协议
</a></p>
<p><a href="https://qizhanming.com/blog/2018/05/17/how-to-config-keepalived-on-centos-7" target="_blank" rel="noopener">CentOS 7 配置 Keepalived 实现双机热备</a></p>
<p><a href="https://blog.csdn.net/tushanpeipei/article/details/112448165" target="_blank" rel="noopener">VRRP技术原理与注意点
</a></p>
<p><a href="http://blog.itpub.net/70000438/viewspace-2782269/" target="_blank" rel="noopener">LVS+Keepalived+Nginx高可用实现
</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2020/12/26/bernetes单节点安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/26/bernetes单节点安装/" itemprop="url">CentOS7安装kubernetes单master节点(v1.19.x)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-26T11:01:24+08:00">
                2020-12-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/26/bernetes单节点安装/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/12/26/bernetes单节点安装/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5,212
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="配置要求"><a href="#配置要求" class="headerlink" title="配置要求"></a>配置要求</h1><p>对于 Kubernetes 初学者，在搭建K8S集群时，推荐在阿里云或腾讯云采购如下配置：（您也可以使用自己的虚拟机、私有云等您最容易获得的 Linux 环境）</p>
<ul>
<li>至少2台 2核4G 的服务器</li>
<li>Cent OS 7.6 / 7.7 / 7.8</li>
</ul>
<h2 id="安装后软件版本"><a href="#安装后软件版本" class="headerlink" title="安装后软件版本"></a>安装后软件版本</h2><ul>
<li><p>Kubernetes v1.19.x</p>
<ul>
<li><p>calico 3.13.1</p>
</li>
<li><p>nginx-ingress 1.5.5</p>
</li>
</ul>
</li>
<li>Docker 19.03.14</li>
</ul>
<blockquote>
<p><strong>关于二进制安装</strong></p>
<p>kubeadm 是 Kubernetes 官方支持的安装方式，“二进制” 不是。本文档采用 kubernetes.io 官方推荐的 kubeadm 工具安装 kubernetes 集群。</p>
</blockquote>
<h1 id="检查CentOS-hostname"><a href="#检查CentOS-hostname" class="headerlink" title="检查CentOS / hostname"></a>检查CentOS / hostname</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 在 master 节点和 worker 节点都要执行</span><br><span class="line">cat /etc/redhat-release</span><br><span class="line"></span><br><span class="line"># 此处 hostname 的输出将会是该机器在 Kubernetes 集群中的节点名字</span><br><span class="line"># 不能使用 localhost 作为节点的名字</span><br><span class="line">hostname</span><br><span class="line"></span><br><span class="line"># 请使用 lscpu 命令，核对 CPU 信息</span><br><span class="line"># Architecture: x86_64    本安装文档不支持 arm 架构</span><br><span class="line"># CPU(s):       2         CPU 内核数量不能低于 2</span><br><span class="line">lscpu</span><br></pre></td></tr></table></figure>
<p><strong>操作系统兼容性</strong></p>
<table>
<thead>
<tr>
<th>CentOS版本</th>
<th>本文档是否兼容</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.8</td>
<td>是</td>
<td>已验证</td>
</tr>
<tr>
<td>7.7</td>
<td>是</td>
<td>已验证</td>
</tr>
<tr>
<td>7.6</td>
<td>是</td>
<td>已验证</td>
</tr>
<tr>
<td>7.5</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
<tr>
<td>7.4</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
<tr>
<td>7.3</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
<tr>
<td>7.2</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
</tbody>
</table>
<blockquote>
<p>修改 hostname</p>
<p>如果您需要修改 hostname，可执行如下指令：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 修改 hostname</span><br><span class="line">hostnamectl set-hostname your-new-host-name</span><br><span class="line"><span class="meta">#</span> 查看修改结果</span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="meta">#</span> 设置 hostname 解析</span><br><span class="line">echo "127.0.0.1   $(hostname)" &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<h1 id="检查网络"><a href="#检查网络" class="headerlink" title="检查网络"></a>检查网络</h1><p>在所有节点执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@demo-master-a-1 ~]$ ip route show</span><br><span class="line">default via 172.21.0.1 dev eth0 </span><br><span class="line">169.254.0.0/16 dev eth0 scope link metric 1002 </span><br><span class="line">172.21.0.0/20 dev eth0 proto kernel scope link src 172.21.0.12 </span><br><span class="line"></span><br><span class="line">[root@demo-master-a-1 ~]$ ip address</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:16:3e:12:a4:1b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.216.80/20 brd 172.17.223.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 305741654sec preferred_lft 305741654sec</span><br></pre></td></tr></table></figure>
<h1 id="安装docker及kubelet"><a href="#安装docker及kubelet" class="headerlink" title="安装docker及kubelet"></a>安装docker及kubelet</h1><p>使用 root 身份在所有节点执行如下代码，以安装软件：</p>
<ul>
<li>docker</li>
<li>nfs-utils</li>
<li>kubectl / kubeadm / kubelet</li>
</ul>
<h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><p><strong>请将脚本最后的 1.19.6 替换成您需要的版本号</strong>， 脚本中间的 v1.19.x 不要替换</p>
<p>docker hub 镜像请根据自己网络的情况任选一个</p>
<ul>
<li>第四行为腾讯云 docker hub 镜像</li>
<li>第六行为DaoCloud docker hub 镜像</li>
<li>第八行为华为云 docker hub 镜像</li>
<li>第十行为阿里云 docker hub 镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在 master 节点和 worker 节点都要执行</span><br><span class="line"><span class="meta">#</span> 最后一个参数 1.19.5 用于指定 kubenetes 版本，支持所有 1.19.x 版本的安装</span><br><span class="line"><span class="meta">#</span> 腾讯云 docker hub 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="https://mirror.ccs.tencentyun.com"</span><br><span class="line"><span class="meta">#</span> DaoCloud 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="http://f1361db2.m.daocloud.io"</span><br><span class="line"><span class="meta">#</span> 华为云镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com"</span><br><span class="line"><span class="meta">#</span> 阿里云 docker hub 镜像</span><br><span class="line">export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.6</span><br></pre></td></tr></table></figure>
<h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><blockquote>
<p>手动执行以下代码，结果与快速安装相同。<strong>请将脚本第79行（已高亮）的 ${1} 替换成您需要的版本号，例如 1.19.6</strong></p>
</blockquote>
<p>docker hub 镜像请根据自己网络的情况任选一个</p>
<ul>
<li>第四行为腾讯云 docker hub 镜像</li>
<li>第六行为DaoCloud docker hub 镜像</li>
<li>第八行为阿里云 docker hub 镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在 master 节点和 worker 节点都要执行</span><br><span class="line"><span class="meta">#</span> 最后一个参数 1.19.5 用于指定 kubenetes 版本，支持所有 1.19.x 版本的安装</span><br><span class="line"><span class="meta">#</span> 腾讯云 docker hub 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="https://mirror.ccs.tencentyun.com"</span><br><span class="line"><span class="meta">#</span> DaoCloud 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="http://f1361db2.m.daocloud.io"</span><br><span class="line"><span class="meta">#</span> 阿里云 docker hub 镜像</span><br><span class="line">export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以指定安装docker-ce的版本，用<strong>yum list docker-ce –showduplicates|sort -r</strong> 查看所有版本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 在 master 节点和 worker 节点都要执行</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装 docker</span><br><span class="line"><span class="meta">#</span> 参考文档如下</span><br><span class="line"><span class="meta">#</span> https://docs.docker.com/install/linux/docker-ce/centos/ </span><br><span class="line"><span class="meta">#</span> https://docs.docker.com/install/linux/linux-postinstall/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 卸载旧版本</span><br><span class="line">yum remove -y docker \</span><br><span class="line">docker-client \</span><br><span class="line">docker-client-latest \</span><br><span class="line">docker-ce-cli \</span><br><span class="line">docker-common \</span><br><span class="line">docker-latest \</span><br><span class="line">docker-latest-logrotate \</span><br><span class="line">docker-logrotate \</span><br><span class="line">docker-selinux \</span><br><span class="line">docker-engine-selinux \</span><br><span class="line">docker-engine</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 设置 yum repository</span><br><span class="line">yum install -y yum-utils \</span><br><span class="line">device-mapper-persistent-data \</span><br><span class="line">lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装并启动 docker</span><br><span class="line">yum install -y docker-ce-19.03.14 docker-ce-cli-19.03.14</span><br><span class="line"></span><br><span class="line">mkdir /etc/docker || true</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "registry-mirrors": ["$&#123;REGISTRY_MIRROR&#125;"],</span><br><span class="line">  "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">  "log-driver": "json-file",</span><br><span class="line">  "log-opts": &#123;</span><br><span class="line">    "max-size": "100m"</span><br><span class="line">  &#125;,</span><br><span class="line">  "storage-driver": "overlay2",</span><br><span class="line">  "storage-opts": [</span><br><span class="line">    "overlay2.override_kernel_check=true"</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Restart Docker</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable docker</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装 nfs-utils</span><br><span class="line"><span class="meta">#</span> 必须先安装 nfs-utils 才能挂载 nfs 网络存储</span><br><span class="line">yum install -y nfs-utils</span><br><span class="line">yum install -y wget</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关闭 防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关闭 SeLinux</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关闭 swap</span><br><span class="line">swapoff -a</span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 修改 /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span> 如果有配置，则修改</span><br><span class="line">sed -i "s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.all.disable_ipv6.*#net.ipv6.conf.all.disable_ipv6=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.default.disable_ipv6.*#net.ipv6.conf.default.disable_ipv6=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.lo.disable_ipv6.*#net.ipv6.conf.lo.disable_ipv6=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.all.forwarding.*#net.ipv6.conf.all.forwarding=1#g"  /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span> 可能没有，追加</span><br><span class="line">echo "net.ipv4.ip_forward = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.bridge.bridge-nf-call-ip6tables = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.bridge.bridge-nf-call-iptables = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.all.disable_ipv6 = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.default.disable_ipv6 = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.lo.disable_ipv6 = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.all.forwarding = 1"  &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span> 执行命令以应用</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置K8S的yum源</span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 卸载旧版本</span><br><span class="line">yum remove -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装kubelet、kubeadm、kubectl</span><br><span class="line"><span class="meta">#</span> 将 $&#123;1&#125; 替换为 kubernetes 版本号，例如 1.19.6</span><br><span class="line">yum install -y kubelet-$&#123;1&#125; kubeadm-$&#123;1&#125; kubectl-$&#123;1&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 重启 docker，并启动 kubelet</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"></span><br><span class="line">docker version</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WARNING</p>
<p>如果此时执行 systemctl status kubelet 命令，将得到 kubelet 启动失败的错误提示，请忽略此错误，因为必须完成后续步骤中 kubeadm init 的操作，kubelet 才能正常启动</p>
</blockquote>
<h1 id="初始化master节点"><a href="#初始化master节点" class="headerlink" title="初始化master节点"></a>初始化master节点</h1><blockquote>
<p>关于初始化时用到的环境变量</p>
</blockquote>
<ul>
<li>APISERVER_NAME 不能是 master 的 hostname</li>
<li>APISERVER_NAME 必须全为小写字母、数字、小数点，不能包含减号</li>
<li>POD_SUBNET 所使用的网段不能与 master节点/worker节点 所在的网段重叠。该字段的取值为一个 CIDR 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.1/16 命令，不做修改</li>
</ul>
<h2 id="快速初始化"><a href="#快速初始化" class="headerlink" title="快速初始化"></a>快速初始化</h2><p><strong>请将脚本最后的 1.19.6 替换成您需要的版本号</strong>， 脚本中间的 v1.19.x 不要替换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"><span class="meta">#</span> 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span><br><span class="line"><span class="meta">#</span> export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span><br><span class="line">export MASTER_IP=x.x.x.x</span><br><span class="line"><span class="meta">#</span> 替换 apiserver.demo 为 您想要的 dnsName</span><br><span class="line">export APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="meta">#</span> Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span><br><span class="line">export POD_SUBNET=10.100.0.1/16</span><br><span class="line">echo "$&#123;MASTER_IP&#125;    $&#123;APISERVER_NAME&#125;" &gt;&gt; /etc/hosts</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/init_master.sh | sh -s 1.19.6</span><br></pre></td></tr></table></figure>
<h2 id="手动初始化"><a href="#手动初始化" class="headerlink" title="手动初始化"></a>手动初始化</h2><blockquote>
<p>手动执行以下代码，结果与快速初始化相同。<strong>请将脚本第21行（已高亮）的 ${1} 替换成您需要的版本号，例如 1.19.6</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"><span class="meta">#</span> 替换 x.x.x.x 为 master 节点的内网IP</span><br><span class="line"><span class="meta">#</span> export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span><br><span class="line">export MASTER_IP=x.x.x.x</span><br><span class="line"><span class="meta">#</span> 替换 apiserver.demo 为 您想要的 dnsName</span><br><span class="line">export APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="meta">#</span> Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span><br><span class="line">export POD_SUBNET=10.100.0.1/16</span><br><span class="line">echo "$&#123;MASTER_IP&#125;    $&#123;APISERVER_NAME&#125;" &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 脚本出错时终止执行</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">if [ $&#123;#POD_SUBNET&#125; -eq 0 ] || [ $&#123;#APISERVER_NAME&#125; -eq 0 ]; then</span><br><span class="line">  echo -e "\033[31;1m请确保您已经设置了环境变量 POD_SUBNET 和 APISERVER_NAME \033[0m"</span><br><span class="line">  echo 当前POD_SUBNET=$POD_SUBNET</span><br><span class="line">  echo 当前APISERVER_NAME=$APISERVER_NAME</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看完整配置选项 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</span><br><span class="line">rm -f ./kubeadm-config.yaml</span><br><span class="line">cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v$&#123;1&#125;</span><br><span class="line">imageRepository: registry.aliyuncs.com/k8sxio</span><br><span class="line">controlPlaneEndpoint: "$&#123;APISERVER_NAME&#125;:6443"</span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: "10.96.0.0/16"</span><br><span class="line">  podSubnet: "$&#123;POD_SUBNET&#125;"</span><br><span class="line">  dnsDomain: "cluster.local"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> kubeadm init</span><br><span class="line"><span class="meta">#</span> 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span><br><span class="line">kubeadm config images pull --config=kubeadm-config.yaml</span><br><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置 kubectl</span><br><span class="line">rm -rf /root/.kube/</span><br><span class="line">mkdir /root/.kube/</span><br><span class="line">cp -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装 calico 网络插件</span><br><span class="line"><span class="meta">#</span> 参考文档 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span><br><span class="line">echo "安装calico-3.13.1"</span><br><span class="line">rm -f calico-3.13.1.yaml</span><br><span class="line">wget https://kuboard.cn/install-script/calico/calico-3.13.1.yaml</span><br><span class="line">kubectl apply -f calico-3.13.1.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>感谢 <a href="https://github.com/zhangguanzhang/google_containers" target="_blank" rel="noopener">https://github.com/zhangguanzhang/google_containers</a> (opens new window)提供最新的 google_containers 国内镜像</p>
</blockquote>
<h2 id="初始化如果出错请看"><a href="#初始化如果出错请看" class="headerlink" title="初始化如果出错请看"></a>初始化如果出错请看</h2><ul>
<li><p>请确保您的环境符合 <a href="https://kuboard.cn/install/install-k8s.html#安装docker及kubelet" target="_blank" rel="noopener">安装docker及kubelet</a> 中所有勾选框的要求</p>
</li>
<li><p>请确保您使用 root 用户执行初始化命令</p>
</li>
<li><p>不能下载 kubernetes 的 docker 镜像</p>
<ul>
<li><p>安装文档中，默认使用阿里云的 docker 镜像仓库，然而，有时候，该镜像会罢工</p>
</li>
<li><p>如碰到不能下载 docker 镜像的情况，请尝试手工初始化，并修改手工初始化脚本里的第22行（文档中已高亮）为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageRepository: gcr.azk8s.cn/google-containers</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>检查环境变量，执行如下命令</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo MASTER_IP=$&#123;MASTER_IP&#125; &amp;&amp; echo APISERVER_NAME=$&#123;APISERVER_NAME&#125; &amp;&amp; echo POD_SUBNET=$&#123;POD_SUBNET&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>请验证如下几点：<ul>
<li>环境变量 <strong><em>MASTER_IP</em></strong> 的值应该为 master 节点的 <strong>内网IP</strong>，如果不是，请重新 export</li>
<li><strong>APISERVER_NAME</strong> 不能是 master 的 hostname</li>
<li><strong>APISERVER_NAME</strong> 必须全为小写字母、数字、小数点，不能包含减号</li>
<li><strong>POD_SUBNET</strong> 所使用的网段不能与 <strong><em>master节点/worker节点</em></strong> 所在的网段重叠。该字段的取值为一个 <a href="https://kuboard.cn/glossary/cidr.html" target="_blank" rel="noopener">CIDR</a> 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.1/16 命令，不做修改</li>
</ul>
</li>
<li>重新初始化 master 节点前，请先执行 <code>kubeadm reset -f</code> 操作</li>
</ul>
<ul>
<li><p>ImagePullBackoff / Pending</p>
</li>
<li><p>如果 kubectl get pod -n kube-system -o wide 的输出结果中出现 ImagePullBackoff 或者长时间处于 Pending 的情况，请参考 查看镜像抓取进度</p>
</li>
<li><p>ContainerCreating</p>
</li>
<li><p>如果 kubectl get pod -n kube-system -o wide 的输出结果中某个 Pod 长期处于 ContainerCreating、PodInitializing 或 Init:0/3 的状态，可以尝试：</p>
<ul>
<li>查看该 Pod 的状态，例如：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
<p>如果输出结果中，最后一行显示的是 Pulling image，请耐心等待，或者参考 查看镜像抓取进度</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Normal  Pulling    44s   kubelet, k8s-worker-02  Pulling image "quay.io/coreos/flannel:v0.12.0-amd64"</span><br></pre></td></tr></table></figure>
<ul>
<li>将该 Pod 删除，系统会自动重建一个新的 Pod，例如：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="检查master初始化结果"><a href="#检查master初始化结果" class="headerlink" title="检查master初始化结果"></a>检查master初始化结果</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看 master 节点初始化结果</span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果出错请看</p>
</blockquote>
<ul>
<li><p>ImagePullBackoff / Pending</p>
<ul>
<li>如果 kubectl get pod -n kube-system -o wide的输出结果中出现 ImagePullBackoff 或者长时间处于 Pending 的情况，请参考 <a href="https://kuboard.cn/learning/faq/image-pull-backoff.html" target="_blank" rel="noopener">查看镜像抓取进度</a></li>
</ul>
</li>
<li><p>ContainerCreating</p>
<ul>
<li><p>如果kubectl get pod -n kube-system -o wide的输出结果中某个 Pod 长期处于 ContainerCreating、PodInitializing 或 Init:0/3 的状态，可以尝试：</p>
<ul>
<li><p>查看该 Pod 的状态，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
<p>如果输出结果中，最后一行显示的是 Pulling image，请耐心等待，或者参考查看镜像抓取进度</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">      Normal  Pulling    44s   kubelet, k8s-worker-02  Pulling image <span class="string">"quay.io/coreos/flannel:v0.12.0-amd64"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将该 Pod 删除，系统会自动重建一个新的 Pod，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="初始化worker节点"><a href="#初始化worker节点" class="headerlink" title="初始化worker节点"></a>初始化worker节点</h1><h2 id="获得join参数"><a href="#获得join参数" class="headerlink" title="获得join参数"></a>获得join参数</h2><p>在master节点上执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<p>可获取kubeadm join 命令及参数，如下所示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有效时间</p>
</blockquote>
<p>该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token 初始化任意数量的 worker 节点。</p>
<h2 id="worker节点执行初始化"><a href="#worker节点执行初始化" class="headerlink" title="worker节点执行初始化"></a>worker节点执行初始化</h2><p>针对所有的 worker 节点执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 worker 节点执行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换 x.x.x.x 为 master 节点的内网 IP</span></span><br><span class="line">export MASTER_IP=x.x.x.x</span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span></span><br><span class="line">export APISERVER_NAME=apiserver.demo</span><br><span class="line">echo "$&#123;MASTER_IP&#125;    $&#123;APISERVER_NAME&#125;" &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换为 master 节点上 kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>
<h2 id="检查初始化结果"><a href="#检查初始化结果" class="headerlink" title="检查初始化结果"></a>检查初始化结果</h2><p>在master节点上执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure></p>
<p>输出结果如下所示：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@demo-master-a-1 ~]# kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES    AGE     VERSION</span><br><span class="line">demo-master-a-1   Ready    master   5m3s    v1.19.x</span><br><span class="line">demo-worker-a-1   Ready    &lt;none&gt;   2m26s   v1.19.x</span><br><span class="line">demo-worker-a-2   Ready    &lt;none&gt;   3m56s   v1.19.x</span><br></pre></td></tr></table></figure></p>
<h2 id="常见错误原因"><a href="#常见错误原因" class="headerlink" title="常见错误原因"></a>常见错误原因</h2><p>经常在群里提问为什么 join 不成功的情况大致有这几种：</p>
<h3 id="worker-节点不能访问-apiserver"><a href="#worker-节点不能访问-apiserver" class="headerlink" title="worker 节点不能访问 apiserver"></a><strong>worker 节点不能访问 apiserver</strong></h3><p>在worker节点执行以下语句可验证worker节点是否能访问 apiserver</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -ik https://apiserver.demo:6443</span><br></pre></td></tr></table></figure>
<p>如果不能，请在 master 节点上验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -ik https://localhost:6443</span><br></pre></td></tr></table></figure>
<p>  正常输出结果如下所示：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Cache-Control: no-cache, private</span><br><span class="line">Content-Type: application/json</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">Date: Fri, 15 Nov 2019 04:34:40 GMT</span><br><span class="line">Content-Length: 233</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "kind": "Status",</span><br><span class="line">  "apiVersion": "v1",</span><br><span class="line">  "metadata": &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 可能原因</p>
<ul>
<li>如果 master 节点能够访问 apiserver、而 worker 节点不能，则请检查自己的网络设置<ul>
<li>/etc/hosts 是否正确设置？</li>
<li>是否有安全组或防火墙的限制？</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="worker-节点默认网卡"><a href="#worker-节点默认网卡" class="headerlink" title="worker 节点默认网卡"></a>worker 节点默认网卡</h3><p>   Kubelet使用的 IP 地址与 master 节点可互通（无需 NAT 映射），且没有防火墙、安全组隔离</p>
<p>如果你使用 vmware 或 virtualbox 创建虚拟机用于 K8S 学习，可以尝试 NAT 模式的网络，而不是桥接模式的网络</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><h3 id="移除worker节点并重试"><a href="#移除worker节点并重试" class="headerlink" title="移除worker节点并重试"></a>移除worker节点并重试</h3><blockquote>
<p>WARNING</p>
<p>正常情况下，您无需移除 worker 节点，如果添加到集群出错，您可以移除 worker 节点，再重新尝试添加  </p>
</blockquote>
<p>在准备移除的 worker 节点上执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 worker 节点执行</span></span><br><span class="line">kubeadm reset -f</span><br></pre></td></tr></table></figure>
<p>在 master 节点 demo-master-a-1 上执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>
<p>如果列表中没有您要移除的节点，则忽略下一个步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 只在 master 节点执行</span><br><span class="line">kubectl delete node demo-worker-x-x</span><br></pre></td></tr></table></figure>
<blockquote>
<p>TIP</p>
<ul>
<li>将 demo-worker-x-x 替换为要移除的 worker 节点的名字</li>
<li>worker 节点的名字可以通过在节点 demo-master-a-1 上执行 kubectl get nodes 命令获得</li>
</ul>
</blockquote>
<h1 id="安装Ingress-Controller"><a href="#安装Ingress-Controller" class="headerlink" title="安装Ingress Controller"></a>安装Ingress Controller</h1><h2 id="快速初始化-1"><a href="#快速初始化-1" class="headerlink" title="快速初始化"></a>快速初始化</h2><p><strong>在master节点上执行</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubectl apply -f https://kuboard.cn/install-script/v1.19.x/nginx-ingress.yaml</span><br></pre></td></tr></table></figure></p>
<p><strong>nginx-ingress.yaml内容</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"># 如果打算用于生产环境，请参考 https://github.com/nginxinc/kubernetes-ingress/blob/v1.5.5/docs/installation.md 并根据您自己的情况做进一步定制</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress </span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: default-server-secret</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2akNDQWFZQ0NRREFPRjl0THNhWFhEQU5CZ2txaGtpRzl3MEJBUXNGQURBaE1SOHdIUVlEVlFRRERCWk8KUjBsT1dFbHVaM0psYzNORGIyNTBjbTlzYkdWeU1CNFhEVEU0TURreE1qRTRNRE16TlZvWERUSXpNRGt4TVRFNApNRE16TlZvd0lURWZNQjBHQTFVRUF3d1dUa2RKVGxoSmJtZHlaWE56UTI5dWRISnZiR3hsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwvN2hIUEtFWGRMdjNyaUM3QlBrMTNpWkt5eTlyQ08KR2xZUXYyK2EzUDF0azIrS3YwVGF5aGRCbDRrcnNUcTZzZm8vWUk1Y2Vhbkw4WGM3U1pyQkVRYm9EN2REbWs1Qgo4eDZLS2xHWU5IWlg0Rm5UZ0VPaStlM2ptTFFxRlBSY1kzVnNPazFFeUZBL0JnWlJVbkNHZUtGeERSN0tQdGhyCmtqSXVuektURXUyaDU4Tlp0S21ScUJHdDEwcTNRYzhZT3ExM2FnbmovUWRjc0ZYYTJnMjB1K1lYZDdoZ3krZksKWk4vVUkxQUQ0YzZyM1lma1ZWUmVHd1lxQVp1WXN2V0RKbW1GNWRwdEMzN011cDBPRUxVTExSakZJOTZXNXIwSAo1TmdPc25NWFJNV1hYVlpiNWRxT3R0SmRtS3FhZ25TZ1JQQVpQN2MwQjFQU2FqYzZjNGZRVXpNQ0F3RUFBVEFOCkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWpLb2tRdGRPcEsrTzhibWVPc3lySmdJSXJycVFVY2ZOUitjb0hZVUoKdGhrYnhITFMzR3VBTWI5dm15VExPY2xxeC9aYzJPblEwMEJCLzlTb0swcitFZ1U2UlVrRWtWcitTTFA3NTdUWgozZWI4dmdPdEduMS9ienM3bzNBaS9kclkrcUI5Q2k1S3lPc3FHTG1US2xFaUtOYkcyR1ZyTWxjS0ZYQU80YTY3Cklnc1hzYktNbTQwV1U3cG9mcGltU1ZmaXFSdkV5YmN3N0NYODF6cFErUyt1eHRYK2VBZ3V0NHh3VlI5d2IyVXYKelhuZk9HbWhWNThDd1dIQnNKa0kxNXhaa2VUWXdSN0diaEFMSkZUUkk3dkhvQXprTWIzbjAxQjQyWjNrN3RXNQpJUDFmTlpIOFUvOWxiUHNoT21FRFZkdjF5ZytVRVJxbStGSis2R0oxeFJGcGZnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdi91RWM4b1JkMHUvZXVJTHNFK1RYZUprckxMMnNJNGFWaEMvYjVyYy9XMlRiNHEvClJOcktGMEdYaVN1eE9ycXgrajlnamx4NXFjdnhkenRKbXNFUkJ1Z1B0ME9hVGtIekhvb3FVWmcwZGxmZ1dkT0EKUTZMNTdlT1l0Q29VOUZ4amRXdzZUVVRJVUQ4R0JsRlNjSVo0b1hFTkhzbysyR3VTTWk2Zk1wTVM3YUhudzFtMApxWkdvRWEzWFNyZEJ6eGc2clhkcUNlUDlCMXl3VmRyYURiUzc1aGQzdUdETDU4cGszOVFqVUFQaHpxdmRoK1JWClZGNGJCaW9CbTVpeTlZTW1hWVhsMm0wTGZzeTZuUTRRdFFzdEdNVWozcGJtdlFmazJBNnljeGRFeFpkZFZsdmwKMm82MjBsMllxcHFDZEtCRThCay90elFIVTlKcU56cHpoOUJUTXdJREFRQUJBb0lCQVFDZklHbXowOHhRVmorNwpLZnZJUXQwQ0YzR2MxNld6eDhVNml4MHg4Mm15d1kxUUNlL3BzWE9LZlRxT1h1SENyUlp5TnUvZ2IvUUQ4bUFOCmxOMjRZTWl0TWRJODg5TEZoTkp3QU5OODJDeTczckM5bzVvUDlkazAvYzRIbjAzSkVYNzZ5QjgzQm9rR1FvYksKMjhMNk0rdHUzUmFqNjd6Vmc2d2szaEhrU0pXSzBwV1YrSjdrUkRWYmhDYUZhNk5nMUZNRWxhTlozVDhhUUtyQgpDUDNDeEFTdjYxWTk5TEI4KzNXWVFIK3NYaTVGM01pYVNBZ1BkQUk3WEh1dXFET1lvMU5PL0JoSGt1aVg2QnRtCnorNTZud2pZMy8yUytSRmNBc3JMTnIwMDJZZi9oY0IraVlDNzVWYmcydVd6WTY3TWdOTGQ5VW9RU3BDRkYrVm4KM0cyUnhybnhBb0dCQU40U3M0ZVlPU2huMVpQQjdhTUZsY0k2RHR2S2ErTGZTTXFyY2pOZjJlSEpZNnhubmxKdgpGenpGL2RiVWVTbWxSekR0WkdlcXZXaHFISy9iTjIyeWJhOU1WMDlRQ0JFTk5jNmtWajJTVHpUWkJVbEx4QzYrCk93Z0wyZHhKendWelU0VC84ajdHalRUN05BZVpFS2FvRHFyRG5BYWkyaW5oZU1JVWZHRXFGKzJyQW9HQkFOMVAKK0tZL0lsS3RWRzRKSklQNzBjUis3RmpyeXJpY05iWCtQVzUvOXFHaWxnY2grZ3l4b25BWlBpd2NpeDN3QVpGdwpaZC96ZFB2aTBkWEppc1BSZjRMazg5b2pCUmpiRmRmc2l5UmJYbyt3TFU4NUhRU2NGMnN5aUFPaTVBRHdVU0FkCm45YWFweUNweEFkREtERHdObit3ZFhtaTZ0OHRpSFRkK3RoVDhkaVpBb0dCQUt6Wis1bG9OOTBtYlF4VVh5YUwKMjFSUm9tMGJjcndsTmVCaWNFSmlzaEhYa2xpSVVxZ3hSZklNM2hhUVRUcklKZENFaHFsV01aV0xPb2I2NTNyZgo3aFlMSXM1ZUtka3o0aFRVdnpldm9TMHVXcm9CV2xOVHlGanIrSWhKZnZUc0hpOGdsU3FkbXgySkJhZUFVWUNXCndNdlQ4NmNLclNyNkQrZG8wS05FZzFsL0FvR0FlMkFVdHVFbFNqLzBmRzgrV3hHc1RFV1JqclRNUzRSUjhRWXQKeXdjdFA4aDZxTGxKUTRCWGxQU05rMXZLTmtOUkxIb2pZT2pCQTViYjhibXNVU1BlV09NNENoaFJ4QnlHbmR2eAphYkJDRkFwY0IvbEg4d1R0alVZYlN5T294ZGt5OEp0ek90ajJhS0FiZHd6NlArWDZDODhjZmxYVFo5MWpYL3RMCjF3TmRKS2tDZ1lCbyt0UzB5TzJ2SWFmK2UwSkN5TGhzVDQ5cTN3Zis2QWVqWGx2WDJ1VnRYejN5QTZnbXo5aCsKcDNlK2JMRUxwb3B0WFhNdUFRR0xhUkcrYlNNcjR5dERYbE5ZSndUeThXczNKY3dlSTdqZVp2b0ZpbmNvVlVIMwphdmxoTUVCRGYxSjltSDB5cDBwWUNaS2ROdHNvZEZtQktzVEtQMjJhTmtsVVhCS3gyZzR6cFE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-config</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">data:</span><br><span class="line">  server-names-hash-bucket-size: &quot;1024&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - update</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;extensions&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - k8s.nginx.org</span><br><span class="line">  resources:</span><br><span class="line">  - virtualservers</span><br><span class="line">  - virtualserverroutes</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">    prometheus.io/port: &quot;9113&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ingress</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ingress</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nginx-ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx/nginx-ingress:1.5.5</span><br><span class="line">        name: nginx-ingress</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: https</span><br><span class="line">          containerPort: 443</span><br><span class="line">          hostPort: 443</span><br><span class="line">        - name: prometheus</span><br><span class="line">          containerPort: 9113</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        args:</span><br><span class="line">          - -nginx-configmaps=$(POD_NAMESPACE)/nginx-config</span><br><span class="line">          - -default-server-tls-secret=$(POD_NAMESPACE)/default-server-secret</span><br><span class="line">         #- -v=3 # Enables extensive logging. Useful for troubleshooting.</span><br><span class="line">         #- -report-ingress-status</span><br><span class="line">         #- -external-service=nginx-ingress</span><br><span class="line">         #- -enable-leader-election</span><br><span class="line">          - -enable-prometheus-metrics</span><br><span class="line">         #- -enable-custom-resources</span><br></pre></td></tr></table></figure></p>
<p><strong>卸载ingress congroller</strong></p>
<p>在master节点上执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#只在 master 节点执行</span><br><span class="line">kubectl delete -f https://kuboard.cn/install-script/v1.19.x/nginx-ingress.yaml</span><br></pre></td></tr></table></figure>
<p><strong>配置域名解析</strong></p>
<p>将域名 *.demo.yourdomain.com 解析到 demo-worker-a-2 的 IP 地址 z.z.z.z （也可以是 demo-worker-a-1 的地址 y.y.y.y）</p>
<p><strong>验证配置</strong></p>
<p>在浏览器访问 a.demo.yourdomain.com，将得到 404 NotFound 错误页面</p>
<blockquote>
<p>提示</p>
</blockquote>
<p>许多初学者在安装 Ingress Controller 时会碰到问题，请不要灰心，可暂时跳过 安装 Ingress Controller 这个部分，等您学完 www.kuboard.cn 上 Kubernetes 入门 以及 通过互联网访问您的应用程序 这两部分内容后，再来回顾 Ingress Controller 的安装。</p>
<p>也可以参考 Install Nginx Ingress</p>
<h1 id="问题及注意"><a href="#问题及注意" class="headerlink" title="问题及注意"></a>问题及注意</h1><h2 id="重启Kubenetes集群后遇到的问题"><a href="#重启Kubenetes集群后遇到的问题" class="headerlink" title="重启Kubenetes集群后遇到的问题"></a>重启Kubenetes集群后遇到的问题</h2><p>Kubernetes集群的设计目标是setup-and-run-forever，然而许多学习者使用自己笔记本上的虚拟机安装K8S集群用于学习，这就必然会出现反复重启集群所在虚拟机的情况。本文针对重启后会出现一些的一些令人困惑的问题做了解释。</p>
<ul>
<li><p>Worker节点不能启动<br>Master 节点的 IP 地址变化，导致 worker 节点不能启动。请重装集群，并确保所有节点都有固定内网 IP 地址。</p>
</li>
<li><p>许多Pod一直Crash或不能正常访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>重启后会发现许多 Pod 不在 Running 状态，此时，请使用如下命令删除这些状态不正常的 Pod。通常，您的 Pod 如果是使用 Deployment、StatefulSet 等控制器创建的，kubernetes 将创建新的 Pod 作为替代，重新启动的 Pod 通常能够正常工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod &lt;pod-name&gt; -n &lt;pod-namespece&gt;</span><br></pre></td></tr></table></figure>
<h2 id="安装过程中的问题"><a href="#安装过程中的问题" class="headerlink" title="安装过程中的问题"></a>安装过程中的问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory</span><br><span class="line">sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.all.forwarding = 1</span><br></pre></td></tr></table></figure>
<p>解决办法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure></p>
<p>查看版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl version</span><br></pre></td></tr></table></figure></p>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><p>怎么查看可安装的docker版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates|sort -r</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://kuboard.cn/install/install-k8s.html#%E6%A3%80%E6%9F%A5-centos-hostname" target="_blank" rel="noopener">https://kuboard.cn/install/install-k8s.html#%E6%A3%80%E6%9F%A5-centos-hostname</a><br><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2020/03/15/afka安装及入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/15/afka安装及入门/" itemprop="url">Kafka安装及入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-15T12:38:24+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/15/afka安装及入门/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/15/afka安装及入门/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  494
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="下载kafka-cmak"><a href="#下载kafka-cmak" class="headerlink" title="下载kafka,cmak"></a>下载kafka,cmak</h1><p>下载好后，分别解压到/opt目录下</p>
<p>这里如果是单机kafka，可以直接用kafka自带的,启动方式为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./$KAFKA_HOME/bin/zookeeper-server-start.sh -daemon config/zookeeper.properties</span><br></pre></td></tr></table></figure></p>
<h1 id="配置kafka"><a href="#配置kafka" class="headerlink" title="配置kafka"></a>配置kafka</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">broker.id=0</span><br><span class="line">log.dirs=/tmp/kafka-logs</span><br><span class="line">zookeeper.connect=localhost:2181</span><br></pre></td></tr></table></figure>
<blockquote>
<p>大多数情况下，可能会改动的估计就是上述3个配置，由于kafka需要做持久化消息，故这里有一个log.dirs的配置项</p>
</blockquote>
<h1 id="启动kafka"><a href="#启动kafka" class="headerlink" title="启动kafka"></a>启动kafka</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ./bin/kafka-server-start.sh -daemon config/server.properties</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不加-daemon则是前台启动，若是在docker中启动，就不用加-daemon</p>
</blockquote>
<h1 id="cmak-kafka-manager"><a href="#cmak-kafka-manager" class="headerlink" title="cmak(kafka manager)"></a>cmak(kafka manager)</h1><p><strong>依赖的组件说明</strong></p>
<p>cmak 3.x需要依赖jdk 11+ 且zookeeper需要3.5.x版本,我直接用了es 7.x的自带jdk13</p>
<p>所以修改了cmak启动脚本get_java_cmd函数:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Detect if we should use JAVA_HOME or just try PATH.</span><br><span class="line">get_java_cmd() &#123;</span><br><span class="line"><span class="meta">  #</span> High-priority override for Jlink images</span><br><span class="line"><span class="meta">  #</span>if [[ -n "$bundled_jvm" ]];  then</span><br><span class="line"><span class="meta">  #</span>  echo "$bundled_jvm/bin/java"</span><br><span class="line"><span class="meta">  #</span>elif [[ -n "$JAVA_HOME" ]] &amp;&amp; [[ -x "$JAVA_HOME/bin/java" ]];  then</span><br><span class="line"><span class="meta">  #</span>  echo "$JAVA_HOME/bin/java"</span><br><span class="line"><span class="meta">  #</span>else</span><br><span class="line"><span class="meta">  #</span>  echo "java"</span><br><span class="line"><span class="meta">  #</span>fi</span><br><span class="line">  echo "/opt/elasticsearch-7.6.1/jdk/bin/java"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>修改配置</strong><br>修改conf/application.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kafka-manager.zkhosts=&quot;localhost:2181&quot;</span><br><span class="line">kafka-manager.zkhosts=$&#123;?ZK_HOSTS&#125;</span><br><span class="line">cmak.zkhosts=&quot;localhost:2181&quot;</span><br><span class="line">cmak.zkhosts=$&#123;?ZK_HOSTS&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然也可以不修改application.conf文件，而是提供环境变量ZK_HOSTS</p>
</blockquote>
<p><strong>启动cmak</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/cmak &gt; cmak.out 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p><strong>添加集群</strong></p>
<p>点添加集群（Add Cluster）<br><img src="/images/pasted-36.png" alt="upload successful"></p>
<p>填写集群名称与zookeeper地址<br><img src="/images/pasted-37.png" alt="upload successful"></p>
<p>添加完成查看集群信息，包括zookeepers连接地址，kafka版本，topic数量，broker数量<br><img src="/images/pasted-38.png" alt="upload successful"></p>
<p><strong>查看broker信息</strong></p>
<p><img src="/images/pasted-42.png" alt="upload successful"></p>
<p><strong>查看、操作topic</strong></p>
<p>之前已经创建过first-topic，topics列表就可以看到了<br><img src="/images/pasted-39.png" alt="upload successful"></p>
<p>给topic增加分区</p>
<p><img src="/images/pasted-40.png" alt="upload successful"></p>
<p>创建topic<br><img src="/images/pasted-41.png" alt="upload successful"></p>
<p>PS:更多cmak的功能有待实践</p>
<p><strong>常见错误</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This application is already running (Or delete /opt/kafka-cmak-3.0.0.4/RUNNING_PID file).</span><br></pre></td></tr></table></figure></p>
<p>删掉RUNNING_PID重新启动</p>
<h1 id="Kafka入门"><a href="#Kafka入门" class="headerlink" title="Kafka入门"></a>Kafka入门</h1><p><strong>创建Topic</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/opt/kafka_2.12-2.4.0# ./bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic first-topic</span><br><span class="line">Created topic first-topic.</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://segmentfault.com/a/1190000012730949" target="_blank" rel="noopener">https://segmentfault.com/a/1190000012730949</a><br><a href="https://blog.wolfogre.com/posts/kafka-manager-download/" target="_blank" rel="noopener">https://blog.wolfogre.com/posts/kafka-manager-download/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2020/03/07/ElasticSearch7-x集群安装部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/ElasticSearch7-x集群安装部署/" itemprop="url">ElasticSearch7.x集群安装部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T20:46:29+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/07/ElasticSearch7-x集群安装部署/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/07/ElasticSearch7-x集群安装部署/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,367
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd es &amp;&amp; useradd es -g es -M -s /bin/bash</span><br><span class="line">chown -R es:es /opt/$ES_HOME</span><br></pre></td></tr></table></figure>
<h1 id="系统参数修改"><a href="#系统参数修改" class="headerlink" title="系统参数修改"></a>系统参数修改</h1><ul>
<li>vi /etc/sysctl.conf添加如下配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使得重启之后也生效，即永久生效</p>
</blockquote>
<p> 执行如下命令使得立即生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl –p</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改/etc/security/limits.conf添加以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">es hard nofile 65535</span><br><span class="line">es soft nofile 65535</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/systemd/user.conf和/etc/systemd/system.conf分别添加以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DefaultLimitNOFILE=65535</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>systemd启动elasticsearch，需要设置这两个文件，否则启动会报如下错误<br>[1] bootstrap checks failed<br>[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</p>
</blockquote>
<h1 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf elasticsearch-7.6.1-linux-x86_64.tar.gz -C /opt/</span><br></pre></td></tr></table></figure>
<h1 id="配置ES"><a href="#配置ES" class="headerlink" title="配置ES"></a>配置ES</h1><p>1主2从的配置</p>
<ul>
<li>node-1</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster.name:</span> <span class="string">my-es</span></span><br><span class="line"></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-1</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.131</span></span><br><span class="line"></span><br><span class="line"><span class="string">discovery.seed_hosts:</span> <span class="string">[</span> <span class="string">"192.168.56.132"</span><span class="string">,"192.168.56.133"]</span></span><br><span class="line"><span class="string">cluster.initial_master_nodes:</span> <span class="string">["node-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域，elastic header需要</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>node-2</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster.name:</span> <span class="string">my-es</span></span><br><span class="line"></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-2</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.132</span></span><br><span class="line"></span><br><span class="line"><span class="string">discovery.seed_hosts:</span> <span class="string">["192.168.56.131","192.168.56.133"]</span></span><br><span class="line"></span><br><span class="line"><span class="string">cluster.initial_master_nodes:</span> <span class="string">["node-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域，elastic header需要</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>node-3</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster.name:</span> <span class="string">my-es</span></span><br><span class="line"></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-3</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.133</span></span><br><span class="line"></span><br><span class="line"><span class="string">discovery.seed_hosts:</span> <span class="string">["192.168.56.131",</span> <span class="string">"192.168.56.132"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">cluster.initial_master_nodes:</span> <span class="string">["node-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域，elastic header需要</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>生产环境建议network.host: 指定IP</p>
</blockquote>
<h1 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://192.168.56.131:9200/_cluster/health?pretty</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">cluster_name: "my-es",</span><br><span class="line">status: "green",</span><br><span class="line">timed_out: false,</span><br><span class="line">number_of_nodes: 3,</span><br><span class="line">number_of_data_nodes: 3,</span><br><span class="line">active_primary_shards: 0,</span><br><span class="line">active_shards: 0,</span><br><span class="line">relocating_shards: 0,</span><br><span class="line">initializing_shards: 0,</span><br><span class="line">unassigned_shards: 0,</span><br><span class="line">delayed_unassigned_shards: 0,</span><br><span class="line">number_of_pending_tasks: 0,</span><br><span class="line">number_of_in_flight_fetch: 0,</span><br><span class="line">task_max_waiting_in_queue_millis: 0,</span><br><span class="line">active_shards_percent_as_number: 100</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="开机启动ElasticSearch"><a href="#开机启动ElasticSearch" class="headerlink" title="开机启动ElasticSearch"></a>开机启动ElasticSearch</h1><p><strong>方案一 在/etc/init.d目录下</strong></p>
<p>创建名为elasticsearch的文件，内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line"><span class="meta">#</span>description: elasticsearch</span><br><span class="line"><span class="meta">#</span>## BEGIN INIT INFO</span><br><span class="line"><span class="meta">#</span> Provides:          elasticsearch</span><br><span class="line"><span class="meta">#</span> Required-Start:    $all</span><br><span class="line"><span class="meta">#</span> Required-Stop:</span><br><span class="line"><span class="meta">#</span> Default-Start:     2 3 4 5</span><br><span class="line"><span class="meta">#</span> Default-Stop:</span><br><span class="line"><span class="meta">#</span> Short-Description: start elasticsearch</span><br><span class="line"><span class="meta">#</span>## END INIT INFO</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">case "$1" in</span><br><span class="line">start)</span><br><span class="line">    cd /opt/elasticsearch-7.6.1</span><br><span class="line">    ./bin/elasticsearch -d</span><br><span class="line">!</span><br><span class="line">    echo "elasticsearch startup"</span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep -v 'grep elasticsearch' | awk '&#123;print $2&#125;'`</span><br><span class="line">    kill -9 $es_pid</span><br><span class="line">    echo "elasticsearch stopped"</span><br><span class="line">    ;;</span><br><span class="line">restart)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep -v 'grep elasticsearch' | awk '&#123;print $2&#125;'`</span><br><span class="line">    kill -9 $es_pid</span><br><span class="line">    echo "elasticsearch stopped"</span><br><span class="line">    cd /opt/elasticsearch-7.6.1</span><br><span class="line">    ./bin/elasticsearch -d</span><br><span class="line">!</span><br><span class="line">    echo "elasticsearch startup"</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    echo "start|stop|restart"</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">exit $?</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> chmod a+x elasticsearch.sh</span><br></pre></td></tr></table></figure>
<p><strong>方案二 在/lib/systemd/system目录下</strong></p>
<p>创建名为elasticsearch.service的文件，内容如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=elasticsearch</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/bin/bash /opt/elasticsearch-7.6.1/bin/elasticsearch</span><br><span class="line">Restart=always</span><br><span class="line">User=es</span><br><span class="line">Group=es</span><br><span class="line">WorkingDirectory=/opt/elasticsearch-7.6.1</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=mutil-user.target</span><br></pre></td></tr></table></figure></p>
<p>重载配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure></p>
<p>启用服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo systemctl enable elasticsearch</span><br></pre></td></tr></table></figure></p>
<p>启动服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo systemctl start elasticsearch</span><br></pre></td></tr></table></figure></p>
<p>如果启动失败，想看下日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看状态</span><br><span class="line"><span class="meta">$</span> sudo systemctl status elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看日志</span><br><span class="line"><span class="meta">$</span> sudo journalctl -u elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 实时输出最新日志</span><br><span class="line"><span class="meta">$</span> sudo journalctl --follow -u elasticsearch</span><br></pre></td></tr></table></figure>
<p>通过systemctl 启动服务报如下错误<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: ERROR: [1] bootstrap checks failed</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: ERROR: Elasticsearch did not exit normally - check the logs at /opt/elasticsearch-7.6.1/logs/my-es.log</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,352][INFO ][o.e.n.Node               ] [node-1] stopping ...</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,462][INFO ][o.e.n.Node               ] [node-1] stopped</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,463][INFO ][o.e.n.Node               ] [node-1] closing ...</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,535][INFO ][o.e.n.Node               ] [node-1] closed</span><br></pre></td></tr></table></figure></p>
<p><em>划重点：通过systemctrl自建elasticsearch系统服务的形式来启动的es,则需要修改/etc/systemd/user.conf,/etc/systemd/system.conf这两个文件，添加以下配置</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DefaultLimitNOFILE=65536</span><br></pre></td></tr></table></figure></p>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">org.elasticsearch.bootstrap.StartupException: java.lang.RuntimeException: can not run elasticsearch as root</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">174</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:<span class="number">161</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:<span class="number">86</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">125</span>) ~[elasticsearch-cli-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:<span class="number">90</span>) ~[elasticsearch-cli-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">126</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">92</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">Caused by: java.lang.RuntimeException: can not run elasticsearch as root</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:<span class="number">105</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:<span class="number">172</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:<span class="number">349</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">170</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br></pre></td></tr></table></figure>
<p>这个是最常见的了，不能用root用户来启动elasticsearch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> org.elasticsearch.bootstrap.BootstrapException: java.nio.file.AccessDeniedException: /opt/elasticsearch-<span class="number">7.6</span>.1/config/elasticsearch.keystore</span><br><span class="line">Likely root cause: java.nio.file.AccessDeniedException: /opt/elasticsearch-<span class="number">7.6</span>.1/config/elasticsearch.keystore</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:<span class="number">90</span>)</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:<span class="number">111</span>)</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:<span class="number">116</span>)</span><br><span class="line">	at java.base/sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:<span class="number">219</span>)</span><br><span class="line">	at java.base/java.nio.file.Files.newByteChannel(Files.java:<span class="number">374</span>)</span><br><span class="line">	at java.base/java.nio.file.Files.newByteChannel(Files.java:<span class="number">425</span>)</span><br><span class="line">	at org.apache.lucene.store.SimpleFSDirectory.openInput(SimpleFSDirectory.java:<span class="number">77</span>)</span><br><span class="line">	at org.elasticsearch.common.settings.KeyStoreWrapper.load(KeyStoreWrapper.java:<span class="number">219</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.loadSecureSettings(Bootstrap.java:<span class="number">234</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:<span class="number">305</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">170</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:<span class="number">161</span>)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:<span class="number">86</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">125</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:<span class="number">90</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">126</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">92</span>)</span><br></pre></td></tr></table></figure>
<p>处理方法 chown -R es:es $ES_HOME/conf</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">2020-03-07 14:50:20,774 main ERROR Unable to invoke factory method in class org.apache.logging.log4j.core.appender.RollingFileAppender for element RollingFile: java.lang.IllegalStateException: No factory method found for class org.apache.logging.log4j.core.appender.RollingFileAppender java.lang.IllegalStateException: No factory method found for class org.apache.logging.log4j.core.appender.RollingFileAppender</span><br><span class="line">	at org.apache.logging.log4j.core.config.plugins.util.PluginBuilder.findFactoryMethod(PluginBuilder.java:<span class="number">235</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.plugins.util.PluginBuilder.build(PluginBuilder.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.createPluginObject(AbstractConfiguration.java:<span class="number">959</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.createConfiguration(AbstractConfiguration.java:<span class="number">899</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.createConfiguration(AbstractConfiguration.java:<span class="number">891</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.doConfigure(AbstractConfiguration.java:<span class="number">514</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.initialize(AbstractConfiguration.java:<span class="number">238</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.start(AbstractConfiguration.java:<span class="number">250</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.LoggerContext.setConfiguration(LoggerContext.java:<span class="number">547</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:<span class="number">263</span>)</span><br><span class="line">	at org.elasticsearch.common.logging.LogConfigurator.configure(LogConfigurator.java:<span class="number">234</span>)</span><br><span class="line">	at org.elasticsearch.common.logging.LogConfigurator.configure(LogConfigurator.java:<span class="number">127</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:<span class="number">310</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">170</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:<span class="number">161</span>)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:<span class="number">86</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">125</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:<span class="number">90</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">126</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">92</span>)</span><br></pre></td></tr></table></figure>
<p>处理方法 chown -R es:es $ES_HOME/logs</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2020</span>-<span class="number">03</span>-<span class="number">07</span>T14:<span class="number">11</span>:<span class="number">03</span>,<span class="number">119</span>][WARN ][o.e.c.c.Coordinator      ] [node-<span class="number">1</span>] failed to validate incoming join request from node [&#123;node-<span class="number">2</span>&#125;&#123;OTFjHR3wRuyQBMbb9PdGoQ&#125;&#123;GH_dXyYZQIuyjnnBTsELRw&#125;&#123;<span class="number">192.168</span>.56.132&#125;&#123;<span class="number">192.168</span>.56.132:<span class="number">9300</span>&#125;&#123;dil&#125;&#123;ml.machine_memory=<span class="number">3665874944</span>, ml.max_open_jobs=<span class="number">20</span>, xpack.installed=<span class="keyword">true</span>&#125;]</span><br><span class="line">org.elasticsearch.transport.RemoteTransportException: [node-<span class="number">2</span>][<span class="number">192.168</span>.56.132:<span class="number">9300</span>][internal:cluster/coordination/join/validate]</span><br><span class="line">Caused by: org.elasticsearch.cluster.coordination.CoordinationStateRejectedException: join validation on cluster state with a different cluster uuid of6I6UasSd209Y_5-YdZ2A than local cluster uuid <span class="number">4</span>jifFlHcR9K7wQflerzo3g, rejecting</span><br><span class="line">	at org.elasticsearch.cluster.coordination.JoinHelper.lambda$<span class="keyword">new</span>$<span class="number">4</span>(JoinHelper.java:<span class="number">148</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$<span class="number">1</span>.doRun(SecurityServerTransportInterceptor.java:<span class="number">257</span>) ~[?:?]</span><br><span class="line">	at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:<span class="number">37</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:<span class="number">315</span>) ~[?:?]</span><br><span class="line">	at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:<span class="number">63</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.transport.InboundHandler$RequestHandler.doRun(InboundHandler.java:<span class="number">264</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:<span class="number">692</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:<span class="number">37</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1128</span>) [?:?]</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">628</span>) [?:?]</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">830</span>) [?:?]</span><br></pre></td></tr></table></figure>
<p>如果集群所有节点cluster.name设置都一样的，但还是报以上错误，可以将集群内的节点的data目录删掉后重启</p>
<h1 id="附加"><a href="#附加" class="headerlink" title="附加"></a>附加</h1><p>目前es没有桌面客户端，不过elasticsearch-head算是比较方便的，用于快速查询下数据。<br>这里我就给出elastic-head，systemd服务的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=elasticsearch head</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Environment=PATH=/opt/node-v12.16.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">ExecStart=/opt/node-v12.16.1/bin/npm run start</span><br><span class="line">Restart=always</span><br><span class="line">User=es</span><br><span class="line">Group=es</span><br><span class="line">WorkingDirectory=/opt/elasticsearch-head</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=mutil-user.target</span><br></pre></td></tr></table></figure>
<blockquote>
<p>请事先安装好node环境，并在/opt/elasticsearch-head目录，执行好npm i -V安装好相关module</p>
</blockquote>
<p>执行如下命令，下次就能开机启动了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">$</span> systemctl enable elasticsearch-head</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docker.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docker.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html</a><br><a href="https://www.linuxtechi.com/set-ulimit-file-descriptors-limit-linux-servers/" target="_blank" rel="noopener">https://www.linuxtechi.com/set-ulimit-file-descriptors-limit-linux-servers/</a><br><a href="https://askubuntu.com/questions/1102512/set-ulimit-for-non-root-user" target="_blank" rel="noopener">https://askubuntu.com/questions/1102512/set-ulimit-for-non-root-user</a><br><a href="https://superuser.com/questions/1200539/cannot-increase-open-file-limit-past-4096-ubuntu/1200818#1200818" target="_blank" rel="noopener">https://superuser.com/questions/1200539/cannot-increase-open-file-limit-past-4096-ubuntu/1200818#1200818</a><br><a href="http://www.ruanyifeng.com/blog/2018/03/systemd-timer.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2018/03/systemd-timer.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2019/12/02/何构建SpringBoot应用的Docker镜像/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/02/何构建SpringBoot应用的Docker镜像/" itemprop="url">如何构建SpringBoot应用的Docker镜像</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-02T20:57:36+08:00">
                2019-12-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/02/何构建SpringBoot应用的Docker镜像/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/12/02/何构建SpringBoot应用的Docker镜像/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,990
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>title: 如何构建SpringBoot应用的Docker镜像<br>date: 2019-12-04 22:17:54<br>categories: </p>
<ul>
<li>SpringBoot<br>tags:</li>
<li>Docker</li>
<li>SpringBoot</li>
</ul>
<hr>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>SpringBoot大道其行，微服务也是大道其行，越来越多的SpringBoot应用使用Docker容器来运行。既然要用Docker容器运行，那首先得把SpringBoot应用打包成Docker镜像。</p>
<h1 id="构建方法"><a href="#构建方法" class="headerlink" title="构建方法"></a>构建方法</h1><p>目前主要的方法有三种：</p>
<ul>
<li>1.使用dockerfile-maven-plugin插件构建</li>
<li>2.使用Google Jib插件构建</li>
<li>3.手动构建</li>
</ul>
<p>下面我们一一来介绍，首先来介绍</p>
<h2 id="使用dockerfile-maven-plugin插件构建"><a href="#使用dockerfile-maven-plugin插件构建" class="headerlink" title="使用dockerfile-maven-plugin插件构建"></a>使用dockerfile-maven-plugin插件构建</h2><p>项目地址：<a href="https://github.com/spotify/dockerfile-maven" target="_blank" rel="noopener">https://github.com/spotify/dockerfile-maven</a></p>
<h3 id="项目根目录下创建Dockerfile"><a href="#项目根目录下创建Dockerfile" class="headerlink" title="项目根目录下创建Dockerfile"></a>项目根目录下创建Dockerfile</h3><blockquote>
<blockquote>
<p>以下给出了多个Dockerfile，根据实际情况选择</p>
</blockquote>
</blockquote>
<ol>
<li><p>简洁版</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> jaychang &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="bash">ARG FILE</span></span><br><span class="line"><span class="bash">ARG APP_NAME</span></span><br><span class="line"><span class="bash">ADD <span class="variable">$&#123;FILE&#125;</span> /app.jar</span></span><br><span class="line"><span class="bash">ENV JAVA_OPTS=<span class="string">"-XX:MaxRAMFraction=2"</span></span></span><br><span class="line"><span class="bash"><span class="comment"># Configure ustc alpine software source and timezone</span></span></span><br><span class="line"><span class="bash">RUN sed -i <span class="string">"s#http://dl-cdn.alpinelinux.org#https://mirrors.aliyun.com#g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br><span class="line"><span class="bash"><span class="comment"># To reduce Tomcat startup time we added a system property pointing to "/dev/urandom" as a source of entropy.</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"sh"</span>,<span class="string">"-c"</span>,<span class="string">"java <span class="variable">$JAVA_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar app.jar"</span>]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>有带-D的参数</p>
</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> jaychang &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="bash">ARG FILE</span></span><br><span class="line"><span class="bash">ARG APP_NAME</span></span><br><span class="line"><span class="bash">ADD <span class="variable">$&#123;FILE&#125;</span> /app.jar</span></span><br><span class="line"><span class="bash"><span class="comment"># PINPOINT_VERSION Default 1.6.2 it can be replaced at docker run use -e or docker service -e or environment in docker-compose.yml</span></span></span><br><span class="line"><span class="bash">ENV PINPOINT_VERSION=1.6.2</span></span><br><span class="line"><span class="bash">ENV JAVA_OPTS=<span class="string">"-XX:MaxRAMFraction=2"</span></span></span><br><span class="line"><span class="bash">ENV PINPOINT_OPTS=<span class="string">"-Dpinpoint.agentId=<span class="variable">$&#123;APP_NAME&#125;</span> -Dpinpoint.applicationName=<span class="variable">$APP_NAME</span>"</span></span></span><br><span class="line"><span class="bash"><span class="comment"># Configure ustc alpine software source and timezone</span></span></span><br><span class="line"><span class="bash">RUN sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br><span class="line"><span class="bash"><span class="comment"># To reduce Tomcat startup time we added a system property pointing to "/dev/urandom" as a source of entropy.</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"sh"</span>,<span class="string">"-c"</span>,<span class="string">"java <span class="variable">$JAVA_OPTS</span> -javaagent:/pinpoint_data/pinpoint-agent-<span class="variable">$&#123;PINPOINT_VERSION&#125;</span>/pinpoint-bootstrap-<span class="variable">$PINPOINT_VERSION</span>.jar <span class="variable">$PINPOINT_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar app.jar"</span>]</span></span><br></pre></td></tr></table></figure>
<ol>
<li>带字体版<blockquote>
<p>常见的场景如excel导出，验证码</p>
</blockquote>
</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> jaychang &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="bash">ARG FILE</span></span><br><span class="line"><span class="bash">ARG APP_NAME</span></span><br><span class="line"><span class="bash">ADD <span class="variable">$&#123;FILE&#125;</span> /app.jar</span></span><br><span class="line"><span class="bash">ENV JAVA_OPTS=<span class="string">"-XX:MaxRAMFraction=2"</span></span></span><br><span class="line"><span class="bash"><span class="comment"># Configure ustc alpine software source and timezone</span></span></span><br><span class="line"><span class="bash">RUN sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cahce add font-adobe-100dpi ttf-dejavu fontconfig \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br><span class="line"><span class="bash"><span class="comment"># To reduce Tomcat startup time we added a system property pointing to "/dev/urandom" as a source of entropy.</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"sh"</span>,<span class="string">"-c"</span>,<span class="string">"java <span class="variable">$JAVA_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar app.jar"</span>]</span></span><br></pre></td></tr></table></figure>
<h3 id="在pom-xml中配置maven插件"><a href="#在pom-xml中配置maven插件" class="headerlink" title="在pom.xml中配置maven插件"></a>在pom.xml中配置maven插件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>build-image<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>tag-image-version<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>tag<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>tag-image-latest<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>tag<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">FILE</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">APP_NAME</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">APP_NAME</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>docker.image.prefix可以预先在properties标签中定义好，如果要区分不同环境传到不同的镜像中心可使用profiles标签来定义不同环境的docker.image.prefix</p>
</blockquote>
<h3 id="开始构建镜像"><a href="#开始构建镜像" class="headerlink" title="开始构建镜像"></a>开始构建镜像</h3><p>前提是要先安装好docker服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -Dmaven.test.skip=true -U</span><br></pre></td></tr></table></figure>
<h2 id="使用Google-Jib插件构建"><a href="#使用Google-Jib插件构建" class="headerlink" title="使用Google Jib插件构建"></a>使用Google Jib插件构建</h2><p>项目地址：<a href="https://github.com/GoogleContainerTools/jib" target="_blank" rel="noopener">https://github.com/GoogleContainerTools/jib</a></p>
<p>Google Jib的优势是无需事先安装docker，无需定义Dockerfile文件，而且Google Jib可以分层,依赖的jar构成一层，resource构成一层，然后项目本身的classes构建一层。这样如果只是改变项目本身代码，那么构建是非常快的。且推送的镜像也是非常小的，可以大大节省网络流量。</p>
<h3 id="在pom-xml中配置maven插件-1"><a href="#在pom-xml中配置maven插件-1" class="headerlink" title="在pom.xml中配置maven插件"></a>在pom.xml中配置maven插件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">					<span class="comment">&lt;!-- other annotation processors --&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">compilerArg</span>&gt;</span>-Amapstruct.defaultComponentModel=default<span class="tag">&lt;/<span class="name">compilerArg</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">compilerArg</span>&gt;</span>-Amapstruct.unmappedTargetPolicy=WARN<span class="tag">&lt;/<span class="name">compilerArg</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.cloud.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jib-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">from</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>harbor.chaomeifan.com/library/openjdk:8-jdk-alpine-v1<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">allowInsecureRegistries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">allowInsecureRegistries</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">to</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">tags</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">container</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class="tag">&lt;/<span class="name">creationTime</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">environment</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">PINPOINT_VERSION</span>&gt;</span>1.8.4<span class="tag">&lt;/<span class="name">PINPOINT_VERSION</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">PINPOINT_OPTS</span>&gt;</span>-Dpinpoint.agentId=$&#123;project.artifactId&#125; -Dpinpoint.applicationName=$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">PINPOINT_OPTS</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">NACOS_OPTS</span>&gt;</span>-Dregistry.nacos.namespace=bbae7e8e-29cb-48e3-8c36-c8a9759975a9<span class="tag">&lt;/<span class="name">NACOS_OPTS</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">user</span>&gt;</span>zcckj:zcckj<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/sbin/tini<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>--<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/bin/sh<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>java $&#123;JAVA_OPTS&#125; -javaagent:/pinpoint_data/pinpoint-agent-$&#123;PINPOINT_VERSION&#125;/pinpoint-bootstrap-$PINPOINT_VERSION.jar $PINPOINT_OPTS $NACOS_OPTS -Djava.security.egd=file:/dev/./urandom -cp /app/resources/:/app/classes/:/app/libs/* com.zcckj.jingtian.biz.server.JingtianBizApplication<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>lombok.version为1.18.8</p>
</li>
<li><p>mapstruct.version为1.3.0.Final</p>
</li>
</ul>
<blockquote>
<blockquote>
<p>如果您的项目没有用到Pinpoint,Nacos可以完全精简为如下</p>
</blockquote>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>编译插件省略(同上)...<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span> </span><br><span class="line">		 <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.cloud.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jib-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">from</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>harbor.chaomeifan.com/library/openjdk:8-jdk-alpine-v1<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">allowInsecureRegistries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">allowInsecureRegistries</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">to</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">tags</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">container</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class="tag">&lt;/<span class="name">creationTime</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">user</span>&gt;</span>zcckj:zcckj<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/sbin/tini<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>--<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/bin/sh<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>java -cp /app/resources/:/app/classes/:/app/libs/* com.zcckj.jingtian.biz.server.JingtianBizApplication<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里我们构建了一个基镜像harbor.chaomeifan.com/library/openjdk:8-jdk-alpine-v1，以下给出基镜像的Dockerfile</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> zhangjie &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">user</span>=zcckj</span><br><span class="line"><span class="keyword">ARG</span> group=zcckj</span><br><span class="line"><span class="keyword">ARG</span> uid=<span class="number">1739</span></span><br><span class="line"><span class="keyword">ARG</span> gid=<span class="number">1739</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">"-Xmx1024M -Xms1024M -Xmn192M -XX:MaxMetaspaceSize=256M -XX:MetaspaceSize=256M -XX:+UseParallelGC -XX:+UseAdaptiveSizePolicy -XX:MaxGCPauseMillis=100 -XX:ErrorFile=/tmp/hs_err_pid%p.log   -Xloggc:/tmp/gc.log -XX:HeapDumpPath=/tmp -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure aliyun alpine software source and timezone</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add bash bash-completion bash-doc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cahce add font-adobe-100dpi ttf-dejavu fontconfig \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; addgroup --gid <span class="variable">$&#123;gid&#125;</span> <span class="variable">$&#123;group&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; adduser --uid <span class="variable">$&#123;uid&#125;</span> -G <span class="variable">$&#123;group&#125;</span> <span class="variable">$&#123;user&#125;</span> -s /bin/bash -D</span></span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>由于基镜像用了非root用户启动进程，故如果有映射到容器的目录需要将目录所有者所属组改为Dockerfile中定义的用户id,组id，chown -R 1739:1739 /path/directory</p>
<p>如果觉得嫌麻烦，可以在基镜像中直接用root</p>
</blockquote>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> zhangjie &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">"-Xmx1024M -Xms1024M -Xmn192M -XX:MaxMetaspaceSize=256M -XX:MetaspaceSize=256M -XX:+UseParallelGC -XX:+UseAdaptiveSizePolicy -XX:MaxGCPauseMillis=100 -XX:ErrorFile=/tmp/hs_err_pid%p.log   -Xloggc:/tmp/gc.log -XX:HeapDumpPath=/tmp -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure aliyun alpine software source and timezone</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add bash bash-completion bash-doc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cahce add font-adobe-100dpi ttf-dejavu fontconfig \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>这样就无需在jib插件配置中设置<user>zcckj:zcckj</user></p>
</blockquote>
</blockquote>
<h3 id="开始构建镜像-1"><a href="#开始构建镜像-1" class="headerlink" title="开始构建镜像"></a>开始构建镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean compile jib:build -Dmaven.test.skip=true -DsendCredentialsOverHttp=true -U</span><br></pre></td></tr></table></figure>
<h2 id="手工构建"><a href="#手工构建" class="headerlink" title="手工构建"></a>手工构建</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/default_avatar.png"
                alt="Jay Chang" />
            
              <p class="site-author-name" itemprop="name">Jay Chang</p>
              <p class="site-description motion-element" itemprop="description">当你的才华还撑不起你的野心时，你就应该静下心来学习。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jaychang9" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/jaychang1987" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/jaychang1987" target="_blank" title="Facebook">
                      
                        <i class="fa fa-fw fa-facebook"></i>Facebook</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/jaychang1987" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jaychang1987@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tech.meituan.com/" title="美团点评" target="_blank">美团点评</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tech.youzan.com/" title="有赞技术" target="_blank">有赞技术</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://tech.lede.com/" title="网易乐得" target="_blank">网易乐得</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://lovestblog.cn/" title="你假笨" target="_blank">你假笨</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/u/90ab66c248e6" title="占小狼" target="_blank">占小狼</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/quhongwei_zhanqiu" title="斩秋" target="_blank">斩秋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.iocoder.cn/" title="芋道源码" target="_blank">芋道源码</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wuchong.me/" title="伍翀Jark" target="_blank">伍翀Jark</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.jasongj.com/" title="郭俊Jason" target="_blank">郭俊Jason</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/chenssy" title="Chenssy" target="_blank">Chenssy</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://techlog.cn/" title="龙谭斋" target="_blank">龙谭斋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://imququ.com/" title="Jerry Qu" target="_blank">Jerry Qu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/morewindows/article/details/17488865" title="MoreWindows" target="_blank">MoreWindows</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.philipphauer.de/" title="Philipp Hauer" target="_blank">Philipp Hauer</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jay Chang</span>
  <span>
	<a class="theme-link" target="_blank" href="http://zjca.miit.gov.cn/">
		浙ICP备19027095号
	</a>
  </span>	
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://jay-changs-blog.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
