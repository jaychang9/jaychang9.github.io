<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-j.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-j.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-j.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo_j.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Java,Spring,Spring Cloud,中间件,RocketMQ,高并发,分布式,分布式事务,流式计算,Storm,机器学习,深度学习,Python,大数据,Spark,Hadoop,HDFS" />





  <link rel="alternate" href="/atom.xml" title="Jay Chang's Blog" type="application/atom+xml" />






<meta name="description" content="当你的才华还撑不起你的野心时，你就应该静下心来学习。">
<meta property="og:type" content="website">
<meta property="og:title" content="Jay Chang&#39;s Blog">
<meta property="og:url" content="http://jaychang.cn/index.html">
<meta property="og:site_name" content="Jay Chang&#39;s Blog">
<meta property="og:description" content="当你的才华还撑不起你的野心时，你就应该静下心来学习。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jay Chang&#39;s Blog">
<meta name="twitter:description" content="当你的才华还撑不起你的野心时，你就应该静下心来学习。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://jaychang.cn/"/>





  <title>Jay Chang's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d383fa81ebb62476e09fe22470595b8d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
	
	<a href="https://github.com/jaychang9"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jay Chang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我的技术博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2022/10/09/VS高可用实战之DR模式-CentOS-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/10/09/VS高可用实战之DR模式-CentOS-7/" itemprop="url">LVS高可用实战之DR模式(CentOS 7)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-10-09T16:18:50+08:00">
                2022-10-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/10/09/VS高可用实战之DR模式-CentOS-7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/10/09/VS高可用实战之DR模式-CentOS-7/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,134
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>VirtualBox虚拟机3台，使用的网络有桥接网卡、网络地址转换(NAT)</p>
<p>桥接网卡网段是10.1.80.0/24，网络地址转换(NAT)是为了能访问internet以便安装软件</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>IP</th>
<th>VIP</th>
</tr>
</thead>
<tbody>
<tr>
<td>ds1</td>
<td>10.1.80.91</td>
<td>enp0s3</td>
<td></td>
</tr>
<tr>
<td>ds2</td>
<td>10.1.80.92</td>
<td>enp0s3</td>
<td></td>
</tr>
<tr>
<td>rs1</td>
<td>10.1.80.93</td>
<td>lo:0</td>
<td></td>
</tr>
<tr>
<td>rs2</td>
<td>10.1.80.95</td>
<td>lo:0</td>
<td></td>
</tr>
</tbody>
</table>
<p>VIP地址为10.1.80.90</p>
<p>RS的RIP可以使用私网或公网IP， 文中DS与RS用的是同一网段。实际场景，一般情况下RS的RIP与VIP是不同网段的。</p>
<h1 id="LVS常用名词"><a href="#LVS常用名词" class="headerlink" title="LVS常用名词"></a>LVS常用名词</h1><ul>
<li>Load Balancer：负载均衡器，运行LVS负责负载均衡的服务器</li>
<li>DS：Director Server，指的是前端负载均衡器节点，也就是运行LVS的服务器；</li>
<li>RS：Real Server，后端真实的工作服务器；</li>
<li>VIP：Virtual Server IP，向外部直接面向用户请求，作为用户请求的目标的IP地址，一般也是DS的外部IP地址；</li>
<li>DIP：Director Server IP，主要用于和内部主机通讯的IP地址，一般也是DS的内部IP地址；</li>
<li>RIP：Real Server IP，后端服务器的IP地址；</li>
<li>CIP：Client IP，访问客户端的IP地址；</li>
</ul>
<h1 id="Director-Server"><a href="#Director-Server" class="headerlink" title="Director Server"></a>Director Server</h1><h2 id="ds1"><a href="#ds1" class="headerlink" title="ds1"></a>ds1</h2><p>安装ipvsadm<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y ipvsadm</span><br></pre></td></tr></table></figure></p>
<p>安装keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y keepalived</span><br></pre></td></tr></table></figure></p>
<p>备份keepalived.conf配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 101</span><br><span class="line">    advert_int 1</span><br><span class="line">    </span><br><span class="line">    # 如果两节点的上联交换机禁用了组播，则采用 vrrp 单播通告的方式</span><br><span class="line">    # unicast_src_ip 10.1.80.91</span><br><span class="line">    # unicast_peer &#123;</span><br><span class="line">    #    10.1.80.92</span><br><span class="line">    # &#125;</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.1.80.90</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.1.80.90 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 5</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.93 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.95 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ds1作为MASTER优先级比ds2高，ds1设置priority 101，ds2设置priority 100</p>
</blockquote>
<p>重启keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart keepalived</span><br></pre></td></tr></table></figure></p>
<p>防火墙开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>防火墙允许vrrp的组播</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class="line"></span><br><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --out-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>防火墙重新加载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h2 id="ds2"><a href="#ds2" class="headerlink" title="ds2"></a>ds2</h2><p>安装ipvsadm<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y ipvsadm</span><br></pre></td></tr></table></figure></p>
<p>安装keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y keepalived</span><br></pre></td></tr></table></figure></p>
<p>备份keepalived.conf配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface enp0s3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    </span><br><span class="line">    # 如果两节点的上联交换机禁用了组播，则采用 vrrp 单播通告的方式</span><br><span class="line">    # unicast_src_ip 10.1.80.92</span><br><span class="line">    # unicast_peer &#123;</span><br><span class="line">    #    10.1.80.91</span><br><span class="line">    # &#125;</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.1.80.90</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 10.1.80.90 80 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 5</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.93 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    real_server 10.1.80.95 80 &#123;</span><br><span class="line">        weight 100</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">           connect_timeout 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启keepalived<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart keepalived</span><br></pre></td></tr></table></figure></p>
<p>防火墙开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>防火墙允许vrrp的组播</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class="line"></span><br><span class="line">sudo firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --out-interface enp0s3 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>防火墙重新加载<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<h1 id="Real-Server"><a href="#Real-Server" class="headerlink" title="Real Server"></a>Real Server</h1><h2 id="rs1"><a href="#rs1" class="headerlink" title="rs1"></a>rs1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/scripts</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /opt/scripts/lvs_rs.sh</span><br></pre></td></tr></table></figure>
<p>脚本如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash </span><br><span class="line">VIP=10.1.80.90</span><br><span class="line">case "$1" in</span><br><span class="line">start)</span><br><span class="line">       ifconfig lo:0 $VIP netmask 255.255.255.255 broadcast $VIP</span><br><span class="line">       /sbin/route add -host $VIP dev lo:0</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       sysctl -p &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "RealServer Start OK"</span><br><span class="line">       ;;</span><br><span class="line">stop)</span><br><span class="line">       ifconfig lo:0 down</span><br><span class="line">       route del $VIP &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       echo "RealServer Stoped"</span><br><span class="line">       ;;</span><br><span class="line">*)</span><br><span class="line">       echo "Usage: $0 &#123;start|stop&#125;"</span><br><span class="line">       exit 1</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /opt/scripts/lvs_rs.sh </span><br><span class="line">sudo /opt/scripts/lvs_rs.sh start</span><br></pre></td></tr></table></figure>
<p>安装tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /tmp/software</span><br><span class="line">sudo cd /tmp/software</span><br><span class="line">sudo curl -O https://tengine.taobao.org/download/tengine-2.3.3.tar.gz</span><br><span class="line">sudo tar -xzvf tengine-2.3.3.tar.gz</span><br><span class="line">sudo cd tengine-2.3.3</span><br><span class="line">sudo yum install -y gcc make pcre-devel openssl-devel</span><br><span class="line">sudo ./configure --prefix=/usr/local/tengine</span><br></pre></td></tr></table></figure></p>
<p>修改index.html<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /usr/local/tengine/html/index.html</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">其余省略...</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to tengine! I'm rs1<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">其余省略...</span><br></pre></td></tr></table></figure>
<p>启动tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/tengine/sbin/nginx</span><br></pre></td></tr></table></figure></p>
<p>防火墙设置开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<h2 id="rs2"><a href="#rs2" class="headerlink" title="rs2"></a>rs2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/scripts</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /opt/scripts/lvs_rs.sh</span><br></pre></td></tr></table></figure>
<p>脚本如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash </span><br><span class="line">VIP=10.1.80.90</span><br><span class="line">case "$1" in</span><br><span class="line">start)</span><br><span class="line">       ifconfig lo:0 $VIP netmask 255.255.255.255 broadcast $VIP</span><br><span class="line">       /sbin/route add -host $VIP dev lo:0</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       sysctl -p &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "RealServer Start OK"</span><br><span class="line">       ;;</span><br><span class="line">stop)</span><br><span class="line">       ifconfig lo:0 down</span><br><span class="line">       route del $VIP &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">       echo "0" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">       echo "RealServer Stoped"</span><br><span class="line">       ;;</span><br><span class="line">*)</span><br><span class="line">       echo "Usage: $0 &#123;start|stop&#125;"</span><br><span class="line">       exit 1</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /opt/scripts/lvs_rs.sh </span><br><span class="line">sudo /opt/scripts/lvs_rs.sh start</span><br></pre></td></tr></table></figure>
<p>安装tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /tmp/software</span><br><span class="line">sudo cd /tmp/software</span><br><span class="line">sudo curl -O https://tengine.taobao.org/download/tengine-2.3.3.tar.gz</span><br><span class="line">sudo tar -xzvf tengine-2.3.3.tar.gz</span><br><span class="line">sudo cd tengine-2.3.3</span><br><span class="line">sudo yum install -y gcc make pcre-devel openssl-devel</span><br><span class="line">sudo ./configure --prefix=/usr/local/tengine</span><br></pre></td></tr></table></figure></p>
<p>修改index.html<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /usr/local/tengine/html/index.html</span><br></pre></td></tr></table></figure></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">其余省略...</span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to tengine! I'm rs2<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">其余省略...</span><br></pre></td></tr></table></figure>
<p>启动tengine<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/tengine/sbin/nginx</span><br></pre></td></tr></table></figure></p>
<p>防火墙设置开放80端口<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<h1 id="测试keepalived-vrrp报文"><a href="#测试keepalived-vrrp报文" class="headerlink" title="测试keepalived vrrp报文"></a>测试keepalived vrrp报文</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 host 224.0.0.18</span><br></pre></td></tr></table></figure>
<p>在ds1上执行(ds2,rs1,rs2都可以的)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">14:43:04.752665 IP (tos 0xc0, ttl 255, id 130, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 101, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br><span class="line">14:43:05.753059 IP (tos 0xc0, ttl 255, id 131, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 101, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br></pre></td></tr></table></figure></p>
<p>可以看到10.1.80.91在发组播消息，10.1.80.91证明我是MASTER，vip(10.1.80.90)在ds1的enp0s3上。<br>然后把ds1的keepalived关了,sudo systemctl stop keepalived</p>
<p>观察报文变化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">14:45:08.488190 IP (tos 0xc0, ttl 255, id 253, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 0, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br><span class="line">14:45:09.120876 IP (tos 0xc0, ttl 255, id 8772, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.92 &gt; 224.0.0.18: vrrp 10.1.80.92 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br></pre></td></tr></table></figure>
<p>发现已经由10.1.80.91改为10.1.80.92发组播消息,vip(10.1.80.90)飘到了ds2的enp0s3上。</p>
<p>重新启动ds1上的keepalived,再次观察报文</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">14:46:59.177236 IP (tos 0xc0, ttl 255, id 8880, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.92 &gt; 224.0.0.18: vrrp 10.1.80.92 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 100, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br><span class="line">14:46:59.177350 IP (tos 0xc0, ttl 255, id 1, offset 0, flags [none], proto VRRP (112), length 40)</span><br><span class="line">    10.1.80.91 &gt; 224.0.0.18: vrrp 10.1.80.91 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 101, authtype simple, intvl 1s, length 20, addrs: 10.1.80.90 auth "1111^@^@^@^@"</span><br></pre></td></tr></table></figure>
<p>发现由10.1.80.92改为了10.1.80.91发组播消息了，vip(10.1.80.90)飘回了ds1的enp0s3上。</p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><ul>
<li>打开浏览器，访问<a href="http://10.1.80.90" target="_blank" rel="noopener">http://10.1.80.90</a></li>
</ul>
<p>页面展示 Welcome to tengine! I’m rs1</p>
<p>ds1上查看sudo ipvsadm -ln</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[jaychang@ds01 ~]# sudo ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.1.80.90:80 wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.93:80              Route   100    0          0</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.95:80              Route   100    2          0</span><br></pre></td></tr></table></figure>
<ul>
<li>停掉rs1的nginx后</li>
</ul>
<p>ds1上查看/var/log/keepalived.log(如果未设置过，默认是在/var/log/message)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Oct  8 15:50:14 ds01 Keepalived_healthcheckers[15444]: TCP connection to [10.1.80.93]:80 failed.</span><br><span class="line">Oct  8 15:50:15 ds01 Keepalived_healthcheckers[15444]: TCP connection to [10.1.80.93]:80 failed.</span><br><span class="line">Oct  8 15:50:15 ds01 Keepalived_healthcheckers[15444]: Check on service [10.1.80.93]:80 failed after 1 retry.</span><br><span class="line">Oct  8 15:50:15 ds01 Keepalived_healthcheckers[15444]: Removing service [10.1.80.93]:80 from VS [10.1.80.90]:80</span><br></pre></td></tr></table></figure>
<p>从日志内容可以看到10.1.80.93已被剔除了</p>
<p>ds1上查看sudo ipvsadm -ln</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[jaychang@ds01 ~]$ sudo ipvsadm -ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.1.80.90:80 wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.95:80              Route   100    4          0</span><br></pre></td></tr></table></figure>
<p>刷新浏览器页面显示Welcome to tengine! I’m rs2</p>
<ul>
<li>重新开启rs1的nginx</li>
</ul>
<p>观察/var/log/keepalived.log(如果未设置过，默认是在/var/log/message)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Oct  8 16:11:41 ds01 Keepalived_healthcheckers[15444]: TCP connection to [10.1.80.93]:80 success.</span><br><span class="line">Oct  8 16:11:41 ds01 Keepalived_healthcheckers[15444]: Adding service [10.1.80.93]:80 to VS [10.1.80.90]:80</span><br></pre></td></tr></table></figure>
<p>ds1上查看sudo ipvsadm -ln</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.1.80.90:80 wrr persistent 50</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.93:80              Route   100    0          0</span><br><span class="line"><span class="meta">  -&gt;</span> 10.1.80.95:80              Route   100    2          0</span><br></pre></td></tr></table></figure>
<p>发现10.1.80.93已经重新被加入到服务列表中了</p>
<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><ul>
<li>ds1,ds2上的LVS规则如何删除？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm --clear</span><br></pre></td></tr></table></figure>
<ul>
<li>如何删掉ds1,ds2上的VIP？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig enp0s3:0 down</span><br></pre></td></tr></table></figure>
<ul>
<li>如何查看LVS统计信息？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm -ln --stats</span><br></pre></td></tr></table></figure>
<ul>
<li>如何查看LVS连接条目？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ipvsadm -lnc</span><br></pre></td></tr></table></figure>
<ul>
<li>ds1,ds2上用tcpdump抓包观察组播消息？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 host 224.0.0.18</span><br></pre></td></tr></table></figure>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 vrrp</span><br></pre></td></tr></table></figure></p>
<ul>
<li>指定访问来源主机，指定抓包端口号，网卡名称<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i enp0s3 tcp port 80 and host 10.1.80.62</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>查看详细一点信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -vvv -n -i enp0s3 tcp port 80 and host 10.1.80.62</span><br></pre></td></tr></table></figure>
<ul>
<li>用iptables如何允许组播?</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -I INPUT -i enp0s3 -d 224.0.0.18 -p vrrp -j ACCEPT</span><br><span class="line">sudo iptables -I OUTPUT -o enp0s3 -d 224.0.0.18 -p vrrp -j ACCEPT</span><br></pre></td></tr></table></figure>
<ul>
<li>firewall防火墙如何开放端口，关闭端口？</li>
</ul>
<p>开放80端口访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>关闭80端口访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --remove-port=80/tcp --permanent</span><br></pre></td></tr></table></figure></p>
<p>记得要reload或restart下，防火墙才会生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload firewalld</span><br></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart firewalld</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>推荐使用第一种方式重新加载防火墙</p>
</blockquote>
<ul>
<li>查看防火墙开放的端口</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --list-port</span><br></pre></td></tr></table></figure>
<ul>
<li>脑裂的原因有哪些？</li>
</ul>
<ol>
<li>主备的virtual_router_id 不一致</li>
<li>交换机不允许组播(可以改成单播方式)</li>
<li>防火墙未允许组播</li>
</ol>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul>
<li>注意要使得rs1,rs2上的配置重启生效的话，可以将/opt/scripts/lvs_rs.sh作为启动脚本（推荐）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo echo "/opt/scripts/lvs_rs.sh start" &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
<p>在centos7中，/etc/rc.d/rc.local文件的权限被降低了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></p>
<ul>
<li>或使用以下方法</li>
</ul>
<p>要使得rs1,rs2上的lo:0重启后仍生效的话，要创建一个ifcfg-lo:0文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/sysconfig/network-scripts/ifcfg-lo /etc/sysconfig/network-scripts/ifcfg-lo:0</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/sysconfig/network-scripts/ifcfg-lo:0</span><br></pre></td></tr></table></figure>
<p>内容如下<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=lo:0</span><br><span class="line">IPADDR=10.1.80.90</span><br><span class="line">NETMASK=255.255.255.255</span><br><span class="line">BROADCAST=10.1.80.90</span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure></p>
<p>重启网络<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service network restart</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure>
<p>添加以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.default.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.default.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br></pre></td></tr></table></figure>
<p>刷新文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>路由设置添加开启自启动<br>echo “route add -host 10.1.80.90 dev lo:0” &gt;&gt; /etc/rc.local</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://tinychen.com/20200427-lvs-principle-introduction/" target="_blank" rel="noopener">LVS三种模式的工作原理</a></p>
<p><a href="https://ynotes.cn/blog/article_detail/194" target="_blank" rel="noopener">CentOS7搭建LVS负载均衡器</a></p>
<p><a href="http://www.linuxvirtualserver.org/docs/ha/keepalived.html" target="_blank" rel="noopener">LVS High Availability - The Keepalived Solution</a></p>
<p><a href="https://blog.51cto.com/qujunorz/1861541" target="_blank" rel="noopener">keepalived组播故障排查</a></p>
<p><a href="https://blog.csdn.net/u010943765/article/details/59574764" target="_blank" rel="noopener">centos7 keepalived 主备通信 防火墙vrrp 协议
</a></p>
<p><a href="https://qizhanming.com/blog/2018/05/17/how-to-config-keepalived-on-centos-7" target="_blank" rel="noopener">CentOS 7 配置 Keepalived 实现双机热备</a></p>
<p><a href="https://blog.csdn.net/tushanpeipei/article/details/112448165" target="_blank" rel="noopener">VRRP技术原理与注意点
</a></p>
<p><a href="http://blog.itpub.net/70000438/viewspace-2782269/" target="_blank" rel="noopener">LVS+Keepalived+Nginx高可用实现
</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2020/12/26/bernetes单节点安装/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/26/bernetes单节点安装/" itemprop="url">CentOS7安装kubernetes单master节点(v1.19.x)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-26T11:01:24+08:00">
                2020-12-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/26/bernetes单节点安装/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/12/26/bernetes单节点安装/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5,212
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="配置要求"><a href="#配置要求" class="headerlink" title="配置要求"></a>配置要求</h1><p>对于 Kubernetes 初学者，在搭建K8S集群时，推荐在阿里云或腾讯云采购如下配置：（您也可以使用自己的虚拟机、私有云等您最容易获得的 Linux 环境）</p>
<ul>
<li>至少2台 2核4G 的服务器</li>
<li>Cent OS 7.6 / 7.7 / 7.8</li>
</ul>
<h2 id="安装后软件版本"><a href="#安装后软件版本" class="headerlink" title="安装后软件版本"></a>安装后软件版本</h2><ul>
<li><p>Kubernetes v1.19.x</p>
<ul>
<li><p>calico 3.13.1</p>
</li>
<li><p>nginx-ingress 1.5.5</p>
</li>
</ul>
</li>
<li>Docker 19.03.14</li>
</ul>
<blockquote>
<p><strong>关于二进制安装</strong></p>
<p>kubeadm 是 Kubernetes 官方支持的安装方式，“二进制” 不是。本文档采用 kubernetes.io 官方推荐的 kubeadm 工具安装 kubernetes 集群。</p>
</blockquote>
<h1 id="检查CentOS-hostname"><a href="#检查CentOS-hostname" class="headerlink" title="检查CentOS / hostname"></a>检查CentOS / hostname</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 在 master 节点和 worker 节点都要执行</span><br><span class="line">cat /etc/redhat-release</span><br><span class="line"></span><br><span class="line"># 此处 hostname 的输出将会是该机器在 Kubernetes 集群中的节点名字</span><br><span class="line"># 不能使用 localhost 作为节点的名字</span><br><span class="line">hostname</span><br><span class="line"></span><br><span class="line"># 请使用 lscpu 命令，核对 CPU 信息</span><br><span class="line"># Architecture: x86_64    本安装文档不支持 arm 架构</span><br><span class="line"># CPU(s):       2         CPU 内核数量不能低于 2</span><br><span class="line">lscpu</span><br></pre></td></tr></table></figure>
<p><strong>操作系统兼容性</strong></p>
<table>
<thead>
<tr>
<th>CentOS版本</th>
<th>本文档是否兼容</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>7.8</td>
<td>是</td>
<td>已验证</td>
</tr>
<tr>
<td>7.7</td>
<td>是</td>
<td>已验证</td>
</tr>
<tr>
<td>7.6</td>
<td>是</td>
<td>已验证</td>
</tr>
<tr>
<td>7.5</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
<tr>
<td>7.4</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
<tr>
<td>7.3</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
<tr>
<td>7.2</td>
<td>否</td>
<td>已证实会出现 kubelet 无法启动的问题</td>
</tr>
</tbody>
</table>
<blockquote>
<p>修改 hostname</p>
<p>如果您需要修改 hostname，可执行如下指令：</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 修改 hostname</span><br><span class="line">hostnamectl set-hostname your-new-host-name</span><br><span class="line"><span class="meta">#</span> 查看修改结果</span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="meta">#</span> 设置 hostname 解析</span><br><span class="line">echo "127.0.0.1   $(hostname)" &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<h1 id="检查网络"><a href="#检查网络" class="headerlink" title="检查网络"></a>检查网络</h1><p>在所有节点执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@demo-master-a-1 ~]$ ip route show</span><br><span class="line">default via 172.21.0.1 dev eth0 </span><br><span class="line">169.254.0.0/16 dev eth0 scope link metric 1002 </span><br><span class="line">172.21.0.0/20 dev eth0 proto kernel scope link src 172.21.0.12 </span><br><span class="line"></span><br><span class="line">[root@demo-master-a-1 ~]$ ip address</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:16:3e:12:a4:1b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.216.80/20 brd 172.17.223.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 305741654sec preferred_lft 305741654sec</span><br></pre></td></tr></table></figure>
<h1 id="安装docker及kubelet"><a href="#安装docker及kubelet" class="headerlink" title="安装docker及kubelet"></a>安装docker及kubelet</h1><p>使用 root 身份在所有节点执行如下代码，以安装软件：</p>
<ul>
<li>docker</li>
<li>nfs-utils</li>
<li>kubectl / kubeadm / kubelet</li>
</ul>
<h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><p><strong>请将脚本最后的 1.19.6 替换成您需要的版本号</strong>， 脚本中间的 v1.19.x 不要替换</p>
<p>docker hub 镜像请根据自己网络的情况任选一个</p>
<ul>
<li>第四行为腾讯云 docker hub 镜像</li>
<li>第六行为DaoCloud docker hub 镜像</li>
<li>第八行为华为云 docker hub 镜像</li>
<li>第十行为阿里云 docker hub 镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在 master 节点和 worker 节点都要执行</span><br><span class="line"><span class="meta">#</span> 最后一个参数 1.19.5 用于指定 kubenetes 版本，支持所有 1.19.x 版本的安装</span><br><span class="line"><span class="meta">#</span> 腾讯云 docker hub 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="https://mirror.ccs.tencentyun.com"</span><br><span class="line"><span class="meta">#</span> DaoCloud 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="http://f1361db2.m.daocloud.io"</span><br><span class="line"><span class="meta">#</span> 华为云镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com"</span><br><span class="line"><span class="meta">#</span> 阿里云 docker hub 镜像</span><br><span class="line">export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.6</span><br></pre></td></tr></table></figure>
<h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><blockquote>
<p>手动执行以下代码，结果与快速安装相同。<strong>请将脚本第79行（已高亮）的 ${1} 替换成您需要的版本号，例如 1.19.6</strong></p>
</blockquote>
<p>docker hub 镜像请根据自己网络的情况任选一个</p>
<ul>
<li>第四行为腾讯云 docker hub 镜像</li>
<li>第六行为DaoCloud docker hub 镜像</li>
<li>第八行为阿里云 docker hub 镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在 master 节点和 worker 节点都要执行</span><br><span class="line"><span class="meta">#</span> 最后一个参数 1.19.5 用于指定 kubenetes 版本，支持所有 1.19.x 版本的安装</span><br><span class="line"><span class="meta">#</span> 腾讯云 docker hub 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="https://mirror.ccs.tencentyun.com"</span><br><span class="line"><span class="meta">#</span> DaoCloud 镜像</span><br><span class="line"><span class="meta">#</span> export REGISTRY_MIRROR="http://f1361db2.m.daocloud.io"</span><br><span class="line"><span class="meta">#</span> 阿里云 docker hub 镜像</span><br><span class="line">export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以指定安装docker-ce的版本，用<strong>yum list docker-ce –showduplicates|sort -r</strong> 查看所有版本</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 在 master 节点和 worker 节点都要执行</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装 docker</span><br><span class="line"><span class="meta">#</span> 参考文档如下</span><br><span class="line"><span class="meta">#</span> https://docs.docker.com/install/linux/docker-ce/centos/ </span><br><span class="line"><span class="meta">#</span> https://docs.docker.com/install/linux/linux-postinstall/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 卸载旧版本</span><br><span class="line">yum remove -y docker \</span><br><span class="line">docker-client \</span><br><span class="line">docker-client-latest \</span><br><span class="line">docker-ce-cli \</span><br><span class="line">docker-common \</span><br><span class="line">docker-latest \</span><br><span class="line">docker-latest-logrotate \</span><br><span class="line">docker-logrotate \</span><br><span class="line">docker-selinux \</span><br><span class="line">docker-engine-selinux \</span><br><span class="line">docker-engine</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 设置 yum repository</span><br><span class="line">yum install -y yum-utils \</span><br><span class="line">device-mapper-persistent-data \</span><br><span class="line">lvm2</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装并启动 docker</span><br><span class="line">yum install -y docker-ce-19.03.14 docker-ce-cli-19.03.14</span><br><span class="line"></span><br><span class="line">mkdir /etc/docker || true</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "registry-mirrors": ["$&#123;REGISTRY_MIRROR&#125;"],</span><br><span class="line">  "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">  "log-driver": "json-file",</span><br><span class="line">  "log-opts": &#123;</span><br><span class="line">    "max-size": "100m"</span><br><span class="line">  &#125;,</span><br><span class="line">  "storage-driver": "overlay2",</span><br><span class="line">  "storage-opts": [</span><br><span class="line">    "overlay2.override_kernel_check=true"</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Restart Docker</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable docker</span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装 nfs-utils</span><br><span class="line"><span class="meta">#</span> 必须先安装 nfs-utils 才能挂载 nfs 网络存储</span><br><span class="line">yum install -y nfs-utils</span><br><span class="line">yum install -y wget</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关闭 防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关闭 SeLinux</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关闭 swap</span><br><span class="line">swapoff -a</span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 修改 /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span> 如果有配置，则修改</span><br><span class="line">sed -i "s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.all.disable_ipv6.*#net.ipv6.conf.all.disable_ipv6=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.default.disable_ipv6.*#net.ipv6.conf.default.disable_ipv6=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.lo.disable_ipv6.*#net.ipv6.conf.lo.disable_ipv6=1#g"  /etc/sysctl.conf</span><br><span class="line">sed -i "s#^net.ipv6.conf.all.forwarding.*#net.ipv6.conf.all.forwarding=1#g"  /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span> 可能没有，追加</span><br><span class="line">echo "net.ipv4.ip_forward = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.bridge.bridge-nf-call-ip6tables = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.bridge.bridge-nf-call-iptables = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.all.disable_ipv6 = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.default.disable_ipv6 = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.lo.disable_ipv6 = 1" &gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo "net.ipv6.conf.all.forwarding = 1"  &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span> 执行命令以应用</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置K8S的yum源</span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 卸载旧版本</span><br><span class="line">yum remove -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装kubelet、kubeadm、kubectl</span><br><span class="line"><span class="meta">#</span> 将 $&#123;1&#125; 替换为 kubernetes 版本号，例如 1.19.6</span><br><span class="line">yum install -y kubelet-$&#123;1&#125; kubeadm-$&#123;1&#125; kubectl-$&#123;1&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 重启 docker，并启动 kubelet</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"></span><br><span class="line">docker version</span><br></pre></td></tr></table></figure>
<blockquote>
<p>WARNING</p>
<p>如果此时执行 systemctl status kubelet 命令，将得到 kubelet 启动失败的错误提示，请忽略此错误，因为必须完成后续步骤中 kubeadm init 的操作，kubelet 才能正常启动</p>
</blockquote>
<h1 id="初始化master节点"><a href="#初始化master节点" class="headerlink" title="初始化master节点"></a>初始化master节点</h1><blockquote>
<p>关于初始化时用到的环境变量</p>
</blockquote>
<ul>
<li>APISERVER_NAME 不能是 master 的 hostname</li>
<li>APISERVER_NAME 必须全为小写字母、数字、小数点，不能包含减号</li>
<li>POD_SUBNET 所使用的网段不能与 master节点/worker节点 所在的网段重叠。该字段的取值为一个 CIDR 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.1/16 命令，不做修改</li>
</ul>
<h2 id="快速初始化"><a href="#快速初始化" class="headerlink" title="快速初始化"></a>快速初始化</h2><p><strong>请将脚本最后的 1.19.6 替换成您需要的版本号</strong>， 脚本中间的 v1.19.x 不要替换</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"><span class="meta">#</span> 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span><br><span class="line"><span class="meta">#</span> export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span><br><span class="line">export MASTER_IP=x.x.x.x</span><br><span class="line"><span class="meta">#</span> 替换 apiserver.demo 为 您想要的 dnsName</span><br><span class="line">export APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="meta">#</span> Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span><br><span class="line">export POD_SUBNET=10.100.0.1/16</span><br><span class="line">echo "$&#123;MASTER_IP&#125;    $&#123;APISERVER_NAME&#125;" &gt;&gt; /etc/hosts</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/init_master.sh | sh -s 1.19.6</span><br></pre></td></tr></table></figure>
<h2 id="手动初始化"><a href="#手动初始化" class="headerlink" title="手动初始化"></a>手动初始化</h2><blockquote>
<p>手动执行以下代码，结果与快速初始化相同。<strong>请将脚本第21行（已高亮）的 ${1} 替换成您需要的版本号，例如 1.19.6</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"><span class="meta">#</span> 替换 x.x.x.x 为 master 节点的内网IP</span><br><span class="line"><span class="meta">#</span> export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span><br><span class="line">export MASTER_IP=x.x.x.x</span><br><span class="line"><span class="meta">#</span> 替换 apiserver.demo 为 您想要的 dnsName</span><br><span class="line">export APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="meta">#</span> Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span><br><span class="line">export POD_SUBNET=10.100.0.1/16</span><br><span class="line">echo "$&#123;MASTER_IP&#125;    $&#123;APISERVER_NAME&#125;" &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 脚本出错时终止执行</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">if [ $&#123;#POD_SUBNET&#125; -eq 0 ] || [ $&#123;#APISERVER_NAME&#125; -eq 0 ]; then</span><br><span class="line">  echo -e "\033[31;1m请确保您已经设置了环境变量 POD_SUBNET 和 APISERVER_NAME \033[0m"</span><br><span class="line">  echo 当前POD_SUBNET=$POD_SUBNET</span><br><span class="line">  echo 当前APISERVER_NAME=$APISERVER_NAME</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看完整配置选项 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2</span><br><span class="line">rm -f ./kubeadm-config.yaml</span><br><span class="line">cat &lt;&lt;EOF &gt; ./kubeadm-config.yaml</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v$&#123;1&#125;</span><br><span class="line">imageRepository: registry.aliyuncs.com/k8sxio</span><br><span class="line">controlPlaneEndpoint: "$&#123;APISERVER_NAME&#125;:6443"</span><br><span class="line">networking:</span><br><span class="line">  serviceSubnet: "10.96.0.0/16"</span><br><span class="line">  podSubnet: "$&#123;POD_SUBNET&#125;"</span><br><span class="line">  dnsDomain: "cluster.local"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> kubeadm init</span><br><span class="line"><span class="meta">#</span> 根据您服务器网速的情况，您需要等候 3 - 10 分钟</span><br><span class="line">kubeadm config images pull --config=kubeadm-config.yaml</span><br><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置 kubectl</span><br><span class="line">rm -rf /root/.kube/</span><br><span class="line">mkdir /root/.kube/</span><br><span class="line">cp -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装 calico 网络插件</span><br><span class="line"><span class="meta">#</span> 参考文档 https://docs.projectcalico.org/v3.13/getting-started/kubernetes/self-managed-onprem/onpremises</span><br><span class="line">echo "安装calico-3.13.1"</span><br><span class="line">rm -f calico-3.13.1.yaml</span><br><span class="line">wget https://kuboard.cn/install-script/calico/calico-3.13.1.yaml</span><br><span class="line">kubectl apply -f calico-3.13.1.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>感谢 <a href="https://github.com/zhangguanzhang/google_containers" target="_blank" rel="noopener">https://github.com/zhangguanzhang/google_containers</a> (opens new window)提供最新的 google_containers 国内镜像</p>
</blockquote>
<h2 id="初始化如果出错请看"><a href="#初始化如果出错请看" class="headerlink" title="初始化如果出错请看"></a>初始化如果出错请看</h2><ul>
<li><p>请确保您的环境符合 <a href="https://kuboard.cn/install/install-k8s.html#安装docker及kubelet" target="_blank" rel="noopener">安装docker及kubelet</a> 中所有勾选框的要求</p>
</li>
<li><p>请确保您使用 root 用户执行初始化命令</p>
</li>
<li><p>不能下载 kubernetes 的 docker 镜像</p>
<ul>
<li><p>安装文档中，默认使用阿里云的 docker 镜像仓库，然而，有时候，该镜像会罢工</p>
</li>
<li><p>如碰到不能下载 docker 镜像的情况，请尝试手工初始化，并修改手工初始化脚本里的第22行（文档中已高亮）为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageRepository: gcr.azk8s.cn/google-containers</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>检查环境变量，执行如下命令</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo MASTER_IP=$&#123;MASTER_IP&#125; &amp;&amp; echo APISERVER_NAME=$&#123;APISERVER_NAME&#125; &amp;&amp; echo POD_SUBNET=$&#123;POD_SUBNET&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>请验证如下几点：<ul>
<li>环境变量 <strong><em>MASTER_IP</em></strong> 的值应该为 master 节点的 <strong>内网IP</strong>，如果不是，请重新 export</li>
<li><strong>APISERVER_NAME</strong> 不能是 master 的 hostname</li>
<li><strong>APISERVER_NAME</strong> 必须全为小写字母、数字、小数点，不能包含减号</li>
<li><strong>POD_SUBNET</strong> 所使用的网段不能与 <strong><em>master节点/worker节点</em></strong> 所在的网段重叠。该字段的取值为一个 <a href="https://kuboard.cn/glossary/cidr.html" target="_blank" rel="noopener">CIDR</a> 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET=10.100.0.1/16 命令，不做修改</li>
</ul>
</li>
<li>重新初始化 master 节点前，请先执行 <code>kubeadm reset -f</code> 操作</li>
</ul>
<ul>
<li><p>ImagePullBackoff / Pending</p>
</li>
<li><p>如果 kubectl get pod -n kube-system -o wide 的输出结果中出现 ImagePullBackoff 或者长时间处于 Pending 的情况，请参考 查看镜像抓取进度</p>
</li>
<li><p>ContainerCreating</p>
</li>
<li><p>如果 kubectl get pod -n kube-system -o wide 的输出结果中某个 Pod 长期处于 ContainerCreating、PodInitializing 或 Init:0/3 的状态，可以尝试：</p>
<ul>
<li>查看该 Pod 的状态，例如：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
<p>如果输出结果中，最后一行显示的是 Pulling image，请耐心等待，或者参考 查看镜像抓取进度</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Normal  Pulling    44s   kubelet, k8s-worker-02  Pulling image "quay.io/coreos/flannel:v0.12.0-amd64"</span><br></pre></td></tr></table></figure>
<ul>
<li>将该 Pod 删除，系统会自动重建一个新的 Pod，例如：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
<h2 id="检查master初始化结果"><a href="#检查master初始化结果" class="headerlink" title="检查master初始化结果"></a>检查master初始化结果</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 只在 master 节点执行</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看 master 节点初始化结果</span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果出错请看</p>
</blockquote>
<ul>
<li><p>ImagePullBackoff / Pending</p>
<ul>
<li>如果 kubectl get pod -n kube-system -o wide的输出结果中出现 ImagePullBackoff 或者长时间处于 Pending 的情况，请参考 <a href="https://kuboard.cn/learning/faq/image-pull-backoff.html" target="_blank" rel="noopener">查看镜像抓取进度</a></li>
</ul>
</li>
<li><p>ContainerCreating</p>
<ul>
<li><p>如果kubectl get pod -n kube-system -o wide的输出结果中某个 Pod 长期处于 ContainerCreating、PodInitializing 或 Init:0/3 的状态，可以尝试：</p>
<ul>
<li><p>查看该 Pod 的状态，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
<p>如果输出结果中，最后一行显示的是 Pulling image，请耐心等待，或者参考查看镜像抓取进度</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">      Normal  Pulling    44s   kubelet, k8s-worker-02  Pulling image <span class="string">"quay.io/coreos/flannel:v0.12.0-amd64"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将该 Pod 删除，系统会自动重建一个新的 Pod，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod kube-flannel-ds-amd64-8l25c -n kube-system</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="初始化worker节点"><a href="#初始化worker节点" class="headerlink" title="初始化worker节点"></a>初始化worker节点</h1><h2 id="获得join参数"><a href="#获得join参数" class="headerlink" title="获得join参数"></a>获得join参数</h2><p>在master节点上执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<p>可获取kubeadm join 命令及参数，如下所示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有效时间</p>
</blockquote>
<p>该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token 初始化任意数量的 worker 节点。</p>
<h2 id="worker节点执行初始化"><a href="#worker节点执行初始化" class="headerlink" title="worker节点执行初始化"></a>worker节点执行初始化</h2><p>针对所有的 worker 节点执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 worker 节点执行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换 x.x.x.x 为 master 节点的内网 IP</span></span><br><span class="line">export MASTER_IP=x.x.x.x</span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span></span><br><span class="line">export APISERVER_NAME=apiserver.demo</span><br><span class="line">echo "$&#123;MASTER_IP&#125;    $&#123;APISERVER_NAME&#125;" &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 替换为 master 节点上 kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303</span><br></pre></td></tr></table></figure>
<h2 id="检查初始化结果"><a href="#检查初始化结果" class="headerlink" title="检查初始化结果"></a>检查初始化结果</h2><p>在master节点上执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure></p>
<p>输出结果如下所示：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@demo-master-a-1 ~]# kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES    AGE     VERSION</span><br><span class="line">demo-master-a-1   Ready    master   5m3s    v1.19.x</span><br><span class="line">demo-worker-a-1   Ready    &lt;none&gt;   2m26s   v1.19.x</span><br><span class="line">demo-worker-a-2   Ready    &lt;none&gt;   3m56s   v1.19.x</span><br></pre></td></tr></table></figure></p>
<h2 id="常见错误原因"><a href="#常见错误原因" class="headerlink" title="常见错误原因"></a>常见错误原因</h2><p>经常在群里提问为什么 join 不成功的情况大致有这几种：</p>
<h3 id="worker-节点不能访问-apiserver"><a href="#worker-节点不能访问-apiserver" class="headerlink" title="worker 节点不能访问 apiserver"></a><strong>worker 节点不能访问 apiserver</strong></h3><p>在worker节点执行以下语句可验证worker节点是否能访问 apiserver</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -ik https://apiserver.demo:6443</span><br></pre></td></tr></table></figure>
<p>如果不能，请在 master 节点上验证</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -ik https://localhost:6443</span><br></pre></td></tr></table></figure>
<p>  正常输出结果如下所示：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Cache-Control: no-cache, private</span><br><span class="line">Content-Type: application/json</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">Date: Fri, 15 Nov 2019 04:34:40 GMT</span><br><span class="line">Content-Length: 233</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "kind": "Status",</span><br><span class="line">  "apiVersion": "v1",</span><br><span class="line">  "metadata": &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 可能原因</p>
<ul>
<li>如果 master 节点能够访问 apiserver、而 worker 节点不能，则请检查自己的网络设置<ul>
<li>/etc/hosts 是否正确设置？</li>
<li>是否有安全组或防火墙的限制？</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="worker-节点默认网卡"><a href="#worker-节点默认网卡" class="headerlink" title="worker 节点默认网卡"></a>worker 节点默认网卡</h3><p>   Kubelet使用的 IP 地址与 master 节点可互通（无需 NAT 映射），且没有防火墙、安全组隔离</p>
<p>如果你使用 vmware 或 virtualbox 创建虚拟机用于 K8S 学习，可以尝试 NAT 模式的网络，而不是桥接模式的网络</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><h3 id="移除worker节点并重试"><a href="#移除worker节点并重试" class="headerlink" title="移除worker节点并重试"></a>移除worker节点并重试</h3><blockquote>
<p>WARNING</p>
<p>正常情况下，您无需移除 worker 节点，如果添加到集群出错，您可以移除 worker 节点，再重新尝试添加  </p>
</blockquote>
<p>在准备移除的 worker 节点上执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 worker 节点执行</span></span><br><span class="line">kubeadm reset -f</span><br></pre></td></tr></table></figure>
<p>在 master 节点 demo-master-a-1 上执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure>
<p>如果列表中没有您要移除的节点，则忽略下一个步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 只在 master 节点执行</span><br><span class="line">kubectl delete node demo-worker-x-x</span><br></pre></td></tr></table></figure>
<blockquote>
<p>TIP</p>
<ul>
<li>将 demo-worker-x-x 替换为要移除的 worker 节点的名字</li>
<li>worker 节点的名字可以通过在节点 demo-master-a-1 上执行 kubectl get nodes 命令获得</li>
</ul>
</blockquote>
<h1 id="安装Ingress-Controller"><a href="#安装Ingress-Controller" class="headerlink" title="安装Ingress Controller"></a>安装Ingress Controller</h1><h2 id="快速初始化-1"><a href="#快速初始化-1" class="headerlink" title="快速初始化"></a>快速初始化</h2><p><strong>在master节点上执行</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只在 master 节点执行</span></span><br><span class="line">kubectl apply -f https://kuboard.cn/install-script/v1.19.x/nginx-ingress.yaml</span><br></pre></td></tr></table></figure></p>
<p><strong>nginx-ingress.yaml内容</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"># 如果打算用于生产环境，请参考 https://github.com/nginxinc/kubernetes-ingress/blob/v1.5.5/docs/installation.md 并根据您自己的情况做进一步定制</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress </span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: default-server-secret</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">type: Opaque</span><br><span class="line">data:</span><br><span class="line">  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2akNDQWFZQ0NRREFPRjl0THNhWFhEQU5CZ2txaGtpRzl3MEJBUXNGQURBaE1SOHdIUVlEVlFRRERCWk8KUjBsT1dFbHVaM0psYzNORGIyNTBjbTlzYkdWeU1CNFhEVEU0TURreE1qRTRNRE16TlZvWERUSXpNRGt4TVRFNApNRE16TlZvd0lURWZNQjBHQTFVRUF3d1dUa2RKVGxoSmJtZHlaWE56UTI5dWRISnZiR3hsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwvN2hIUEtFWGRMdjNyaUM3QlBrMTNpWkt5eTlyQ08KR2xZUXYyK2EzUDF0azIrS3YwVGF5aGRCbDRrcnNUcTZzZm8vWUk1Y2Vhbkw4WGM3U1pyQkVRYm9EN2REbWs1Qgo4eDZLS2xHWU5IWlg0Rm5UZ0VPaStlM2ptTFFxRlBSY1kzVnNPazFFeUZBL0JnWlJVbkNHZUtGeERSN0tQdGhyCmtqSXVuektURXUyaDU4Tlp0S21ScUJHdDEwcTNRYzhZT3ExM2FnbmovUWRjc0ZYYTJnMjB1K1lYZDdoZ3krZksKWk4vVUkxQUQ0YzZyM1lma1ZWUmVHd1lxQVp1WXN2V0RKbW1GNWRwdEMzN011cDBPRUxVTExSakZJOTZXNXIwSAo1TmdPc25NWFJNV1hYVlpiNWRxT3R0SmRtS3FhZ25TZ1JQQVpQN2MwQjFQU2FqYzZjNGZRVXpNQ0F3RUFBVEFOCkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWpLb2tRdGRPcEsrTzhibWVPc3lySmdJSXJycVFVY2ZOUitjb0hZVUoKdGhrYnhITFMzR3VBTWI5dm15VExPY2xxeC9aYzJPblEwMEJCLzlTb0swcitFZ1U2UlVrRWtWcitTTFA3NTdUWgozZWI4dmdPdEduMS9ienM3bzNBaS9kclkrcUI5Q2k1S3lPc3FHTG1US2xFaUtOYkcyR1ZyTWxjS0ZYQU80YTY3Cklnc1hzYktNbTQwV1U3cG9mcGltU1ZmaXFSdkV5YmN3N0NYODF6cFErUyt1eHRYK2VBZ3V0NHh3VlI5d2IyVXYKelhuZk9HbWhWNThDd1dIQnNKa0kxNXhaa2VUWXdSN0diaEFMSkZUUkk3dkhvQXprTWIzbjAxQjQyWjNrN3RXNQpJUDFmTlpIOFUvOWxiUHNoT21FRFZkdjF5ZytVRVJxbStGSis2R0oxeFJGcGZnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class="line">  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdi91RWM4b1JkMHUvZXVJTHNFK1RYZUprckxMMnNJNGFWaEMvYjVyYy9XMlRiNHEvClJOcktGMEdYaVN1eE9ycXgrajlnamx4NXFjdnhkenRKbXNFUkJ1Z1B0ME9hVGtIekhvb3FVWmcwZGxmZ1dkT0EKUTZMNTdlT1l0Q29VOUZ4amRXdzZUVVRJVUQ4R0JsRlNjSVo0b1hFTkhzbysyR3VTTWk2Zk1wTVM3YUhudzFtMApxWkdvRWEzWFNyZEJ6eGc2clhkcUNlUDlCMXl3VmRyYURiUzc1aGQzdUdETDU4cGszOVFqVUFQaHpxdmRoK1JWClZGNGJCaW9CbTVpeTlZTW1hWVhsMm0wTGZzeTZuUTRRdFFzdEdNVWozcGJtdlFmazJBNnljeGRFeFpkZFZsdmwKMm82MjBsMllxcHFDZEtCRThCay90elFIVTlKcU56cHpoOUJUTXdJREFRQUJBb0lCQVFDZklHbXowOHhRVmorNwpLZnZJUXQwQ0YzR2MxNld6eDhVNml4MHg4Mm15d1kxUUNlL3BzWE9LZlRxT1h1SENyUlp5TnUvZ2IvUUQ4bUFOCmxOMjRZTWl0TWRJODg5TEZoTkp3QU5OODJDeTczckM5bzVvUDlkazAvYzRIbjAzSkVYNzZ5QjgzQm9rR1FvYksKMjhMNk0rdHUzUmFqNjd6Vmc2d2szaEhrU0pXSzBwV1YrSjdrUkRWYmhDYUZhNk5nMUZNRWxhTlozVDhhUUtyQgpDUDNDeEFTdjYxWTk5TEI4KzNXWVFIK3NYaTVGM01pYVNBZ1BkQUk3WEh1dXFET1lvMU5PL0JoSGt1aVg2QnRtCnorNTZud2pZMy8yUytSRmNBc3JMTnIwMDJZZi9oY0IraVlDNzVWYmcydVd6WTY3TWdOTGQ5VW9RU3BDRkYrVm4KM0cyUnhybnhBb0dCQU40U3M0ZVlPU2huMVpQQjdhTUZsY0k2RHR2S2ErTGZTTXFyY2pOZjJlSEpZNnhubmxKdgpGenpGL2RiVWVTbWxSekR0WkdlcXZXaHFISy9iTjIyeWJhOU1WMDlRQ0JFTk5jNmtWajJTVHpUWkJVbEx4QzYrCk93Z0wyZHhKendWelU0VC84ajdHalRUN05BZVpFS2FvRHFyRG5BYWkyaW5oZU1JVWZHRXFGKzJyQW9HQkFOMVAKK0tZL0lsS3RWRzRKSklQNzBjUis3RmpyeXJpY05iWCtQVzUvOXFHaWxnY2grZ3l4b25BWlBpd2NpeDN3QVpGdwpaZC96ZFB2aTBkWEppc1BSZjRMazg5b2pCUmpiRmRmc2l5UmJYbyt3TFU4NUhRU2NGMnN5aUFPaTVBRHdVU0FkCm45YWFweUNweEFkREtERHdObit3ZFhtaTZ0OHRpSFRkK3RoVDhkaVpBb0dCQUt6Wis1bG9OOTBtYlF4VVh5YUwKMjFSUm9tMGJjcndsTmVCaWNFSmlzaEhYa2xpSVVxZ3hSZklNM2hhUVRUcklKZENFaHFsV01aV0xPb2I2NTNyZgo3aFlMSXM1ZUtka3o0aFRVdnpldm9TMHVXcm9CV2xOVHlGanIrSWhKZnZUc0hpOGdsU3FkbXgySkJhZUFVWUNXCndNdlQ4NmNLclNyNkQrZG8wS05FZzFsL0FvR0FlMkFVdHVFbFNqLzBmRzgrV3hHc1RFV1JqclRNUzRSUjhRWXQKeXdjdFA4aDZxTGxKUTRCWGxQU05rMXZLTmtOUkxIb2pZT2pCQTViYjhibXNVU1BlV09NNENoaFJ4QnlHbmR2eAphYkJDRkFwY0IvbEg4d1R0alVZYlN5T294ZGt5OEp0ek90ajJhS0FiZHd6NlArWDZDODhjZmxYVFo5MWpYL3RMCjF3TmRKS2tDZ1lCbyt0UzB5TzJ2SWFmK2UwSkN5TGhzVDQ5cTN3Zis2QWVqWGx2WDJ1VnRYejN5QTZnbXo5aCsKcDNlK2JMRUxwb3B0WFhNdUFRR0xhUkcrYlNNcjR5dERYbE5ZSndUeThXczNKY3dlSTdqZVp2b0ZpbmNvVlVIMwphdmxoTUVCRGYxSjltSDB5cDBwWUNaS2ROdHNvZEZtQktzVEtQMjJhTmtsVVhCS3gyZzR6cFE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-config</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">data:</span><br><span class="line">  server-names-hash-bucket-size: &quot;1024&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - secrets</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - update</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - events</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">  - patch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;extensions&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses/status</span><br><span class="line">  verbs:</span><br><span class="line">  - update</span><br><span class="line">- apiGroups:</span><br><span class="line">  - k8s.nginx.org</span><br><span class="line">  resources:</span><br><span class="line">  - virtualservers</span><br><span class="line">  - virtualserverroutes</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">  - get</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress</span><br><span class="line">  namespace: nginx-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">    prometheus.io/port: &quot;9113&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-ingress</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ingress</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nginx-ingress</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx/nginx-ingress:1.5.5</span><br><span class="line">        name: nginx-ingress</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 80</span><br><span class="line">        - name: https</span><br><span class="line">          containerPort: 443</span><br><span class="line">          hostPort: 443</span><br><span class="line">        - name: prometheus</span><br><span class="line">          containerPort: 9113</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        args:</span><br><span class="line">          - -nginx-configmaps=$(POD_NAMESPACE)/nginx-config</span><br><span class="line">          - -default-server-tls-secret=$(POD_NAMESPACE)/default-server-secret</span><br><span class="line">         #- -v=3 # Enables extensive logging. Useful for troubleshooting.</span><br><span class="line">         #- -report-ingress-status</span><br><span class="line">         #- -external-service=nginx-ingress</span><br><span class="line">         #- -enable-leader-election</span><br><span class="line">          - -enable-prometheus-metrics</span><br><span class="line">         #- -enable-custom-resources</span><br></pre></td></tr></table></figure></p>
<p><strong>卸载ingress congroller</strong></p>
<p>在master节点上执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#只在 master 节点执行</span><br><span class="line">kubectl delete -f https://kuboard.cn/install-script/v1.19.x/nginx-ingress.yaml</span><br></pre></td></tr></table></figure>
<p><strong>配置域名解析</strong></p>
<p>将域名 *.demo.yourdomain.com 解析到 demo-worker-a-2 的 IP 地址 z.z.z.z （也可以是 demo-worker-a-1 的地址 y.y.y.y）</p>
<p><strong>验证配置</strong></p>
<p>在浏览器访问 a.demo.yourdomain.com，将得到 404 NotFound 错误页面</p>
<blockquote>
<p>提示</p>
</blockquote>
<p>许多初学者在安装 Ingress Controller 时会碰到问题，请不要灰心，可暂时跳过 安装 Ingress Controller 这个部分，等您学完 www.kuboard.cn 上 Kubernetes 入门 以及 通过互联网访问您的应用程序 这两部分内容后，再来回顾 Ingress Controller 的安装。</p>
<p>也可以参考 Install Nginx Ingress</p>
<h1 id="问题及注意"><a href="#问题及注意" class="headerlink" title="问题及注意"></a>问题及注意</h1><h2 id="重启Kubenetes集群后遇到的问题"><a href="#重启Kubenetes集群后遇到的问题" class="headerlink" title="重启Kubenetes集群后遇到的问题"></a>重启Kubenetes集群后遇到的问题</h2><p>Kubernetes集群的设计目标是setup-and-run-forever，然而许多学习者使用自己笔记本上的虚拟机安装K8S集群用于学习，这就必然会出现反复重启集群所在虚拟机的情况。本文针对重启后会出现一些的一些令人困惑的问题做了解释。</p>
<ul>
<li><p>Worker节点不能启动<br>Master 节点的 IP 地址变化，导致 worker 节点不能启动。请重装集群，并确保所有节点都有固定内网 IP 地址。</p>
</li>
<li><p>许多Pod一直Crash或不能正常访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>重启后会发现许多 Pod 不在 Running 状态，此时，请使用如下命令删除这些状态不正常的 Pod。通常，您的 Pod 如果是使用 Deployment、StatefulSet 等控制器创建的，kubernetes 将创建新的 Pod 作为替代，重新启动的 Pod 通常能够正常工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod &lt;pod-name&gt; -n &lt;pod-namespece&gt;</span><br></pre></td></tr></table></figure>
<h2 id="安装过程中的问题"><a href="#安装过程中的问题" class="headerlink" title="安装过程中的问题"></a>安装过程中的问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-ip6tables: No such file or directory</span><br><span class="line">sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.all.forwarding = 1</span><br></pre></td></tr></table></figure>
<p>解决办法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure></p>
<p>查看版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl version</span><br></pre></td></tr></table></figure></p>
<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><p>怎么查看可安装的docker版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates|sort -r</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://kuboard.cn/install/install-k8s.html#%E6%A3%80%E6%9F%A5-centos-hostname" target="_blank" rel="noopener">https://kuboard.cn/install/install-k8s.html#%E6%A3%80%E6%9F%A5-centos-hostname</a><br><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2020/03/15/afka安装及入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/15/afka安装及入门/" itemprop="url">Kafka安装及入门</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-15T12:38:24+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/15/afka安装及入门/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/15/afka安装及入门/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  494
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="下载kafka-cmak"><a href="#下载kafka-cmak" class="headerlink" title="下载kafka,cmak"></a>下载kafka,cmak</h1><p>下载好后，分别解压到/opt目录下</p>
<p>这里如果是单机kafka，可以直接用kafka自带的,启动方式为<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./$KAFKA_HOME/bin/zookeeper-server-start.sh -daemon config/zookeeper.properties</span><br></pre></td></tr></table></figure></p>
<h1 id="配置kafka"><a href="#配置kafka" class="headerlink" title="配置kafka"></a>配置kafka</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">broker.id=0</span><br><span class="line">log.dirs=/tmp/kafka-logs</span><br><span class="line">zookeeper.connect=localhost:2181</span><br></pre></td></tr></table></figure>
<blockquote>
<p>大多数情况下，可能会改动的估计就是上述3个配置，由于kafka需要做持久化消息，故这里有一个log.dirs的配置项</p>
</blockquote>
<h1 id="启动kafka"><a href="#启动kafka" class="headerlink" title="启动kafka"></a>启动kafka</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ./bin/kafka-server-start.sh -daemon config/server.properties</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不加-daemon则是前台启动，若是在docker中启动，就不用加-daemon</p>
</blockquote>
<h1 id="cmak-kafka-manager"><a href="#cmak-kafka-manager" class="headerlink" title="cmak(kafka manager)"></a>cmak(kafka manager)</h1><p><strong>依赖的组件说明</strong></p>
<p>cmak 3.x需要依赖jdk 11+ 且zookeeper需要3.5.x版本,我直接用了es 7.x的自带jdk13</p>
<p>所以修改了cmak启动脚本get_java_cmd函数:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Detect if we should use JAVA_HOME or just try PATH.</span><br><span class="line">get_java_cmd() &#123;</span><br><span class="line"><span class="meta">  #</span> High-priority override for Jlink images</span><br><span class="line"><span class="meta">  #</span>if [[ -n "$bundled_jvm" ]];  then</span><br><span class="line"><span class="meta">  #</span>  echo "$bundled_jvm/bin/java"</span><br><span class="line"><span class="meta">  #</span>elif [[ -n "$JAVA_HOME" ]] &amp;&amp; [[ -x "$JAVA_HOME/bin/java" ]];  then</span><br><span class="line"><span class="meta">  #</span>  echo "$JAVA_HOME/bin/java"</span><br><span class="line"><span class="meta">  #</span>else</span><br><span class="line"><span class="meta">  #</span>  echo "java"</span><br><span class="line"><span class="meta">  #</span>fi</span><br><span class="line">  echo "/opt/elasticsearch-7.6.1/jdk/bin/java"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>修改配置</strong><br>修改conf/application.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kafka-manager.zkhosts=&quot;localhost:2181&quot;</span><br><span class="line">kafka-manager.zkhosts=$&#123;?ZK_HOSTS&#125;</span><br><span class="line">cmak.zkhosts=&quot;localhost:2181&quot;</span><br><span class="line">cmak.zkhosts=$&#123;?ZK_HOSTS&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然也可以不修改application.conf文件，而是提供环境变量ZK_HOSTS</p>
</blockquote>
<p><strong>启动cmak</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/cmak &gt; cmak.out 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p><strong>添加集群</strong></p>
<p>点添加集群（Add Cluster）<br><img src="/images/pasted-36.png" alt="upload successful"></p>
<p>填写集群名称与zookeeper地址<br><img src="/images/pasted-37.png" alt="upload successful"></p>
<p>添加完成查看集群信息，包括zookeepers连接地址，kafka版本，topic数量，broker数量<br><img src="/images/pasted-38.png" alt="upload successful"></p>
<p><strong>查看broker信息</strong></p>
<p><img src="/images/pasted-42.png" alt="upload successful"></p>
<p><strong>查看、操作topic</strong></p>
<p>之前已经创建过first-topic，topics列表就可以看到了<br><img src="/images/pasted-39.png" alt="upload successful"></p>
<p>给topic增加分区</p>
<p><img src="/images/pasted-40.png" alt="upload successful"></p>
<p>创建topic<br><img src="/images/pasted-41.png" alt="upload successful"></p>
<p>PS:更多cmak的功能有待实践</p>
<p><strong>常见错误</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This application is already running (Or delete /opt/kafka-cmak-3.0.0.4/RUNNING_PID file).</span><br></pre></td></tr></table></figure></p>
<p>删掉RUNNING_PID重新启动</p>
<h1 id="Kafka入门"><a href="#Kafka入门" class="headerlink" title="Kafka入门"></a>Kafka入门</h1><p><strong>创建Topic</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/opt/kafka_2.12-2.4.0# ./bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic first-topic</span><br><span class="line">Created topic first-topic.</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://segmentfault.com/a/1190000012730949" target="_blank" rel="noopener">https://segmentfault.com/a/1190000012730949</a><br><a href="https://blog.wolfogre.com/posts/kafka-manager-download/" target="_blank" rel="noopener">https://blog.wolfogre.com/posts/kafka-manager-download/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2020/03/07/ElasticSearch7-x集群安装部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/ElasticSearch7-x集群安装部署/" itemprop="url">ElasticSearch7.x集群安装部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T20:46:29+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/07/ElasticSearch7-x集群安装部署/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/07/ElasticSearch7-x集群安装部署/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,367
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd es &amp;&amp; useradd es -g es -M -s /bin/bash</span><br><span class="line">chown -R es:es /opt/$ES_HOME</span><br></pre></td></tr></table></figure>
<h1 id="系统参数修改"><a href="#系统参数修改" class="headerlink" title="系统参数修改"></a>系统参数修改</h1><ul>
<li>vi /etc/sysctl.conf添加如下配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使得重启之后也生效，即永久生效</p>
</blockquote>
<p> 执行如下命令使得立即生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl –p</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改/etc/security/limits.conf添加以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">es hard nofile 65535</span><br><span class="line">es soft nofile 65535</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/systemd/user.conf和/etc/systemd/system.conf分别添加以下配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DefaultLimitNOFILE=65535</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>systemd启动elasticsearch，需要设置这两个文件，否则启动会报如下错误<br>[1] bootstrap checks failed<br>[1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</p>
</blockquote>
<h1 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf elasticsearch-7.6.1-linux-x86_64.tar.gz -C /opt/</span><br></pre></td></tr></table></figure>
<h1 id="配置ES"><a href="#配置ES" class="headerlink" title="配置ES"></a>配置ES</h1><p>1主2从的配置</p>
<ul>
<li>node-1</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster.name:</span> <span class="string">my-es</span></span><br><span class="line"></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-1</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.131</span></span><br><span class="line"></span><br><span class="line"><span class="string">discovery.seed_hosts:</span> <span class="string">[</span> <span class="string">"192.168.56.132"</span><span class="string">,"192.168.56.133"]</span></span><br><span class="line"><span class="string">cluster.initial_master_nodes:</span> <span class="string">["node-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域，elastic header需要</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>node-2</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster.name:</span> <span class="string">my-es</span></span><br><span class="line"></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-2</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.132</span></span><br><span class="line"></span><br><span class="line"><span class="string">discovery.seed_hosts:</span> <span class="string">["192.168.56.131","192.168.56.133"]</span></span><br><span class="line"></span><br><span class="line"><span class="string">cluster.initial_master_nodes:</span> <span class="string">["node-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域，elastic header需要</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>node-3</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cluster.name:</span> <span class="string">my-es</span></span><br><span class="line"></span><br><span class="line"><span class="string">node.name:</span> <span class="string">node-3</span></span><br><span class="line"><span class="string">node.master:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">node.data:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="string">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="string">network.publish_host:</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.133</span></span><br><span class="line"></span><br><span class="line"><span class="string">discovery.seed_hosts:</span> <span class="string">["192.168.56.131",</span> <span class="string">"192.168.56.132"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="string">cluster.initial_master_nodes:</span> <span class="string">["node-1"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许跨域，elastic header需要</span></span><br><span class="line"><span class="string">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">http.cors.allow-origin:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>生产环境建议network.host: 指定IP</p>
</blockquote>
<h1 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://192.168.56.131:9200/_cluster/health?pretty</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">cluster_name: "my-es",</span><br><span class="line">status: "green",</span><br><span class="line">timed_out: false,</span><br><span class="line">number_of_nodes: 3,</span><br><span class="line">number_of_data_nodes: 3,</span><br><span class="line">active_primary_shards: 0,</span><br><span class="line">active_shards: 0,</span><br><span class="line">relocating_shards: 0,</span><br><span class="line">initializing_shards: 0,</span><br><span class="line">unassigned_shards: 0,</span><br><span class="line">delayed_unassigned_shards: 0,</span><br><span class="line">number_of_pending_tasks: 0,</span><br><span class="line">number_of_in_flight_fetch: 0,</span><br><span class="line">task_max_waiting_in_queue_millis: 0,</span><br><span class="line">active_shards_percent_as_number: 100</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="开机启动ElasticSearch"><a href="#开机启动ElasticSearch" class="headerlink" title="开机启动ElasticSearch"></a>开机启动ElasticSearch</h1><p><strong>方案一 在/etc/init.d目录下</strong></p>
<p>创建名为elasticsearch的文件，内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line"><span class="meta">#</span>description: elasticsearch</span><br><span class="line"><span class="meta">#</span>## BEGIN INIT INFO</span><br><span class="line"><span class="meta">#</span> Provides:          elasticsearch</span><br><span class="line"><span class="meta">#</span> Required-Start:    $all</span><br><span class="line"><span class="meta">#</span> Required-Stop:</span><br><span class="line"><span class="meta">#</span> Default-Start:     2 3 4 5</span><br><span class="line"><span class="meta">#</span> Default-Stop:</span><br><span class="line"><span class="meta">#</span> Short-Description: start elasticsearch</span><br><span class="line"><span class="meta">#</span>## END INIT INFO</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">case "$1" in</span><br><span class="line">start)</span><br><span class="line">    cd /opt/elasticsearch-7.6.1</span><br><span class="line">    ./bin/elasticsearch -d</span><br><span class="line">!</span><br><span class="line">    echo "elasticsearch startup"</span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep -v 'grep elasticsearch' | awk '&#123;print $2&#125;'`</span><br><span class="line">    kill -9 $es_pid</span><br><span class="line">    echo "elasticsearch stopped"</span><br><span class="line">    ;;</span><br><span class="line">restart)</span><br><span class="line">    es_pid=`ps aux|grep elasticsearch | grep -v 'grep elasticsearch' | awk '&#123;print $2&#125;'`</span><br><span class="line">    kill -9 $es_pid</span><br><span class="line">    echo "elasticsearch stopped"</span><br><span class="line">    cd /opt/elasticsearch-7.6.1</span><br><span class="line">    ./bin/elasticsearch -d</span><br><span class="line">!</span><br><span class="line">    echo "elasticsearch startup"</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    echo "start|stop|restart"</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">exit $?</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> chmod a+x elasticsearch.sh</span><br></pre></td></tr></table></figure>
<p><strong>方案二 在/lib/systemd/system目录下</strong></p>
<p>创建名为elasticsearch.service的文件，内容如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=elasticsearch</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/bin/bash /opt/elasticsearch-7.6.1/bin/elasticsearch</span><br><span class="line">Restart=always</span><br><span class="line">User=es</span><br><span class="line">Group=es</span><br><span class="line">WorkingDirectory=/opt/elasticsearch-7.6.1</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=mutil-user.target</span><br></pre></td></tr></table></figure></p>
<p>重载配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure></p>
<p>启用服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo systemctl enable elasticsearch</span><br></pre></td></tr></table></figure></p>
<p>启动服务<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo systemctl start elasticsearch</span><br></pre></td></tr></table></figure></p>
<p>如果启动失败，想看下日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看状态</span><br><span class="line"><span class="meta">$</span> sudo systemctl status elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看日志</span><br><span class="line"><span class="meta">$</span> sudo journalctl -u elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 实时输出最新日志</span><br><span class="line"><span class="meta">$</span> sudo journalctl --follow -u elasticsearch</span><br></pre></td></tr></table></figure>
<p>通过systemctl 启动服务报如下错误<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: ERROR: [1] bootstrap checks failed</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [1]: max file descriptors [4096] for elasticsearch process is too low, increase to at least [65535]</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: ERROR: Elasticsearch did not exit normally - check the logs at /opt/elasticsearch-7.6.1/logs/my-es.log</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,352][INFO ][o.e.n.Node               ] [node-1] stopping ...</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,462][INFO ][o.e.n.Node               ] [node-1] stopped</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,463][INFO ][o.e.n.Node               ] [node-1] closing ...</span><br><span class="line">Mar 15 10:08:51 ubuntu bash[1308]: [2020-03-15T02:08:51,535][INFO ][o.e.n.Node               ] [node-1] closed</span><br></pre></td></tr></table></figure></p>
<p><em>划重点：通过systemctrl自建elasticsearch系统服务的形式来启动的es,则需要修改/etc/systemd/user.conf,/etc/systemd/system.conf这两个文件，添加以下配置</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DefaultLimitNOFILE=65536</span><br></pre></td></tr></table></figure></p>
<h1 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">org.elasticsearch.bootstrap.StartupException: java.lang.RuntimeException: can not run elasticsearch as root</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">174</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:<span class="number">161</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:<span class="number">86</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">125</span>) ~[elasticsearch-cli-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:<span class="number">90</span>) ~[elasticsearch-cli-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">126</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">92</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">Caused by: java.lang.RuntimeException: can not run elasticsearch as root</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:<span class="number">105</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:<span class="number">172</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:<span class="number">349</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">170</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br></pre></td></tr></table></figure>
<p>这个是最常见的了，不能用root用户来启动elasticsearch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> org.elasticsearch.bootstrap.BootstrapException: java.nio.file.AccessDeniedException: /opt/elasticsearch-<span class="number">7.6</span>.1/config/elasticsearch.keystore</span><br><span class="line">Likely root cause: java.nio.file.AccessDeniedException: /opt/elasticsearch-<span class="number">7.6</span>.1/config/elasticsearch.keystore</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:<span class="number">90</span>)</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:<span class="number">111</span>)</span><br><span class="line">	at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:<span class="number">116</span>)</span><br><span class="line">	at java.base/sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:<span class="number">219</span>)</span><br><span class="line">	at java.base/java.nio.file.Files.newByteChannel(Files.java:<span class="number">374</span>)</span><br><span class="line">	at java.base/java.nio.file.Files.newByteChannel(Files.java:<span class="number">425</span>)</span><br><span class="line">	at org.apache.lucene.store.SimpleFSDirectory.openInput(SimpleFSDirectory.java:<span class="number">77</span>)</span><br><span class="line">	at org.elasticsearch.common.settings.KeyStoreWrapper.load(KeyStoreWrapper.java:<span class="number">219</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.loadSecureSettings(Bootstrap.java:<span class="number">234</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:<span class="number">305</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">170</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:<span class="number">161</span>)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:<span class="number">86</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">125</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:<span class="number">90</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">126</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">92</span>)</span><br></pre></td></tr></table></figure>
<p>处理方法 chown -R es:es $ES_HOME/conf</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">2020-03-07 14:50:20,774 main ERROR Unable to invoke factory method in class org.apache.logging.log4j.core.appender.RollingFileAppender for element RollingFile: java.lang.IllegalStateException: No factory method found for class org.apache.logging.log4j.core.appender.RollingFileAppender java.lang.IllegalStateException: No factory method found for class org.apache.logging.log4j.core.appender.RollingFileAppender</span><br><span class="line">	at org.apache.logging.log4j.core.config.plugins.util.PluginBuilder.findFactoryMethod(PluginBuilder.java:<span class="number">235</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.plugins.util.PluginBuilder.build(PluginBuilder.java:<span class="number">135</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.createPluginObject(AbstractConfiguration.java:<span class="number">959</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.createConfiguration(AbstractConfiguration.java:<span class="number">899</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.createConfiguration(AbstractConfiguration.java:<span class="number">891</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.doConfigure(AbstractConfiguration.java:<span class="number">514</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.initialize(AbstractConfiguration.java:<span class="number">238</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.config.AbstractConfiguration.start(AbstractConfiguration.java:<span class="number">250</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.LoggerContext.setConfiguration(LoggerContext.java:<span class="number">547</span>)</span><br><span class="line">	at org.apache.logging.log4j.core.LoggerContext.start(LoggerContext.java:<span class="number">263</span>)</span><br><span class="line">	at org.elasticsearch.common.logging.LogConfigurator.configure(LogConfigurator.java:<span class="number">234</span>)</span><br><span class="line">	at org.elasticsearch.common.logging.LogConfigurator.configure(LogConfigurator.java:<span class="number">127</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:<span class="number">310</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:<span class="number">170</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:<span class="number">161</span>)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:<span class="number">86</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:<span class="number">125</span>)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:<span class="number">90</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">126</span>)</span><br><span class="line">	at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:<span class="number">92</span>)</span><br></pre></td></tr></table></figure>
<p>处理方法 chown -R es:es $ES_HOME/logs</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2020</span>-<span class="number">03</span>-<span class="number">07</span>T14:<span class="number">11</span>:<span class="number">03</span>,<span class="number">119</span>][WARN ][o.e.c.c.Coordinator      ] [node-<span class="number">1</span>] failed to validate incoming join request from node [&#123;node-<span class="number">2</span>&#125;&#123;OTFjHR3wRuyQBMbb9PdGoQ&#125;&#123;GH_dXyYZQIuyjnnBTsELRw&#125;&#123;<span class="number">192.168</span>.56.132&#125;&#123;<span class="number">192.168</span>.56.132:<span class="number">9300</span>&#125;&#123;dil&#125;&#123;ml.machine_memory=<span class="number">3665874944</span>, ml.max_open_jobs=<span class="number">20</span>, xpack.installed=<span class="keyword">true</span>&#125;]</span><br><span class="line">org.elasticsearch.transport.RemoteTransportException: [node-<span class="number">2</span>][<span class="number">192.168</span>.56.132:<span class="number">9300</span>][internal:cluster/coordination/join/validate]</span><br><span class="line">Caused by: org.elasticsearch.cluster.coordination.CoordinationStateRejectedException: join validation on cluster state with a different cluster uuid of6I6UasSd209Y_5-YdZ2A than local cluster uuid <span class="number">4</span>jifFlHcR9K7wQflerzo3g, rejecting</span><br><span class="line">	at org.elasticsearch.cluster.coordination.JoinHelper.lambda$<span class="keyword">new</span>$<span class="number">4</span>(JoinHelper.java:<span class="number">148</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$<span class="number">1</span>.doRun(SecurityServerTransportInterceptor.java:<span class="number">257</span>) ~[?:?]</span><br><span class="line">	at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:<span class="number">37</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:<span class="number">315</span>) ~[?:?]</span><br><span class="line">	at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:<span class="number">63</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.transport.InboundHandler$RequestHandler.doRun(InboundHandler.java:<span class="number">264</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:<span class="number">692</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:<span class="number">37</span>) ~[elasticsearch-<span class="number">7.6</span>.1.jar:<span class="number">7.6</span>.1]</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1128</span>) [?:?]</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">628</span>) [?:?]</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">830</span>) [?:?]</span><br></pre></td></tr></table></figure>
<p>如果集群所有节点cluster.name设置都一样的，但还是报以上错误，可以将集群内的节点的data目录删掉后重启</p>
<h1 id="附加"><a href="#附加" class="headerlink" title="附加"></a>附加</h1><p>目前es没有桌面客户端，不过elasticsearch-head算是比较方便的，用于快速查询下数据。<br>这里我就给出elastic-head，systemd服务的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=elasticsearch head</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Environment=PATH=/opt/node-v12.16.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">ExecStart=/opt/node-v12.16.1/bin/npm run start</span><br><span class="line">Restart=always</span><br><span class="line">User=es</span><br><span class="line">Group=es</span><br><span class="line">WorkingDirectory=/opt/elasticsearch-head</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=mutil-user.target</span><br></pre></td></tr></table></figure>
<blockquote>
<p>请事先安装好node环境，并在/opt/elasticsearch-head目录，执行好npm i -V安装好相关module</p>
</blockquote>
<p>执行如下命令，下次就能开机启动了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> systemctl daemon-reload</span><br><span class="line"><span class="meta">$</span> systemctl enable elasticsearch-head</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/targz.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docker.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/docker.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html</a><br><a href="https://www.linuxtechi.com/set-ulimit-file-descriptors-limit-linux-servers/" target="_blank" rel="noopener">https://www.linuxtechi.com/set-ulimit-file-descriptors-limit-linux-servers/</a><br><a href="https://askubuntu.com/questions/1102512/set-ulimit-for-non-root-user" target="_blank" rel="noopener">https://askubuntu.com/questions/1102512/set-ulimit-for-non-root-user</a><br><a href="https://superuser.com/questions/1200539/cannot-increase-open-file-limit-past-4096-ubuntu/1200818#1200818" target="_blank" rel="noopener">https://superuser.com/questions/1200539/cannot-increase-open-file-limit-past-4096-ubuntu/1200818#1200818</a><br><a href="http://www.ruanyifeng.com/blog/2018/03/systemd-timer.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2018/03/systemd-timer.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2019/12/02/何构建SpringBoot应用的Docker镜像/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/02/何构建SpringBoot应用的Docker镜像/" itemprop="url">如何构建SpringBoot应用的Docker镜像</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-02T20:57:36+08:00">
                2019-12-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/02/何构建SpringBoot应用的Docker镜像/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/12/02/何构建SpringBoot应用的Docker镜像/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,990
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>title: 如何构建SpringBoot应用的Docker镜像<br>date: 2019-12-04 22:17:54<br>categories: </p>
<ul>
<li>SpringBoot<br>tags:</li>
<li>Docker</li>
<li>SpringBoot</li>
</ul>
<hr>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>SpringBoot大道其行，微服务也是大道其行，越来越多的SpringBoot应用使用Docker容器来运行。既然要用Docker容器运行，那首先得把SpringBoot应用打包成Docker镜像。</p>
<h1 id="构建方法"><a href="#构建方法" class="headerlink" title="构建方法"></a>构建方法</h1><p>目前主要的方法有三种：</p>
<ul>
<li>1.使用dockerfile-maven-plugin插件构建</li>
<li>2.使用Google Jib插件构建</li>
<li>3.手动构建</li>
</ul>
<p>下面我们一一来介绍，首先来介绍</p>
<h2 id="使用dockerfile-maven-plugin插件构建"><a href="#使用dockerfile-maven-plugin插件构建" class="headerlink" title="使用dockerfile-maven-plugin插件构建"></a>使用dockerfile-maven-plugin插件构建</h2><p>项目地址：<a href="https://github.com/spotify/dockerfile-maven" target="_blank" rel="noopener">https://github.com/spotify/dockerfile-maven</a></p>
<h3 id="项目根目录下创建Dockerfile"><a href="#项目根目录下创建Dockerfile" class="headerlink" title="项目根目录下创建Dockerfile"></a>项目根目录下创建Dockerfile</h3><blockquote>
<blockquote>
<p>以下给出了多个Dockerfile，根据实际情况选择</p>
</blockquote>
</blockquote>
<ol>
<li><p>简洁版</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> jaychang &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="bash">ARG FILE</span></span><br><span class="line"><span class="bash">ARG APP_NAME</span></span><br><span class="line"><span class="bash">ADD <span class="variable">$&#123;FILE&#125;</span> /app.jar</span></span><br><span class="line"><span class="bash">ENV JAVA_OPTS=<span class="string">"-XX:MaxRAMFraction=2"</span></span></span><br><span class="line"><span class="bash"><span class="comment"># Configure ustc alpine software source and timezone</span></span></span><br><span class="line"><span class="bash">RUN sed -i <span class="string">"s#http://dl-cdn.alpinelinux.org#https://mirrors.aliyun.com#g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br><span class="line"><span class="bash"><span class="comment"># To reduce Tomcat startup time we added a system property pointing to "/dev/urandom" as a source of entropy.</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"sh"</span>,<span class="string">"-c"</span>,<span class="string">"java <span class="variable">$JAVA_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar app.jar"</span>]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>有带-D的参数</p>
</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> jaychang &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="bash">ARG FILE</span></span><br><span class="line"><span class="bash">ARG APP_NAME</span></span><br><span class="line"><span class="bash">ADD <span class="variable">$&#123;FILE&#125;</span> /app.jar</span></span><br><span class="line"><span class="bash"><span class="comment"># PINPOINT_VERSION Default 1.6.2 it can be replaced at docker run use -e or docker service -e or environment in docker-compose.yml</span></span></span><br><span class="line"><span class="bash">ENV PINPOINT_VERSION=1.6.2</span></span><br><span class="line"><span class="bash">ENV JAVA_OPTS=<span class="string">"-XX:MaxRAMFraction=2"</span></span></span><br><span class="line"><span class="bash">ENV PINPOINT_OPTS=<span class="string">"-Dpinpoint.agentId=<span class="variable">$&#123;APP_NAME&#125;</span> -Dpinpoint.applicationName=<span class="variable">$APP_NAME</span>"</span></span></span><br><span class="line"><span class="bash"><span class="comment"># Configure ustc alpine software source and timezone</span></span></span><br><span class="line"><span class="bash">RUN sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br><span class="line"><span class="bash"><span class="comment"># To reduce Tomcat startup time we added a system property pointing to "/dev/urandom" as a source of entropy.</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"sh"</span>,<span class="string">"-c"</span>,<span class="string">"java <span class="variable">$JAVA_OPTS</span> -javaagent:/pinpoint_data/pinpoint-agent-<span class="variable">$&#123;PINPOINT_VERSION&#125;</span>/pinpoint-bootstrap-<span class="variable">$PINPOINT_VERSION</span>.jar <span class="variable">$PINPOINT_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar app.jar"</span>]</span></span><br></pre></td></tr></table></figure>
<ol>
<li>带字体版<blockquote>
<p>常见的场景如excel导出，验证码</p>
</blockquote>
</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> jaychang &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /tmp</span></span><br><span class="line"><span class="bash">ARG FILE</span></span><br><span class="line"><span class="bash">ARG APP_NAME</span></span><br><span class="line"><span class="bash">ADD <span class="variable">$&#123;FILE&#125;</span> /app.jar</span></span><br><span class="line"><span class="bash">ENV JAVA_OPTS=<span class="string">"-XX:MaxRAMFraction=2"</span></span></span><br><span class="line"><span class="bash"><span class="comment"># Configure ustc alpine software source and timezone</span></span></span><br><span class="line"><span class="bash">RUN sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cahce add font-adobe-100dpi ttf-dejavu fontconfig \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br><span class="line"><span class="bash"><span class="comment"># To reduce Tomcat startup time we added a system property pointing to "/dev/urandom" as a source of entropy.</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/sbin/tini"</span>, <span class="string">"--"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"sh"</span>,<span class="string">"-c"</span>,<span class="string">"java <span class="variable">$JAVA_OPTS</span> -Djava.security.egd=file:/dev/./urandom -jar app.jar"</span>]</span></span><br></pre></td></tr></table></figure>
<h3 id="在pom-xml中配置maven插件"><a href="#在pom-xml中配置maven插件" class="headerlink" title="在pom.xml中配置maven插件"></a>在pom.xml中配置maven插件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>build-image<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>tag-image-version<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>tag<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>tag-image-latest<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>tag<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>push<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">FILE</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">APP_NAME</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">APP_NAME</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>docker.image.prefix可以预先在properties标签中定义好，如果要区分不同环境传到不同的镜像中心可使用profiles标签来定义不同环境的docker.image.prefix</p>
</blockquote>
<h3 id="开始构建镜像"><a href="#开始构建镜像" class="headerlink" title="开始构建镜像"></a>开始构建镜像</h3><p>前提是要先安装好docker服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -Dmaven.test.skip=true -U</span><br></pre></td></tr></table></figure>
<h2 id="使用Google-Jib插件构建"><a href="#使用Google-Jib插件构建" class="headerlink" title="使用Google Jib插件构建"></a>使用Google Jib插件构建</h2><p>项目地址：<a href="https://github.com/GoogleContainerTools/jib" target="_blank" rel="noopener">https://github.com/GoogleContainerTools/jib</a></p>
<p>Google Jib的优势是无需事先安装docker，无需定义Dockerfile文件，而且Google Jib可以分层,依赖的jar构成一层，resource构成一层，然后项目本身的classes构建一层。这样如果只是改变项目本身代码，那么构建是非常快的。且推送的镜像也是非常小的，可以大大节省网络流量。</p>
<h3 id="在pom-xml中配置maven插件-1"><a href="#在pom-xml中配置maven插件-1" class="headerlink" title="在pom.xml中配置maven插件"></a>在pom.xml中配置maven插件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;java.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">					<span class="comment">&lt;!-- other annotation processors --&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">compilerArg</span>&gt;</span>-Amapstruct.defaultComponentModel=default<span class="tag">&lt;/<span class="name">compilerArg</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">compilerArg</span>&gt;</span>-Amapstruct.unmappedTargetPolicy=WARN<span class="tag">&lt;/<span class="name">compilerArg</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.cloud.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jib-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">from</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>harbor.chaomeifan.com/library/openjdk:8-jdk-alpine-v1<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">allowInsecureRegistries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">allowInsecureRegistries</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">to</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">tags</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">container</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class="tag">&lt;/<span class="name">creationTime</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">environment</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">PINPOINT_VERSION</span>&gt;</span>1.8.4<span class="tag">&lt;/<span class="name">PINPOINT_VERSION</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">PINPOINT_OPTS</span>&gt;</span>-Dpinpoint.agentId=$&#123;project.artifactId&#125; -Dpinpoint.applicationName=$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">PINPOINT_OPTS</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">NACOS_OPTS</span>&gt;</span>-Dregistry.nacos.namespace=bbae7e8e-29cb-48e3-8c36-c8a9759975a9<span class="tag">&lt;/<span class="name">NACOS_OPTS</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">user</span>&gt;</span>zcckj:zcckj<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/sbin/tini<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>--<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/bin/sh<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>java $&#123;JAVA_OPTS&#125; -javaagent:/pinpoint_data/pinpoint-agent-$&#123;PINPOINT_VERSION&#125;/pinpoint-bootstrap-$PINPOINT_VERSION.jar $PINPOINT_OPTS $NACOS_OPTS -Djava.security.egd=file:/dev/./urandom -cp /app/resources/:/app/classes/:/app/libs/* com.zcckj.jingtian.biz.server.JingtianBizApplication<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>lombok.version为1.18.8</p>
</li>
<li><p>mapstruct.version为1.3.0.Final</p>
</li>
</ul>
<blockquote>
<blockquote>
<p>如果您的项目没有用到Pinpoint,Nacos可以完全精简为如下</p>
</blockquote>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>编译插件省略(同上)...<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span> </span><br><span class="line">		 <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.cloud.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jib-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">from</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>harbor.chaomeifan.com/library/openjdk:8-jdk-alpine-v1<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">allowInsecureRegistries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">allowInsecureRegistries</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">to</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">image</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">tags</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">container</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class="tag">&lt;/<span class="name">creationTime</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">user</span>&gt;</span>zcckj:zcckj<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/sbin/tini<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>--<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/bin/sh<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">arg</span>&gt;</span>java -cp /app/resources/:/app/classes/:/app/libs/* com.zcckj.jingtian.biz.server.JingtianBizApplication<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里我们构建了一个基镜像harbor.chaomeifan.com/library/openjdk:8-jdk-alpine-v1，以下给出基镜像的Dockerfile</p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> zhangjie &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">user</span>=zcckj</span><br><span class="line"><span class="keyword">ARG</span> group=zcckj</span><br><span class="line"><span class="keyword">ARG</span> uid=<span class="number">1739</span></span><br><span class="line"><span class="keyword">ARG</span> gid=<span class="number">1739</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">"-Xmx1024M -Xms1024M -Xmn192M -XX:MaxMetaspaceSize=256M -XX:MetaspaceSize=256M -XX:+UseParallelGC -XX:+UseAdaptiveSizePolicy -XX:MaxGCPauseMillis=100 -XX:ErrorFile=/tmp/hs_err_pid%p.log   -Xloggc:/tmp/gc.log -XX:HeapDumpPath=/tmp -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure aliyun alpine software source and timezone</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add bash bash-completion bash-doc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cahce add font-adobe-100dpi ttf-dejavu fontconfig \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; addgroup --gid <span class="variable">$&#123;gid&#125;</span> <span class="variable">$&#123;group&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; adduser --uid <span class="variable">$&#123;uid&#125;</span> -G <span class="variable">$&#123;group&#125;</span> <span class="variable">$&#123;user&#125;</span> -s /bin/bash -D</span></span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>由于基镜像用了非root用户启动进程，故如果有映射到容器的目录需要将目录所有者所属组改为Dockerfile中定义的用户id,组id，chown -R 1739:1739 /path/directory</p>
<p>如果觉得嫌麻烦，可以在基镜像中直接用root</p>
</blockquote>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> zhangjie &lt;jaychang1987@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">"-Xmx1024M -Xms1024M -Xmn192M -XX:MaxMetaspaceSize=256M -XX:MetaspaceSize=256M -XX:+UseParallelGC -XX:+UseAdaptiveSizePolicy -XX:MaxGCPauseMillis=100 -XX:ErrorFile=/tmp/hs_err_pid%p.log   -Xloggc:/tmp/gc.log -XX:HeapDumpPath=/tmp -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+HeapDumpOnOutOfMemoryError"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure aliyun alpine software source and timezone</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">"s/http:\/\/dl-cdn.alpinelinux.org/https:\/\/mirrors.aliyun.com/g"</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add bash bash-completion bash-doc \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add tzdata curl tini \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cahce add font-adobe-100dpi ttf-dejavu fontconfig \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt;  /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/cache/apk/*</span></span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>这样就无需在jib插件配置中设置<user>zcckj:zcckj</user></p>
</blockquote>
</blockquote>
<h3 id="开始构建镜像-1"><a href="#开始构建镜像-1" class="headerlink" title="开始构建镜像"></a>开始构建镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean compile jib:build -Dmaven.test.skip=true -DsendCredentialsOverHttp=true -U</span><br></pre></td></tr></table></figure>
<h2 id="手工构建"><a href="#手工构建" class="headerlink" title="手工构建"></a>手工构建</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2019/07/27/buntu18-04安装MySQL5-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/27/buntu18-04安装MySQL5-7/" itemprop="url">Ubuntu Linux下安装MySQL5.7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-27T22:40:34+08:00">
                2019-07-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/27/buntu18-04安装MySQL5-7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/27/buntu18-04安装MySQL5-7/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,540
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>MySQL通用Linux二进制安装包用于在Linux系统上安装MySQL。可以根据我们的需求，定制安装MySQL,比如可以设置数据存储目录，日志存储目录等。</p>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>如果系统之前安装过mysql，版本可能是比较旧的，需要在安装之前确认下。可以使用如apt,yum包管理工具，将mysql卸载。并注意/etc/my.cnf，mysql数据存放目录，将数据备份好，然后再删除这些文件或目录。</p>
<p>mysql需要依赖libaio库，在安装mysql前确认已经安装好libaio库</p>
<ul>
<li><p>centos:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum search libaio  # search for info</span><br><span class="line">yum install libaio # install library</span><br></pre></td></tr></table></figure>
</li>
<li><p>ubuntu:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-cache search libaio # search for info</span><br><span class="line">apt-get install libaio1 # install library</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="下载MySQL二进制安装包"><a href="#下载MySQL二进制安装包" class="headerlink" title="下载MySQL二进制安装包"></a>下载MySQL二进制安装包</h1><p>下载64位mysql5.7.27 linux通用二进制安装包<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.27-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>二进制安装包清单</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>目录中的文件</th>
</tr>
</thead>
<tbody>
<tr>
<td>bin</td>
<td>mysqld服务端程序,mysql客户端程序，等其他工具程序</td>
</tr>
<tr>
<td>docs</td>
<td>mysql文档</td>
</tr>
<tr>
<td>man</td>
<td>man手册</td>
</tr>
<tr>
<td>include</td>
<td>header头文件</td>
</tr>
<tr>
<td>share</td>
<td>用于数据库安装的错误消息、字典和SQ</td>
</tr>
<tr>
<td>support-files</td>
<td>各种支持文件</td>
</tr>
</tbody>
</table>
<h1 id="创建用户组、用户"><a href="#创建用户组、用户" class="headerlink" title="创建用户组、用户"></a>创建用户组、用户</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql -s /bin/false mysql</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此用户仅仅用于mysql服务，而不用于系统登录，所以使用useradd -r和-s /bin/false命令选项来创建没有登录权限的用户。</p>
</blockquote>
<h1 id="解压MySQL安装包"><a href="#解压MySQL安装包" class="headerlink" title="解压MySQL安装包"></a>解压MySQL安装包</h1><p>解压mysql安装包到/user/local目录下，并设置软连接，使得mysql的basedir为/usr/local/mysql<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf /path/to/mysql-5.7.27-linux-glibc2.12-x86_64.tar.gz -C /usr/local</span><br><span class="line">cd /usr/local</span><br><span class="line">ln -s mysql-5.7.26-linux-glibc2.12-x86_64 mysql</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>/path/to改为mysql安装包所在目录</p>
</blockquote>
<p>将bin目录添加到PATH环境变量中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:/usr/local/mysql/bin</span><br><span class="line">echo "export PATH=$PATH:/usr/local/mysql/bin" &gt;&gt; ~/.bashrc</span><br><span class="line">echo "export PATH=$PATH:/usr/local/mysql/bin" &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h1 id="mysql目录、文件规划"><a href="#mysql目录、文件规划" class="headerlink" title="mysql目录、文件规划"></a>mysql目录、文件规划</h1><table>
<thead>
<tr>
<th>名称</th>
<th>目录或文件</th>
<th>软链</th>
<th>实际目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据目录datadir</td>
<td>/data/mysql/data</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>参数配置my.cnf</td>
<td>/usr/local/mysql/etc/my.cnf</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>日志log目录</td>
<td>/usr/local/mysql/log</td>
<td>是</td>
<td>/data/mysql/log</td>
</tr>
<tr>
<td>错误日志log-error</td>
<td>/usr/local/mysql/log/mysql_error.log</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>慢查询日志slow_query_log_file</td>
<td>/usr/local/mysql/log/mysql_slow_query.log</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>二进制日志log-bin</td>
<td>/usr/local/mysql/binlogs/mysql-bin</td>
<td>是</td>
<td>/data/mysql/binlogs/mysql-bin</td>
</tr>
<tr>
<td>套接字socket文件</td>
<td>/usr/local/mysql/run/mysql.sock</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>pid文件(进程id)</td>
<td>/usr/local/mysql/run/mysql.pid</td>
<td>否</td>
</tr>
</tbody>
</table>
<blockquote>
<p>默认情况下socket文件， pid文件是存在datadir的，建议还是分开一个目录，取名run目录好一点</p>
</blockquote>
<h1 id="创建所需目录并设置权限"><a href="#创建所需目录并设置权限" class="headerlink" title="创建所需目录并设置权限"></a>创建所需目录并设置权限</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/mysql/&#123;etc,run&#125;</span><br><span class="line">mkdir -p /data/mysql/&#123;data,binlogs,log&#125;</span><br><span class="line">chown -R mysql.mysql /data/mysql</span><br><span class="line">chown -R mysql.mysql /usr/local/mysql/&#123;etc,run&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置my-cnf"><a href="#配置my-cnf" class="headerlink" title="配置my.cnf"></a>配置my.cnf</h2><p>文件放在/usr/local/mysql/etc/my.cnf，放此目录，会自动加载该配置文件的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">socket = /usr/local/mysql/run/mysql.sock</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line">#GENERAL</span><br><span class="line">##########################</span><br><span class="line">user = mysql</span><br><span class="line">port = 3306</span><br><span class="line">server_id = 1</span><br><span class="line">skip-name-resolve</span><br><span class="line">bind-address= 0.0.0.0</span><br><span class="line">default_storage_engine = InnoDB</span><br><span class="line">socket = /usr/local/mysql/run/mysql.sock</span><br><span class="line">pid-file = /usr/local/mysql/run/mysqld.pid</span><br><span class="line">max_allowed_packet=32M</span><br><span class="line">max_connections = 1024</span><br><span class="line">open_files_limit = 65535</span><br><span class="line">#default-time-zone=&apos;+08:00&apos;</span><br><span class="line">explicit_defaults_for_timestamp=true</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># character set</span><br><span class="line">##########################</span><br><span class="line">character_set_server = utf8mb4</span><br><span class="line">collation-server = utf8mb4_general_ci</span><br><span class="line">init_connect=&apos;SET NAMES utf8mb4&apos;</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># DATA STORAGE </span><br><span class="line">##########################</span><br><span class="line">basedir= /usr/local/mysql</span><br><span class="line">datadir = /data/mysql/data</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># INNODB</span><br><span class="line">##########################</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_buffer_pool_size = 512M</span><br><span class="line">innodb_log_buffer_size = 16M</span><br><span class="line">innodb_log_file_size = 128M</span><br><span class="line">innodb_tmpdir= /data/mysql/tmp</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># MyISAM</span><br><span class="line">##########################</span><br><span class="line">key_buffer_size = 64M</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># Logging</span><br><span class="line">##########################</span><br><span class="line"># mysql log timezone use system timezone</span><br><span class="line">log_timestamps=SYSTEM</span><br><span class="line">log_error = /data/mysql/log/mysql_error.log</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># log bin</span><br><span class="line">##########################</span><br><span class="line">log-bin = /data/mysql/binlogs/mysql-bin</span><br><span class="line">sync-binlog = 1</span><br><span class="line">binlog_format = row</span><br><span class="line">binlog_row_image = FULL</span><br><span class="line">expire_logs_days = 15</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># log relay</span><br><span class="line">##########################</span><br><span class="line">relay-log = /data/mysql/binlogs/relay-bin</span><br><span class="line">relay_log_recovery = on</span><br><span class="line">max_relay_log_size = 1G</span><br><span class="line">log_slave_updates = 1</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># gtid</span><br><span class="line">##########################</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">replicate_ignore_db=mysql</span><br><span class="line">replicate_ignore_db=information_schema</span><br><span class="line">replicate_ignore_db=performation_schema</span><br><span class="line">replicate_ignore_db=sys</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># General logs (only enable for debugging – it use too much I/O)</span><br><span class="line">##########################</span><br><span class="line">#general-log = on</span><br><span class="line">#general-log-file = /data/mysql/log/general-query.log</span><br><span class="line"></span><br><span class="line">##########################</span><br><span class="line"># Slow query logs (optional)</span><br><span class="line">##########################</span><br><span class="line">slow_query_log = on</span><br><span class="line">long_query_time= 3</span><br><span class="line">slow_query_log_file = /data/mysql/log/slow-query.log</span><br></pre></td></tr></table></figure></p>
<h2 id="初始化mysql-server"><a href="#初始化mysql-server" class="headerlink" title="初始化mysql server"></a>初始化mysql server</h2><p>查看初始化参数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --verbose --help |more</span><br></pre></td></tr></table></figure></p>
<ul>
<li>初始化数据库<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /user/local/mysql</span><br><span class="line">mkdir mysql-files</span><br><span class="line">chown mysql:mysql mysql-files</span><br><span class="line">chmod 750 mysql-files</span><br><span class="line">bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql/data</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在日志文件理会提示一个临时密码，记录这个密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep 'temporary password' /data/mysql/log/mysql_error.log</span><br></pre></td></tr></table></figure>
<p><img src="\images\pasted-34.png" alt="upload successful"></p>
<ul>
<li>生成ssl</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_ssl_rsa_setup --basedir=/usr/local/mysql --datadir=/data/mysql/data</span><br></pre></td></tr></table></figure>
<h2 id="启动mysql服务"><a href="#启动mysql服务" class="headerlink" title="启动mysql服务"></a>启动mysql服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld_safe --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql/data --defaults-file=/usr/local/mysql/etc/my.cnf &amp;</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld_safe --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql/data &amp;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以不用指定–defaults-file，会加载到$MYSQL_HOME/etc/my.cnf这个配置文件</p>
</blockquote>
<h2 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h2><p>mysql -uroot -p<br>输入上一步查到的临时密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set password=password('123456');</span><br><span class="line">grant all privileges on *.* to root@'%' identified by '123456' with grant option;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
<h1 id="mysql作为系统服务"><a href="#mysql作为系统服务" class="headerlink" title="mysql作为系统服务"></a>mysql作为系统服务</h1><h2 id="非systemctrl管理（不推荐）"><a href="#非systemctrl管理（不推荐）" class="headerlink" title="非systemctrl管理（不推荐）"></a>非systemctrl管理（不推荐）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Next <span class="built_in">command</span> is optional</span></span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysqld</span><br></pre></td></tr></table></figure>
<p>修改/etc/init.d/mysqld的basedir,datadir等配置<br>chomod 755 /etc/init.d/mysqld</p>
<p>下面介绍使用 systemctrl来管理mysql服务</p>
<h2 id="systemctl管理（强烈推荐）"><a href="#systemctl管理（强烈推荐）" class="headerlink" title="systemctl管理（强烈推荐）"></a>systemctl管理（强烈推荐）</h2><p>创建 /etc/systemd/system/mysqld.service<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=MySQL Server</span><br><span class="line">Documentation=man:mysqld(5.7)</span><br><span class="line">Documentation=https://dev.mysql.com/doc/refman/5.7/en/using-systemd.html</span><br><span class="line">After=network.target</span><br><span class="line">After=syslog.target</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=mysql</span><br><span class="line">Group=mysql</span><br><span class="line">#PIDFile=/usr/local/mysql/run/mysqld.pid</span><br><span class="line">#ExecStart=</span><br><span class="line">ExecStart=/usr/local/mysql/bin/mysqld_safe --defaults-file=/usr/local/mysql/etc/my.cnf</span><br><span class="line">LimitNOFILE=65535</span><br></pre></td></tr></table></figure></p>
<p>设置开机启动<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable mysqld</span><br></pre></td></tr></table></figure></p>
<p>启动、停止、查看日志<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctrl start mysqld</span><br><span class="line">systemctrl stop mysqld</span><br><span class="line">journalctl -u mysqld</span><br></pre></td></tr></table></figure></p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>单机多实例的安装配置见<a href="https://www.jb51.net/article/103843.htm，需要注意版本差异" target="_blank" rel="noopener">https://www.jb51.net/article/103843.htm，需要注意版本差异</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://lalitvc.wordpress.com/2019/03/04/mysql-5-7-binary-install-on-linux/" target="_blank" rel="noopener">https://lalitvc.wordpress.com/2019/03/04/mysql-5-7-binary-install-on-linux/</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/postinstallation.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/postinstallation.html</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/using-systemd.html#systemd-mysql-configuration" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/using-systemd.html#systemd-mysql-configuration</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-safe.html#option_mysqld_safe_malloc-lib" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/mysqld-safe.html#option_mysqld_safe_malloc-lib</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html</a><br><a href="https://blog.csdn.net/zml3721/article/details/79090983" target="_blank" rel="noopener">https://blog.csdn.net/zml3721/article/details/79090983</a><br><a href="https://www.jianshu.com/p/0d628b2f7476" target="_blank" rel="noopener">https://www.jianshu.com/p/0d628b2f7476</a><br><a href="https://www.jb51.net/article/103843.htm" target="_blank" rel="noopener">https://www.jb51.net/article/103843.htm</a><br><a href="https://blog.pythian.com/manage-multiple-mysql-binary-installations-with-systemd/" target="_blank" rel="noopener">https://blog.pythian.com/manage-multiple-mysql-binary-installations-with-systemd/</a><br><a href="https://www.linuxidc.com/Linux/2017-10/147829.htm" target="_blank" rel="noopener">https://www.linuxidc.com/Linux/2017-10/147829.htm</a><br><a href="https://blog.csdn.net/l1028386804/article/details/87996449" target="_blank" rel="noopener">https://blog.csdn.net/l1028386804/article/details/87996449</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2019/07/14/ntitled/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/14/ntitled/" itemprop="url">使用Helm安装harbor到Kubernates集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-14T20:34:00+08:00">
                2019-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/14/ntitled/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/14/ntitled/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5,107
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Harbor"><a href="#Harbor" class="headerlink" title="Harbor"></a>Harbor</h1><p>Harbor是一个开源的镜像中心，用于存储、管理容器镜像。</p>
<h1 id="添加harbor的chart仓库"><a href="#添加harbor的chart仓库" class="headerlink" title="添加harbor的chart仓库"></a>添加harbor的chart仓库</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">helm repo add harbor https://helm.goharbor.io</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<h1 id="获取harbor的chart压缩包"><a href="#获取harbor的chart压缩包" class="headerlink" title="获取harbor的chart压缩包"></a>获取harbor的chart压缩包</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm fetch harbor/harbor</span><br><span class="line">tar xzvf harbor-1.1.1.tgz</span><br><span class="line">cd harbor</span><br></pre></td></tr></table></figure>
<h1 id="查看chart包的values-yaml"><a href="#查看chart包的values-yaml" class="headerlink" title="查看chart包的values.yaml"></a>查看chart包的values.yaml</h1><p>安装 Helm Chart 包最重要的当然是values.yaml文件了，我们可以通过覆盖该文件中的属性来改变配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">expose:</span></span><br><span class="line">  <span class="comment"># 设置暴露服务的方式。将类型设置为 ingress、clusterIP或nodePort并补充对应部分的信息。</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ingress</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line">    <span class="comment"># 是否开启 tls，注意：如果类型是 ingress 并且tls被禁用，则在pull/push镜像时，则必须包含端口。详细查看文档：https://github.com/goharbor/harbor/issues/5291。</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 如果你想使用自己的 TLS 证书和私钥，请填写这个 secret 的名称，这个 secret 必须包含名为 tls.crt 和 tls.key 的证书和私钥文件，如果没有设置则会自动生成证书和私钥文件。</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">""</span></span><br><span class="line">    <span class="comment"># 默认 Notary 服务会使用上面相同的证书和私钥文件，如果你想用一个独立的则填充下面的字段，注意只有类型是 ingress 的时候才需要。</span></span><br><span class="line"><span class="attr">    notarySecretName:</span> <span class="string">""</span></span><br><span class="line">    <span class="comment"># common name 是用于生成证书的，当类型是 clusterIP 或者 nodePort 并且 secretName 为空的时候才需要</span></span><br><span class="line"><span class="attr">    commonName:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="attr">      core:</span> <span class="string">core.harbor.domain</span></span><br><span class="line"><span class="attr">      notary:</span> <span class="string">notary.harbor.domain</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line">      <span class="string">ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"true"</span></span><br><span class="line">      <span class="string">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"true"</span></span><br><span class="line">      <span class="string">ingress.kubernetes.io/proxy-body-size:</span> <span class="string">"0"</span></span><br><span class="line">      <span class="string">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">  clusterIP:</span></span><br><span class="line">    <span class="comment"># ClusterIP 服务的名称</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">harbor</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">      httpPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      httpsPort:</span> <span class="number">443</span></span><br><span class="line">      <span class="comment"># Notary 服务监听端口，只有当 notary.enabled 设置为 true 的时候有效</span></span><br><span class="line"><span class="attr">      notaryPort:</span> <span class="number">4443</span></span><br><span class="line"><span class="attr">  nodePort:</span></span><br><span class="line">    <span class="comment"># NodePort 服务名称</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">harbor</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">        nodePort:</span> <span class="number">30002</span></span><br><span class="line"><span class="attr">      https:</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">        nodePort:</span> <span class="number">30003</span></span><br><span class="line"><span class="attr">      notary:</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">4443</span></span><br><span class="line"><span class="attr">        nodePort:</span> <span class="number">30004</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor 核心服务外部访问 URL。主要用于：# 1) 补全 portal 页面上面显示的 docker/helm 命令# 2) 补全返回给 docker/notary 客户端的 token 服务 URL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式：protocol://domain[:port]。# 1) 如果 expose.type=ingress，"domain"的值就是 expose.ingress.hosts.core 的值# 2) 如果 expose.type=clusterIP，"domain"的值就是 expose.clusterIP.name 的值# 3) 如果 expose.type=nodePort，"domain"的值就是 k8s 节点的 IP 地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果在代理后面部署 Harbor，请将其设置为代理的 URL</span></span><br><span class="line"><span class="attr">externalURL:</span> <span class="attr">https://core.harbor.domain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认情况下开启数据持久化，在k8s集群中需要动态的挂载卷默认需要一个StorageClass对象。# 如果你有已经存在可以使用的持久卷，需要在"storageClass"中指定你的 storageClass 或者设置 "existingClaim"。## 对于存储 docker 镜像和 Helm charts 包，你也可以用 "azure"、"gcs"、"s3"、"swift" 或者 "oss"，直接在 "imageChartStorage" 区域设置即可</span></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 设置成"keep"避免在执行 helm 删除操作期间移除 PVC，留空则在 chart 被删除后删除 PVC</span></span><br><span class="line"><span class="attr">  resourcePolicy:</span> <span class="string">"keep"</span></span><br><span class="line"><span class="attr">  persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">    registry:</span></span><br><span class="line">      <span class="comment"># 使用一个存在的 PVC(必须在绑定前先手动创建)</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">""</span></span><br><span class="line">      <span class="comment"># 指定"storageClass"，或者使用默认的 StorageClass 对象，设置成"-"禁用动态分配挂载卷</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      subPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      accessMode:</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">      size:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">    chartmuseum:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      subPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      accessMode:</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">      size:</span> <span class="number">5</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">    jobservice:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      subPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      accessMode:</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">      size:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line">    <span class="comment"># 如果使用外部的数据库服务，下面的设置将会被忽略</span></span><br><span class="line"><span class="attr">    database:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      subPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      accessMode:</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">      size:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line">    <span class="comment"># 如果使用外部的 Redis 服务，下面的设置将会被忽略</span></span><br><span class="line"><span class="attr">    redis:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      subPath:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      accessMode:</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">      size:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line">  <span class="comment"># 定义使用什么存储后端来存储镜像和 charts 包，详细文档地址：https://github.com/docker/distribution/blob/master/docs/configuration.md#storage</span></span><br><span class="line"><span class="attr">  imageChartStorage:</span></span><br><span class="line">    <span class="comment"># 正对镜像和chart存储是否禁用跳转，对于一些不支持的后端(例如对于使用minio的`s3`存储)，需要禁用它。为了禁止跳转，只需要设置`disableredirect=true`即可，详细文档地址：https://github.com/docker/distribution/blob/master/docs/configuration.md#redirect</span></span><br><span class="line"><span class="attr">    disableredirect:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 指定存储类型："filesystem", "azure", "gcs", "s3", "swift", "oss"，在相应的区域填上对应的信息。</span></span><br><span class="line">    <span class="comment"># 如果你想使用 pv 则必须设置成"filesystem"类型</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">filesystem</span></span><br><span class="line"><span class="attr">    filesystem:</span></span><br><span class="line"><span class="attr">      rootdirectory:</span> <span class="string">/storage</span></span><br><span class="line">      <span class="comment">#maxthreads: 100</span></span><br><span class="line"><span class="attr">    azure:</span></span><br><span class="line"><span class="attr">      accountname:</span> <span class="string">accountname</span></span><br><span class="line"><span class="attr">      accountkey:</span> <span class="string">base64encodedaccountkey</span></span><br><span class="line"><span class="attr">      container:</span> <span class="string">containername</span></span><br><span class="line">      <span class="comment">#realm: core.windows.net</span></span><br><span class="line"><span class="attr">    gcs:</span></span><br><span class="line"><span class="attr">      bucket:</span> <span class="string">bucketname</span></span><br><span class="line">      <span class="comment"># The base64 encoded json file which contains the key</span></span><br><span class="line"><span class="attr">      encodedkey:</span> <span class="string">base64-encoded-json-key-file</span></span><br><span class="line">      <span class="comment">#rootdirectory: /gcs/object/name/prefix</span></span><br><span class="line">      <span class="comment">#chunksize: "5242880"</span></span><br><span class="line"><span class="attr">    s3:</span></span><br><span class="line"><span class="attr">      region:</span> <span class="string">us-west-1</span></span><br><span class="line"><span class="attr">      bucket:</span> <span class="string">bucketname</span></span><br><span class="line">      <span class="comment">#accesskey: awsaccesskey</span></span><br><span class="line">      <span class="comment">#secretkey: awssecretkey</span></span><br><span class="line">      <span class="comment">#regionendpoint: http://myobjects.local</span></span><br><span class="line">      <span class="comment">#encrypt: false</span></span><br><span class="line">      <span class="comment">#keyid: mykeyid</span></span><br><span class="line">      <span class="comment">#secure: true</span></span><br><span class="line">      <span class="comment">#v4auth: true</span></span><br><span class="line">      <span class="comment">#chunksize: "5242880"</span></span><br><span class="line">      <span class="comment">#rootdirectory: /s3/object/name/prefix</span></span><br><span class="line">      <span class="comment">#storageclass: STANDARD</span></span><br><span class="line"><span class="attr">    swift:</span></span><br><span class="line"><span class="attr">      authurl:</span> <span class="attr">https://storage.myprovider.com/v3/auth</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">      container:</span> <span class="string">containername</span></span><br><span class="line">      <span class="comment">#region: fr</span></span><br><span class="line">      <span class="comment">#tenant: tenantname</span></span><br><span class="line">      <span class="comment">#tenantid: tenantid</span></span><br><span class="line">      <span class="comment">#domain: domainname</span></span><br><span class="line">      <span class="comment">#domainid: domainid</span></span><br><span class="line">      <span class="comment">#trustid: trustid</span></span><br><span class="line">      <span class="comment">#insecureskipverify: false</span></span><br><span class="line">      <span class="comment">#chunksize: 5M</span></span><br><span class="line">      <span class="comment">#prefix:</span></span><br><span class="line">      <span class="comment">#secretkey: secretkey</span></span><br><span class="line">      <span class="comment">#accesskey: accesskey</span></span><br><span class="line">      <span class="comment">#authversion: 3</span></span><br><span class="line">      <span class="comment">#endpointtype: public</span></span><br><span class="line">      <span class="comment">#tempurlcontainerkey: false</span></span><br><span class="line">      <span class="comment">#tempurlmethods:</span></span><br><span class="line"><span class="attr">    oss:</span></span><br><span class="line"><span class="attr">      accesskeyid:</span> <span class="string">accesskeyid</span></span><br><span class="line"><span class="attr">      accesskeysecret:</span> <span class="string">accesskeysecret</span></span><br><span class="line"><span class="attr">      region:</span> <span class="string">regionname</span></span><br><span class="line"><span class="attr">      bucket:</span> <span class="string">bucketname</span></span><br><span class="line">      <span class="comment">#endpoint: endpoint</span></span><br><span class="line">      <span class="comment">#internal: false</span></span><br><span class="line">      <span class="comment">#encrypt: false</span></span><br><span class="line">      <span class="comment">#secure: true</span></span><br><span class="line">      <span class="comment">#chunksize: 10M</span></span><br><span class="line">      <span class="comment">#rootdirectory: rootdirectory</span></span><br><span class="line"></span><br><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logLevel:</span> <span class="string">debug</span></span><br><span class="line"><span class="comment"># Harbor admin 初始密码，Harbor 启动后通过 Portal 修改该密码</span></span><br><span class="line"><span class="attr">harborAdminPassword:</span> <span class="string">"Harbor12345"</span><span class="comment"># 用于加密的一个 secret key，必须是一个16位的字符串</span></span><br><span class="line"><span class="attr">secretKey:</span> <span class="string">"not-a-secure-key"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果你通过"ingress"保留服务，则下面的Nginx不会被使用</span></span><br><span class="line"><span class="attr">nginx:</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">goharbor/nginx-photon</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># resources:</span></span><br><span class="line">  <span class="comment">#  requests:</span></span><br><span class="line">  <span class="comment">#    memory: 256Mi</span></span><br><span class="line">  <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="comment">## 额外的 Deployment 的一些 annotations</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">portal:</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">goharbor/harbor-portal</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span><span class="comment"># resources:#  requests:#    memory: 256Mi#    cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">core:</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">goharbor/harbor-core</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span><span class="comment"># resources:#  requests:#    memory: 256Mi#    cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">adminserver:</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">goharbor/harbor-adminserver</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># resources:</span></span><br><span class="line">  <span class="comment">#  requests:</span></span><br><span class="line">  <span class="comment">#    memory: 256Mi</span></span><br><span class="line">  <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobservice:</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">goharbor/harbor-jobservice</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  maxJobWorkers:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># jobs 的日志收集器："file", "database" or "stdout"</span></span><br><span class="line"><span class="attr">  jobLogger:</span> <span class="string">file</span></span><br><span class="line"><span class="comment"># resources:#   requests:#     memory: 256Mi#     cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">registry:</span></span><br><span class="line"><span class="attr">  registry:</span></span><br><span class="line"><span class="attr">    image:</span></span><br><span class="line"><span class="attr">      repository:</span> <span class="string">goharbor/registry-photon</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">v2.6.2-v1.7.0</span></span><br><span class="line"><span class="attr">  controller:</span></span><br><span class="line"><span class="attr">    image:</span></span><br><span class="line"><span class="attr">      repository:</span> <span class="string">goharbor/harbor-registryctl</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">chartmuseum:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">goharbor/chartmuseum-photon</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v0.7.1-v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># resources:</span></span><br><span class="line">  <span class="comment">#  requests:</span></span><br><span class="line">  <span class="comment">#    memory: 256Mi</span></span><br><span class="line">  <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">clair:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  image:</span></span><br><span class="line"><span class="attr">    repository:</span> <span class="string">goharbor/clair-photon</span></span><br><span class="line"><span class="attr">    tag:</span> <span class="string">v2.0.7-v1.7.0</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># 用于从 Internet 更新漏洞数据库的http(s)代理</span></span><br><span class="line"><span class="attr">  httpProxy:</span></span><br><span class="line"><span class="attr">  httpsProxy:</span></span><br><span class="line">  <span class="comment"># clair 更新程序的间隔，单位为小时，设置为0来禁用</span></span><br><span class="line"><span class="attr">  updatersInterval:</span> <span class="number">12</span></span><br><span class="line">  <span class="comment"># resources:</span></span><br><span class="line">  <span class="comment">#  requests:</span></span><br><span class="line">  <span class="comment">#    memory: 256Mi</span></span><br><span class="line">  <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">notary:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  server:</span></span><br><span class="line"><span class="attr">    image:</span></span><br><span class="line"><span class="attr">      repository:</span> <span class="string">goharbor/notary-server-photon</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">v0.6.1-v1.7.0</span></span><br><span class="line"><span class="attr">    replicas:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># resources:</span></span><br><span class="line">    <span class="comment">#  requests:</span></span><br><span class="line">    <span class="comment">#    memory: 256Mi</span></span><br><span class="line">    <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">  signer:</span></span><br><span class="line"><span class="attr">    image:</span></span><br><span class="line"><span class="attr">      repository:</span> <span class="string">goharbor/notary-signer-photon</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">v0.6.1-v1.7.0</span></span><br><span class="line"><span class="attr">    replicas:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># resources:</span></span><br><span class="line">    <span class="comment">#  requests:</span></span><br><span class="line">    <span class="comment">#    memory: 256Mi</span></span><br><span class="line">    <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">  nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="comment"># 如果使用外部的数据库，则设置 type=external，然后填写 external 区域的一些连接信息</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">internal</span></span><br><span class="line"><span class="attr">  internal:</span></span><br><span class="line"><span class="attr">    image:</span></span><br><span class="line"><span class="attr">      repository:</span> <span class="string">goharbor/harbor-db</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">v1.7.0</span></span><br><span class="line">    <span class="comment"># 内部的数据库的初始化超级用户的密码</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">"changeit"</span></span><br><span class="line">    <span class="comment"># resources:</span></span><br><span class="line">    <span class="comment">#  requests:</span></span><br><span class="line">    <span class="comment">#    memory: 256Mi</span></span><br><span class="line">    <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">    nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  external:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">"192.168.0.1"</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">"5432"</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">"user"</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">"password"</span></span><br><span class="line"><span class="attr">    coreDatabase:</span> <span class="string">"registry"</span></span><br><span class="line"><span class="attr">    clairDatabase:</span> <span class="string">"clair"</span></span><br><span class="line"><span class="attr">    notaryServerDatabase:</span> <span class="string">"notary_server"</span></span><br><span class="line"><span class="attr">    notarySignerDatabase:</span> <span class="string">"notary_signer"</span></span><br><span class="line"><span class="attr">    sslmode:</span> <span class="string">"disable"</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="comment"># 如果使用外部的 Redis 服务，设置 type=external，然后补充 external 部分的连接信息。</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">internal</span></span><br><span class="line"><span class="attr">  internal:</span></span><br><span class="line"><span class="attr">    image:</span></span><br><span class="line"><span class="attr">      repository:</span> <span class="string">goharbor/redis-photon</span></span><br><span class="line"><span class="attr">      tag:</span> <span class="string">v1.7.0</span></span><br><span class="line">    <span class="comment"># resources:</span></span><br><span class="line">    <span class="comment">#  requests:</span></span><br><span class="line">    <span class="comment">#    memory: 256Mi</span></span><br><span class="line">    <span class="comment">#    cpu: 100m</span></span><br><span class="line"><span class="attr">    nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">    tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">    affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  external:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">"192.168.0.2"</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">"6379"</span></span><br><span class="line">    <span class="comment"># coreDatabaseIndex 必须设置为0</span></span><br><span class="line"><span class="attr">    coreDatabaseIndex:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">    jobserviceDatabaseIndex:</span> <span class="string">"1"</span></span><br><span class="line"><span class="attr">    registryDatabaseIndex:</span> <span class="string">"2"</span></span><br><span class="line"><span class="attr">    chartmuseumDatabaseIndex:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="创建动态存储StorageClass"><a href="#创建动态存储StorageClass" class="headerlink" title="创建动态存储StorageClass"></a>创建动态存储StorageClass</h1><blockquote>
<p>10.1.80.72是nfs服务器的ip地址，/var/nfs/k8s是在nfs服务器上的共享目录</p>
</blockquote>
<p>nfs-client.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">quay.azk8s.cn/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line"><span class="attr">              value:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.72</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_PATH</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">/var/nfs/k8s</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">          nfs:</span></span><br><span class="line"><span class="attr">            server:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.72</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/var/nfs/k8s</span></span><br></pre></td></tr></table></figure>
<p>nfs-client-sa.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["events"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["list",</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["endpoints"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"delete"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
<p>应用nfs-client-sa.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nfs-client-sa.yaml</span><br></pre></td></tr></table></figure>
<p>harbor-data-sc.yaml 创建名为harbor-data的storeclass</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-data</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br></pre></td></tr></table></figure>
<p>应用harbor-data-sc.yaml</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f harbor-data-sc.yaml</span><br></pre></td></tr></table></figure>
<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><p>用之前部署kubernetes的ca证书生成 harbor的 tls.key,tls.crt，10.1.80.77是VIP</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat EOF &lt;&lt; registry.jaychang.cn-csr.json&#123;</span><br><span class="line">    "CN": "harbor",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "10.1.80.71",</span><br><span class="line">        "10.1.80.72",</span><br><span class="line">        "10.1.80.73",</span><br><span class="line">        "10.1.80.77",</span><br><span class="line">        "registry.jaychang.cn"</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "HZ",</span><br><span class="line">            "L": "HangZhou"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>生成harbor.pem,harbor-key.pem</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=/opt/k8s/work/ca.pem \</span><br><span class="line">  -ca-key=/opt/k8s/work/ca-key.pem \</span><br><span class="line">  -config=/opt/k8s/work/ca-config.json \</span><br><span class="line">  -profile=kubernetes registry.jaychang.cn-csr.json | cfssljson -bare harbor</span><br></pre></td></tr></table></figure>
<h1 id="创建tls类型的secret"><a href="#创建tls类型的secret" class="headerlink" title="创建tls类型的secret"></a>创建tls类型的secret</h1><p>使用tr -d ‘\r\n’去掉回车换行符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ca.crt</span></span><br><span class="line">tr -d '\r\n' &lt; /etc/kubernetes/cert/ca.pem |base64</span><br><span class="line"><span class="meta">#</span><span class="bash"> tls.crt</span></span><br><span class="line">tr -d '\r\n' &lt; ./harbor.pem |base64</span><br><span class="line"><span class="meta">#</span><span class="bash"> tls.key</span></span><br><span class="line">tr -d '\r\n' &lt; ./harbor-key.pem |base64</span><br></pre></td></tr></table></figure>
<p>根据上一步返回的结果，替换harbor-secret.yaml文件中的{ca.crt},{tls.crt},{tls.key}<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">ca.crt:</span> <span class="string">&#123;ca.crt&#125;</span></span><br><span class="line">  <span class="string">tls.crt:</span> <span class="string">&#123;tls.crt&#125;</span></span><br><span class="line">  <span class="string">tls.key:</span> <span class="string">&#123;tls.key&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>创建名为harbor-secret的secret</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f harbor-secret.yaml</span><br></pre></td></tr></table></figure>
<h1 id="创建harbor-values-yaml文件"><a href="#创建harbor-values-yaml文件" class="headerlink" title="创建harbor-values.yaml文件"></a>创建harbor-values.yaml文件</h1><p>其中需要修改的内容很少，我们这里主要是用到了自定义的secret，所以需要指定secretName,使用默认的igress暴露服务，其他需要我们修改的就是数据持久化，我们需要提前为上面这些服务创建好PVC或StorageClass。比如我们这里就是使用了一个名为harbor-data的StorageClass资源对象，当然也可以根据我们实际的需求修改 accessMode 或者存储容量：(harbor-data-sc.yaml)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">expose:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ingress</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">harbor-secret</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="attr">      core:</span> <span class="string">registry.jaychang.cn</span></span><br><span class="line"><span class="attr">      notary:</span> <span class="string">notary.jaychang.cn</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line">      <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line">      <span class="string">ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"true"</span></span><br><span class="line">      <span class="string">ingress.kubernetes.io/proxy-body-size:</span> <span class="string">"0"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">externalURL:</span> <span class="attr">https://registry.jaychang.cn</span></span><br><span class="line"></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  resourcePolicy:</span> <span class="string">"keep"</span></span><br><span class="line"><span class="attr">  persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">    registry:</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">"harbor-data"</span></span><br><span class="line"><span class="attr">    chartmuseum:</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">"harbor-data"</span></span><br><span class="line"><span class="attr">    jobservice:</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">"harbor-data"</span></span><br><span class="line"><span class="attr">    database:</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">"harbor-data"</span></span><br><span class="line"><span class="attr">    redis:</span></span><br><span class="line"><span class="attr">      storageClass:</span> <span class="string">"harbor-data"</span></span><br></pre></td></tr></table></figure>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>使用上面定义的harbor-values.yaml进行安装<br>在解压出来的目录里面执行，注意这里的.表示当前所在目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install . --name harbor --namespace kube-ops -f harbor-values.yaml</span><br></pre></td></tr></table></figure>
<p>查看ingress资源对象</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get ing -o wide -n kube-ops</span></span><br><span class="line">NAME                    HOSTS                                     ADDRESS   PORTS     AGE</span><br><span class="line">harbor-harbor-ingress   registry.jaychang.cn,notary.jaychang.cn             80, 443   77m</span><br></pre></td></tr></table></figure>
<h1 id="查看Harbor-Portal"><a href="#查看Harbor-Portal" class="headerlink" title="查看Harbor Portal"></a>查看Harbor Portal</h1><p>添加完成后，在浏览器中输入registry.jaychang.cn就可以打开熟悉的 Harbor 的 Portal 界面了，当然我们配置的 Ingress 中会强制跳转到 https，所以如果你的浏览器有什么安全限制的话，需要信任我们这里 Ingress 对应的证书，证书文件可以通过查看 Secret 资源对象获取。</p>
<p><img src="\images\pasted-26.png" alt="upload successful"><br>原图</p>
<p>然后输入用户名：admin，密码：Harbor12345（当然我们也可以通过 Helm 安装的时候自己覆盖 harborAdminPassword）即可登录进入 Portal 首页：</p>
<p><img src="\images\pasted-27.png" alt="upload successful"></p>
<p>与此同时我们可以看到，证书起作用了(当然先要将自建的ca证书导入到受信任根证书)<br><img src="\images\pasted-28.png" alt="upload successful"></p>
<p>我们可以看到有很多功能，默认情况下会有一个名叫library的项目，改项目默认是公开访问权限的，进入项目可以看到里面还有 Helm Chart 包的管理，可以手动在这里上传，也可以对改项目里面的镜像进行一些配置，比如是否开启自动扫描镜像功能：</p>
<p><img src="\images\pasted-29.png" alt="upload successful"></p>
<h1 id="docker-cli测试login-pull-push"><a href="#docker-cli测试login-pull-push" class="headerlink" title="docker cli测试login,pull,push"></a>docker cli测试login,pull,push</h1><p>然后我们来测试下使用 docker cli 来进行 pull/push 镜像，由于上面我们安装的时候通过 Ingress 来暴露的 Harbor 的服务，而且强制使用了 https，所以如果我们要在终端中使用我们这里的私有仓库的话，就需要配置上相应的证书：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker login registry.jaychang.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">Error response from daemon: Get https://registry.jaychang.cn/v2/: x509: certificate signed by unknown authority</span><br></pre></td></tr></table></figure>
<p>这是因为我们没有提供证书文件，我们将使用到的ca.crt文件复制到/etc/docker/certs.d/registry.jaychang.cn目录下面，如果该目录不存在，则创建它。ca.crt 这个证书文件我们可以通过 Ingress 中使用的 Secret 资源对象来提供：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@host00:/opt/k8s/test/harbor-helm# kubectl get secret harbor-secret -n kube-ops -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  ca.crt: &#123;ca.crt&#125;</span><br><span class="line">  tls.crt: &#123;tls.crt&#125;</span><br><span class="line">  tls.key: &#123;tls.key&#125;</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubectl.kubernetes.io/last-applied-configuration: |</span><br><span class="line">      &#123;"apiVersion":"v1","data":&#123;"ca.crt":"ca的内容"&#125;,"kind":"Secret","metadata":&#123;"annotations":&#123;&#125;,"name":"harbor-secret","namespace":"kube-ops"&#125;,"type":"kubernetes.io/tls"&#125;</span><br><span class="line">  creationTimestamp: "2019-07-09T02:49:17Z"</span><br><span class="line">  name: harbor-secret</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">  resourceVersion: "422332"</span><br><span class="line">  selfLink: /api/v1/namespaces/kube-ops/secrets/harbor-secret</span><br><span class="line">  uid: 24a65b58-a1f4-11e9-adf7-0800276ce4ac</span><br><span class="line">type: kubernetes.io/tls</span><br></pre></td></tr></table></figure>
<p>其中 data 区域中 ca.crt 对应的值就是我们需要证书，不过需要注意还需要做一个 base64 的解码，这样证书配置上以后就可以正常访问了。</p>
<p>将我们自建的ca.crt拷贝到/etc/docker/certs.d/registry.jaychang.cn目录后，再次login果然就可以了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker login registry.jaychang.cn</span></span><br><span class="line">Username: admin</span><br><span class="line">Password:</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure></p>
<p>不过由于上面的方法较为繁琐，所以一般情况下面我们在使用 docker cli 的时候是在 docker 启动参数后面添加一个–insecure-registry参数来忽略证书的校验的，在 docker 启动配置文件docker.service中修改ExecStart的启动参数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ExecStart=/usr/bin/dockerd</span> <span class="bullet">--insecure-registry</span> <span class="string">registry.jaychang.cn</span></span><br></pre></td></tr></table></figure>
<p>或</p>
<p>修改/etc/docker/daemon.json<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">省略...</span><br><span class="line">"insecure-registries": ["registry.jaychang.cn"],</span><br><span class="line">省略...</span><br></pre></td></tr></table></figure></p>
<p>然后保存重启 docker，再使用 docker cli 就没有任何问题了</p>
<p>下面我们测试下docker push ,我们先pull一个busybox镜像<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull busybox</span></span><br><span class="line">Using default tag: latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">latest: Pulling from library/busybox</span><br><span class="line">8e674ad76dce: Pull complete</span><br><span class="line">Digest: sha256:c94cf1b87ccb80f2e6414ef913c748b105060debda482058d2b8d0fce39f11b9</span><br><span class="line">Status: Downloaded newer image for busybox:latest</span><br></pre></td></tr></table></figure></p>
<p>然后重命名tag<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker  images</span></span><br><span class="line">REPOSITORY                                                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">busybox                                                      latest              e4db68de4ff2        3 weeks ago         1.22MB</span><br></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker tag busybox:latest registry.jaychang.cn/library/busybox:latest</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker push registry.jaychang.cn/library/busybox:latest</span></span><br><span class="line">The push refers to repository [registry.jaychang.cn/library/busybox]</span><br><span class="line">6194458b07fc: Pushed</span><br><span class="line">latest: digest: sha256:bf510723d2cd2d4e3f5ce7e93bf1e52c8fd76831995ac3bd3f90ecc866643aff size: 527</span><br></pre></td></tr></table></figure>
<p>我们去harbor portal的library下看看,busybox已经成功上传到harbor了<br><img src="\images\pasted-30.png" alt="upload successful"></p>
<p>镜像 push 成功，同样可以测试下 pull，为了测试我们可以先删除busybox这个镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rmi e4db68de4ff2</span></span><br><span class="line">Untagged: busybox:latest</span><br><span class="line">Untagged: busybox@sha256:c94cf1b87ccb80f2e6414ef913c748b105060debda482058d2b8d0fce39f11b9</span><br><span class="line">Deleted: sha256:e4db68de4ff27c2adfea0c54bbb73a61a42f5b667c326de4d7d5b19ab71c6a3b</span><br><span class="line">Deleted: sha256:6194458b07fcf01f1483d96cd6c34302ffff7f382bb151a6d023c4e80ba3050a</span><br></pre></td></tr></table></figure>
<p>pull也成功了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull registry.jaychang.cn/library/busybox:latest</span></span><br><span class="line">latest: Pulling from library/busybox</span><br><span class="line">8e674ad76dce: Pull complete</span><br><span class="line">Digest: sha256:bf510723d2cd2d4e3f5ce7e93bf1e52c8fd76831995ac3bd3f90ecc866643aff</span><br><span class="line">Status: Downloaded newer image for registry.jaychang.cn/library/busybox:latest</span><br></pre></td></tr></table></figure>
<p>到这里证明上面我们的私有 docker 仓库搭建成功了，大家可以尝试去创建一个私有的项目，然后创建一个新的用户，使用这个用户来进行 pull/push 镜像，Harbor 还具有其他的一些功能，比如镜像复制，大家可以自行测试，感受下 Harbor 和官方自带的 registry 仓库的差别。</p>
<h1 id="查看harbor-secret以及自动创建的pv-pvc"><a href="#查看harbor-secret以及自动创建的pv-pvc" class="headerlink" title="查看harbor-secret以及自动创建的pv,pvc"></a>查看harbor-secret以及自动创建的pv,pvc</h1><p>查看kubernetes dashboard可以看到我们创建的harbor-secret<br><img src="\images\pasted-31.png" alt="upload successful"></p>
<p>可以看到由StorageClass自动创建的pv,pvc<br><img src="\images\pasted-32.png" alt="upload successful"></p>
<h1 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><h2 id="如何使用PV-PVC来搞定数据持久存储"><a href="#如何使用PV-PVC来搞定数据持久存储" class="headerlink" title="如何使用PV,PVC来搞定数据持久存储"></a>如何使用PV,PVC来搞定数据持久存储</h2><p>在nfs服务器上创建相应目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/nfs/k8s/harbor/registry</span><br><span class="line">mkdir -p /var/nfs/k8s/harbor/chartmuseum</span><br><span class="line">mkdir -p /var/nfs/k8s/harbor/jobservice</span><br><span class="line">mkdir -p /var/nfs/k8s/harbor/database</span><br><span class="line">mkdir -p /var/nfs/k8s/harbor/redis</span><br></pre></td></tr></table></figure>
<p>只需要将上面步骤中的创建动态存储StorageClass的步骤，改为使用harbor-pvc.yaml来创建pv,pvc</p>
<p>harbor-pvc.yaml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-registry-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.72</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/var/nfs/k8s/harbor/registry</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-registry-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line">      </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-chartmuseum-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.72</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/var/nfs/k8s/harbor/chartmuseum</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-chartmuseum-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--</span>      </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-jobservice-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.72</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/var/nfs/k8s/harbor/jobservice</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-jobservice-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--</span>     </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-database-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.72</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/var/nfs/k8s/harbor/database</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-database-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="bullet">--</span>     </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-redis-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.1</span><span class="number">.80</span><span class="number">.72</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/var/nfs/k8s/harbor/redis</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">harbor-redis-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure></p>
<p>创建pv,pvc<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl apply -f harbor-pvc.yaml</span></span><br></pre></td></tr></table></figure></p>
<p>并修改harbor-values.yaml，指定各个persistence.persistentVolumeClaim</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">expose:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">ingress</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    secretName:</span> <span class="string">"harbor-secret"</span></span><br><span class="line"><span class="attr">  ingress:</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="attr">      core:</span> <span class="string">registry.jaychang.cn</span></span><br><span class="line"><span class="attr">      notary:</span> <span class="string">notary.jaychang.cn</span></span><br><span class="line"><span class="attr">    annotations:</span></span><br><span class="line">      <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line">      <span class="string">ingress.kubernetes.io/ssl-redirect:</span> <span class="string">"true"</span></span><br><span class="line">      <span class="string">ingress.kubernetes.io/proxy-body-size:</span> <span class="string">"0"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">externalURL:</span> <span class="attr">https://registry.jaychang.cn</span></span><br><span class="line"></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  resourcePolicy:</span> <span class="string">"keep"</span></span><br><span class="line"><span class="attr">  persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">    registry:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">"harbor-registry-pvc"</span></span><br><span class="line"><span class="attr">    chartmuseum:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">"harbor-chartmuseum-pvc"</span></span><br><span class="line"><span class="attr">    jobservice:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">"harbor-jobservice-pvc"</span></span><br><span class="line"><span class="attr">    database:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">"harbor-database-pvc"</span></span><br><span class="line"><span class="attr">    redis:</span></span><br><span class="line"><span class="attr">      existingClaim:</span> <span class="string">"harbor-redis-pvc"</span></span><br></pre></td></tr></table></figure>
<p>安装harbor到kubernetes集群中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ helm install . --name harbor --namespace kube-ops -f harbor-values.yaml</span><br></pre></td></tr></table></figure></p>
<h2 id="如何从kubernetes集群中卸载harbor"><a href="#如何从kubernetes集群中卸载harbor" class="headerlink" title="如何从kubernetes集群中卸载harbor"></a>如何从kubernetes集群中卸载harbor</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> helm delete harbor --purge</span></span><br><span class="line">These resources were kept due to the resource policy:</span><br><span class="line">[PersistentVolumeClaim] harbor-harbor-chartmuseum</span><br><span class="line">[PersistentVolumeClaim] harbor-harbor-jobservice</span><br><span class="line">[PersistentVolumeClaim] harbor-harbor-registry</span><br><span class="line"></span><br><span class="line">release "harbor" deleted</span><br></pre></td></tr></table></figure>
<p>如果想保留数据的话，下面的步骤就不要执行了</p>
<p>删除StorageClass</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f harbor-data-sc.yaml</span></span><br><span class="line">storageclass.storage.k8s.io "harbor-data" deleted</span><br></pre></td></tr></table></figure>
<p>删除ServiceAccount,删除nfs-provisioner<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f nfs-client-sa.yaml</span></span><br><span class="line">serviceaccount "nfs-client-provisioner" deleted</span><br><span class="line">clusterrole.rbac.authorization.k8s.io "nfs-client-provisioner-runner" deleted</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io "run-nfs-client-provisioner" deleted</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl delete -f nfs-client.yaml</span></span><br><span class="line">deployment.extensions "nfs-client-provisioner" deleted</span><br></pre></td></tr></table></figure></p>
<p>kubernetes dashboard上的持久化存储卷，持久化存储卷声明里删除自动创建的pv,pvc</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文介绍了如何使用helm将harbor的chart安装包下载到本地，然后根据values.yaml可配置项，用自己的自定义配置覆盖values.yaml的默认配置项，首先是介绍了如何使用StorageClass来作为数据持久化存储，在QA中又介绍了如何使用pv,pvc来作为数据持久化存储（实际使用中感觉还是pv,pvc作为数据持久化存储比较好），以及介绍了如何从kubernetes集群中卸载harbor</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.qikqiak.com/post/harbor-quick-install/" target="_blank" rel="noopener">https://www.qikqiak.com/post/harbor-quick-install/</a></p>
<p><a href="https://github.com/goharbor/harbor-helm" target="_blank" rel="noopener">https://github.com/goharbor/harbor-helm</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2019/07/07/buntu18-04-Nginx-Lua-GraphicsMagick图片缩放/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/07/buntu18-04-Nginx-Lua-GraphicsMagick图片缩放/" itemprop="url">Ubuntu18.04 Nginx+Lua+GraphicsMagick图片缩放</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-07T21:18:00+08:00">
                2019-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-Server/" itemprop="url" rel="index">
                    <span itemprop="name">Linux Server</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/07/buntu18-04-Nginx-Lua-GraphicsMagick图片缩放/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/07/buntu18-04-Nginx-Lua-GraphicsMagick图片缩放/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,311
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>自己搭建的图片服务器，有图片缩放的需求，大致思路是可以使用nginx调用lua，使用GraphicMagick的命令来做图片缩放</p>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><h2 id="文件夹规划"><a href="#文件夹规划" class="headerlink" title="文件夹规划"></a>文件夹规划</h2><p>lua.jaychang.cn(如/var/filebase)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">jaychang@nginx:~$ tree /var/filebase/</span><br><span class="line">/var/filebase/</span><br><span class="line">├── avatar.png</span><br><span class="line">├── cache</span><br><span class="line">│   └── thumb</span><br><span class="line">│       ├── avatar.png_100x100.png</span><br><span class="line">│       └── upload</span><br><span class="line">│           ├── 1.png_100x100.png #固定高和宽</span><br><span class="line">│           ├── 1.png_400-.png # 定高</span><br><span class="line">│           └── 1.png_800-.png # 定宽</span><br><span class="line">└── upload</span><br><span class="line">    ├── 1.png</span><br><span class="line">4 directories, 8 files</span><br></pre></td></tr></table></figure>
<p>其中img.xyz.com为图片站点根目录<br>cache/thumb为缩略图存放目录<br>upload目录存放上传的图片</p>
<h2 id="链接地址对应关系"><a href="#链接地址对应关系" class="headerlink" title="链接地址对应关系"></a>链接地址对应关系</h2><p>原图访问地址：<a href="http://img.xyz.com/upload/1.png" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png</a><br>缩略图访问地址：<a href="http://img.xyz.com/upload/1.png_100x100.png" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png_100x100.png</a> 即为宽100,高100<br>自动宽地址: <a href="http://img.xyz.com/upload/1.png_-400.png" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png_-400.png</a> 用”-“表示自动,即为高400,宽自动<br>自动高地址: <a href="http://img.xyz.com/upload/1.png_800-.jpg" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png_800-.jpg</a> 用”-“表示自动,即为宽800,高自动</p>
<h2 id="访问流程"><a href="#访问流程" class="headerlink" title="访问流程"></a>访问流程</h2><p>首先判断缩略图是否存在，如存在则直接显示缩略图；<br>缩略图不存在,则判断原图是否存在，如原图存在则拼接graphicsmagick(gm)命令,生成并显示缩略图,否则返回404</p>
<h1 id="所需软件"><a href="#所需软件" class="headerlink" title="所需软件"></a>所需软件</h1><ul>
<li>lua-5.3.5.tar.gz</li>
<li>LuaJIT-2.0.5.tar.gz</li>
<li>nginx-1.14.2.tar.gz</li>
<li>nginx模块：lua-nginx-module-0.10.15.tar.gz<blockquote>
<p>lua-nginx-module 依赖于 LuaJIT 和 ngx_devel_kit。LuaJIT 需要安装，ngx_devel_kit 只需下载源码包，在 Nginx 编译时指定 ngx_devel_kit 目录</p>
</blockquote>
</li>
<li>nginx模块：nginx-http-concat</li>
<li>nginx模块：ngx_devel_kit</li>
<li>nginx模块：nginx-http-concat</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br><span class="line">curl -R -O http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br><span class="line">curl -R -O http://nginx.org/download/nginx-1.14.2.tar.gz</span><br><span class="line">curl -R -O https://github.com/openresty/lua-nginx-module/archive/v0.10.15.tar.gz</span><br><span class="line">curl -R -O https://github.com/openresty/lua-resty-core/archive/v0.1.17.tar.gz</span><br><span class="line">curl -R -O https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz</span><br><span class="line">git clone git@github.com:alibaba/nginx-http-concat.git</span><br></pre></td></tr></table></figure>
<h1 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y gcc g++ make</span><br><span class="line"></span><br><span class="line">apt-get install libreadline-dev libpcre3 libpcre3-dev openssl libssl-dev zlib1g zlib1g-dev libgeoip-dev -y</span><br></pre></td></tr></table></figure>
<h1 id="编译安装Lua-LuaJIT"><a href="#编译安装Lua-LuaJIT" class="headerlink" title="编译安装Lua LuaJIT"></a>编译安装Lua LuaJIT</h1><h2 id="编译安装Lua"><a href="#编译安装Lua" class="headerlink" title="编译安装Lua"></a>编译安装Lua</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br><span class="line">tar zxf lua-5.3.5.tar.gz</span><br><span class="line">cd lua-5.3.5</span><br><span class="line">make linux test</span><br></pre></td></tr></table></figure>
<h2 id="编译安装LuaJIT"><a href="#编译安装LuaJIT" class="headerlink" title="编译安装LuaJIT"></a>编译安装LuaJIT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -R -O http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br><span class="line">tar -zxvf LuaJIT-2.0.5.tar.gz</span><br><span class="line">cd LuaJIT-2.0.5</span><br><span class="line">make -j2 &amp;&amp; make install</span><br><span class="line">export LUAJIT_LIB=/usr/local/lib</span><br><span class="line">export LUAJIT_INC=/usr/local/include/luajit-2.0</span><br><span class="line">echo &quot;/usr/local/lib&quot; &gt; /etc/ld.so.conf.d/usr_local_lib.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>
<h1 id="安装GraphicsMagick"><a href="#安装GraphicsMagick" class="headerlink" title="安装GraphicsMagick"></a>安装GraphicsMagick</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install -y graphicsmagick</span><br></pre></td></tr></table></figure>
<blockquote>
<p>直接用apt来安装的话，可以免去安装 jpg,png 等图片库依赖</p>
</blockquote>
<h1 id="创建用户及相应目录"><a href="#创建用户及相应目录" class="headerlink" title="创建用户及相应目录"></a>创建用户及相应目录</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd nginx &amp;&amp; useradd nginx -g nginx -s /sbin/nologin -M</span><br><span class="line"></span><br><span class="line">mkdir -p /var/tmp/nginx/client_body_temp</span><br><span class="line">mkdir -p /var/tmp/nginx/uwsgi_temp</span><br></pre></td></tr></table></figure>
<p>创建用户也可以用以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd nginx &amp;&amp; useradd nginx -g nginx -s /bin/false -M</span><br></pre></td></tr></table></figure></p>
<h1 id="编译安装nginx"><a href="#编译安装nginx" class="headerlink" title="编译安装nginx"></a>编译安装nginx</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--user=nginx --group=nginx \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_flv_module \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_addition_module \</span><br><span class="line">--with-http_geoip_module \</span><br><span class="line">--add-module=/usr/local/src/lua-nginx-module-0.10.15 \</span><br><span class="line">--add-module=/usr/local/src/ngx_devel_kit-0.3.0 \</span><br><span class="line">--add-module=/usr/local/src/nginx-http-concat \</span><br><span class="line">--http-scgi-temp-path=/var/tmp/nginx/cgi_temp \</span><br><span class="line">--http-client-body-temp-path=/var/tmp/nginx/client_body_temp \</span><br><span class="line">--http-proxy-temp-path=/var/tmp/nginx/proxy_temp \</span><br><span class="line">--http-uwsgi-temp-path=/var/tmp/nginx/uwsgi_temp \</span><br><span class="line">--http-fastcgi-temp-path=/var/tmp/nginx/fastcgi_temp \</span><br><span class="line">--http-log-path=/var/log/nginx/access.log \</span><br><span class="line">--error-log-path=/var/log/nginx/error.log</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j 2 &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p> 注意：动态加载模块，Nginx官方的load_module指令,详细文档<a href="http://nginx.org/en/docs/ngx_core_module.html#load_module" target="_blank" rel="noopener">参考1</a><br>和 <a href="https://www.nginx.com/resources/wiki/extending/converting/#compiling-dynamic" target="_blank" rel="noopener">参考2</a><br>还有–with-http_spdy_module 已经改为–with-http_v2_module了<br>,如果不用geo的话，编译的时候可以不加–with-http_geoip_module，可以不安装libgeoip-dev</p>
<h1 id="测试nginx"><a href="#测试nginx" class="headerlink" title="测试nginx"></a>测试nginx</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure>
<p>如果出现以下错误(没有报错就不用做以下操作了)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/usr/local/src/nginx-1.14.2# nginx -t</span><br><span class="line">nginx: error while loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>执行以下命令即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;/usr/local/lib&quot; &gt; /etc/ld.so.conf.d/usr_local_lib.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure></p>
<h1 id="修改nginx-conf配置文件"><a href="#修改nginx-conf配置文件" class="headerlink" title="修改nginx.conf配置文件"></a>修改nginx.conf配置文件</h1><p>将nginx.conf配置文件中的<strong>server{}段</strong>配置注释掉</p>
<p>加一行配置，以便读取/usr/local/tengine/conf.d目录下所有后缀为.conf的配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include ../conf.d/*.conf;</span><br></pre></td></tr></table></figure></p>
<p>可以参考如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes 4;</span><br><span class="line">worker_cpu_affinity 1000 0100 0010 0001;</span><br><span class="line">error_log /var/log/nginx/error.log error;</span><br><span class="line">pid /usr/local/nginx/logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">	use epoll;</span><br><span class="line">	worker_connections 65535;</span><br><span class="line">&#125;</span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">   lua_load_resty_core off;</span><br><span class="line">   limit_conn_zone $binary_remote_addr zone=one:10m;</span><br><span class="line">   limit_conn_zone $server_name zone=perserver:10m;</span><br><span class="line">	include mime.types;</span><br><span class="line">	include fastcgi.conf;</span><br><span class="line">	default_type application/octet-stream;</span><br><span class="line">	charset utf-8;</span><br><span class="line">	server_names_hash_bucket_size 128;</span><br><span class="line">	client_header_buffer_size 32k;</span><br><span class="line">	large_client_header_buffers 4 64k;</span><br><span class="line">	sendfile on;</span><br><span class="line">	autoindex off;</span><br><span class="line">	tcp_nopush on;</span><br><span class="line">	tcp_nodelay on;</span><br><span class="line">	keepalive_timeout 120;</span><br><span class="line">    </span><br><span class="line">	fastcgi_connect_timeout 60;</span><br><span class="line">	fastcgi_send_timeout 60;</span><br><span class="line">	fastcgi_read_timeout 60;</span><br><span class="line">	fastcgi_buffer_size 128k;</span><br><span class="line">	fastcgi_buffers 8 128k;</span><br><span class="line">	fastcgi_busy_buffers_size 128k;</span><br><span class="line">	fastcgi_temp_file_write_size 128k;</span><br><span class="line">    </span><br><span class="line">	gzip on;</span><br><span class="line">	gzip_min_length 1k;</span><br><span class="line">	gzip_buffers 4 16k;</span><br><span class="line">	gzip_http_version 1.0;</span><br><span class="line">	gzip_comp_level 2;</span><br><span class="line">	gzip_types text/plain application/x-javascript text/css application/xml;</span><br><span class="line">	gzip_vary on;</span><br><span class="line"></span><br><span class="line">	log_format main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">	&apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">	&apos;&quot;$http_user_agent&quot; $http_x_forwarded_for&apos;;</span><br><span class="line"></span><br><span class="line">	client_max_body_size 10m;</span><br><span class="line"></span><br><span class="line">	include ../conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：lua_load_resty_core off;如果不加会有以下错误</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nginx: [alert] detected a LuaJIT version which is not OpenResty&apos;s; many optimizations will be disabled and performance will be compromised (see https://github.com/openresty/luajit2 for OpenResty&apos;s LuaJIT or, even better, consider using the OpenResty releases from https://openresty.org/en/download.html)</span><br><span class="line">nginx: [error] lua_load_resty_core failed to load the resty.core module from https://github.com/openresty/lua-resty-core; ensure you are using an OpenResty release from https://openresty.org/en/download.html (rc: 2, reason: module &apos;resty.core&apos; not found:</span><br><span class="line">        no field package.preload[&apos;resty.core&apos;]</span><br><span class="line">        no file &apos; /usr/local/lib/lua-resty-core-0.1.17/lib/resty/core.lua&apos;</span><br><span class="line">        no file &apos;./resty/core.lua&apos;</span><br><span class="line">        no file &apos;/usr/local/share/luajit-2.0.5/resty/core.lua&apos;</span><br><span class="line">        no file &apos;/usr/local/share/lua/5.1/resty/core.lua&apos;</span><br><span class="line">        no file &apos;/usr/local/share/lua/5.1/resty/core/init.lua&apos;</span><br><span class="line">        no file &apos;./resty/core.so&apos;</span><br><span class="line">        no file &apos;/usr/local/lib/lua/5.1/resty/core.so&apos;</span><br><span class="line">        no file &apos;/usr/local/lib/lua/5.1/loadall.so&apos;</span><br><span class="line">        no file &apos;./resty.so&apos;</span><br><span class="line">        no file &apos;/usr/local/lib/lua/5.1/resty.so&apos;</span><br><span class="line">        no file &apos;/usr/local/lib/lua/5.1/loadall.so&apos;)</span><br></pre></td></tr></table></figure>
<h1 id="创建放图片的目录"><a href="#创建放图片的目录" class="headerlink" title="创建放图片的目录"></a>创建放图片的目录</h1><p>目录规划</p>
<ul>
<li>/var/www 放网页,css,js等资源</li>
<li>/var/fielbase 放图片</li>
<li>/var/filebase/upload 上传的图片放这里</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/filebase/upload </span><br><span class="line">mkdir -p /var/filebase/cache/thumb</span><br><span class="line">chown -R nginx:nginx /var/filebase</span><br></pre></td></tr></table></figure>
<h1 id="配置站点配置文件"><a href="#配置站点配置文件" class="headerlink" title="配置站点配置文件"></a>配置站点配置文件</h1><p>在/usr/local/tengine/conf.d目录下创建demo.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"># 定义lua缩略图支持的图片尺寸及开关</span><br><span class="line">init_by_lua &apos;</span><br><span class="line">    image_sizes_check = true</span><br><span class="line">    image_sizes = &#123;&quot;800x800&quot;, &quot;400x400&quot;,&quot;200x200&quot;,&quot;100x100&quot;, &quot;-800&quot;, &quot;-400&quot;, &quot;-200&quot;,&quot;-100&quot;, &quot;800-&quot;, &quot;400-&quot;, &quot;200-&quot;,&quot;100-&quot;&#125;</span><br><span class="line">&apos;;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   80;</span><br><span class="line">    servername img.xyz.com;</span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    set $root_path &apos;/var/www&apos;;</span><br><span class="line">    root $root_path;</span><br><span class="line"></span><br><span class="line">   # /lua仅用于测试，可去掉</span><br><span class="line">	 location /lua &#123;</span><br><span class="line">		default_type &apos;text/plain&apos;;</span><br><span class="line">        content_by_lua &apos;ngx.say(&quot;hello, ttlsa lua&quot;)&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # 这里也是需要根据实际情况修改的，这里的是用了rewrite</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ /index.php?$args;</span><br><span class="line"></span><br><span class="line">        # add support for img which has query params,</span><br><span class="line">        # like:  xxx.jpg?a=b&amp;c=d_750x750.jpg</span><br><span class="line">        if ($args ~* &quot;^([^_]+)_(\d+)+x(\d+)+\.(jpg|jpeg|gif|png)$&quot;) &#123;</span><br><span class="line">            set $w $2;</span><br><span class="line">            set $h $3;</span><br><span class="line">            set $img_ext $4;</span><br><span class="line"></span><br><span class="line">            # rewrite ^\?(.*)$ _$&#123;w&#125;x$&#123;h&#125;.$img_ext? last;</span><br><span class="line">            rewrite ([^.]*).(jpg|jpeg|png|gif)$  $1.$2_$&#123;w&#125;x$&#123;h&#125;.$img_ext? permanent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # set var for thumb pic</span><br><span class="line">    set $upload_path /var/filebase;</span><br><span class="line">    set $img_original_root  $upload_path;# original root;</span><br><span class="line">    set $img_thumbnail_root $upload_path/cache/thumb;</span><br><span class="line">    set $img_file $img_thumbnail_root$uri;</span><br><span class="line"></span><br><span class="line">    # like：/xx/xx/xx.jpg_100-.jpg or /xx/xx/xx.jpg_-100.jpg</span><br><span class="line">    location ~* ^(.+\.(jpg|jpeg|gif|png))_((\d+\-)|(\-\d+))\.(jpg|jpeg|gif|png)$ &#123;</span><br><span class="line">            root $img_thumbnail_root;    # root path for croped img</span><br><span class="line">            set $img_size $3;</span><br><span class="line"></span><br><span class="line">            if (!-f $img_file) &#123;    # if file not exists</span><br><span class="line">                    add_header X-Powered-By &apos;Nginx+Lua+GraphicsMagick By Botao&apos;;  #  header for test</span><br><span class="line">                    add_header file-path $request_filename;    #  header for test</span><br><span class="line">                    set $request_filepath $img_original_root$1;    # origin_img full path：/document_root/1.gif</span><br><span class="line">                    set $img_size $3;    # img width or height size depends on uri</span><br><span class="line">                    set $img_ext $2;    # file ext</span><br><span class="line">                    content_by_lua_file /usr/local/nginx/lua/autoSize.lua;    # load lua</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # like: /xx/xx/xx.jpg_100x100.jpg</span><br><span class="line">    location ~* ^(.+\.(jpg|jpeg|gif|png))_(\d+)+x(\d+)+\.(jpg|jpeg|gif|png)$ &#123;</span><br><span class="line">            root $img_thumbnail_root;    # root path for croped img</span><br><span class="line"></span><br><span class="line">            if (!-f $img_file) &#123;    # if file not exists</span><br><span class="line">                    add_header X-Powered-By &apos;Nginx+Lua+GraphicsMagick By Botao&apos;;  #  header for test</span><br><span class="line">                    add_header file-path $request_filename;    #  header for test</span><br><span class="line">                    set $request_filepath $img_original_root$1;    # origin_img file path</span><br><span class="line">                    set $img_width $3;    # img width</span><br><span class="line">                    set $img_height $4;    # height</span><br><span class="line">                    set $img_ext $5;    # file ext</span><br><span class="line">                    content_by_lua_file /usr/local/nginx/lua/cropSize.lua;    # load lua</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # if need (all go there)</span><br><span class="line">    location ~* /upload &#123;</span><br><span class="line">            root $img_original_root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="lua脚本"><a href="#lua脚本" class="headerlink" title="lua脚本"></a>lua脚本</h1><ul>
<li>/usr/local/tengine/lua/autoSize.lua</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">-- 根据输入长或宽的尺寸自动裁切图片大小</span><br><span class="line"></span><br><span class="line">-- 检测路径是否目录</span><br><span class="line">local function is_dir(sPath)</span><br><span class="line">    if type(sPath) ~= &quot;string&quot; then return false end</span><br><span class="line"></span><br><span class="line">    local response = os.execute(&quot;cd &quot; .. sPath)</span><br><span class="line">    if response == 0 then</span><br><span class="line">        return true</span><br><span class="line">    end</span><br><span class="line">    return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 文件是否存在</span><br><span class="line">function file_exists(name)</span><br><span class="line">    local f = io.open(name, &quot;r&quot;)</span><br><span class="line">    if f ~= nil then io.close(f) return true else return false end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件路径</span><br><span class="line">function getFileDir(filename)</span><br><span class="line">    return string.match(filename, &quot;(.+)/[^/]*%.%w+$&quot;) --*nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件名</span><br><span class="line">function strippath(filename)</span><br><span class="line">    return string.match(filename, &quot;.+/([^/]*%.%w+)$&quot;) -- *nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--去除扩展名</span><br><span class="line">function stripextension(filename)</span><br><span class="line">    local idx = filename:match(&quot;.+()%.%w+$&quot;)</span><br><span class="line">    if (idx) then</span><br><span class="line">        return filename:sub(1, idx - 1)</span><br><span class="line">    else</span><br><span class="line">        return filename</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--获取扩展名</span><br><span class="line">function getExtension(filename)</span><br><span class="line">    return filename:match(&quot;.+%.(%w+)$&quot;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function getImgSize(img)</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 判断尺寸是否合法</span><br><span class="line">-- check image size</span><br><span class="line">function table.contains(table, element)</span><br><span class="line">   for _, value in pairs(table) do</span><br><span class="line">      if value == element then</span><br><span class="line">         return true</span><br><span class="line">      end</span><br><span class="line">   end</span><br><span class="line">   return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if image_sizes_check</span><br><span class="line">then</span><br><span class="line">    if not table.contains(image_sizes, ngx.var.img_size)</span><br><span class="line">    then</span><br><span class="line">        ngx.exit(404);</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">-- check image end</span><br><span class="line"></span><br><span class="line">-- 开始执行</span><br><span class="line">-- ngx.log(ngx.ERR, getFileDir(ngx.var.img_file));</span><br><span class="line"></span><br><span class="line">local gm_path = &apos;gm&apos;</span><br><span class="line"></span><br><span class="line">-- check image dir</span><br><span class="line">if not is_dir(getFileDir(ngx.var.img_file)) then</span><br><span class="line">    os.execute(&quot;mkdir -p &quot; .. getFileDir(ngx.var.img_file))</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取高宽 100!或!100模式</span><br><span class="line">local uri = ngx.var.img_size</span><br><span class="line">local width = string.sub(uri,1,1)</span><br><span class="line">local height = 0</span><br><span class="line"></span><br><span class="line">if width == &quot;-&quot; then</span><br><span class="line">  width = 0</span><br><span class="line">  height = string.sub(uri,2,string.len(uri))</span><br><span class="line">else</span><br><span class="line">  width = string.sub(uri,1,string.len(uri)-1)</span><br><span class="line">  height = 0</span><br><span class="line">end</span><br><span class="line">-- ngx.log(ngx.ERR,uri)</span><br><span class="line">-- ngx.log(ngx.ERR,width)</span><br><span class="line">-- ngx.log(ngx.ERR,height)</span><br><span class="line">-- ngx.log(ngx.ERR,ngx.var.img_file);</span><br><span class="line">-- ngx.log(ngx.ERR,ngx.var.request_filepath);</span><br><span class="line">-- 裁剪后保证等比缩图 （缺点：裁剪了图片的一部分）</span><br><span class="line">-- 如: gm convert autoSize.jpg -resize x200 -quality 100 +profile &quot;*&quot; autoSize.jpg_-200.jpg</span><br><span class="line">if (file_exists(ngx.var.request_filepath)) then</span><br><span class="line">    local cmd = gm_path .. &apos; convert -auto-orient &apos; .. ngx.var.request_filepath</span><br><span class="line">    if height == 0 then</span><br><span class="line">        cmd = cmd .. &quot; -resize &quot; .. width .. &quot;x&quot; ..  &quot;&quot;</span><br><span class="line">    else</span><br><span class="line">        cmd = cmd .. &quot; -resize &quot; .. &quot;x&quot; .. height .. &quot;&quot;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">-- 由于压缩后比较模糊,默认图片质量为100,请根据自己情况修改quality</span><br><span class="line">    cmd = cmd .. &quot; -quality 100&quot;</span><br><span class="line">    cmd = cmd .. &quot; +profile \&quot;*\&quot; &quot; .. ngx.var.img_file;</span><br><span class="line">    ngx.log(ngx.ERR, cmd);</span><br><span class="line">    os.execute(cmd);</span><br><span class="line">    ngx.exec(ngx.var.uri);</span><br><span class="line">else</span><br><span class="line">    ngx.exit(ngx.HTTP_NOT_FOUND);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>/usr/local/tengine/lua/cropSize.lua</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">-- 根据输入长和宽的尺寸裁切图片</span><br><span class="line"></span><br><span class="line">-- 检测路径是否目录</span><br><span class="line">local function is_dir(sPath)</span><br><span class="line">    if type(sPath) ~= &quot;string&quot; then return false end</span><br><span class="line"></span><br><span class="line">    local response = os.execute(&quot;cd &quot; .. sPath)</span><br><span class="line">    if response == 0 then</span><br><span class="line">        return true</span><br><span class="line">    end</span><br><span class="line">    return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 文件是否存在</span><br><span class="line">function file_exists(name)</span><br><span class="line">    local f = io.open(name, &quot;r&quot;)</span><br><span class="line">    if f ~= nil then io.close(f) return true else return false end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件路径</span><br><span class="line">function getFileDir(filename)</span><br><span class="line">    return string.match(filename, &quot;(.+)/[^/]*%.%w+$&quot;) --*nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件名</span><br><span class="line">function strippath(filename)</span><br><span class="line">    return string.match(filename, &quot;.+/([^/]*%.%w+)$&quot;) -- *nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--去除扩展名</span><br><span class="line">function stripextension(filename)</span><br><span class="line">    local idx = filename:match(&quot;.+()%.%w+$&quot;)</span><br><span class="line">    if (idx) then</span><br><span class="line">        return filename:sub(1, idx - 1)</span><br><span class="line">    else</span><br><span class="line">        return filename</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--获取扩展名</span><br><span class="line">function getExtension(filename)</span><br><span class="line">    return filename:match(&quot;.+%.(%w+)$&quot;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 判断尺寸是否合法</span><br><span class="line">-- 待切割的图片尺寸</span><br><span class="line">local img_width_height = ngx.var.img_width .. &quot;x&quot; .. ngx.var.img_height;</span><br><span class="line">-- check image size</span><br><span class="line">function table.contains(table, element)</span><br><span class="line">   for _, value in pairs(table) do</span><br><span class="line">      if value == element then</span><br><span class="line">         return true</span><br><span class="line">      end</span><br><span class="line">   end</span><br><span class="line">   return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if image_sizes_check</span><br><span class="line">then</span><br><span class="line">    if not table.contains(image_sizes, img_width_height)</span><br><span class="line">    then</span><br><span class="line">        ngx.exit(404);</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">-- check image end</span><br><span class="line"></span><br><span class="line">-- 开始执行</span><br><span class="line">-- ngx.log(ngx.ERR, getFileDir(ngx.var.img_file));</span><br><span class="line"></span><br><span class="line">local gm_path = &apos;gm&apos;</span><br><span class="line"></span><br><span class="line">-- check image dir</span><br><span class="line">if not is_dir(getFileDir(ngx.var.img_file)) then</span><br><span class="line">    os.execute(&quot;mkdir -p &quot; .. getFileDir(ngx.var.img_file))</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--  ngx.log(ngx.ERR,ngx.var.img_file);</span><br><span class="line">--  ngx.log(ngx.ERR,ngx.var.request_filepath);</span><br><span class="line"></span><br><span class="line">-- 裁剪后保证等比缩图 （缺点：裁剪了图片的一部分）</span><br><span class="line">-- gm convert cropSize.jpg -thumbnail 300x300^ -gravity center -extent 300x300 -quality 100 +profile &quot;*&quot; cropSize.jpg_300x300.jpg</span><br><span class="line">if (file_exists(ngx.var.request_filepath)) then</span><br><span class="line">    local cmd = gm_path .. &apos; convert -auto-orient &apos; .. ngx.var.request_filepath</span><br><span class="line">    cmd = cmd .. &quot; -thumbnail &quot; .. ngx.var.img_width .. &quot;x&quot; .. ngx.var.img_height .. &quot;^&quot;</span><br><span class="line">    cmd = cmd .. &quot; -gravity center -extent &quot; .. ngx.var.img_width .. &quot;x&quot; .. ngx.var.img_height</span><br><span class="line"></span><br><span class="line">    -- 由于压缩后比较模糊,默认图片质量为100,请根据自己情况修改quality</span><br><span class="line">    cmd = cmd .. &quot; -quality 100&quot;</span><br><span class="line">    cmd = cmd .. &quot; +profile \&quot;*\&quot; &quot; .. ngx.var.img_file;</span><br><span class="line">--  ngx.log(ngx.ERR, cmd);</span><br><span class="line">    os.execute(cmd);</span><br><span class="line">    ngx.exec(ngx.var.uri);</span><br><span class="line">else</span><br><span class="line">    ngx.exit(ngx.HTTP_NOT_FOUND);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>然后 nginx -s reload下</p>
<h1 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h1><p>在/var/filebase/upload目录，放1张图片</p>
<p><img src="\images\pasted-21.png" alt="upload successful"><br>原图</p>
<p><img src="\images\pasted-22.png" alt="upload successful"><br>100x100</p>
<p><img src="\images\pasted-23.png" alt="upload successful"><br>由于我们开启了image_sizes_check，不支持的尺寸会返回404</p>
<p><img src="\images\pasted-24.png" alt="upload successful"><br>固定定宽高自适应</p>
<p><img src="\images\pasted-25.png" alt="upload successful"><br>查看服务器上生成的文件</p>
<p>PS:这里有个问题，就是图片缩放后，图片的方向跟原先不一致的问题，后来笔者查了下GraphicsMagick资料，关于图片缩放后改变图片方向的问题，可以用-auto-orient参数可以来解决的,可以写成”gm convert -auto-orient “</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://github.com/botaozhao/nginx-lua-GraphicsMagick" target="_blank" rel="noopener">https://github.com/botaozhao/nginx-lua-GraphicsMagick</a><br><a href="https://www.fanhaobai.com/2017/09/lua-in-nginx.html" target="_blank" rel="noopener">https://www.fanhaobai.com/2017/09/lua-in-nginx.html</a><br><a href="https://github.com/openresty/lua-nginx-module/issues/1533" target="_blank" rel="noopener">https://github.com/openresty/lua-nginx-module/issues/1533</a><br><a href="https://github.com/openresty/lua-nginx-module/pull/1501#issuecomment-486123650" target="_blank" rel="noopener">https://github.com/openresty/lua-nginx-module/pull/1501#issuecomment-486123650</a><br><a href="https://github.com/openresty/lua-resty-core/issues/248" target="_blank" rel="noopener">https://github.com/openresty/lua-resty-core/issues/248</a><br><a href="https://segmentfault.com/a/1190000011093243" target="_blank" rel="noopener">https://segmentfault.com/a/1190000011093243</a><br><a href="https://github.com/yanue/nginx-lua-GraphicsMagick/blob/master/nginx-install.md" target="_blank" rel="noopener">https://github.com/yanue/nginx-lua-GraphicsMagick/blob/master/nginx-install.md</a><br><a href="http://www.icode9.com/content-3-77987.html" target="_blank" rel="noopener">http://www.icode9.com/content-3-77987.html</a><br><a href="https://my.oschina.net/ranhai/blog/1797454" target="_blank" rel="noopener">https://my.oschina.net/ranhai/blog/1797454</a><br><a href="https://www.twblogs.net/a/5bafdb372b7177781a0f64d7/zh-cn" target="_blank" rel="noopener">https://www.twblogs.net/a/5bafdb372b7177781a0f64d7/zh-cn</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2019/06/10/Ubuntu18-04-安装tengine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/10/Ubuntu18-04-安装tengine/" itemprop="url">Ubuntu18.04 Tengine+Lua+GraphicsMagick图片缩放</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-10T21:36:00+08:00">
                2019-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-Server/" itemprop="url" rel="index">
                    <span itemprop="name">Linux Server</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/10/Ubuntu18-04-安装tengine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/10/Ubuntu18-04-安装tengine/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,952
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>自己搭建的图片服务器，有图片缩放的需求，大致思路是可以使用nginx调用lua，使用GraphicMagick的命令来做图片缩放</p>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><h2 id="文件夹规划"><a href="#文件夹规划" class="headerlink" title="文件夹规划"></a>文件夹规划</h2><p>lua.jaychang.cn(如/var/filebase)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">jaychang@tengine:~$ tree /var/filebase/</span><br><span class="line">/var/filebase/</span><br><span class="line">├── avatar.png</span><br><span class="line">├── cache</span><br><span class="line">│   └── thumb</span><br><span class="line">│       ├── avatar.png_100x100.png</span><br><span class="line">│       └── upload</span><br><span class="line">│           ├── 1.png_100x100.png #固定高和宽</span><br><span class="line">│           ├── 1.png_400-.png # 定高</span><br><span class="line">│           └── 1.png_800-.png # 定宽</span><br><span class="line">└── upload</span><br><span class="line">    ├── 1.png</span><br><span class="line">4 directories, 8 files</span><br></pre></td></tr></table></figure>
<p>其中img.xyz.com为图片站点根目录<br>cache/thumb为缩略图存放目录<br>upload目录存放上传的图片</p>
<h2 id="链接地址对应关系"><a href="#链接地址对应关系" class="headerlink" title="链接地址对应关系"></a>链接地址对应关系</h2><p>原图访问地址：<a href="http://img.xyz.com/upload/1.png" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png</a><br>缩略图访问地址：<a href="http://img.xyz.com/upload/1.png_100x100.png" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png_100x100.png</a> 即为宽100,高100<br>自动宽地址: <a href="http://img.xyz.com/upload/1.png_-400.png" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png_-400.png</a> 用”-“表示自动,即为高400,宽自动<br>自动高地址: <a href="http://img.xyz.com/upload/1.png_800-.jpg" target="_blank" rel="noopener">http://img.xyz.com/upload/1.png_800-.jpg</a> 用”-“表示自动,即为宽800,高自动</p>
<h2 id="访问流程"><a href="#访问流程" class="headerlink" title="访问流程"></a>访问流程</h2><p>首先判断缩略图是否存在，如存在则直接显示缩略图；<br>缩略图不存在,则判断原图是否存在，如原图存在则拼接graphicsmagick(gm)命令,生成并显示缩略图,否则返回404</p>
<h1 id="所需软件"><a href="#所需软件" class="headerlink" title="所需软件"></a>所需软件</h1><ul>
<li>lua-5.3.5.tar.gz</li>
<li>LuaJIT-2.0.5.tar.gz</li>
<li>tengine-2.3.0.tar.gz</li>
</ul>
<h1 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y gcc g++ make</span><br><span class="line"></span><br><span class="line">apt-get install libreadline-dev libpcre3 libpcre3-dev openssl libssl-dev zlib1g zlib1g-dev libgeoip-dev -y</span><br></pre></td></tr></table></figure>
<h1 id="编译安装Lua-LuaJIT"><a href="#编译安装Lua-LuaJIT" class="headerlink" title="编译安装Lua LuaJIT"></a>编译安装Lua LuaJIT</h1><h2 id="编译安装Lua"><a href="#编译安装Lua" class="headerlink" title="编译安装Lua"></a>编译安装Lua</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz</span><br><span class="line">tar zxf lua-5.3.5.tar.gz</span><br><span class="line">cd lua-5.3.5</span><br><span class="line">make linux test</span><br></pre></td></tr></table></figure>
<h2 id="编译安装LuaJIT"><a href="#编译安装LuaJIT" class="headerlink" title="编译安装LuaJIT"></a>编译安装LuaJIT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -R -O http://luajit.org/download/LuaJIT-2.0.5.tar.gz</span><br><span class="line">tar -zxvf LuaJIT-2.0.5.tar.gz</span><br><span class="line">cd LuaJIT-2.0.5</span><br><span class="line">make -j2</span><br><span class="line">export LUAJIT_LIB=/usr/local/lib</span><br><span class="line">export LUAJIT_INC=/usr/local/include/luajit-2.0</span><br><span class="line">ln -s /usr/local/lib/libluajit-5.1.so.2 /lib64/libluajit-5.1.so.2</span><br></pre></td></tr></table></figure>
<h1 id="安装GraphicsMagick"><a href="#安装GraphicsMagick" class="headerlink" title="安装GraphicsMagick"></a>安装GraphicsMagick</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget ftp://ftp.graphicsmagick.org/pub/GraphicsMagick/1.3/GraphicsMagick-1.3.31.tar.gz</span><br><span class="line">tar xzvf GraphicsMagick-1.3.31.tar.gz</span><br><span class="line">cd GraphicsMagick-1.3.31</span><br><span class="line">./configure --prefix=/usr/local/GraphicsMagick --enable-shared</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h1 id="创建用户及相应目录"><a href="#创建用户及相应目录" class="headerlink" title="创建用户及相应目录"></a>创建用户及相应目录</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd nginx &amp;&amp; useradd nginx -g nginx -s /sbin/nologin -M</span><br><span class="line"></span><br><span class="line">mkdir -p /var/tmp/tengine/client_body_temp</span><br><span class="line">mkdir -p /var/tmp/tengine/uwsgi_temp</span><br></pre></td></tr></table></figure>
<p>创建用户也可以用以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd nginx &amp;&amp; useradd nginx -g nginx -s /bin/false -M</span><br></pre></td></tr></table></figure></p>
<h1 id="编译安装tengine"><a href="#编译安装tengine" class="headerlink" title="编译安装tengine"></a>编译安装tengine</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/tengine \</span><br><span class="line">--user=nginx --group=nginx \</span><br><span class="line">--sbin-path=/usr/sbin/nginx \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_lua_module \</span><br><span class="line">--with-http_flv_module \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_addition_module \</span><br><span class="line">--with-http_geoip_module \</span><br><span class="line">--http-scgi-temp-path=/var/tmp/tengine/cgi_temp \</span><br><span class="line">--http-client-body-temp-path=/var/tmp/tengine/client_body_temp \</span><br><span class="line">--http-proxy-temp-path=/var/tmp/tengine/proxy_temp \</span><br><span class="line">--http-uwsgi-temp-path=/var/tmp/tengine/uwsgi_temp \</span><br><span class="line">--http-fastcgi-temp-path=/var/tmp/tengine/fastcgi_temp \</span><br><span class="line">--http-log-path=/var/log/tengine/access.log \</span><br><span class="line">--error-log-path=/var/log/tengine/error.log</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j 2 &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p> 注意：在Tengine-2.3.0版本后废弃Tengine的dso_tool工具以及dso配置指令，若之前有使用Tengine的dso功能、则可以切换到Nginx官方的load_module指令,详细文档<a href="http://nginx.org/en/docs/ngx_core_module.html#load_module" target="_blank" rel="noopener">参考1</a><br>和 <a href="https://www.nginx.com/resources/wiki/extending/converting/#compiling-dynamic" target="_blank" rel="noopener">参考2</a><br>还有–with-http_spdy_module 已经改为–with-http_v2_module了<br>,如果不用geo的话，编译的时候可以不加–with-http_geoip_module，可以不安装libgeoip-dev</p>
<h1 id="测试tengine"><a href="#测试tengine" class="headerlink" title="测试tengine"></a>测试tengine</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/tengine</span><br><span class="line">./sbin/nginx -t</span><br></pre></td></tr></table></figure>
<p>如果出现以下错误(没有报错就不用做以下操作了)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jaychang@tengine:/usr/local/tengine/sbin$ ./nginx -t</span><br><span class="line">./nginx: error while loading shared libraries: libluajit-5.1.so.2: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p>
<p>查找下位置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">jaychang@tengine:/usr/local/tengine/sbin$ sudo whereis libluajit-5.1.so.2</span><br><span class="line">libluajit-5.1.so: /usr/local/lib/libluajit-5.1.so /usr/local/lib/libluajit-5.1.so.2</span><br></pre></td></tr></table></figure></p>
<p>修改/etc/ld.so.conf,添加“/usr/local/lib”<br>vi /etc/ld.so.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include /etc/ld.so.conf.d/*.conf</span><br><span class="line">/usr/local/lib</span><br></pre></td></tr></table></figure></p>
<p>然后执行下ldconfig<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldconfig</span><br></pre></td></tr></table></figure></p>
<h1 id="修改nginx-conf配置文件"><a href="#修改nginx-conf配置文件" class="headerlink" title="修改nginx.conf配置文件"></a>修改nginx.conf配置文件</h1><p>将nginx.conf配置文件中的<strong>server{}段</strong>配置注释掉</p>
<p>加一行配置，以便读取/usr/local/tengine/conf.d目录下所有后缀为.conf的配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include ../conf.d/*.conf;</span><br></pre></td></tr></table></figure></p>
<p>可以参考如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes 4;</span><br><span class="line">worker_cpu_affinity 1000 0100 0010 0001;</span><br><span class="line">error_log /var/log/tengine/error.log error;</span><br><span class="line">pid /usr/local/tengine/logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">	use epoll;</span><br><span class="line">	worker_connections 65535;</span><br><span class="line">&#125;</span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">   limit_conn_zone $binary_remote_addr zone=one:10m;</span><br><span class="line">   limit_conn_zone $server_name zone=perserver:10m;</span><br><span class="line">	include mime.types;</span><br><span class="line">	include fastcgi.conf;</span><br><span class="line">	default_type application/octet-stream;</span><br><span class="line">	charset utf-8;</span><br><span class="line">	server_names_hash_bucket_size 128;</span><br><span class="line">	client_header_buffer_size 32k;</span><br><span class="line">	large_client_header_buffers 4 64k;</span><br><span class="line">	sendfile on;</span><br><span class="line">	autoindex off;</span><br><span class="line">	tcp_nopush on;</span><br><span class="line">	tcp_nodelay on;</span><br><span class="line">	keepalive_timeout 120;</span><br><span class="line">    </span><br><span class="line">	fastcgi_connect_timeout 60;</span><br><span class="line">	fastcgi_send_timeout 60;</span><br><span class="line">	fastcgi_read_timeout 60;</span><br><span class="line">	fastcgi_buffer_size 128k;</span><br><span class="line">	fastcgi_buffers 8 128k;</span><br><span class="line">	fastcgi_busy_buffers_size 128k;</span><br><span class="line">	fastcgi_temp_file_write_size 128k;</span><br><span class="line">    </span><br><span class="line">	gzip on;</span><br><span class="line">	gzip_min_length 1k;</span><br><span class="line">	gzip_buffers 4 16k;</span><br><span class="line">	gzip_http_version 1.0;</span><br><span class="line">	gzip_comp_level 2;</span><br><span class="line">	gzip_types text/plain application/x-javascript text/css application/xml;</span><br><span class="line">	gzip_vary on;</span><br><span class="line"></span><br><span class="line">	log_format main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">	&apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">	&apos;&quot;$http_user_agent&quot; $http_x_forwarded_for&apos;;</span><br><span class="line"></span><br><span class="line">	client_max_body_size 10m;</span><br><span class="line"></span><br><span class="line">	include ../conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="创建放图片的目录"><a href="#创建放图片的目录" class="headerlink" title="创建放图片的目录"></a>创建放图片的目录</h1><p>目录规划</p>
<ul>
<li>/var/www 放网页,css,js等资源</li>
<li>/var/fielbase 放图片</li>
<li>/var/filebase/upload 上传的图片放这里</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/filebase/upload </span><br><span class="line">mkdir -p /var/filebase/cache/thumb</span><br><span class="line">chown -R nginx:nginx /var/filebase</span><br></pre></td></tr></table></figure>
<h1 id="配置站点配置文件"><a href="#配置站点配置文件" class="headerlink" title="配置站点配置文件"></a>配置站点配置文件</h1><p>在/usr/local/tengine/conf.d目录下创建demo.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"># 定义lua缩略图支持的图片尺寸及开关</span><br><span class="line">init_by_lua &apos;</span><br><span class="line">    image_sizes_check = true</span><br><span class="line">    image_sizes = &#123;&quot;800x800&quot;, &quot;400x400&quot;,&quot;200x200&quot;,&quot;100x100&quot;, &quot;-800&quot;, &quot;-400&quot;, &quot;-200&quot;,&quot;-100&quot;, &quot;800-&quot;, &quot;400-&quot;, &quot;200-&quot;,&quot;100-&quot;&#125;</span><br><span class="line">&apos;;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   80;</span><br><span class="line">    servername img.xyz.com;</span><br><span class="line">    index index.php index.html index.htm;</span><br><span class="line"></span><br><span class="line">    set $root_path &apos;/var/www&apos;;</span><br><span class="line">    root $root_path;</span><br><span class="line"></span><br><span class="line">   # /lua仅用于测试，可去掉</span><br><span class="line">	 location /lua &#123;</span><br><span class="line">		default_type &apos;text/plain&apos;;</span><br><span class="line">        content_by_lua &apos;ngx.say(&quot;hello, ttlsa lua&quot;)&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # 这里也是需要根据实际情况修改的，这里的是用了rewrite</span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files $uri $uri/ /index.php?$args;</span><br><span class="line"></span><br><span class="line">        # add support for img which has query params,</span><br><span class="line">        # like:  xxx.jpg?a=b&amp;c=d_750x750.jpg</span><br><span class="line">        if ($args ~* &quot;^([^_]+)_(\d+)+x(\d+)+\.(jpg|jpeg|gif|png)$&quot;) &#123;</span><br><span class="line">            set $w $2;</span><br><span class="line">            set $h $3;</span><br><span class="line">            set $img_ext $4;</span><br><span class="line"></span><br><span class="line">            # rewrite ^\?(.*)$ _$&#123;w&#125;x$&#123;h&#125;.$img_ext? last;</span><br><span class="line">            rewrite ([^.]*).(jpg|jpeg|png|gif)$  $1.$2_$&#123;w&#125;x$&#123;h&#125;.$img_ext? permanent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # set var for thumb pic</span><br><span class="line">    set $upload_path /var/filebase;</span><br><span class="line">    set $img_original_root  $upload_path;# original root;</span><br><span class="line">    set $img_thumbnail_root $upload_path/cache/thumb;</span><br><span class="line">    set $img_file $img_thumbnail_root$uri;</span><br><span class="line"></span><br><span class="line">    # like：/xx/xx/xx.jpg_100-.jpg or /xx/xx/xx.jpg_-100.jpg</span><br><span class="line">    location ~* ^(.+\.(jpg|jpeg|gif|png))_((\d+\-)|(\-\d+))\.(jpg|jpeg|gif|png)$ &#123;</span><br><span class="line">            root $img_thumbnail_root;    # root path for croped img</span><br><span class="line">            set $img_size $3;</span><br><span class="line"></span><br><span class="line">            if (!-f $img_file) &#123;    # if file not exists</span><br><span class="line">                    add_header X-Powered-By &apos;Nginx+Lua+GraphicsMagick By Botao&apos;;  #  header for test</span><br><span class="line">                    add_header file-path $request_filename;    #  header for test</span><br><span class="line">                    set $request_filepath $img_original_root$1;    # origin_img full path：/document_root/1.gif</span><br><span class="line">                    set $img_size $3;    # img width or height size depends on uri</span><br><span class="line">                    set $img_ext $2;    # file ext</span><br><span class="line">                    content_by_lua_file /usr/local/tengine/lua/autoSize.lua;    # load lua</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # like: /xx/xx/xx.jpg_100x100.jpg</span><br><span class="line">    location ~* ^(.+\.(jpg|jpeg|gif|png))_(\d+)+x(\d+)+\.(jpg|jpeg|gif|png)$ &#123;</span><br><span class="line">            root $img_thumbnail_root;    # root path for croped img</span><br><span class="line"></span><br><span class="line">            if (!-f $img_file) &#123;    # if file not exists</span><br><span class="line">                    add_header X-Powered-By &apos;Nginx+Lua+GraphicsMagick By Botao&apos;;  #  header for test</span><br><span class="line">                    add_header file-path $request_filename;    #  header for test</span><br><span class="line">                    set $request_filepath $img_original_root$1;    # origin_img file path</span><br><span class="line">                    set $img_width $3;    # img width</span><br><span class="line">                    set $img_height $4;    # height</span><br><span class="line">                    set $img_ext $5;    # file ext</span><br><span class="line">                    content_by_lua_file /usr/local/tengine/lua/cropSize.lua;    # load lua</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # if need (all go there)</span><br><span class="line">    location ~* /upload &#123;</span><br><span class="line">            root $img_original_root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    location ~ /\.ht &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="lua脚本"><a href="#lua脚本" class="headerlink" title="lua脚本"></a>lua脚本</h1><ul>
<li>/usr/local/tengine/lua/autoSize.lua</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">-- 根据输入长或宽的尺寸自动裁切图片大小</span><br><span class="line"></span><br><span class="line">-- 检测路径是否目录</span><br><span class="line">local function is_dir(sPath)</span><br><span class="line">    if type(sPath) ~= &quot;string&quot; then return false end</span><br><span class="line"></span><br><span class="line">    local response = os.execute(&quot;cd &quot; .. sPath)</span><br><span class="line">    if response == 0 then</span><br><span class="line">        return true</span><br><span class="line">    end</span><br><span class="line">    return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 文件是否存在</span><br><span class="line">function file_exists(name)</span><br><span class="line">    local f = io.open(name, &quot;r&quot;)</span><br><span class="line">    if f ~= nil then io.close(f) return true else return false end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件路径</span><br><span class="line">function getFileDir(filename)</span><br><span class="line">    return string.match(filename, &quot;(.+)/[^/]*%.%w+$&quot;) --*nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件名</span><br><span class="line">function strippath(filename)</span><br><span class="line">    return string.match(filename, &quot;.+/([^/]*%.%w+)$&quot;) -- *nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--去除扩展名</span><br><span class="line">function stripextension(filename)</span><br><span class="line">    local idx = filename:match(&quot;.+()%.%w+$&quot;)</span><br><span class="line">    if (idx) then</span><br><span class="line">        return filename:sub(1, idx - 1)</span><br><span class="line">    else</span><br><span class="line">        return filename</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--获取扩展名</span><br><span class="line">function getExtension(filename)</span><br><span class="line">    return filename:match(&quot;.+%.(%w+)$&quot;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">function getImgSize(img)</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 判断尺寸是否合法</span><br><span class="line">-- check image size</span><br><span class="line">function table.contains(table, element)</span><br><span class="line">   for _, value in pairs(table) do</span><br><span class="line">      if value == element then</span><br><span class="line">         return true</span><br><span class="line">      end</span><br><span class="line">   end</span><br><span class="line">   return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if image_sizes_check</span><br><span class="line">then</span><br><span class="line">    if not table.contains(image_sizes, ngx.var.img_size)</span><br><span class="line">    then</span><br><span class="line">        ngx.exit(404);</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">-- check image end</span><br><span class="line"></span><br><span class="line">-- 开始执行</span><br><span class="line">-- ngx.log(ngx.ERR, getFileDir(ngx.var.img_file));</span><br><span class="line"></span><br><span class="line">local gm_path = &apos;gm&apos;</span><br><span class="line"></span><br><span class="line">-- check image dir</span><br><span class="line">if not is_dir(getFileDir(ngx.var.img_file)) then</span><br><span class="line">    os.execute(&quot;mkdir -p &quot; .. getFileDir(ngx.var.img_file))</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取高宽 100!或!100模式</span><br><span class="line">local uri = ngx.var.img_size</span><br><span class="line">local width = string.sub(uri,1,1)</span><br><span class="line">local height = 0</span><br><span class="line"></span><br><span class="line">if width == &quot;-&quot; then</span><br><span class="line">  width = 0</span><br><span class="line">  height = string.sub(uri,2,string.len(uri))</span><br><span class="line">else</span><br><span class="line">  width = string.sub(uri,1,string.len(uri)-1)</span><br><span class="line">  height = 0</span><br><span class="line">end</span><br><span class="line">-- ngx.log(ngx.ERR,uri)</span><br><span class="line">-- ngx.log(ngx.ERR,width)</span><br><span class="line">-- ngx.log(ngx.ERR,height)</span><br><span class="line">-- ngx.log(ngx.ERR,ngx.var.img_file);</span><br><span class="line">-- ngx.log(ngx.ERR,ngx.var.request_filepath);</span><br><span class="line">-- 裁剪后保证等比缩图 （缺点：裁剪了图片的一部分）</span><br><span class="line">-- 如: gm convert autoSize.jpg -resize x200 -quality 100 +profile &quot;*&quot; autoSize.jpg_-200.jpg</span><br><span class="line">if (file_exists(ngx.var.request_filepath)) then</span><br><span class="line">    local cmd = gm_path .. &apos; convert -auto-orient &apos; .. ngx.var.request_filepath</span><br><span class="line">    if height == 0 then</span><br><span class="line">        cmd = cmd .. &quot; -resize &quot; .. width .. &quot;x&quot; ..  &quot;&quot;</span><br><span class="line">    else</span><br><span class="line">        cmd = cmd .. &quot; -resize &quot; .. &quot;x&quot; .. height .. &quot;&quot;</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">-- 由于压缩后比较模糊,默认图片质量为100,请根据自己情况修改quality</span><br><span class="line">    cmd = cmd .. &quot; -quality 100&quot;</span><br><span class="line">    cmd = cmd .. &quot; +profile \&quot;*\&quot; &quot; .. ngx.var.img_file;</span><br><span class="line">    ngx.log(ngx.ERR, cmd);</span><br><span class="line">    os.execute(cmd);</span><br><span class="line">    ngx.exec(ngx.var.uri);</span><br><span class="line">else</span><br><span class="line">    ngx.exit(ngx.HTTP_NOT_FOUND);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>/usr/local/tengine/lua/cropSize.lua</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">-- 根据输入长和宽的尺寸裁切图片</span><br><span class="line"></span><br><span class="line">-- 检测路径是否目录</span><br><span class="line">local function is_dir(sPath)</span><br><span class="line">    if type(sPath) ~= &quot;string&quot; then return false end</span><br><span class="line"></span><br><span class="line">    local response = os.execute(&quot;cd &quot; .. sPath)</span><br><span class="line">    if response == 0 then</span><br><span class="line">        return true</span><br><span class="line">    end</span><br><span class="line">    return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 文件是否存在</span><br><span class="line">function file_exists(name)</span><br><span class="line">    local f = io.open(name, &quot;r&quot;)</span><br><span class="line">    if f ~= nil then io.close(f) return true else return false end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件路径</span><br><span class="line">function getFileDir(filename)</span><br><span class="line">    return string.match(filename, &quot;(.+)/[^/]*%.%w+$&quot;) --*nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 获取文件名</span><br><span class="line">function strippath(filename)</span><br><span class="line">    return string.match(filename, &quot;.+/([^/]*%.%w+)$&quot;) -- *nix system</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--去除扩展名</span><br><span class="line">function stripextension(filename)</span><br><span class="line">    local idx = filename:match(&quot;.+()%.%w+$&quot;)</span><br><span class="line">    if (idx) then</span><br><span class="line">        return filename:sub(1, idx - 1)</span><br><span class="line">    else</span><br><span class="line">        return filename</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--获取扩展名</span><br><span class="line">function getExtension(filename)</span><br><span class="line">    return filename:match(&quot;.+%.(%w+)$&quot;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">-- 判断尺寸是否合法</span><br><span class="line">-- 待切割的图片尺寸</span><br><span class="line">local img_width_height = ngx.var.img_width .. &quot;x&quot; .. ngx.var.img_height;</span><br><span class="line">-- check image size</span><br><span class="line">function table.contains(table, element)</span><br><span class="line">   for _, value in pairs(table) do</span><br><span class="line">      if value == element then</span><br><span class="line">         return true</span><br><span class="line">      end</span><br><span class="line">   end</span><br><span class="line">   return false</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if image_sizes_check</span><br><span class="line">then</span><br><span class="line">    if not table.contains(image_sizes, img_width_height)</span><br><span class="line">    then</span><br><span class="line">        ngx.exit(404);</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">-- check image end</span><br><span class="line"></span><br><span class="line">-- 开始执行</span><br><span class="line">-- ngx.log(ngx.ERR, getFileDir(ngx.var.img_file));</span><br><span class="line"></span><br><span class="line">local gm_path = &apos;gm&apos;</span><br><span class="line"></span><br><span class="line">-- check image dir</span><br><span class="line">if not is_dir(getFileDir(ngx.var.img_file)) then</span><br><span class="line">    os.execute(&quot;mkdir -p &quot; .. getFileDir(ngx.var.img_file))</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--  ngx.log(ngx.ERR,ngx.var.img_file);</span><br><span class="line">--  ngx.log(ngx.ERR,ngx.var.request_filepath);</span><br><span class="line"></span><br><span class="line">-- 裁剪后保证等比缩图 （缺点：裁剪了图片的一部分）</span><br><span class="line">-- gm convert cropSize.jpg -thumbnail 300x300^ -gravity center -extent 300x300 -quality 100 +profile &quot;*&quot; cropSize.jpg_300x300.jpg</span><br><span class="line">if (file_exists(ngx.var.request_filepath)) then</span><br><span class="line">    local cmd = gm_path .. &apos; convert -auto-orient &apos; .. ngx.var.request_filepath</span><br><span class="line">    cmd = cmd .. &quot; -thumbnail &quot; .. ngx.var.img_width .. &quot;x&quot; .. ngx.var.img_height .. &quot;^&quot;</span><br><span class="line">    cmd = cmd .. &quot; -gravity center -extent &quot; .. ngx.var.img_width .. &quot;x&quot; .. ngx.var.img_height</span><br><span class="line"></span><br><span class="line">    -- 由于压缩后比较模糊,默认图片质量为100,请根据自己情况修改quality</span><br><span class="line">    cmd = cmd .. &quot; -quality 100&quot;</span><br><span class="line">    cmd = cmd .. &quot; +profile \&quot;*\&quot; &quot; .. ngx.var.img_file;</span><br><span class="line">--  ngx.log(ngx.ERR, cmd);</span><br><span class="line">    os.execute(cmd);</span><br><span class="line">    ngx.exec(ngx.var.uri);</span><br><span class="line">else</span><br><span class="line">    ngx.exit(ngx.HTTP_NOT_FOUND);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>然后 nginx -s reload下</p>
<h1 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h1><p>在/var/filebase/upload目录，放1张图片</p>
<p><img src="\images\pasted-21.png" alt="upload successful"><br>原图</p>
<p><img src="\images\pasted-22.png" alt="upload successful"><br>100x100</p>
<p><img src="\images\pasted-23.png" alt="upload successful"><br>由于我们开启了image_sizes_check，不支持的尺寸会返回404</p>
<p><img src="\images\pasted-24.png" alt="upload successful"><br>固定定宽高自适应</p>
<p><img src="\images\pasted-25.png" alt="upload successful"><br>查看服务器上生成的文件</p>
<p>PS:这里有个问题，就是图片缩放后，图片的方向跟原先不一致的问题，后来笔者查了下GraphicsMagick资料，关于图片缩放后改变图片方向的问题，可以用-auto-orient参数可以来解决的,可以写成”gm convert -auto-orient “</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://github.com/botaozhao/nginx-lua-GraphicsMagick" target="_blank" rel="noopener">https://github.com/botaozhao/nginx-lua-GraphicsMagick</a><br><a href="https://github.com/yanue/nginx-lua-GraphicsMagick/blob/master/nginx-install.md" target="_blank" rel="noopener">https://github.com/yanue/nginx-lua-GraphicsMagick/blob/master/nginx-install.md</a><br><a href="http://www.icode9.com/content-3-77987.html" target="_blank" rel="noopener">http://www.icode9.com/content-3-77987.html</a><br><a href="https://my.oschina.net/ranhai/blog/1797454" target="_blank" rel="noopener">https://my.oschina.net/ranhai/blog/1797454</a><br><a href="https://www.twblogs.net/a/5bafdb372b7177781a0f64d7/zh-cn" target="_blank" rel="noopener">https://www.twblogs.net/a/5bafdb372b7177781a0f64d7/zh-cn</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://jaychang.cn/2019/05/15/Ubuntu 18.04 Docker Swarm集群搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jay Chang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/default_avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jay Chang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/15/Ubuntu 18.04 Docker Swarm集群搭建/" itemprop="url">Ubuntu18.04 Swarm集群搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-15T22:56:00+08:00">
                2019-05-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Docker-Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Docker&Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/15/Ubuntu 18.04 Docker Swarm集群搭建/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/15/Ubuntu 18.04 Docker Swarm集群搭建/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,828
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Swarm简介"><a href="#Swarm简介" class="headerlink" title="Swarm简介"></a>Swarm简介</h1><p>Swarm 是 Docker 官方提供的一款集群管理工具，用来管理 Docker 集群，它将若干台 Docker 主机抽象为一个整体，并且通过一个入口统一管理这些 Docker 主机上的各种 Docker 资源。</p>
<p>Swarm 只是一个调度器（Scheduler）加路由器 (Router)，Swarm 自己不运行容器，它只是接受 Docker 客户端发送过来的请求，调度适合的节点来运行容器，这意味着，即使 Swarm 由于某些原因挂掉了，集群中的节点也会照常运行，当 Swarm 重新恢复运行之后，它会收集重建集群信息。</p>
<p>Docker Engine 从 V1.12.0 版本开始，原生集成了 Docker Swarm，所以只要在每台机器上安装 Docker，就可以直接使用 Docker Swarm。</p>
<p>Swarm 和 Kubernetes 比较类似，但是更加轻，具有的功能也较 Kubernetes 更少一些。</p>
<p>Swarm会提供网络管理、负载均衡、基于DNS容器发现、集群状态管理、扩容缩容等功能，在DevOps流程层面，可以组合成发布、回滚应用、查看服务的状态、日志、终端，更改发布配置（例如环境变量、默认副本数等）等功能。这个层面Portainer这个开源项目，提供了更好用集群管理的UI界面和类似Kubernetes Apiserver设计的Docker集群API接口服务。</p>
<p><img src="\images\pasted-18.png" alt="upload successful"></p>
<p>Docker Swarm的资源抽象比较简单，在没有容器编排的情况下，我们主要使用Services，这个和Kubernetes上的Services有些不一样，可以理解为Services和Deployment的合体，用来管理和定义容器的调度和扩容等，也可以直接做端口映射，在容器集群里任意IP都可以访问。</p>
<h1 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h1><p>因为Manager节点只负责调度集群的Task，配置要求不高，可用3台低配置机器作为Manager节点，根据Raft算法，3台可以容许1台机器出问题，5台可以允许2台机器出问题，大家可以按需求部署。Worker节点的作用是运行业务容器。同时，在Manager和Worker节点上，会以容器方式部署机器监控和日志收集，上面还需要运行网络和存储插件。</p>
<table>
<thead>
<tr>
<th>IP地址</th>
<th>Swarm节点类型</th>
<th>主机名</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.56.111</td>
<td>manager</td>
<td>m01</td>
</tr>
<tr>
<td>192.168.56.112</td>
<td>manager</td>
<td>m02</td>
</tr>
<tr>
<td>192.168.56.113</td>
<td>manager</td>
<td>m03</td>
</tr>
<tr>
<td>192.168.56.114</td>
<td>worker</td>
<td>n01</td>
</tr>
<tr>
<td>192.168.56.115</td>
<td>worker</td>
<td>n02</td>
</tr>
</tbody>
</table>
<h2 id="集群节点配置"><a href="#集群节点配置" class="headerlink" title="集群节点配置"></a>集群节点配置</h2><p>笔者是用VirtualBox虚拟5台机器,作为运行Docker的宿主机。本节以下内容均是在m01上操作的。其他节点配置不再赘述，参考此m01节点的配置即可。</p>
<h3 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h3><p>每台宿主机需要启用仅主机(Host-Only)网络及网络地址转换(NAT)两张网卡</p>
<p>以m01为例,/etc/netplan/01-netcfg.yaml网络配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    enp0s3:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      dhcp6: no</span><br><span class="line">      addresses: [192.168.56.111/24]</span><br><span class="line">    enp0s8:</span><br><span class="line">      dhcp4: yes</span><br><span class="line">      dhcp6: no</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意这里enp0s3就是仅主机(Host-Only)网络这个网卡，此网卡用于ssh连接我们的虚拟机，由于这里是virtualbox虚拟机无需配置网关，enp0s8就是网络地址转换(NAT)这个网卡，此网卡用于访问外网。</p>
</blockquote>
<h3 id="主机名及hosts"><a href="#主机名及hosts" class="headerlink" title="主机名及hosts"></a>主机名及hosts</h3><p>设置主机名 sudo vi /etc/hostname<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m01</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>如果遇到重启机器后主机名被重置，可以再用<strong><em>sudo hostnamectl set-hostname xxx</em></strong> 设置</p>
</blockquote>
<p> 通过sudo vi /etc/host以添加以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.111 m01</span><br><span class="line">192.168.56.112 m02</span><br><span class="line">192.168.56.113 m03</span><br><span class="line">192.168.56.114 n01</span><br><span class="line">192.168.56.115 n02</span><br></pre></td></tr></table></figure>
<h3 id="设置国内软件源"><a href="#设置国内软件源" class="headerlink" title="设置国内软件源"></a>设置国内软件源</h3><p> 备份sources.list,sudo cp /etc/apt/sources.list /etc/apt/sources.list.default</p>
<p>批量修改sources.list<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i &quot;s#us.archive.ubuntu.com/#mirrors.aliyun.com/#g&quot; /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">sudo sed -i &quot;s#security.ubuntu.com/#mirrors.aliyun.com/#g&quot; /etc/apt/sources.list</span><br></pre></td></tr></table></figure></p>
<h3 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h3><h4 id="安装GPG证书"><a href="#安装GPG证书" class="headerlink" title="安装GPG证书"></a>安装GPG证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure>
<h4 id="写入软件源信息"><a href="#写入软件源信息" class="headerlink" title="写入软件源信息"></a>写入软件源信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br></pre></td></tr></table></figure>
<h4 id="更新并安装Docker-CE"><a href="#更新并安装Docker-CE" class="headerlink" title="更新并安装Docker-CE"></a>更新并安装Docker-CE</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y install docker-ce</span><br></pre></td></tr></table></figure>
<p>若想要安装指定版本Docker，参照如下操作：</p>
<ul>
<li>Step 1: 查找Docker-CE的版本:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo apt-cache madison docker-ce</span><br></pre></td></tr></table></figure>
<ul>
<li>Step 2: 安装指定版本的Docker-CE</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install docker-ce=[VERSION]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意上面命令中的[VERSION]需要替换成你想要安装的docker版本，<br>比如这里我将[VERSION]替换为5:18.09.4~3-0~ubuntu-bionic，所以最终的安装命令是<strong>sudo apt-get -y install docker-ce=5:18.09.6~3-0~ubuntu-bionic</strong></p>
<p>其他可选的Docker软件源还有<a href="https://mirror.tuna.tsinghua.edu.cn/help/docker-ce/" title="清华大学Docker软件源" target="_blank" rel="noopener">清华大学Docker软件源</a></p>
</blockquote>
<h4 id="配置Docker镜像加速"><a href="#配置Docker镜像加速" class="headerlink" title="配置Docker镜像加速"></a>配置Docker镜像加速</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意 insecure-registries是配置非https的镜像中心，比如我们自己搭建的一个docker私有镜像中心，是用http的话，就可以用insecure-registries指定。</p>
</blockquote>
<h4 id="修改docker-service配置"><a href="#修改docker-service配置" class="headerlink" title="修改docker.service配置"></a>修改docker.service配置</h4><p>如果碰到Unable to proxy the request via the Docker socket,这个错误，建议可以在任意worker节点，docker服务配置，<br><img src="\images\pasted-20.png" alt="upload successful"></p>
<p>这里只要改集群中一个节点就可以了(如果是用portainer agent方式添加的endpoint)主要是要改ExecStart,暴露2375,笔者改的是n01节点上的/lib/systemd/system/docker.service</p>
<p>sudo vi /lib/systemd/system/docker.service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">BindsTo=containerd.service</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// -H 0.0.0.0:2375 --containerd=/run/containerd/containerd.sock</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line"># Note that StartLimit* options were moved from &quot;Service&quot; to &quot;Unit&quot; in systemd 229.</span><br><span class="line"># Both the old, and new location are accepted by systemd 229 and up, so using the old location</span><br><span class="line"># to make them work for either version of systemd.</span><br><span class="line">StartLimitBurst=3</span><br><span class="line"></span><br><span class="line"># Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230.</span><br><span class="line"># Both the old, and new name are accepted by systemd 230 and up, so using the old name to make</span><br><span class="line"># this option work for either version of systemd.</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="line"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"></span><br><span class="line"># Comment TasksMax if your systemd version does not supports it.</span><br><span class="line"># Only systemd 226 and above support this option.</span><br><span class="line">TasksMax=infinity</span><br><span class="line"></span><br><span class="line"># set delegate yes so that systemd does not reset the cgroups of docker containers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">内容过多省略...</span><br></pre></td></tr></table></figure>
<p>还可以改成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd -H unix:// -H 0.0.0.0:2375 --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure></p>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375 --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>
<p>sudo systemctl daemon-reload<br>sudo systemctl restart docker</p>
<h4 id="重启docker服务"><a href="#重启docker服务" class="headerlink" title="重启docker服务"></a>重启docker服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<h1 id="开始搭建Swarm集群"><a href="#开始搭建Swarm集群" class="headerlink" title="开始搭建Swarm集群"></a>开始搭建Swarm集群</h1><p>上述都是在做准备工作，接下来就正式开始搭建Swarm集群。</p>
<h2 id="初始化Swarm集群"><a href="#初始化Swarm集群" class="headerlink" title="初始化Swarm集群"></a>初始化Swarm集群</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker swarm init --advertise-addr 192.168.56.111</span><br></pre></td></tr></table></figure>
<p><img src="/images/pasted-0.png" alt="初始化swarm集群"></p>
<blockquote>
<p>注意：上图显示的token仅作参考，具体需看实际情况，也请记下来</p>
<p>如果遗失可以通过下面两个命令，分别找回manager、worker的join token</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker swarm join-token manager</span><br><span class="line"></span><br><span class="line">sudo docker swarm join-token worker</span><br></pre></td></tr></table></figure>
<h2 id="集群添加manager节点"><a href="#集群添加manager节点" class="headerlink" title="集群添加manager节点"></a>集群添加manager节点</h2><h3 id="获取manager的join-token"><a href="#获取manager的join-token" class="headerlink" title="获取manager的join token"></a>获取manager的join token</h3><p>根据上一节给出的提示，在192.168.56.111(m01)上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker swarm join-token manager</span><br></pre></td></tr></table></figure></p>
<p><img src="\images\pasted-1.png" alt="集群添加manager节点"></p>
<p>根据提示，若要将节点作为manager节点加入swarm集群，需执行如下命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-65q3om1lmrjrsvnbqug0qccf00ertneorskvmv86g05qzicc8w-1kuf57afgawuuz24h7gx4hycb 192.168.56.111:2377</span><br></pre></td></tr></table></figure></p>
<h3 id="添加manager节点到集群"><a href="#添加manager节点到集群" class="headerlink" title="添加manager节点到集群"></a>添加manager节点到集群</h3><p>根据我们的规划，我们要将m02、m03作为manager节点加入到swarm集群，所以我们在m02,m03上执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker swarm join --token SWMTKN-1-65q3om1lmrjrsvnbqug0qccf00ertneorskvmv86g05qzicc8w-1kuf57afgawuuz24h7gx4hycb 192.168.56.111:2377</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：请根据实际情况进行修改，不要一模一样复制！</p>
</blockquote>
<p><img src="\images\pasted-2.png" alt="upload successful"></p>
<p><img src="\images\pasted-3.png" alt="upload successful"></p>
<h2 id="添加worker节点到集群"><a href="#添加worker节点到集群" class="headerlink" title="添加worker节点到集群"></a>添加worker节点到集群</h2><p>分别在n01,n02上执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-65q3om1lmrjrsvnbqug0qccf00ertneorskvmv86g05qzicc8w-978befgfbbuqzqzv2zbvcg8fk 192.168.56.111:2377</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：请根据实际情况进行修改，不要一模一样复制！</p>
</blockquote>
<p><img src="\images\pasted-4.png" alt="upload successful"></p>
<p><img src="\images\pasted-5.png" alt="upload successful"></p>
<h2 id="查看节点状态"><a href="#查看节点状态" class="headerlink" title="查看节点状态"></a>查看节点状态</h2><p>在任意manager节点上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker node ls</span><br></pre></td></tr></table></figure></p>
<p><img src="\images\pasted-7.png" alt="upload successful"></p>
<p>从上图可以看到集群中有3个manager节点，2个worker</p>
<h1 id="Swarm集群管理UI"><a href="#Swarm集群管理UI" class="headerlink" title="Swarm集群管理UI"></a>Swarm集群管理UI</h1><p>建议每次都在固定的节点上运行,所以这里指定了node.hostname == m01<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker service create --name portainer --publish 9000:9000 --replicas=1 --constraint &apos;node.hostname == m01&apos; --mount type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock --mount type=volume,src=portainer_data,dst=/data portainer/portainer</span><br></pre></td></tr></table></figure></p>
<p><img src="\images\pasted-9.png" alt="upload successful"></p>
<h2 id="Add-Endpoints"><a href="#Add-Endpoints" class="headerlink" title="Add Endpoints"></a>Add Endpoints</h2><p>添加一个Local Endpoint，由于portainer是运行在m01上的，所以就是添加m01</p>
<p><img src="\images\pasted-10.png" alt="upload successful"></p>
<p><img src="\images\pasted-11.png" alt="upload successful"></p>
<h2 id="部署Portainer-Agent"><a href="#部署Portainer-Agent" class="headerlink" title="部署Portainer Agent"></a>部署Portainer Agent</h2><p>打开App Template，点击Poirtainer Agent<br><img src="\images\pasted-12.png" alt="upload successful"></p>
<p>给stack取个名字，然后单击deploy</p>
<p><img src="\images\pasted-14.png" alt="upload successful"></p>
<p>部署完成后，每个节点会起一个</p>
<p><img src="\images\pasted-15.png" alt="upload successful"></p>
<blockquote>
<p>部署Portainer Agent的另外一个途径是在任意manager节点上，执行<br>以下命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://downloads.portainer.io/agent-stack.yml -o agent-stack.yml &amp;&amp; docker stack deploy --compose-file=agent-stack.yml portainer-agent</span><br></pre></td></tr></table></figure>
<h2 id="添加其他Endpoint"><a href="#添加其他Endpoint" class="headerlink" title="添加其他Endpoint"></a>添加其他Endpoint</h2><p>这里以添加m02为例，Endpoint的名称我们就填m02这个主机名好了，然后就是要填写Endpoint URL，就填m02节点的IP地址以及Portainer Agent的端口号，即192.168.56.112:9001</p>
<p><img src="\images\pasted-16.png" alt="upload successful"></p>
<p>所有Endpoint添加完毕</p>
<p><img src="\images\pasted-17.png" alt="upload successful"></p>
<blockquote>
<p>这里的m01也可以删掉后，用Agent来添加</p>
</blockquote>
<h2 id="镜像中心设置"><a href="#镜像中心设置" class="headerlink" title="镜像中心设置"></a>镜像中心设置</h2><p>当镜像中心是需要身份认证的，那么可以在registries里添加一个镜像中心，输入镜像中心的用户名，密码即可，这样集群中的所有节点都能从该镜像中心拉取镜像了。由于篇幅，这里不再赘述跟截图了，读者可以自行尝试。</p>
<h1 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h1><ul>
<li>部署一个nginx service</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker service create --name mynginx --replicas 3 -p 8088:80 nginx:alpine</span><br></pre></td></tr></table></figure>
<p><img src="\images\pasted-19.png" alt="upload successful"></p>
<blockquote>
<p>我们发现通过任意节点的8088端口都能访问，那是因为Ingress的特性使得请求可以转发到任何一台Worker或者Manager节点上，然后通过内置的routing mesh的Load Balancer通过LVS转发请求到Service的其中一个副本，一个值得注意的点是，就算这台Node上没有运行这个Service的容器。Load Balancer也会找到其他机器上存在的副本，这个主要是通过内置的DNS加LVS转发实现。</p>
</blockquote>
<ul>
<li>扩容、缩容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker service scale mynginx=2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker service scale mynginx=3</span><br></pre></td></tr></table></figure>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><h3 id="删除manager节点"><a href="#删除manager节点" class="headerlink" title="删除manager节点"></a>删除manager节点</h3><p>manager节点不能直接删除，需要先降级到worker节点再删除。</p>
<p>比如，这里我误把n02作为manager加入到集群，我想把n02改成worker节点。</p>
<p><img src="\images\pasted-6.png" alt="upload successful"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker node demote cu8f</span><br><span class="line">sudo docker node rm cu8f</span><br></pre></td></tr></table></figure>
<blockquote>
<p>cu8f为节点ID的前缀</p>
</blockquote>
<h3 id="删除worker节点"><a href="#删除worker节点" class="headerlink" title="删除worker节点"></a>删除worker节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker node rm [ID或HOSTNAME]</span><br></pre></td></tr></table></figure>
<h3 id="工作节点离开集群"><a href="#工作节点离开集群" class="headerlink" title="工作节点离开集群"></a>工作节点离开集群</h3><p>在工作节点上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker swarm leave</span><br></pre></td></tr></table></figure></p>
<p>工作节点离开集群后，节点状态就会变为Down,这样此节点就可以加入到另外一个swarm集群了。（原先的swarm集群manager节点上记得用sudo docker node rm xxx删除此节点）</p>
<h2 id="创建overlay网络"><a href="#创建overlay网络" class="headerlink" title="创建overlay网络"></a>创建overlay网络</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=192.168.10.0/24 --attachable -d overlay my-net</span><br></pre></td></tr></table></figure>
<h2 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h2><h3 id="如何删除docker"><a href="#如何删除docker" class="headerlink" title="如何删除docker"></a>如何删除docker</h3><p>通过sudo apt-get purge docker-ce,然后将/var/lib/docker目录删掉</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://dockone.io/article/8808" target="_blank" rel="noopener">http://dockone.io/article/8808</a> 房多多容器化和容器云实践<br><a href="https://www.cnblogs.com/bigberg/p/8656963.html" target="_blank" rel="noopener">https://www.cnblogs.com/bigberg/p/8656963.html</a> Docker Macvlan<br><a href="https://cizixs.com/2017/02/14/network-virtualization-macvlan/" target="_blank" rel="noopener">https://cizixs.com/2017/02/14/network-virtualization-macvlan/</a> linux 网络虚拟化： macvlan<br><a href="https://opsx.alibaba.com/guide?lang=zh-CN&amp;document=69a2341e-801e-11e8-8b5a-00163e04cdbb" target="_blank" rel="noopener">https://opsx.alibaba.com/guide?lang=zh-CN&amp;document=69a2341e-801e-11e8-8b5a-00163e04cdbb</a> ubuntu 18.04 (bionic) 配置 opsx 安装源</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/default_avatar.png"
                alt="Jay Chang" />
            
              <p class="site-author-name" itemprop="name">Jay Chang</p>
              <p class="site-description motion-element" itemprop="description">当你的才华还撑不起你的野心时，你就应该静下心来学习。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jaychang9" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/jaychang1987" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/jaychang1987" target="_blank" title="Facebook">
                      
                        <i class="fa fa-fw fa-facebook"></i>Facebook</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/jaychang1987" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jaychang1987@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tech.meituan.com/" title="美团点评" target="_blank">美团点评</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tech.youzan.com/" title="有赞技术" target="_blank">有赞技术</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://tech.lede.com/" title="网易乐得" target="_blank">网易乐得</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://lovestblog.cn/" title="你假笨" target="_blank">你假笨</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jianshu.com/u/90ab66c248e6" title="占小狼" target="_blank">占小狼</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/quhongwei_zhanqiu" title="斩秋" target="_blank">斩秋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.iocoder.cn/" title="芋道源码" target="_blank">芋道源码</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wuchong.me/" title="伍翀Jark" target="_blank">伍翀Jark</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.jasongj.com/" title="郭俊Jason" target="_blank">郭俊Jason</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/chenssy" title="Chenssy" target="_blank">Chenssy</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://techlog.cn/" title="龙谭斋" target="_blank">龙谭斋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://imququ.com/" title="Jerry Qu" target="_blank">Jerry Qu</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/morewindows/article/details/17488865" title="MoreWindows" target="_blank">MoreWindows</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.philipphauer.de/" title="Philipp Hauer" target="_blank">Philipp Hauer</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jay Chang</span>
  <span>
	<a class="theme-link" target="_blank" href="http://zjca.miit.gov.cn/">
		浙ICP备19027095号
	</a>
  </span>	
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://jay-changs-blog.disqus.com/count.js" async></script>
    

    

  




	





  














  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
